<apex:page showHeader="true" sidebar="false" standardController="dealer__Deal__c" showChat="true" 
   title="{!dealer__Deal__c.Name}" id="p" docType="html-5.0" extensions="Deal_MBW2,SObjectHistory_EXT">
<!-- 
2015-07-??  B. Leaman   BLL1 - Correct total commission calc to include F-and-I;auto-resize text area;
2015-08-17  B. Leaman   BLL2 - Correct saving of deal & proposed delivery dates; Enforce creation from Solution Opp;
                        Fix GP% calc displayed (javascript calc is right);
2015-08-25  B. Leaman   BLL3 - adjust logic protecting creation w/out solution opportunity to only affect NEW proposals. 
2015-08-26  J. Kuljis   JVK1 - Add another lookup to account for Other Payor (non-government agencies making payments) Requested by Jerry August.
2015-08-27  J. Kuljis   JVK2 - Split commission error, "0" when set will override comm rates
2015-08-31  B. Leaman   BLL4 - round totalGov javascript calc
2015-09-03  J. Kuljis   JVK3 - Show CMC Gross even when percent is overriden.  Allow for Total_Additional_Equipment to have a zero cost.  Previously resulting in a divide by zero error.
2015-09-11  B. Leaman   BLL5 - Show additional equipment costs
2015-09-28  D. Ray      DR1 - Show Fee block on equipment only sale because we need access to the sales tax field
2015-09-29  D. Ray      DR2 - User Friendly error message on Service Vehicle Creation
2015-10-08  B. Leaman   BLL6 - Change 3rd Third Party Payor to "Other" payor (regular account, not 3rd party acct)
2015-10-15  B. Leaman   BLL7 IT#13638 Kathi N.: Dont refresh additional equipment until search button (new) is clicked.
                        Also show as many commissions as are saved on the proposal.
2015-10-26  B. Leaman   BLL8 IT#14367 - Show wheelchair information above selected equipment, autosave trade sums.
2015-10-30  B. Leaman   BLL9 add proposal history (Commented out for now until vetted & tested in qa. extensions add SObjectHistory_EXT)
2015-11-10  RedTeal     RT1 - Changed the alert for open repair orders to use a new field. Will now fire whenever there is an open order, regardless of amount.
2015-11-11  B. Leaman   BLL13 - Tax integration. Production 2015-11-19.
2015-12-03  B. Leaman   BLL14 - hide misc additional equipment if cost, labor & price are 0 (using sublet w/ no cost/price/labor as notes).
2015-12-09  B. Leaman   BLL15 - Allow deal type to be changed only when deal is in "Pending" status.
2015-12-16  RedTeal     RT2   - Show transactions on page
2015-12-22  B. Leaman   BLL16 - Show Fees/Taxes navigation
2016-1-4    D. Ray      DR3 - Format fees as only two decimals
2016-01-12  B. Leaman   BLL17 IT18391 - Show advanced vehicle search for anything except equipment-only sales.
2016-01-20  B. Leaman   BLL18 - Add support for fair market value (for taxation in MD, GA) & url; // not implemented: DoNotCollectTax flag;
2016-1-22   D. Ray      DR4 - Override Commission Calculation ONLY if "flatRateField > 0"
2016-02-04  B. Leaman   BLL19 - Search additional equipment - rerender change and add "new search" button.
2016-2-17   D. Ray      DR5 -  "flatRateField > 0" needs to use double value
2016-03-25  B. Leaman   BLL20 IT#22404 - Add "Deliver at store" flag for taxing locally for some out-of-state deliveries like AZ. 
2016-04-14  B. Leaman   BLL21 IT#22916 - show pack and conversion discount in GP column.
2016-04-19  B. Leaman   BLL22 IT#21410 - Change "Proposed delivery date" to "Delivery date" and larger print & blue to stand out more.
2016-04-26  B. Leaman   BLL23 IT#22498 - Allow entry into Year, Make, Model, VIN for vehicles at vendors site we dont yet own.
2016-04-27  B. Leaman   BLL24 - No commission calcs on deals as of May 2, 2016.
2016-05-11  B. Leaman   BLL25 IT#23750 - Refresh county after tax calcs in case it was filled in.
2016-05-17  RedTeal     RT4   - Small tweak to correct occasional error when adding a service vehicle to an equipment proposal
2016-06-21  B. Leaman   BLL26 - Not displaying vehicle right after Advanced vehicle selection
2016-07-07  B. Leaman   BLL27 - Support for do not collect out-of-state taxes.
2016-07-08  J. Kuljis   JVK4  - Set Kit cost/sale to east/west based on location setting
2016-07-13  D. Ray      DR6   - Replace Diamon Fusion with Tire+Wheel [Ticket #28211]
2016-07-23  J. kuljis   JVK5  - Add Support for Appraisals when adding a trade to the Deal
2016-07-29  B. Leaman   BLL28 - Changed message display to be more noticeable.
2016-08-29  B. Leaman   BLL29 - TaxExempt flag on added equipment and ConversionExempt flag on proposal.
2016-09-16  B. Leaman   BLL30 - add "mark lost" button
2016-11-01  B. Leaman   BLL31 - Add special F&I save button that uses "god" mode and other F&I changes.
2016-11-04  B. Leaman   BLL32 - Try a different CDN for jquery stuff.
2016-11-28  B. Leaman   BLL33 - add links to native view & edit page layouts for authorized people only.
2016-12-29  B. Leaman   BLL34 - Replace custom lookups with managed versions (Deal obj) 
2017-01-03  B. Leaman   BLL35 - Use Funding_option__c instead of Contract_CustomerArranged__c.
2017-01-30  B. Leaman   BLL36 - rewritten to include commercial. 
2017-04-05  B. Leaman   BLL37 - add activities related lists.
2017-05-12  B. Leaman   BLL38 - Show delivery information section on retail Chassis/Conversion proposals too.
2017-06-01  B. Leaman   BLL39 - Handle esc product buttons more dynamically.
2017-06-08  B. Leaman   BLL40 - BancLease support, sub-prime cost, commercial changes.
2017-07-06  B. Leaman   BLL41 - fix right-hand sidebar on posted proposals (trade & protection)
2017-07-18  B. Leaman   BLL42 - Show chassis & conversion tax info.
2017-07-21  B. Leaman   BLL43 - CA Fee calculator links; New, Used, Non-resident
2017-08-11  B. Leaman   BLL44 - Integrate lease calculator; reorganize F&I section;
						Add extd service hours & total in added equip section;
						IR-0018362 remove "Trade Record" link (conditioned by custom setting MobilityForceSettings__c.ShowTradeRecordLink__c)
						IR-0018049 add "color" to section on vehicle not yet in stock
						IR-0017085 Show loan in proposal sidebar onscreen
2017-10-10	B. Leaman	BLL45 IR-0021149 screen shows wrong GP from what was saved on proposal due to subprime loan cost.
2017-10-10	B. Leaman	BLL46 IR-0020954 sales tax override for leases only 
						(and out-of-state collection when Avalara says $0, and releasing dealers);
						Also show appraisal edit button even if only a trade record exists.
2017-11-27	B. Leaman	BLL47 - Add exterior color support to new service vehicle window, amt financed only if funding option='Financed'.
						Add button to re-open a lost proposal (to pending); add finance company reimbursement;
2017-12-19	B. Leaman	BLL48 DME: Hide vehicle not yet in stock section for DME & F&I.
2018-03-30	B. Leaman	BLL49 GP Sharing on-screen.
2018-04-20	B. Leaman	BLL50 - show conversion discount on right-hand sidebar.
2018-05-25	B. Leaman	BLL51 - Add support for Client needing a prescription for special tax reductions (or other requirement).
2018-07-17	B. Leaman	BLL52 - Adjustments to the right-hand summary side-bar for leases; rename F&I "Rejected" button to "Declined".
2018-08-07	B. Leaman	BLL53 - IR-0038160 Allow kit/part/labor search & entry (and ESC) even if other required fields are missing (New customer dropdown).
						IR-0038939 Warning if NMEDA label charge is set to print on pg. 2 (VA won't pay this).
						Also change label for "Contract Amount Financed" to "Adjusted Capitalized Cost" for leases.
2018-09-26	B. Leaman	BLL54 W-000443 - Add support for printing the purchase agreement directly from this page.
2018-10-02	B. Leaman	BLL55 - restructure to put right-hand sidebar "higher" up so header bar is to the left of it.					
2018-11-07  B. Leaman   W-000466 BLL56 - Add FICO score to F&I section.
2018-12-03  B. Leaman   W-000505 BLL57 - show acquisition fee for both loans and leases; Bank Of America charges acq fee in Ohio.
2019-01-07	B. Leaman	W-000537 BLL58 - allow "Mark lost" with required fields missing; 
2019-01-08	B. Leaman	W-000482 BLL59 - Button to approve/unapprove VA paperwork and fields showing approval info;
						Custom permission "Proposal Approve VA Paperwork" to see and use this new section.
						Also fix full-screen colors on approval steps (css change).
2019-02-21	B. Leaman			BLL60 - remove older version of jQuery. Don't need both loaded.
2019-03-01	B. Leaman	W-000610 BLL61 - only allow marking a proposal lost while it's pending.
2019-03-04	B. Leaman	W-000579 BLL62 - simplify F&I section within proposal since it's moving to its own tab/component.
2019-03-22  A. Miller   W-000582  AMM62 - Update to handle favoriting
2019-07-16	B. Leaman	W-000717 BLL63 - remove build order from consumer proposals
2019-07-23	B. Leaman	W-000606 BLL64 - F&I only proposal ESC Financing Cost to hit F&I GP only. New field for F&I Loan Acq COST.
2019-08-28	B. Leaman	W-000747 BLL65 - rerender CMC block after proposal type change
2019-11-15	B. Leaman	BLL66 - don't use external icons - they got changed and are making this difficult to use
2019-11-25	B. Leaman	W-000795 BLL67 - Can't search on notes anymore, as they're increased past 256 characters.
-->
 <html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!--BLL55-->
 <head> 
<!--apex:slds/ --><!--BLL55-->
       <!-- apex:stylesheet value="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css"/ -->
<apex:stylesheet value="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css"/>
       <apex:includeScript value="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" />


	   <!-- Bootsrap Includes -->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources,'/js/bootstrap.min.js')}"/>
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources,'/js/typeahead-bundle.min.js')}"/>
       <apex:stylesheet value="{!URLFOR($Resource.dealer__SDLResources,'/css/VFbootstrap.css')}"/>
	   <apex:includeScript value="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"/>
       <!--  apex:includeScript value="//code.jquery.com/ui/1.11.2/jquery-ui.js"/ -->       

       <!-- Include JS Notify and Moment -->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/notify.min.js')}" />
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/moment.min.js')}" />

       <!-- Include datepicker -->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/bootstrap-datepicker.js')}" />
       <apex:stylesheet value="{!URLFOR($Resource.dealer__SDLResources, '/css/datepicker.css')}" />

       <!-- Include Checkbox -->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/bootstrap-checkbox.js')}" />
       <apex:stylesheet value="{!URLFOR($Resource.dealer__SDLResources, '/css/bootstrap-checkbox.css')}" />

       <!-- Include Select Box -->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/bootstrap-select.min.js')}" />
       <apex:stylesheet value="{!URLFOR($Resource.dealer__SDLResources, '/css/bootstrap-select.css')}" />

       <!-- Include Tipr-->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/jquery.tooltipster.min.js')}" />
       <apex:stylesheet value="{!URLFOR($Resource.dealer__SDLResources, '/css/tooltip/tooltipster.css')}" />

       <!-- Alertify -->
       <apex:includeScript value="//cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.min.js" />
       <apex:stylesheet value="//cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.core.min.css" />
       <apex:stylesheet value="//cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.bootstrap.min.css" />

       <!-- Intro JS -->
       <!-- BLL36d unused apex:includeScript value="{!URLFOR($Resource.dealer__IntroJS, 'intro.min.js')}" / -->
       <!-- BLL36d unused apex:stylesheet value="{!URLFOR($Resource.dealer__IntroJS, 'introjs.min.css')}" / -->       

		<script type="text/javascript">
        $dt = jQuery.noConflict();
        var dealId = '{!deal.Id}';
        var fees   =    0;
        var gov    =    0;
        var tradeOA=    doubleVal('{!dealer__Deal__c.dealer__Trade_Allowance__c}')-doubleVal('{!dealer__Deal__c.Trade_ACV__c}');
        var recordTypeName = '{!recordTypeName}';
        // DOM ESC
        function el(s) {
            return '#' + s.replace(/(:|\.)/g,'\\\\$1');
        }       
        /* activate sidebar */

        // BLL24a - commissions not accrued after may 2, 2016
        var may_1_2016 = Date.parse("2016-05-01");
        var pdd = new Date();
        try {pdd = Date.parse('{!deal.Proposed_Delivery_Date__c}'); } catch(e) {}
        // BLL24a end
    
// BLL36a - routine to change input box to orange if value changes from saved value
function setInputValue(selector, value) {
    var elem = $dt(selector);
    var anythingChanged = false;
    if (elem.size()>0) {
        var oldValue = elem.val();
        if (doubleVal(oldValue)!=doubleVal(value)) {
            elem.val(value);
            anythingChanged = true;
            if (console) console.log(selector + ' changed from ' + oldValue + ' to ' + value);
            elem.addClass('unsaved');
        }
    }
    if (anythingChanged) {
        $dt('input[id$="saveButton"]').removeClass('btn-info').addClass('btn-warning');
        $dt('input[id$="saveButtonMenu"]').removeClass('btn-info').addClass('btn-warning');
        $dt('input[id$="saveButtonVehicleTop"]').removeClass('btn-info').addClass('btn-warning');
        $dt('input[id$="saveButtonVehicleBottom"]').removeClass('btn-info').addClass('btn-warning');
        $dt('input[id$="saveButtonGrants"]').removeClass('btn-info').addClass('btn-warning');
    }
}
// BLL36a end 


        $dt(document).ready(function() {

            // introguide.start();
            $dt('.tooltip').tooltipster();

            // Select All on Focus
            $dt('input').on("click", function () {
               $dt(this).select();
            }); 

            // set Focus
            $dt("#p\\:frm\\:pB\\:pbCustomer\\:buyer_contact").focus();

            $dt('#sidebar').affix({
              offset: {
                top: function() {
                       /* BLL36d return $dt('#AppBodyHeader').height(); */
                       // if (console) console.log('sidebar affix top=' + $dt('#proposalHeader').height()); // BLL36a
                       $dt('#sidebar').css('top', $dt('#proposalHeader').height()+15);
                       return 125; // $dt('#proposalHeader').height()-125;  // BLL36a
                     } 
              }
            });

             $dt("#proposalHeader").affix({
                offset: {
                    /*BLL36d top: 105 */
                    top: 125 //function() {
                       // /* BLL36d return $dt('#AppBodyHeader').height(); */
                       //if (console) console.log('header affix top=' + $dt('#proposalHeader').height());   // BLL36a
                       //return $dt('#proposalHeader').height();    // BLL36a
                    //}               
             } 
            });

            $dt('.noEnterSubmit').keypress(function(e){
                if ( e.which == 13 ) e.preventDefault();
            });

            // Default Collapsed Section
            $dt('.hideListButton[id$="coBuyerBlock"]').trigger('click');
            $dt('.hideListButton[id$="pbTitleInfo"]').trigger('click');
            $dt('.hideListButton[id$="LeaseInformationTables"]').trigger('click');

            
            var $submenu = $dt("#proposalHeader");
            $submenu.after('<div style="width:100%;height:' + $submenu.height() + ';border: 1px solid #DBDBDB;" class="proposalHeader affix-placeholder"></div>');

            /* activate scrollspy menu */
            var $dtbody   = $dt(document.body);
            var navHeight = $dt('.recordHeader').outerHeight(true) + 10;
            if (console) console.log('navHeight=' + navHeight); // BLL36a

            $dtbody.scrollspy({
                /*BLL36d target: '#rightCol', */
                target: '#sidebar', /* BLL36a */
                offset: navHeight
            });

            /* smooth scrolling sections */
            $dt('a[href*=#]:not([href=#])').click(function() {
                if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
                  var target = $dt(this.hash);
                  target = target.length ? target : $dt('[name=' + this.hash.slice(1) +']');
                  if (target.length) {
                    $dt('html,body').animate({
                      scrollTop: target.offset().top - 125
                    }, 1000);
                    return false;
                  }
                }
            });

            // Set Task as Proposal Task
            $dt("[name*='dealer__new_car_deal_task']").val('New Proposal Task');
            $dt("[name*='dealer__new_car_deal_task']").addClass('btn-info').addClass('btn-sm');
            $dt("[name*='dealer__log_followup_cardeal']").addClass('btn-info').addClass('btn-sm');
            $dt("[name*='dealer__send_email_to_buyercardeal']").addClass('btn-info').addClass('btn-sm');
            $dt("[name*='dealer__send_email_to_co_buyer']").addClass('btn-info').addClass('btn-sm');
            $dt("[name*='newNote']").addClass('btn-info').addClass('btn-sm');
            $dt("[name*='attachFile']").addClass('btn-info').addClass('btn-sm');

            //BLL54d $dt(":button").addClass('btn-info').addClass('btn-xs'); 
            $dt('input[id$="_title"]').css('color', '#000');


/**
 *==================================================================================
 * WATCH THIS - move/change so it doesn't change saved values on posted proposals!!!
 *==================================================================================
**/

// BLL36 2017-05-24 - Dont recalculate on posted proposals!
calcEscTotal(); // BLL41a
calcTrades();   // BLL41a
if ('{!dealer__Deal__c.dealer__Status__c}'!='Won - Posted') {
            // Load Related Values
            //BLL36d calcChassis(); - no longer does anything
            // calcRebatesPayments();
            calcFees();
            //calcEscTotal();
            //calcTrades();
            // calcPayment();
            calcTotalCart();
}
/**
 * End of WATCH area
**/

            // set Focus
            $dt("#p\\:frm\\:pB\\:pbCustomer\\:buyer_contact").focus();

            /////////////////////////////////////////////////////
            //  Proposal status and date fields remote actions
            /////////////////////////////////////////////////////

            // Deal Status
            //$dt('#p\\:headForm\\:status').on('change', function(){
            //    var dealStatuswithId = '{!dealer__Deal__c.Id}~'+$dt('#p\\:headForm\\:status').val();
            //    alertify.set('notifier','position', 'top-right');
            //    Deal_MBW2.saveDealStatus(dealStatuswithId, function(result, event) {
            //        if(event.status) {
            //            alertify.log("Successfully saved Proposal Status", "success");
            //        } else {
            //            alertify.log("Error: Unable to save Proposal Status", "error");
            //        }
            //    });
            //});

            // Deal Date
            $dt('#p\\:headForm\\:dealdate').on('change', function(){
                var saveddate = $dt('#p\\:frm\\:copy_dealdate').val(); // BLL2a
                var newdate = $dt('#p\\:headForm\\:dealdate').val();   // BLL2a
                $dt('#p\\:frm\\:copy_dealdate').val(newdate); // BLL2a
                var dealDateWithId = '{!dealer__Deal__c.Id}~'+$dt('#p\\:headForm\\:dealdate').val()+'~dd';
                Deal_MBW2.saveDealDate(dealDateWithId, function(result,event){
                    if(event.status) {
                        alertify.log("Successfully Saved Deal Date", "success");
                    } else {
                        alertify.log("Error: Unable to save deal date", "error");
                        $dt('#p\\:frm\\:copy_dealdate').val(saveddate); // BLL2a
                    }
                });
            });

            //Proposed Delivery Date
            $dt('#p\\:headForm\\:proposedDeliveryDate').on('change', function(){
                var saveddate = $dt('#p\\:frm\\:copy_proposedDeliveryDate').val(); // BLL2a
                var newdate = $dt('#p\\:headForm\\:proposedDeliveryDate').val();   // BLL2a
                $dt('#p\\:frm\\:copy_proposedDeliveryDate').val(newdate); // BLL2a
                if (console) console.log('saveddate='+saveddate+'; newdate='+newdate+'; copy='+$dt('#p\\:frm\\:copy_proposedDeliveryDate').val());
                var dealDateWithId = '{!dealer__Deal__c.Id}~'+$dt('#p\\:headForm\\:proposedDeliveryDate').val()+'~pd';
                Deal_MBW2.saveDealDate(dealDateWithId, function(result,event){
                    if(event.status) {
                        alertify.log("Successfully Saved Delivery Date", "success");
                    } else {
                        alertify.log("Error: Unable to save delivery date", "error");
                        $dt('#p\\:frm\\:copy_proposedDeliveryDate').val(saveddate); // BLL2a
                    }
                });
            });


            ////////////////////////////////////////////////////////////////////////////////////////////////////////
            // MultiQuote Actions
            ////////////////////////////////////////////////////////////////////////////////////////////////////////

            /**
            $dt('#MQterm1,#MQrate1').change(function(){
                $dt('#MQpymt_1_1').val(calcMQ(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown1').val()));
                $dt('#MQpymt_2_1').val(calcMQ(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown2').val()));
                $dt('#MQpymt_3_1').val(calcMQ(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown3').val()));
                mqObject();
            });

            $dt('#MQterm2,#MQrate2').change(function(){
                $dt('#MQpymt_1_2').val(calcMQ(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown1').val()));
                $dt('#MQpymt_2_2').val(calcMQ(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown2').val()));
                $dt('#MQpymt_3_2').val(calcMQ(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown3').val()));
                mqObject();
            });     

            $dt('#MQterm3,#MQrate3').change(function(){
                $dt('#MQpymt_1_3').val(calcMQ(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown1').val()));
                $dt('#MQpymt_2_3').val(calcMQ(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown2').val()));
                $dt('#MQpymt_3_3').val(calcMQ(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown3').val()));
                mqObject();
            });  

            $dt('#MQdown1').change(function() {
                $dt('#MQpymt_1_1').val(calcMQ(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown1').val()));
                $dt('#MQpymt_1_2').val(calcMQ(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown1').val()));
                $dt('#MQpymt_1_3').val(calcMQ(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown1').val()));
                mqObject();
            });  

            $dt('#MQdown2').change(function() {
                $dt('#MQpymt_2_1').val(calcMQ(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown2').val()));
                $dt('#MQpymt_2_2').val(calcMQ(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown2').val()));
                $dt('#MQpymt_2_3').val(calcMQ(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown2').val()));
                mqObject();
            });

            $dt('#MQdown3').change(function() {
                $dt('#MQpymt_3_1').val(calcMQ(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown3').val()));
                $dt('#MQpymt_3_2').val(calcMQ(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown3').val()));
                $dt('#MQpymt_3_3').val(calcMQ(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown3').val()));
                mqObject();
            });
            **/  

            $dt('#MQterm1,#MQrate1').change(function(){
                $dt('#MQpymt_1_1').val(calcPmtAmt(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown1').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_2_1').val(calcPmtAmt(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown2').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_3_1').val(calcPmtAmt(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown3').val(), $dt('#MQballoon').val()));
                mqObject();
            });

            $dt('#MQterm2,#MQrate2').change(function(){
                $dt('#MQpymt_1_2').val(calcPmtAmt(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown1').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_2_2').val(calcPmtAmt(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown2').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_3_2').val(calcPmtAmt(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown3').val(), $dt('#MQballoon').val()));
                mqObject();
            });     

            $dt('#MQterm3,#MQrate3').change(function(){
                $dt('#MQpymt_1_3').val(calcPmtAmt(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown1').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_2_3').val(calcPmtAmt(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown2').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_3_3').val(calcPmtAmt(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown3').val(), $dt('#MQballoon').val()));
                mqObject();
            });  

            $dt('#MQdown1').change(function() {
                $dt('#MQpymt_1_1').val(calcPmtAmt(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown1').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_1_2').val(calcPmtAmt(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown1').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_1_3').val(calcPmtAmt(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown1').val(), $dt('#MQballoon').val()));
                mqObject();
            });  

            $dt('#MQdown2').change(function() {
                $dt('#MQpymt_2_1').val(calcPmtAmt(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown2').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_2_2').val(calcPmtAmt(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown2').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_2_3').val(calcPmtAmt(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown2').val(), $dt('#MQballoon').val()));
                mqObject();
            });

            $dt('#MQdown3').change(function() {
                $dt('#MQpymt_3_1').val(calcPmtAmt(0, $dt('#MQterm1').val(), $dt('#MQrate1').val(), $dt('#MQdown3').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_3_2').val(calcPmtAmt(0, $dt('#MQterm2').val(), $dt('#MQrate2').val(), $dt('#MQdown3').val(), $dt('#MQballoon').val()));
                $dt('#MQpymt_3_3').val(calcPmtAmt(0, $dt('#MQterm3').val(), $dt('#MQrate3').val(), $dt('#MQdown3').val(), $dt('#MQballoon').val()));
                mqObject();
            });
            
            $dt('#MQballoon').change(function() {
                $dt('#MQrate1,#MQrate2,#MQrate3').change();
            });


            // Alert if the vehicle is not Ready for Sale or there is WIP
            /** BLL36d - ALERTIFY_MESSAGES put these in as regular warning messages
            if($dt('#p\\:headForm\\:vehicleStatusCode').html()!='Ready For Sale' && $dt('#p\\:headForm\\:vehicleStatusCode').html()!='') {
                alertify.log("Vehicle not Ready For Sale", "error");
            }

            if('{!dealer__Deal__c.Open_Service_Repair_Orders__c}'!='' && '{!dealer__Deal__c.Open_Service_Repair_Orders__c}' != '0') {// RT1, modified by BLL 12/21/2015
                alertify.log("Open Work in Process - Chassis Cost might be understated", "error");
            }
            **/

            // Set Aftermarket to Zero by Default
            if($dt('#tot_equipment').html()=='') {
                $dt('#tot_equipment').html('$0.00');
            }

            // Header Save button
            $dt('#header_save').click(function(){
                $dt(el('p:frm:pB:cmdButton:saveButton')).trigger('click');
                
                //$dt('#p\\:frm').submit();
            });

            // Sortable Page Block Table of Parts
            
            $dt(el('p:frm:pB:additional_equipment:amSelectedEquipment')).find("tbody").sortable({
              update: function( event, ui ) {
                    // Read the order of the table and ID Keys
                    i=1;
                    var pOrder = [];
                    $dt('[name="hAM_ID"]').each(function(){
                        console.log($dt(this).val());
                        pOrder.push({ "RecordId":$dt(this).val(), "PageOrder":i });
                        $dt('#equipmentorder-'+$dt(this).val()).val(i);
                        i++;
                    });

                    // Call Remote
                    var pJson = { "items" : pOrder };
                    Deal_MBW2.setAfterMarketOrder(JSON.stringify(pJson), function(result, event) {
                        if(!event.status) {
                            alertify.log("Error: Unable to update the order of equipment", "error");
                        }
                    });
              }
            });   

            $dt('.dCalc').change(function() {
                cDeal();
            });

            $dt('.dCalc').keypress(function(e){
                if ( e.which == 13 ) e.preventDefault();
            });


/**
 *==================================================================================
 * WATCH THIS - move/change so it doesn't change saved values on posted proposals!!!
 *==================================================================================
**/
// BLL36 2017-05-24 - Dont recalculate on posted proposals! - can this move up with other section???
//if ('{!dealer__Deal__c.dealer__Status__c}'!='Won - Posted') {
            cDeal();  
//}
/**
 * End of WATCH area
**/

            // Show / Hide rebate fields
            /** BLL36d remove, as its not being used 
            $dt('#rebateRow3Add').css('display', 'none');
            $dt('#rebateRow3').css('display', 'none');
            $dt('#rebateRow4Add').css('display', 'none');
            $dt('#rebateRow4').css('display', 'none');

            $dt('#rebateRow2Add').on('click', function(){
                $dt('#rebateRow2').css('display', '');
                $dt('#rebateRow2Add').css('display', 'none');
                $dt('#rebateRow3Add').css('display', '');
            });

            $dt('#rebateRow3Add').on('click', function(){
                $dt('#rebateRow3').css('display', '');
                $dt('#rebateRow3Add').css('display', 'none');
            }); 
            BLL36d end **/

            // Show / Hide commission rows
            $dt('#commRow2Add').on('click', function(){
                $dt('#commRow2').css('display', '');
                $dt('#commRow2Add').css('display', 'none');
                $dt('#commRow3Add').css('display', '');
                //$dt(el('p:frm:pB:commissionemployee2')).focus();
                $dt('input[id$="commissionemployee2"]').focus();
            });                     

            $dt('#commRow3Add').on('click', function(){
                $dt('#commRow3').css('display', '');
                $dt('#commRow3Add').css('display', 'none');
                $dt('#commRow4Add').css('display', '');
            });

            $dt('#commRow4Add').on('click', function(){
                $dt('#commRow4Add').css('display', 'none');
                $dt('#commRow4').css('display', '');
            });

            // Check to see if there are split commissions, if so show the split rows
            //if($dt(el('p:frm:pB:commissionemployee2')).val()!='') {
            if ($dt('input[id$="commissionemployee2"]').val()!='') {
                $dt('#commRow2').css('display', '');
                $dt('#commRow2Add').css('display', 'none');
                $dt('#commRow3Add').css('display', '');
            }
            // BLL7a also check on commission 3 & 4
            //if($dt(el('p:frm:pB:commissionemployee3')).val()!='') {
            if ($dt('input[id$="commissionemployee3"]').val()!='') {
                $dt('#commRow3').css('display', '');
                $dt('#commRow3Add').css('display', 'none');
                $dt('#commRow4Add').css('display', '');
            }
            //if($dt(el('p:frm:pB:commissionemployee4')).val()!='') {
            if ($dt('input[id$="commissionemployee4"]').val()!='') {
                $dt('#commRow4').css('display', '');
                $dt('#commRow4Add').css('display', 'none');
            }
            // BLL7a end

            // Check to see if values are populated
            /** BLL36d always show
            if($dt(el('p:frm:pB:rebate2')).val()!='' && $dt(el('p:frm:pB:rebate2')).val()!='0') {
                $dt('#rebateRow2').css('display', '');
                $dt('#rebateRow2Add').css('display', 'none');                
            }

            if($dt(el('p:frm:pB:rebate3')).val()!='' && $dt(el('p:frm:pB:rebate3')).val()!='0') {
                $dt('#rebateRow3').css('display', '');
                $dt('#rebateRow3Add').css('display', 'none');
            }
            BLL36d end **/

            // Equipment Only Modal Binds
            $dt('#addServiceVehicle').on('shown.bs.modal', function () {
              $dt('#sv_VIN').focus()
            });  

            //console.log($dt('#saveVehicle'));
            //setSaveVehicleAction(); BLL36c Now done on "Add New Customer Owned Vehicle" button click

            // BLL36 note: this is just the calculator section and doesn't matter to anything
            // delay this till the end for proper calculations DR - 7-16-2015
            calcPayment();

            // BLL24a
            if (pdd<may_1_2016) {
                $dt('table#commissiontable').css('display','block');
            }
            // BLL24a end 
                

            // auto-resize text areas BLL1a
            $dt.each(jQuery('textarea[data-autoresize=auto]'), function() {  
                var offset = this.offsetHeight - this.clientHeight;
                var resizeTextarea = function(el) {
                    jQuery(el).css('height', 'auto').css('height', el.scrollHeight + offset);
                };
                $dt(this).on('keyup input', function() { resizeTextarea(this) }).removeAttr('data-autoresize').css({'overflow':'hidden'});  
                resizeTextarea(this); // initial resize!
            });
            // BLL1a end

            // BLL8a
            if ({!autoSaveDeal}) {  // BLL36c was autoSaveTrade
               console.log('Autosave proposal (trade summary or vehicle changed)');
               //saveNotice();
               saveForm();  // BLL36c
               //saveProposal();
               //saveField('dealer__Trade_Allowance__c', '{!dealer__Deal__c.dealer__Trade_Allowance__c}', 'tradeallowance');
               //saveField('dealer__Trade_Payoff__c', '{!dealer__Deal__c.dealer__Trade_Payoff__c}', 'tradeallowance');
               //saveField('Trade_ACV__c', '{!dealer__Deal__c.Trade_ACV__c}', 'tradeallowance');
            }
            // BLL8a end

            $dt('form[id$="frm"]').on('submit', 
                function() {
                    saveNotice();
                }
            );

        }); // End On Ready


    function saveCustomerVehicle() {
                //console.log('saveVehicle button clicked');
                // Create a Service Vehicle from the modal dialog and clear the inputs
                var v = new Object();
                    v.VIN = $dt('#sv_VIN').val();
                    v.Year= $dt('#sv_Year').val();
                    v.Make= $dt('#sv_Make').val();
                    v.Model=$dt('#sv_Model').val();
                    v.Odometer  = $dt('#sv_Odometer').val();
                    v.OwnerId   = $dt(el('p:frm:pB:pbCustomer:buyer_contact_lkid')).val();
                    v.OwnerName = $dt(el('p:frm:pB:pbCustomer:buyer_contact')).val();
                    v.ExteriorColor = $dt('#sv_ExteriorColor').val();	// BLL47a

                // Database Callout 
                Deal_MBW2.addServiceVehicle(JSON.stringify(v), function(result, event){
                    // Conditional Event Checking
                    if(event.status && result != null) {
                        

                        // Set the respective Fields wit their values
                        //$dt(el('p:frm:pB:sec_chassis_conversion:serviceVehicle')).val(result.Name); //RT3
                        //$dt(el('p:frm:pB:sec_chassis_conversion:serviceVehicle_lkid')).val(result.Id);
                        $dt('input[id$="serviceVehicle"]').val(result.Name); //RT3
                        $dt('input[id$="serviceVehicle_lkid"]').val(result.Id);
                        $dt('#addServiceVehicle').modal('hide');
                    } else {
                        // DR2
                        if(typeof event.message != 'undefined') {
                            $dt('#addServiceVehicle .modal-body').append('<p class="alert alert-danger">'+event.message+'</p>');
                        } else {
                            $dt('#addServiceVehicle .modal-body').append('<p class="alert alert-danger">An Anknown error occurred. Please try again later.</p>');    
                        }
                        // /DR2
                    }
                });
    }

    //function setSaveVehicleAction() {
    //       $dt('#saveVehicle').on('click', saveCustomerVehicle);
    //}

        function saveField(fieldName, fieldValue, element) {
            if(dealId != '') {
                Deal_MBW2.saveField(dealId+'~'+fieldName+'~'+fieldValue, function(result, event){
                    if(event.status) {
                        $dt(el(element)).notify('Saved', { position : 'left', className : 'success'});
                    } else {
                        $dt(el(element)).notify('Error Saving', 'error', { position : 'left', className : 'error'});
                    }
                });
            }
        }

        function mqObject() {
            multiQuoteObject = new Object();
            multiQuoteObject.Term1 = $dt('#MQterm1').val();
            multiQuoteObject.Term2 = $dt('#MQterm2').val();
            multiQuoteObject.Term3 = $dt('#MQterm3').val();
            multiQuoteObject.Rate1 = $dt('#MQrate1').val();
            multiQuoteObject.Rate2 = $dt('#MQrate2').val();
            multiQuoteObject.Rate3 = $dt('#MQrate3').val();
            multiQuoteObject.Down1 = $dt('#MQdown1').val();
            multiQuoteObject.Down2 = $dt('#MQdown2').val();
            multiQuoteObject.Down3 = $dt('#MQdown3').val();

            multiQuoteObject.Row1_1 = $dt('#MQpymt_1_1').val();
            multiQuoteObject.Row1_2 = $dt('#MQpymt_1_2').val();
            multiQuoteObject.Row1_3 = $dt('#MQpymt_1_3').val();

            multiQuoteObject.Row2_1 = $dt('#MQpymt_2_1').val();
            multiQuoteObject.Row2_2 = $dt('#MQpymt_2_2').val();
            multiQuoteObject.Row2_3 = $dt('#MQpymt_2_3').val();

            multiQuoteObject.Row3_1 = $dt('#MQpymt_3_1').val();
            multiQuoteObject.Row3_2 = $dt('#MQpymt_3_2').val();
            multiQuoteObject.Row3_3 = $dt('#MQpymt_3_3').val();
            
            multiQuoteObject.Balloon = $dt('#MQballoon').val(); // BLL36a

            var jsonstr = JSON.stringify(multiQuoteObject);
            console.log(jsonstr);
            //$dt(el('Desking:frm:multi-quote-payments')).val(jsonstr);
            //console.log($dt(el('Desking:frm:multi-quote-payments')));
            // Remote this data to the controller
            saveField('MultiQuote_Payment_Grid__c', JSON.stringify(multiQuoteObject), 'noId');
        }   

        function calcMQ(Form_price, Form_term, Form_rate, Form_down) {

            if (console) {
                console.log($dt('#tot_chassis').html());
                console.log($dt('#tot_fees').html());
                console.log($dt('#tot_equipment').html());
                console.log($dt('#tot_esc').html());
            }
            if(Form_price == 0) {
                Price              =    doubleVal($dt('#tot_chassis').html())
                                        +   doubleVal($dt('#tot_fees').html())      
                                        +   doubleVal($dt('#tot_equipment').html())
                                        +   doubleVal($dt('#tot_esc').html());
            } else {
                Price              =    doubleVal(Form_price);
            }

            DownPayment            =    doubleVal(Form_down)
                                        +   doubleVal($dt('#tot_trade').html())
                                        +   doubleVal($dt('#tot_rebates').html()) 
                                        +   doubleVal($dt('#tot_payments').html());

            var discount        =   doubleVal($dt('input[id$="conversionDiscount"]').val());
            var rewards         =   doubleVal($dt('input[id$="mbwRewards"]').val());

            AnnualInterestRate     =    Form_rate / 100;
            MonthlyInterestRate    =    AnnualInterestRate / 12;
            Term                   =    Form_term;
            Warranty               =    0;
            Principal              =    (Price - DownPayment - discount - rewards) + Warranty;
                                        //if(tradenet>0) { Principal+=(tradenet * -1); }

            console.log('Price:'+Price+' - Down:'+DownPayment);                
            console.log("AMT Financed: "+ (Price-DownPayment - discount - rewards));

            Days                   =    doubleVal($dt('input[id$="d_days"]').val());
            
            var P = parseFloat(Principal);
            var r = parseFloat(MonthlyInterestRate);
            var N = parseFloat(Term);
            var A = P*(r*Math.pow(1+r,N))/(Math.pow(1+r,N)-1);
            
            var D = parseFloat(Days);
            var i = AnnualInterestRate / 12;

            // console.log('Price '+Price);
            // console.log('Down '+DownPayment);
            // console.log('Warranty '+Warranty);
            // console.log('Principal '+P);
            // console.log('Rate '+r);
            // console.log('Term '+N);
            // console.log('APR '+A);
            // console.log('Days '+D);
            // console.log('I '+i);
            
            var an = 0;
            var add= 0;

            if(D > 30) {
                an = (1 - 1 / Math.pow((1 + i), N)) / i;
                an = an.toFixed(9);
                add = an * (1 + i);
                add = add.toFixed(9);
                A = P * (1 + D / 30 * i) / add;
            }

            /*
            console.log(Price);
            console.log(DownPayment);
            console.log(P);
            console.log(A);
            console.log(D);
            console.log(i);
            console.log(payment);
            */

            payment = A.toFixed(2); 

            return doubleVal(payment);           
        }     

        // BLL36a
        function calcPmtAmt(price, term, rate, downpmt, balloon) {
            if (console) {
                console.log($dt('#tot_chassis').html());
                console.log($dt('#tot_fees').html());
                console.log($dt('#tot_equipment').html());
                console.log($dt('#tot_esc').html());
            }
            console.log('Balloon='+balloon);
            if(price == 0) {
                price = doubleVal($dt('#tot_chassis').html())
                      + doubleVal($dt('#tot_fees').html())      
                      + doubleVal($dt('#tot_equipment').html())
                      + doubleVal($dt('#tot_esc').html());
            }
            var DownPayment = doubleVal(downpmt)
                        + doubleVal($dt('#tot_trade').html())
                        + doubleVal($dt('#tot_rebates').html()) 
                        + doubleVal($dt('#tot_payments').html());
            var Discount = doubleVal($dt('input[id$="conversionDiscount"]').val());
            var Rewards  = doubleVal($dt('input[id$="mbwRewards"]').val());

            var AnnualInterestRate  = rate / 100;
            var MonthlyInterestRate = AnnualInterestRate / 12;
            var Term                = term;
            var Warranty            = 0;
            var Principal           = (price - DownPayment - Discount - Rewards) + Warranty;

            console.log('Price:'+price+' - Down:'+DownPayment);                
            console.log("AMT Financed: "+ (price-DownPayment - Discount - Rewards));

            Days                   =    doubleVal($dt('input[id$="d_days"]').val());
            
            var PV = parseFloat(Principal);
            var r = parseFloat(MonthlyInterestRate);
            var n = parseFloat(Term);
            //var A = P*(r*Math.pow(1+r,N))/(Math.pow(1+r,N)-1);
            var A = (PV - (balloon/Math.pow(1+r,n))) * (r/(1-Math.pow(1+r,-n)));
            
            // Extra month of interest if first pmt over 30 days from now            
            var D = parseFloat(Days);
            var an = 0;
            var add= 0;
            if(D > 30) {
                an = (1 - 1 / Math.pow((1 + r), n)) / r;
                an = an.toFixed(9);
                add = an * (1 + r);
                add = add.toFixed(9);
                //A = PV * (1 + D / 30 * r) / add;
                A = (PV - (balloon/Math.pow(1+r,n))) * (1 + D / 30 * r) / add;
                
            }
            // end of extra month of interest adjustment
            
            payment = A.toFixed(2); 
            return doubleVal(payment);           
        }
        // BLL36a end

        function calcPayment() {

            var totalDown   = doubleVal($dt('#tot_down').html());
            var pymt = calcPmtAmt( 0 , doubleVal($dt('input[id$="d_term"]').val()), doubleVal($dt('input[id$="d_rate"]').val()), totalDown, 
                doubleVal($dt('input[id$="d_balloon"]').val()) );   // BLL36c add balloon pmt amt

            $dt('input[id$="d_pymt"]').val(pymt);
        }   

        //BLL36d function calcChassis() {
            /* (was removed prior to BLL36)
            var chassis_cost    =   doubleVal($dt("[id$='chassis_cost']").val());
            var chassis_price   =   doubleVal($dt("[id$='chassis_sale']").val());   
            var conversion_price=   doubleVal($dt("[id$='conversion_price']").val());
            var conversion_cost =   doubleVal($dt(el('p:frm:pB:vehiclePricing:conversion_cost')).val());
            var conversion_discount=doubleVal($dt(el('p:frm:pB:vehiclePricing:conversionDiscount')).val());

            $dt('#tot_chassis').html('$'+doubleVal((chassis_price + conversion_price)-conversion_discount));
            calcTotalCart();
            */
        // BLL36d }

        function resetEquipmentValues() {
            var amCost = 0;
            var amSale = 0;
            if(dealId!='') {
                Deal_MBW2.aftermarketItems(dealId, function(result, event){
                    if(event.status) {
                        $dt.each(result, function(index, value) {
                            //BLL36d amCost+=value.dealer__Cost__c;
                            //BLL36d amSale+=value.dealer__Sale_Price__c;
                            amCost += value.ExtendedCost__c;    // BLL36a
                            amSale += value.ExtendedPrice__c;   // BLL36a
                        }); 

                        // Set Values
                        //BLL36d $dt(el('p:frm:pB:equipmentSale')).val(amCost.toFixed(2));
                        //BLL36d $dt(el('p:frm:pB:totalAdditionalEquipment')).val(amSale.toFixed(2));
                        setInputValue('input[id$="equipmentSale"]', amCost.toFixed(2)); // BLL36a
                        setInputValue('input[id$="totalAdditionalEquipment"]', amSale.toFixed(2));  // BLL36a
                        $dt('#tot_equipment').html(amSale.formatMoney(2));  // BLL36a

                        calcGross();
                        cDeal();
                    }
                });
            }
            updateScreenEquipment();    // BLL36a
        }

        function clearFinancialProducts() {
            var scCost = 0;
            var scSale = 0;
            if(dealId!='') {
                Deal_MBW2.serviceContractItems(dealId, function(result, event) {
                    if(event.status) {
                        $dt.each(result, function(index, value) {
                            scCost += value.dealer__Cost__c;
                            scSale += value.dealer__Sale_Price__c;
                        });

                        // set the field values as appropriate
                        //BLL36d $dt(el('p:frm:pB:warrantyCost')).val(scCost.toFixed(2));
                        //BLL36d $dt(el('p:frm:pB:totalProtectionProducts')).val(scSale.toFixed(2));
                        setInputValue('input[id$="warrantyCost"]', scCost.toFixed(2));  // BLL36a
                        setInputValue('input[id$="totalProtectionProducts"]', scSale.toFixed(2));   // BLL36a

                        // 
                    }
                });
            }
        }

        function calcGross() {

            var chassis_cost    =   doubleVal($dt("[id$='chassis_cost']").val());
            var chassis_price   =   doubleVal($dt("[id$='chassis_price']").val());   
            var conversion_price=   doubleVal($dt("[id$='conversion_price']").val());
            //var conversion_cost =   doubleVal($dt(el('p:frm:pB:vehiclePricing:conversion_cost')).val());
            //var conversion_discount=doubleVal($dt(el('p:frm:pB:vehiclePricing:conversionDiscount')).val());
            var conversion_cost =   doubleVal($dt('input[id$="conversion_cost"]').val());
            var conversion_discount=doubleVal($dt('input[id$="conversionDiscount"]').val());
			var othercosts = doubleVal($dt('input[id$="loancost"]').val());	// BLL44a 
			// not included in GP calcs: othercosts += doubleVal($dt('input[id$="loancostesc"]').val());	// BLL64 
            var totalGross     = 0;
            var chassis_gross  = doubleVal(chassis_price-chassis_cost);
            var conversion_gross=doubleVal((conversion_price-conversion_cost)-conversion_discount);
            var releasingdealer = $dt("input[id$='releasingdealer']").val();
            if (releasingdealer!=null && typeof releasingdealer!='undefined') chassis_gross=0;  // BLL36a

            //BLL36d $dt(el('p:frm:pB:sec_commissions_block:chassisGross')).val(chassis_gross.toFixed(2));            
            //BLL36d $dt(el('p:frm:pB:sec_commissions_block:conversionGross')).val(conversion_gross.toFixed(2));
            setInputValue('input[id$="chassisGross"]', chassis_gross.toFixed(2));   // BLL36a            
            setInputValue('input[id$="conversionGross"]', conversion_gross.toFixed(2)); // BLL36a

            Deal_MBW2.dealGrossSVC('{!dealer__Deal__c.Id}', function(result, event) {
                if(event.status) {
                    //BLL36d $dt(el('p:frm:pB:sec_commissions_block:serviceContractGross')).val(doubleVal(result));
                    setInputValue('input[id$="serviceContractGross"]', doubleVal(result));  // BLL36a
                }
            });  

            Deal_MBW2.dealGrossEquipment('{!dealer__Deal__c.Id}', function(result,event){
                if(event.status) {
                    //BLL36d $dt(el('p:frm:pB:sec_commissions_block:equipmentGross')).val(doubleVal(result));
                    setInputValue('input[id$="equipmentGross"]', doubleVal(result));    // BLL36a
                }                    
            }); 

            setTimeout(function(){
                var svcContractGross = doubleVal($dt('input[id$="serviceContractGross"]').val());
                var equipGross = doubleVal($dt('input[id$="equipmentGross"]').val());
            totalGross+= svcContractGross;  //doubleVal($dt(el('p:frm:pB:sec_commissions_block:serviceContractGross')).val());    
            totalGross+= equipGross;    //doubleVal($dt(el('p:frm:pB:sec_commissions_block:equipmentGross')).val());
            totalGross+=doubleVal(chassis_gross);
            totalGross+=doubleVal(conversion_gross);
            totalGross-=othercosts;	// BLL44a
            //BLL36d $dt(el('p:frm:pB:sec_commissions_block:totalGross')).val(totalGross.toFixed(2));
            //BLL36d $dt(el('p:frm:pB:sec_commissions_block:gapGross')).val(0);
            setInputValue('input[id$="totalGross"]', totalGross.toFixed(2));    // BLL36a
            //BLL36 unused field setInputValue('input[id$="gapGross"]', 0); // BLL36a

            // Calc Gross
            /*
                Two Commissions Formulas
                    1) Equipment Only (Customer Owned)
                        Commission$ = (GP <=33 ) * .15 else .20 
                            
                    2) Vehicle Sale
                        Commission$ = (GP <4000) * .15
                                      (GP >=4000 && GP <=5999) * .2
                                      (GP >=6000) * .25 

                    ** Flat override, Change %, no comm at all 
            */
            var com = 0;
            var comrate = .15;
            if(totalGross<4000) { com = totalGross*.15; comrate=.15; } 
            if(totalGross>=4000) { com = totalGross*.2; comrate=.2; } 
            if(totalGross>=6000) { com = totalGross*.25; comrate=.25; }  

            // Check the Record Type to see if we are performing an Equipment Only Override
            //if(recordTypeName == 'Equipment_Only_Sale') {
            //if (recordTypeName.startsWith('Equipment')) { IE doesn't have .startsWith
            var dealType = '{!dealer__Deal__c.dealer__Deal_Type__c}';
            if (dealType.substring(0,9)=='Equipment') {
                //var eq_cost = doubleVal($dt(el('p:frm:pB:equipmentSale')).val());
                //var eq_sale = doubleVal($dt(el('p:frm:pB:totalAdditionalEquipment')).val());
                var eq_cost = doubleVal($dt('input[id$="equipmentSale"]').val());
                var eq_sale = doubleVal($dt('input[id$="totalAdditionalEquipment"]').val());
                var pMarkup = (eq_sale - eq_cost) / eq_sale;
                console.log(eq_cost);
                console.log(eq_sale);
                console.log(pMarkup);
                if(pMarkup>.3333) {
                    comrate = .2;
                    com = totalGross*.2;
                    console.log('>33');
                } else {
                    console.log('<=33');
                    comrate=.15;
                    com = totalGross*.15;
                }
            }

            //BLL36d $dt(el('p:frm:pB:sec_commissions_block:commission')).val(com.toFixed(2));  
            //BLL36d $dt(el('p:frm:pB:sec_commissions_block:commissionRate')).val(comrate); 
            setInputValue('input[id$="commission"]', com.toFixed(2));  // BLL36a
            setInputValue('input[id$="commissionRate"]', comrate);  // BLL36a
             
            },2000);      
        }

        function calcEscTotal() {
            $dt('input[id$="warranty_premium"]').val(doubleVal('{!serviceContractTotal}'));
            var totESC = doubleVal('{!serviceContractTotal}');
            $dt('#tot_esc').html('$'+totESC.formatMoney(2));
        }

        function escRemoveStart() {
            // Display modal showing the removal of a Service Contract
            $dt('#removeESCModal').modal('show');
        }

        function escRemoveEnd() {
            // Display a modal showing the finalization of the removal of a service contract.
            $dt('#removeESCModal').modal('hide');
        }

        function calcFees(){
            var gvw         =   doubleVal($dt("[id$='gvwr']").val());
            var tire        =   doubleVal($dt("[id$='tireFee']").val());
            var smog        =   doubleVal($dt("[id$='smogFee']").val());
            var efile       =   doubleVal($dt("[id$='electronicFilingFee']").val());
            var doc         =   doubleVal($dt("[id$='docfee']").val());
            var lic         =   doubleVal($dt("[id$='licFee']").val());
            var reg         =   doubleVal($dt("[id$='reg']").val());
            var smogcert    =   doubleVal($dt("[id$='smogCert']").val());
            var salesTax    =   doubleVal($dt("[id$='salesTax']").val());
        }

        function calcTotalCart() {
            /*
            var vehicle = doubleVal($dt('#tot_chassis').html());
            var payments = doubleVal($dt('#tot_payments').html());
            var fees = doubleVal($dt('#tot_fees').html());
            var esc = doubleVal('{!serviceContractTotal}');

            calcGross();
            */
        }

        function calcTrades() {
            console.log('calcTrades');
            var tradeTotal = doubleVal('{!tradeValue}');
            //BLL36d $dt('[id$="tradeAllowance"]').val(tradeTotal);
            setInputValue('input[id$="tradeAllowance"]', tradeTotal);   // BLL36a
            $dt('#tot_trade').html('($'+tradeTotal.formatMoney(2)+')');
        }

        function mqv(ename, no) {

            Deal_MBW2.selectStockNumber($dt(el('p:frm:pB:'+ename+'_lkid')).val(), function(result, event) {
                if(event.status) {
                    /*
                    
                    $dt(el('mvq_color_'+no)).val(result[0].dealer__Exterior_Color__c);
                    $dt(el('mvq_engine_'+no)).val(result[0].dealer__Engine_Description__c);
                    $dt(el('mvq_transmission_'+no)).val(result[0].dealer__Transmission_Type__c);
                    $dt(el('mvq_msrp_'+no)).val(result[0].dealer__MSRP__c);
                    */
                    $dt(el('mvq_trim_'+no)).val(result[0].dealer__Trim_Level__c);
                    $dt(el('mvq_saleprice_'+no)).val(result[0].dealer__Retail_Price__c);
                    // $dt(el('mvq_discount_'+no)).val($dt(el('mvq_msrp_'+no)).val() - $dt(el('mvq_saleprice_'+no)).val());
                    $dt(el('mvq_conversionprice_'+no)).val(doubleVal(result[0].Conversion_Cost__c)+8400);
                }
            });
        }

        function mvqCalcOptions(ono) {
            var term = doubleVal($dt(el('mvq_term_'+ono)).val());
            var rate = doubleVal($dt(el('mvq_rate_'+ono)).val());
            var down = doubleVal($dt(el('mvq_down_'+ono)).val());
            var price = doubleVal($dt(el('mvq_saleprice_'+ono)).val());
            var conv  = doubleVal($dt(el('mvq_conversionprice_'+ono)).val());
            var discount = doubleVal($dt(el('mvw_discount_'+ono)).val());

            var totalCost = (price + conv) - discount; 

            var pymt = 0;
            
            if(ono==1) {
            pymt_1_1 = calcMQ(totalCost, doubleVal($dt(el('mvq_term_1')).val()), doubleVal($dt(el('mvq_rate_1')).val()), doubleVal($dt(el('mvq_down_1')).val()));
            pymt_2_1 = calcMQ(totalCost, doubleVal($dt(el('mvq_term_2')).val()), doubleVal($dt(el('mvq_rate_2')).val()), doubleVal($dt(el('mvq_down_2')).val()));
            pymt_3_1 = calcMQ(totalCost, doubleVal($dt(el('mvq_term_3')).val()), doubleVal($dt(el('mvq_rate_3')).val()), doubleVal($dt(el('mvq_down_3')).val()));

            $dt(el('mvq_pymt_1_'+ono)).val(pymt_1_1);
            $dt(el('mvq_pymt_2_'+ono)).val(pymt_2_1);
            $dt(el('mvq_pymt_3_'+ono)).val(pymt_3_1);
            }

            if(ono==2) {
            pymt_1_2 = calcMQ(totalCost, doubleVal($dt(el('mvq_term_1')).val()), doubleVal($dt(el('mvq_rate_1')).val()), doubleVal($dt(el('mvq_down_1')).val()));
            pymt_2_2 = calcMQ(totalCost, doubleVal($dt(el('mvq_term_2')).val()), doubleVal($dt(el('mvq_rate_2')).val()), doubleVal($dt(el('mvq_down_2')).val()));
            pymt_3_2 = calcMQ(totalCost, doubleVal($dt(el('mvq_term_3')).val()), doubleVal($dt(el('mvq_rate_3')).val()), doubleVal($dt(el('mvq_down_3')).val()));

            $dt(el('mvq_pymt_1_'+ono)).val(pymt_1_2);
            $dt(el('mvq_pymt_2_'+ono)).val(pymt_2_2);
            $dt(el('mvq_pymt_3_'+ono)).val(pymt_3_2);
            }

            if(ono==3) {
            pymt_1_3 = calcMQ(totalCost, doubleVal($dt(el('mvq_term_1')).val()), doubleVal($dt(el('mvq_rate_1')).val()), doubleVal($dt(el('mvq_down_1')).val()));
            pymt_2_3 = calcMQ(totalCost, doubleVal($dt(el('mvq_term_2')).val()), doubleVal($dt(el('mvq_rate_2')).val()), doubleVal($dt(el('mvq_down_2')).val()));
            pymt_3_3 = calcMQ(totalCost, doubleVal($dt(el('mvq_term_3')).val()), doubleVal($dt(el('mvq_rate_3')).val()), doubleVal($dt(el('mvq_down_3')).val()));

            $dt(el('mvq_pymt_1_'+ono)).val(pymt_1_3);
            $dt(el('mvq_pymt_2_'+ono)).val(pymt_2_3);
            $dt(el('mvq_pymt_3_'+ono)).val(pymt_3_3);   
            }                     
        }

        function loadCoBuyerRecord(){
            var cbId = $dt(el('p:frm:pB:coBuyerBlock:co_buyer_lkid')).val();
            var cbcId = $dt(el('p:frm:pB:coBuyerBlock:co_buyer_cont_lkid')).val();
            if(cbId!=''&&cbId!='000000000000000') {
                // Associate Co-Buyer data to Form
                Deal_MBW2.lookupCustomerRecord(cbId, cbcId, function(result, event){
                    if(event.status) {
                        console.log(result);
                        //BLL36d $dt(el('p:frm:pB:coBuyerBlock:co_buyer_address')).val(result.PersonMailingStreet);
                        //BLL36d $dt(el('p:frm:pB:coBuyerBlock:co_buyer_city')).val(result.PersonMailingCity);
                        //BLL36d $dt(el('p:frm:pB:coBuyerBlock:co_buyer_state')).val(result.PersonMailingState);
                        //BLL36d $dt(el('p:frm:pB:coBuyerBlock:co_buyer_zip')).val(result.PersonMailingPostalCode);

                        //BLL36d $dt(el('p:frm:pB:coBuyerBlock:co_buyer_homephone')).val(result.PersonHomePhone);
                        //BLL36d $dt(el('p:frm:pB:coBuyerBlock:co_buyer_mobilephone')).val(result.PersonMobilePhone);
                        //BLL36d $dt(el('p:frm:pB:coBuyerBlock:co_buyer_email')).val(result.PersonEmail);

                        $dt('[id$="co_buyer_address"]').val(result.PersonMailingStreet); // BLL36a
                        $dt('[id$="co_buyer_city"]').val(result.PersonMailingCity);  // BLL36a
                        $dt('[id$="co_buyer_state"]').val(result.PersonMailingState);    // BLL36a
                        $dt('[id$="co_buyer_zip"]').val(result.PersonMailingPostalCode); // BLL36a
                        $dt('[id$="co_buyer_homephone"]').val(result.PersonHomePhone);   // BLL36a
                        $dt('[id$="co_buyer_mobilephone"]').val(result.PersonMobilePhone);   // BLL36a
                        $dt('[id$="co_buyer_email"]').val(result.PersonEmail);   // BLL36a
                    }
                });
            }
        }

        function setBuyerDetails() {
            var cbId = $dt(el('p:frm:pB:pbCustomer:buyer_contact_lkid')).val();
            if(cbId!=''&&cbId!='000000000000000') {
                // Associate Co-Buyer data to Form
                Deal_MBW2.lookupCustomerRecord(cbId, '', function(result, event){
                    if(event.status) {
                        //BLL36d $dt(el('p:frm:pB:pbCustomer:buyer_address')).val(result.PersonMailingStreet);
                        //BLL36d $dt(el('p:frm:pB:pbCustomer:buyer_city')).val(result.PersonMailingCity);
                        //BLL36d $dt(el('p:frm:pB:pbCustomer:buyer_state')).val(result.PersonMailingState);
                        //BLL36d $dt(el('p:frm:pB:pbCustomer:buyer_postalcode')).val(result.PersonMailingPostalCode);

                        //BLL36d $dt(el('p:frm:pB:pbCustomer:buyer_homephone')).val(result.PersonHomePhone);
                        //BLL36d $dt(el('p:frm:pB:pbCustomer:buyer_mobilephone')).val(result.PersonMobilePhone);
                        //BLL36d $dt(el('p:frm:pB:pbCustomer:buyer_email')).val(result.PersonEmail);

                        setInputValue('input[id$="buyer_address"]', result.PersonMailingStreet);    // BLL36a
                        setInputValue('input[id$="buyer_city"]', result.PersonMailingCity); // BLL36a
                        setInputValue('input[id$="buyer_state"]', result.PersonMailingState);   // BLL36a
                        setInputValue('input[id$="buyer_postalcode"]', result.PersonMailingPostalCode); // BLL36a
                        setInputValue('input[id$="buyer_homephone"]', result.PersonHomePhone);  // BLL36a
                        setInputValue('input[id$="buyer_mobilephone"]', result.PersonMobilePhone);  // BLL36a
                        setInputValue('input[id$="buyer_email"]', result.PersonEmail);  // BLL36a

                    }
                });
            }
        }


        function doubleVal(v) {

            if(v== undefined) {
                return 0;
            }
            if(typeof v=='number') {
                return v;
            }           
            if(v=='') {
                return 0;
            }
            if(v === parseInt(v)) {
                return v;
            }
            return Number(v.replace(/[^0-9-.]/g, ''));
        }   

        function seStart() {
            $dt('#p\\:frm\\:pB\\:kitSearch').css('opacity', '0.33'); 
            $dt('#searchPartsKits').modal('show');           
        }

        function seEnd() {
            $dt('#p\\:frm\\:pB\\:kitSearch').css('opacity', '1');            
            $dt('#searchPartsKits').modal('hide');
            cDeal();
        }
        
        /* BLL7a */
        function eqsDdStart() {
            $dt('.eqsDropDown').prop('disabled', true);
        }
        function eqsDdEnd() {
            $dt('.eqsDropDown').prop('disabled', false);
        }
        /* BLL7a end */

        function getFees() {

            var gvwr            =   doubleVal($dt('input[id$="gvwr"]').val());
            var tirefee         =   doubleVal($dt('input[id$="tireFee"]').val());
            var smogfee         =   doubleVal($dt('input[id$="smogFee"]').val());
            var electronicFiling=   doubleVal($dt('input[id$="electronicFilingFee"]').val());
            var docfee          =   doubleVal($dt('input[id$="docfee"]').val());
            var licfee          =   doubleVal($dt('input[id$="licFee"]').val());
            var regfee          =   doubleVal($dt('input[id$="registrationTitleFee"]').val());
            var smogcert        =   doubleVal($dt('input[id$="smogCert"]').val());
            var taxes           =   doubleVal($dt('input[id$="totalTax"]').val());
            var leasefee        =   doubleVal($dt('input[id$="leasefee"]').val());      // BLL40a
            //var loancost      =   doubleVal($dt('input[id$="loancost"]').val());      // BLL40a  
            var totalFees       =   gvwr + tirefee + smogfee + electronicFiling + docfee + licfee + regfee + smogcert + taxes + leasefee;   // BLL40c
            $dt('#tot_fees').html('$'+totalFees.formatMoney(2));
            //BLL36d $dt('[id$="totalFees"]').val(totalFees.formatMoney(2));   // DR3
            // set sidebar, which includes freight
            setInputValue('input[id$="totalFees"]', totalFees.formatMoney(2));   // BLL36a

            fees =  totalFees;
            
        }

        function getGovernmentMoney() {
            var autogrant   =   doubleVal($dt('input[id$="autogranttotal"]').val());
            var dp1         =   doubleVal($dt('input[id$="deferred_1"]').val());
            var dp2         =   doubleVal($dt('input[id$="deferred_2"]').val());
            var dp3         =   doubleVal($dt('input[id$="deferred_3"]').val());

            var totalGov    =   doubleVal(autogrant + dp1 + dp2 + dp3);
            totalGov = Math.round(totalGov * 100)/100;  // BLL4a - round the result

            //BLL36d $dt('[id$="grantTotal"]').val(totalGov);
            setInputValue('input[id$="grantTotal"]', totalGov); // BLL36a
            $dt('#tot_payments').html('($'+totalGov.formatMoney(2)+')');
            gov = totalGov;

        }

        function cDeal() {

            getFees();
            getGovernmentMoney();
            //calcEscTotal();   // BLL41a just displays saved total trade credit in right-hand sidebar
            //calcTrades(); // BLL41a just displays saved total trade credit in right-hand sidebar

            var conversion      =   doubleVal($dt('input[id$="conversion_price"]').val());
            var chassis         =   doubleVal($dt('input[id$="chassis_price"]').val());
            var totChasConvo    =   doubleVal(chassis + conversion);

            var discount        =   doubleVal($dt('input[id$="conversionDiscount"]').val());
            $dt('#tot_discount').html('$'+discount.formatMoney(2));	// BLL50a
            var rebate          =   doubleVal($dt('input[id$="rebate"]').val());
            var deposit         =   doubleVal($dt('input[id$="deposit"]').val());
            //var down            =   doubleVal($dt(el('p:frm:pB:down')).val());
            var down            =   doubleVal($dt('input[id$="down"]').val());
            var dep_down        =   deposit + down;

            var rewards         =   doubleVal($dt('input[id$="mbwRewards"]').val());
            var salepriceEx     =   (conversion + chassis);
            //BLL36d var pack            =   doubleVal($dt(el('p:frm:pB:pack')).val());
            var pack            =   doubleVal($dt('input[id$="pack"]').val());
            //BLL36d $dt('[id$="vehicleSalePriceEx"]').val(salepriceEx);
            setInputValue('input[id$="vehicleSalePriceEx"]', salepriceEx);  // BLL36a
            $dt('#tot_chassis').html('$'+totChasConvo.formatMoney(2));

            var gpsharing       =   {!dealer__Deal__c.GP_Sharing_Amount__c} + 0.00;	// BLL49a
            //if (gpsharing==null) gpsharing = 0.00;	// BLL49a

            // BLL36a
            var freightcost     =   doubleVal($dt('input[id$="freightcost"]').val());
            var freightamt      =   doubleVal($dt('input[id$="freightamount"]').val());
            var freightgp       =   freightamt - freightcost;
            
            // Total After Taxes
            var additionalEquipment =   doubleVal($dt('input[id$="totalAdditionalEquipment"]').val());
            var protectionProducts  =   doubleVal($dt('input[id$="totalProtectionProducts"]').val());
            var fees                =   doubleVal($dt('input[id$="totalFees"]').val());
            var taxes               =   doubleVal($dt('input[id$="totalTax"]').val());
            var gpcAmount           =   doubleVal($dt('input[id$="gpcAmount"]').val()); // BLL36a
            //var rebate1             =   doubleVal($dt(el('p:frm:pB:rebate')).val());
            //var rebate2             =   doubleVal($dt(el('p:frm:pB:rebate2')).val());
            //var rebate3             =   doubleVal($dt(el('p:frm:pB:rebate3')).val());
            var rebate1             =   doubleVal($dt('input[id$="rebate"]').val());
            var rebate2             =   doubleVal($dt('input[id$="rebate2"]').val());
            var rebate3             =   doubleVal($dt('input[id$="rebate3"]').val());
            var rebate_total        =   (gpcAmount + rebate1 + rebate2 + rebate3);  // BLL36c add gpc   
            //var rewards             =   doubleVal($dt(el('p:frm:pB:mbwRewards')).val());
            var rewards             =   doubleVal($dt('input[id$="mbwRewards"]').val());
            $dt('#tot_rebates').html('($'+rebate_total.formatMoney(2)+')');

            // Trades
            //var tradeAllow          =   doubleVal($dt(el('p:frm:pB:tradeallowance')).val());
            //var tradePayoff         =   doubleVal($dt(el('p:frm:pB:tradepayoff')).val());
            var tradeAllow          = doubleVal($dt("input[id$='tradeallowance']").val());
            var tradePayoff         = doubleVal($dt("input[id$='tradepayoff']").val());
            var tradeVal            =   tradeAllow - tradePayoff;
	
			// other bll45a
			var othercosts = doubleVal($dt('input[id$="loancost"]').val());	// BLL45a  (BLL64 loancost *or* escloancost)
			// not included in GP calcs: othercosts += doubleVal($dt('input[id$="loancostesc"]').val());	// BLL64
                        
            var totalSalePrice      =   salepriceEx + 
                                        additionalEquipment +
                                        fees + 
                                        protectionProducts -
                                        //BLL52d tradeVal - 
                                        (gpcAmount + rebate1 + rebate2 + rebate3) - // BLL36c add gpcAmount 
                                        //BLL52d deposit - 
                                        //BLL52d down - 
                                        rewards - 
                                        //BLL52d gov -
                                        discount;
            totalSalePrice += freightamt;   // BLL36a
            if (console) {
                var scalc = 'salepriceEx(' + salepriceEx + ')';
                scalc += ' + additionalEquipment(' + additionalEquipment + ')';
                scalc += ' + fees(' + fees + ')';
                scalc += ' + protectionProducts(' + protectionProducts + ')';
                //BLL52d scalc += ' - tradeVal(' + tradeVal + ')';
                scalc += ' - rebates(' + gpcAmount + '+' + rebate1 + '+' + rebate2 + '+' + rebate3 + ')';
                //BLL52d scalc += ' - deposit(' +deposit + ')';
                //BLL52d scalc += ' - down(' + down + ')';
                scalc += ' - rewards(' + rewards + ')';
                //BLL52d scalc += ' - gov(' + gov + ')';
                scalc += ' - discount(' + discount + ')';
                scalc += ' + freight(' + freightamt + ')';
                console.log('cDeal totalSalePrice=' + scalc);
            }

            //BLL36d $dt('[id$="totalPackagePrice"]').val(totalSalePrice.toFixed(2));
            // BLL36a
            var qty = doubleVal($dt('input[id$="quantity"]').val());    
            if (typeof qty == 'undefined' || doubleVal(qty)==0) qty = 1;    
            setInputValue('input[id$="totalUnitPrice"]', totalSalePrice.toFixed(2)); 
            var extendedSalePrice = totalSalePrice.toFixed(2) * qty;
            setInputValue('input[id$="totalPackagePrice"]', extendedSalePrice.toFixed(2)); 
            // BLL36a end

            //var chassis_cost        =   doubleVal($dt(el('p:frm:pB:chassis_cost')).val());
            //var conversion_cost     =   doubleVal($dt(el('p:frm:pB:conversion_cost')).val());
            //var equipmentCost       =   doubleVal($dt(el('p:frm:pB:equipmentSale')).val());
            var chassis_cost        =   doubleVal($dt('input[id$="chassis_cost"]').val());
            var conversion_cost     =   doubleVal($dt('input[id$="conversion_cost"]').val());
            var equipmentCost       =   doubleVal($dt('input[id$="equipmentSale"]').val());

            if (console) {
                var s = 'GROSS: ';
                s += 'Chassis: ' + chassis + '-' + chassis_cost;
                s += ' + Conversion: ' + conversion + '-' + conversion_cost;
                s += ' + Equipment: ' + additionalEquipment + '-' + equipmentCost;
                s += ' + FreightGP: ' + freightgp;  // BLL36a
                s += ' - Discount: ' + discount;
                s += ' - TradeOA: ' + tradeOA;
                s += ' - LoanCost: ' + othercosts;	// BLL45a
                console.log(s);
            }
  
            //BLL36d var tGross        =   (conversion - conversion_cost) +
            var unitGross              =    (chassis - chassis_cost) +
                                       +    (conversion - conversion_cost)                                         
                                       +    (additionalEquipment - equipmentCost) 
                                       +    (freightgp)
                                       -	(gpsharing)	// BLL49a
                                       -    (discount)  
                                       -    (tradeOA)
                                       -	(othercosts);	// BLL45a

            //BLL36d var salesGross          =   (conversion - conversion_cost) +
            var unitSalesGross          = (chassis - chassis_cost)  
                    + (conversion - conversion_cost)                                    
                    + (additionalEquipment - equipmentCost) 
                    + (freightgp)
                    - (pack)
                    - (gpsharing)	// BLL49a
                    - (discount)
                    - (tradeOA)
                    - (othercosts);	// BLL45a
            
            // BLL36a
            var tGross = unitGross * qty;
            tGross = tGross.toFixed(2);
            var salesGross = unitSalesGross * qty;
            console.log('salesGross');
            console.log(unitSalesGross);
            console.log(qty);
            console.log(salesGross);
            salesGross = salesGross.toFixed(2);
            // BLL36a end
            
            console.log('Pack='+pack);
            console.log('GP Sharing='+gpsharing);	// BLL49a
            console.log('***** Total Gross (Not including ESC) ****');
            console.log(tGross);
            console.log('Sales gross=' + salesGross);

            console.log('***** Total ESC Gross ****');
            console.log(doubleVal($dt('input[id$="totalProtectionProducts"]').val()) - doubleVal($dt('input[id$="warrantyCost"]').val()));
            
            //BLL36d $dt(el('p:frm:gross_TotalProposal')).val( doubleVal(tGross) );
            //BLL36d $dt(el('p:frm:gross_FE')).val( doubleVal(tGross) );
            //BLL36d $dt(el('p:frm:gross_FI')).val(0);
            //BLL36d $dt(el('p:frm:gross_BE')).val(0);
            //BLL36d $dt(el('p:frm:gross_Conversion')).val(conversion - conversion_cost);
            //BLL36d $dt(el('p:frm:gross_Sales')).val(salesGross);
            //BLL36d $dt(el('p:frm:gross_Chassis')).val(chassis - chassis_cost);
            //BLL36d $dt(el('p:frm:gross_AM')).val(additionalEquipment - equipmentCost);

            var totalUnitGrossInput =   unitSalesGross.toFixed(2);  // BLL36a
            var totalGrossInput     =   totalUnitGrossInput * qty;  // BLL36a
            totalGrossInput = totalGrossInput.toFixed(2);   // BLL36a
            var chassisGross = chassis - chassis_cost;  // BLL36a
            chassisGross = chassisGross.toFixed(2);     // BLL36a
            var grossAM = additionalEquipment - equipmentCost;  // BLL36a
            grossAM = grossAM.toFixed(2);   // BLL36a
            var grossConv = conversion - conversion_cost;   // BLL36a
            grossConv = grossConv.toFixed(2);   // BLL36a
            
            setInputValue('input[id$="gross_TotalProposal"]', doubleVal(tGross) );
            setInputValue('input[id$="gross_FE"]', doubleVal(tGross) );
            setInputValue('input[id$="gross_FI"]', 0);
            setInputValue('input[id$="gross_BE"]', 0);
            setInputValue('input[id$="gross_Conversion"]', grossConv);
            setInputValue('input[id$="gross_Sales"]', salesGross);  // BLL36c tofixed(2)
            setInputValue('input[id$="gross_Chassis"]', chassisGross);
            setInputValue('input[id$="gross_AM"]', grossAM);
            setInputValue('input[id$="freightgp"]', freightgp); // BLL36a

            // Set the comm gross based on the matrix
            var commGrossRate       =   0;
            var overrideComm        =   false;

            // JVK2 - DR4
            if( doubleVal($dt('input[id$="commissionTotalFlat"]').val()) > 0 ) {  // DR5
                //BLL36d $dt(el('p:frm:pB:commissionRate')).val(0);
                //BLL36d $dt('[id$="commissionTotal"]').val(0);
                setInputValue('input[id$="commissionRate"]', 0);    // BLL36a
                setInputValue('input[id$="commissionTotal"]', 0);   // BLL36a
    
                overrideComm        =   true;
            }
            // JVK2 - DR4 - End

            if(salesGross<4000 && salesGross>0) {
                commGrossRate       =   0.15;
            }
            if(salesGross>=4000) {
                commGrossRate       =   0.20;
            }
            if(salesGross>=6000) {
                commGrossRate       =   0.25;
            }

            // Adjust for Equipment Only Sales
            //if(recordTypeName == 'Equipment_Only_Sale') {
            //if (recordTypeName.startsWith('Equipment')) { // IE 11 doesn't have .startsWith
            var dealType = '{!dealer__Deal__c.dealer__Deal_Type__c}';
            if (dealType.substring(0,9)=='Equipment') {

                var eq_cost = doubleVal($dt(el('p:frm:pB:equipmentSale')).val());
                var eq_sale = doubleVal($dt(el('p:frm:pB:totalAdditionalEquipment')).val());
                var pMarkup = (eq_sale - eq_cost) / eq_sale;

                if(pMarkup>.3333) {
                    commGrossRate=.2;
                } else {
                    commGrossRate=.15;
                }
            }            

            // BLL24a no commission calcs starting Monday, May 2, 2016!
            if (pdd>=may_1_2016) {
                commGrossRate = 0;
                overrideComm = false;
            }
            // BLL24a end

            // JVK2 - Override for Split, when 0% is set override the values, force row calc on input change
            if(overrideComm==false) {
                $dt(el('p:frm:pB:commissionRate')).val(commGrossRate * 100);
            } else {
                $dt(el('p:frm:pB:commissionRate')).val(0);
            }
            //BLL36d $dt('#totalCommission1').val(
            var totComm1 = (    // BLL36a
                        doubleVal($dt(el('p:frm:pB:commissionTotal')).val())+
                        doubleVal($dt(el('p:frm:pB:commissionTotalFlat')).val())+
                        doubleVal($dt(el('p:frm:pB:commissionFI1')).val())
                    );

            //BLL36d $dt('#totalCommission2').val(
            var totComm2 = (    // BLL36a
                        doubleVal($dt(el('p:frm:pB:commissionTotal2')).val())+
                        doubleVal($dt(el('p:frm:pB:commissionTotalFlat2')).val())+
                        doubleVal($dt(el('p:frm:pB:commissionFI2')).val())
                    );

            //BLL36d $dt('#totalCommission3').val(
            var totComm3 = (    // BLL36a
                        doubleVal($dt(el('p:frm:pB:commissionTotal3')).val())+
                        doubleVal($dt(el('p:frm:pB:commissionTotalFlat3')).val())+
                        doubleVal($dt(el('p:frm:pB:commissionFI3')).val())
                    ); 

            //BLL36d $dt('#totalCommission4').val(
            var totComm4 = (    // BLL36a
                        doubleVal($dt(el('p:frm:pB:commissionTotal4')).val())+
                        doubleVal($dt(el('p:frm:pB:commissionTotalFlat4')).val())+
                        doubleVal($dt(el('p:frm:pB:commissionFI4')).val())
                    );                                
            // JVK2 End

            // BLL24a
            if (pdd>=may_1_2016) {
                //BLL36d $dt('#totalCommission1').val(0);
                //BLL36d $dt('#totalCommission2').val(0);
                //BLL36d $dt('#totalCommission3').val(0);
                //BLL36d $dt('#totalCommission4').val(0);
                totComm1=0; // BLL36a
                totComm2=0; // BLL36a
                totComm3=0; // BLL36a
                totComm4=0; // BLL36a
            }
            // BLL24a end

            // Commissions
            //BLL36d var totalGrossInput     =   salesGross.toFixed(2);
            var commGross           =   totalGrossInput * commGrossRate;   
            var flat                =   doubleVal($dt('input[id$="commissionTotalFlat"]').val());
            var ficomm              =   doubleVal($dt('input[id$="commissionFI1"]').val()); // BLL1a
            // BLL24a
            if (pdd>=may_1_2016) {
                commGross = 0;
                flat = 0;
                ficomm = 0; // ???
            }
            // BLL24a end
            var totalComm           =   commGross + flat + ficomm; // BLL1a added ficomm
            // BLL24a
            if (pdd>=may_1_2016) {
                totalComm = 0; 
            }
            // BLL24a end
                
            // JVK2
            if(overrideComm == false) {
                $dt('input[id$="commissionTotal"]').val(commGross.toFixed(2));
                //BLL36d $dt(el('totalCommission1')).val(totalComm.toFixed(2));
                //setInputValue('input[id$="commissionTotal"]', commGross.toFixed(2));    // BLL36a
                totComm1 = totalComm;   // BLL36a
            }

            //setInputValue('#totalCommission1', totComm1);   // BLL36a
            //setInputValue('#totalCommission2', totComm2);   // BLL36a
            //setInputValue('#totalCommission3', totComm3);   // BLL36a
            //setInputValue('#totalCommission4', totComm4);   // BLL36a
            // BLL36a
            $dt('input[id$="totalCommission1"]').val(totComm1);
            $dt('input[id$="totalCommission2"]').val(totComm2);
            $dt('input[id$="totalCommission3"]').val(totComm3);
            $dt('input[id$="totalCommission4"]').val(totComm4);
            // BLL36a end
            $dt('#totalUnitGrossInput').val(totalUnitGrossInput);   // BLL36a
            $dt('#totalGrossInput').val(totalGrossInput);
            // JVK2 End

            // ( $dt('[id$="commissionTotalFlat"]').val() > 0 ) ? 0 : totalGrossInput * commGrossRate;   
            // / && $dt('[id$="commissionTotalFlat"]').val() > 0

            // BLL44a
            var amtdue = totalSalePrice;
            amtdue = amtdue - deposit - down;	// BLL52a
            amtdue = amtdue - tradeVal - gov;	// BLL53a
            var amtfinanced = 0;
            if ('{!dealer__Deal__c.Funding_option__c}'=='Financed') {	// BLL47a
            	amtfinanced = doubleVal($dt('input[id$="amtfinanced"]').val());
            	amtdue = amtdue - amtfinanced;
            	// BLL52 ???
				var firstpmt = doubleVal($dt('input[id$="contractMonthlyPayment"]').val());
				//$dt('#lease_first_pmt').val(firstpmt);
				if ('{!dealer__Deal__c.Contract_Type__c}'=='Lease') {
					//BLL52d amtfinanced = amtfinanced - firstpmt;
				 	amtdue += firstpmt;
				 	dep_down -= deposit;	// BLL52a don't show first pmt as cap cost reduction
				 	$dt("#lease_first_pmt").html(deposit.formatMoney(2));	// BLl52a
				}
            	console.log('cDeal amtfinanced='+amtfinanced);
            	console.log('cDeal amtdue='+amtdue);
            }	// BLL47a
            $dt('#tot_financed').html('<b>$' + amtfinanced.formatMoney(2) + '</b>');	
            // BLL44a end

            $dt('#tot_down').html('(' + dep_down.formatMoney(2) + ')');
            $dt('#tot_cart').html('<b>$' + totalSalePrice.formatMoney(2) + '</b>');
            $dt('#tot_due').html('<b>$' + amtdue.formatMoney(2) + '</b>'); // BLL44a
            $dt('#tot_freight').html('$' + freightamt.formatMoney(2));  // BLL40a
        }

        function detailGross() {

            // Calc Gross
            var conversion      =   doubleVal($dt('input[id$="conversion_price"]').val());
            var chassis         =   doubleVal($dt('input[id$="chassis_price"]').val());
            //var chassis_cost        =   doubleVal($dt(el('p:frm:pB:chassis_cost')).val());
            //var conversion_cost     =   doubleVal($dt(el('p:frm:pB:conversion_cost')).val());
            //var equipmentCost       =   doubleVal($dt(el('p:frm:pB:equipmentSale')).val());   
            var chassis_cost        =   doubleVal($dt('input[id$="chassis_cost"]').val());
            var conversion_cost     =   doubleVal($dt('input[id$="conversion_cost"]').val());
            var equipmentCost       =   doubleVal($dt('input[id$="equipmentSale"]').val());   
            var discount        =   doubleVal($dt('input][id$="conversionDiscount"]').val());
            var additionalEquipment =   doubleVal($dt('input[id$="totalAdditionalEquipment"]').val()); 
            //var pack            =   doubleVal($dt(el('p:frm:pB:pack')).val());
            var pack            =   doubleVal($dt('input[id$=":pack"]').val())          
            // BLL36a
            var freightcost     =   doubleVal($dt('input[id$="freightcost"]').val());
            var freightamt      =   doubleVal($dt('input[id$="freightamount"]').val());
            var freightgp       =   freightamt - freightcost;
            freightgp           =   freightgp.toFixed(2);

            var gpsharing       =   {!dealer__Deal__c.GP_Sharing_Amount__c} + 0.00;	// BLL49a
            //if (gpsharing==null) gpsharing = 0.00;	// BLL49a

            var total   =   (conversion - conversion_cost) +
                                        + (chassis - chassis_cost) 
                                        + (additionalEquipment - equipmentCost) 
                                        - pack 
                                        - gpsharing	// BLL49a
                                        - discount 
                                        - tradeOA;
            total += freightgp;
            
            console.log('chassis '+chassis);
            console.log('chassis_cost '+chassis_cost);
            console.log('conversion '+conversion);            
            console.log('conversion_cost '+conversion_cost);
            console.log('additionalEquipment '+additionalEquipment);
            console.log('equipmentCost '+equipmentCost);
            console.log('discount '+discount);
            console.log('pack '+pack);
            console.log('gpsharing '+gpsharing);	// BLL49a
            console.log('discount '+discount);
            console.log('tradeOA '+tradeOA);
            console.log('freightgp '+freightgp);

            console.log('Total '+total);          
        }

        Number.prototype.formatMoney = function(decPlaces, thouSeparator, decSeparator) {
            var n = this,
                decPlaces = isNaN(decPlaces = Math.abs(decPlaces)) ? 2 : decPlaces,
                decSeparator = decSeparator == undefined ? "." : decSeparator,
                thouSeparator = thouSeparator == undefined ? "," : thouSeparator,
                sign = n < 0 ? "-" : "",
                i = parseInt(n = Math.abs(+n || 0).toFixed(decPlaces)) + "",
                j = (j = i.length) > 3 ? j % 3 : 0;
            return sign + (j ? i.substr(0, j) + thouSeparator : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thouSeparator) + (decPlaces ? decSeparator + Math.abs(n - i).toFixed(decPlaces).slice(2) : "");
        };

        function setEqTax(el) {
            if($dt(el).is(":checked")) {
                // Set the tax to true
                Deal_MBW2.toggleTax($dt(el).attr('recordId')+':true', function(result, event){
                    if(event.status) {
                        // Success
                    }
                });
            } else {
                // Set the tax to false
                Deal_MBW2.toggleTax($dt(el).attr('recordId')+':false', function(result, event){
                    if(event.status) {
                        // Success
                    }
                });                
            }
        }
        
        // BLL29a
        function setEqTaxExempt(el) {
            if($dt(el).is(":checked")) {
                // Set the tax to true
                Deal_MBW2.toggleTaxExempt($dt(el).attr('recordId')+':true', function(result, event){
                    if(event.status) {
                        // Success
                    }
                });
            } else {
                // Set the tax to false
                Deal_MBW2.toggleTaxExempt($dt(el).attr('recordId')+':false', function(result, event){
                    if(event.status) {
                        // Success
                    }
                });                
            }
        }
        // BLL29a end

        function setPrintOnProposal(el) {
            if($dt(el).is(":checked")) {
                // Set the tax to true
                Deal_MBW2.togglePrint($dt(el).attr('recordId')+':true', function(result, event){
                    if(event.status && event.result) {	// BLL53c change from even.status (always true)
                        // Success
                    } else {
                    	alert('Unable to set print flag (NMEDA should not print on page 2)');
                    	$dt(el).prop("checked", false);	// reset visually since it failed to set
                    }
                });
            } else {
                // Set the tax to false
                Deal_MBW2.togglePrint($dt(el).attr('recordId')+':false', function(result, event){
                    if(event.status && event.result) {	// BLL53c change from even.status (always true)
                        // Success
                    } else {
                    	alert('Failed to reset print flag');
                    	$dt(el).prop("checked", true);	// set visually since it failed to reset
                    }
                });                
            }
        }

        function updateEquipmentSale (el) {
            Deal_MBW2.updateEquipmentSale($dt(el).attr('recordId')+'~'+doubleVal($dt(el).val()), function(result, event) {
                if(event.status) {
                    resetEquipmentValues();
                } else {
                    alert('Failed to update the Equipment Sale Price');
                }
            });
        }

        // BLL36a
        function updateEquipmentQty(el) {
            Deal_MBW2.updateEquipmentQty($dt(el).attr('recordId')+'~'+doubleVal($dt(el).val()), function(result, event) {
                if(event.status) {
                    resetEquipmentValues();
                } else {
                    alert('Failed to update the Equipment Quantity');
                }
            });
        }
        // BLL36a end

        function updateServiceContractSale (el) {
            Deal_MBW2.updateServiceContractSale($dt(el).attr('recordId')+'~'+doubleVal($dt(el).val()), function(result, event) {
                if(event.status) {

                } else {
                    alert('Failed to update the Equipment Sale Price');
                }
            });
        } 

        // BLL13a
        var taxCalcDialog = null;
        function showTaxCalcNotice() {
            // Display alert that says Saving
            taxCalcDialog = alertify.alert('Please wait, calculating taxes').delay(3000);
        }       
        // BLL13a end

        // BLL19a
        function clearEquipmentSearch() {
            $dt('select[id$=ctg]').val('');
            $dt('select[id$=mfgS]').val('');
            $dt('select[id$=subCat]').val('');
            $dt('input[id$=searchbypartnumber]').val('');
            $dt('input[id$=searchbydescription]').val('');
            $dt('input[id$=searchbynotes]').val('');
        }
        // BLL19a end

        function saveForm() {
            if ($dt('form[id$="frm"]')[0].checkValidity()) {
                $dt('input[id$="saveButton"]').first().click();
            } else {
                //$dt('#saveNotice').modal('hide');
                alert('Required fields are missing');
            }
        }

        function saveNotice(f) {
            // Display alert that says Saving
            //alertify.alert('Please wait, saving this Proposal');
            //$dt('#saveNotice').modal();
            $dt('#saveNotice').modal();
            return true;
        }
        
    </script>

    <style>
        #force input.btnDisabled[type="submit"] {cursor:default;}   /* BLL31a */
        .labelCol {
            text-align: right !important;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @-webkit-keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .container { width: 100% !important; margin-right: 0px !important; margin-left: 0px !important; }

        
        .recordHeader {
            /* BLL36d height: 60px; */
            border: 1px solid #eeeeee;
            z-index: 1040;
            background-color: #ecf0f1;
            padding: 5px;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            -khtml-border-radius: 5px;
            border-radius: 5px;
            border: 1px solid #DBDBDB;
            box-sizing: content-box;
        }

        /*
        #proposalHeader.affix {
            position: fixed;
            top:0px;
            width:100%;
        }

        #proposalHeader.affix-top {
            position: static;
            margin-top:0px;
            width:100%;
        }       
        */

        .recordHeader.affix {
            position: fixed;
            z-index: 1040;
            top: 0;
            left: 0;
            width: 100%;
            border: 0;
            margin-top: 0;
            padding-top: 0px;
            border-radius: 0;
            animation: fadeIn 0.5s ease-in;
            -webkit-animation: fadeIn 0.5s;
        }

        .affix-placeholder {
            display: none;
        }
        .recordHeader.affix + .affix-placeholder {
            display: block;
            visibility: hidden;
        }   

        .navbar-bright {
         background-color:#111155;
         color:#fff;
        }

        .affix-top,.affix{
         position: static;
        }

        @media (min-width: 979px) {
          #sidebar.affix-top {
            /* BLL36d position: static; */
            /* BLL36d margin-top:30px; */
            margin-top:5px;    /* BLL36a 15px*/ /*BLl55c 6px*/
            width:285px;
          }
          
          /*BLL36d
          #sidebar.affix {
            position: fixed;
            top:70px;
            width:285px;
          }
          */
            #sidebar.affix {
                width:285px;
            }

        }

        
        #sidebar li.active {
          border:0 #eee solid;
          border-bottom: 1px solid #eee !important;
          border-left-width:5px;
        }   

        #sidebar li {
            border-bottom: 1px solid #eee;
        }

        .mainTitle {
            font-size: 24px !important;
        }

        .pbBody h3 {
            font-size: 20px !important;
        }

        #force h3 {
            font-size: 16px !important;
            margin-top: 0px !important;
            margin-bottom: 0px !important;
        /*BLLd    color: #FFFFFF; */
        }   
        .totColumn {
            display: inline;
            float: right;
            margin-top: 5px;
            font-size: 14px;
            color: #7B7B7B;
        }

        .container { 
            padding: 0px !important;
        }

        // Fix BootStrap Overlay
        .btn {
            padding: 5px 10px !important; 
            font-size: 12px !important;
            line-height: 1.5 !important;
            border-radius: 3px !important;
            color: #ffffff !important;
            background-color: #5bc0de !important;
            border-color: #46b8da !important;
            display: inline-block !important;
            margin-bottom: 0 !important;
            font-weight: normal !important;
            text-align: center !important;
            white-space: nowrap !important;
            vertical-align: middle !important;
            background-image: none !important;
            border: 1px solid transparent !important;
            -webkit-user-select: none !important;       
        }

        .back-to-top{
            padding: 4px 10px;
            margin-top: 10px;
            margin-left: 10px;
            font-size: 12px;
            font-weight: 500;
            color: #999;
        }

        h3 {
            font-size: 16px !important;
            margin-top: 0px !important;
            margin-bottom: 0px !important;
            color: ##DBDBDB;
        }

        #force .nav > li > a {
            display: inline-block;
        }

        #force .nav > li li, #force ul.nav ul span {
            font-size: 0.75em;
        }

        #force .nav > li > a {
            display: inline-block;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 80%;
            overflow: hidden;
        }

        #force .modal-dialog {
            width: 1050px;
            padding-top: 30px;
            padding-bottom: 30px;
        }   

        .alertify-logs {
            top: 10px;
            left: 10px;
        }   

        .recordHeader td {
            padding: 0;
        }

        .recordHeader > form > table > tbody > tr > td  {
            padding-left: 5px;
        }

        .recordHeader > form > table > tbody > tr > td:first-child  {
            padding-left: 0;
        }

        .initial_input {
            position: absolute;
            border: 0;
            height: 0;
            width: 0;
            opacity: 0;
        }

        #conversionTable td:nth-child(3) b {
            margin-left: 10px;
            margin-right: 5px;
        }

        .dateFormat {
            font-size: .9em;
        }

        .min_font {
            font-size: .85em;
        }

        [id$=status], 
        [id$=dealdate], 
        [id$=proposedDeliveryDate] {
            margin-left: 5px;
        }

        .nav-stacked li:first-child {
            margin-left: 0;
        }

        .nav-stacked button.btn-link {
            position: relative;
            top: -15px;
        }

        #force .nav-stacked .active .active {
            border-left: 0; 
        }

        @media screen {
          #printSection {
              /* display: none; */
          }
        }

        @media print {
          body * {
            visibility:hidden;
          }
          #printSection, #printSection * {
            visibility:visible;
          }
          #printSection {
            position:absolute;
            left:0;
            top:0;
            font-size: 12px;
            width: 8.5in;
            height: 11in;       
          }

            #force .modal-dialog {
            width: 670px;
            padding-top: 0px;
            padding-bottom: 0px;
            }     

        }   

        #header_save {
            display: inline-block;
            padding: 6px 12px;
            margin-bottom: 0;
            font-size: 14px;
            font-weight: normal;
            line-height: 1.428571429;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            cursor: pointer;
            background-image: none;
            border: 1px solid transparent;
            border-radius: 4px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -o-user-select: none;
            user-select: none;
            color: #ffffff;
            background-color: #5bc0de;
            border-color: #46b8da;
        }

        .dCalc {
            text-align: right;
        }

        #force [id$="mfgS"] {
            width: 90% !important;
        }

        #force [id$="subCat"] {
            width: 90% !important;
        }

        .aright {
            text-align: right;
        }

        /* BLL7a */
        .eqsCatCol {width:35%;text-align:left}
        .eqsMfgCol {width:30%;text-align:left}
        .eqsSubCol {width:35%;text-align:left}
        /* BLL7a end */

/** BLL36a - new CSS **/
input.unsaved {
    color: #FF4500;
    border-color: #FF4500;
}
td.pbTitle { min-width: 400px;}

#proposalHeader {
    border-bottom: 2px solid #5bc0de;
}

#force .nav-stacked > li + li {
    margin-top: 0px;
}

#force .btn-xs { /* BLL53a */
	margin-right:5px;
}
/* BLL62 */
tr.tertiaryPalette.extraRow {
	background-color: #79b4cd;
	border-color: #79b4cd;
}
/* BLL62 end */

/* Next section changes the title border and background colors for commercial */
/* tabstyle={!tabstyle} */
<apex:outputPanel layout="none" rendered="{!tabstyle='CommercialQuote__c'}">
    .Custom108Tab .secondaryPalette, .individualPalette .Custom108Block .secondaryPalette {
        /*    background-color: #007fcc; */
        border-color: #996633;
    }

    .Custom108Tab .listViewport .subNav .linkBar, .Custom108Tab .mComponent .cHeader, .Custom108Tab .genericTable, .Custom108Tab .bSubBlock, .Custom108Tab .bPageBlock {
        border-top: 3px solid #996633;
    }

    .Custom108Tab .tertiaryPalette, .individualPalette .Custom108Block .tertiaryPalette, .layoutEdit .individualPalette .Custom108Block .tertiaryPalette {
        background-color: #996633;
        border-color: #996633;
    }

    .Custom108Tab .tertiaryPalette, .individualPalette .Custom108Block .tertiaryPalette, .layoutEdit .individualPalette .Custom108Block .tertiaryPalette {
        background-color: #996633;
        border-color: #996633;
    }
    #proposalHeader {
        border-bottom: 2px solid #996633;
    }
    table#newVehicleVINtable {
        border:2px solid #996633;
    }
</apex:outputPanel>

<apex:outputPanel layout="none" rendered="{!tabstyle!='CommercialQuote__c'}">
table#newVehicleVINtable {
    border:2px solid #79b4cd;
}
</apex:outputPanel>
/** BLL36a end **/

/** BLL36 styles for collapsible section*/
.myheader {
    width:100%;
    background-color:gray;
    color:white;
    cursor:pointer;
    padding:3px;
    font-size:12px;
}
.myshow div.twistyicon {
    /* content: ' - '; */
    display:inline-block;
    background: transparent url("/img/alohaSkin/twisty_sprite.png") 0 -34px no-repeat; 
}
.myhide div.twistyicon {
    /* content: ' + '; */
    display:inline-block;
    background: transparent url("/img/alohaSkin/twisty_sprite.png") 0 -23px no-repeat; */
}
.readonly {border:none; color:#666666; background:transparent;}

/* Override message display to be a little tighter vertically */
.message .messageText h4 {
    display: inline-block;
    margin-right: 1em;
}
.errorM3 .msgIcon {
    background-size: 12px 12px;
    width: 12px;
    height: 12px;
}
.warningM3 .msgIcon {
    background-size: 12px 12px;
    width: 12px;
    height: 12px;
}
.infoM3 .msgIcon {
    background-size: 12px 12px;
    width: 12px;
    height: 12px;
}

/** BLL55a **/
table#vehicleTable, table#conversionTable {
	background-color:transparent!important;
	margin-bottom: 5px!important;
}
table#vehicleTable > tbody > tr > td, table#conversionTable > tbody > tr > td {
	margin:0px!important;
	font-size:12px!important;
	border:none!important;
	background-color:transparent!important;
	padding:0px!important;
}
#recordHeader table > tbody > td > h4, #force .table > tbody > tr > td  {
	margin-top:0px;
	margin-left:0px;
	font-size:12px;
	border:none!important;
	padding:0px!important;
}
#recordHeader table > td > h2, #force .table > tbody > tr > td  {
	font-size: 12px;
}
#recordHeader table > tr, #force .table > tr {
	border:none;
}
#recordHeader table > tr > td, #force .table > tr > td {
	padding:0px!important;
	border:none!important;
	background-color:transparent;
}
div.messageText > h4 {
	margin-bottom: 0px;
	margin-top: 0px;
	font-size: 11pt;
}
#force .message h4 {
	margin-bottom: 0px;
	margin-top: 0px;
	font-size: 11pt;
}
/** BLL55a end **/

#force .pbSubheader img.showListButton {    /* correct collapse/expand arrow position */
    vertical-align:baseline;
}
#force input.btn {margin-right: 1em;} /* space buttons apart a bit */

/* BLL40 - lease form */
#force table.leaseformtable {
    width:100% !important;
}
#force table.leaseformtable td {
    border:1px solid #eaeaea !important;
}
/* BLL44c narrow spacing in sidebar nav*/
#force .nav > li > a {
    padding: 8px 0px;
}
/* BLL62 */
.hidden {display:none;}
span.redtext span {color:red;}
#recordHeader table.table-condensed > tbody > td > h4, #force .table.table-condensed > tbody > tr > td {
    padding: 2px!important;
}
<!--BLL66-->
.favorite,  .favorite:visited {
	font-size:16pt;
	text-decoration: none!important;
	color:black!important;
}
.favorite:hover {
	font-size:16pt;
	text-decoration: none!important;
	color:#3366ff!important;
}
<!--BLL66-->
</style>

<apex:outputPanel layout="none" rendered="{!RecordTypeName='Commercial'}">
<style>
#force .nondisplay {display:none;}
#force .nondisplay > label {display:none;}
#force .nondisplay > input {display:none;}
#force .nondisplay > span {display:none;}
#force th.nondisplay {display:none;}
#force td.nondisplay {display:none;}

</style>
</apex:outputPanel>

<script type="text/javascript">
function mytoggle(elem, section) {
    $dt("[id$='"+section+"']").collapse('toggle');
    $dt(elem).toggleClass('myshow myhide');
}
// AMM62
function setRemoteFavorite(recordId, boolFlag, locationId, showFavorites) {

if(showFavorites === 'false')
{
    alert("Must enable the checkbox 'Show Favorites' to save this favorite");
}
else
{
    Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.Deal_MBW2.favoriteClick}',
        recordId,
        boolFlag,
        locationId,
        showFavorites,
        function(result, event){
            if (event.status) {
                console.dir(event);
                rerendAction();
            } else if (event.type === 'exception') {
                console.dir(event);
            } else {
                console.dir(event);
            }
        }, 
        {escape: true}
    );    
} 
}
// AMM62
</script>


</head>
    
    
<!--  BODY  -->    
    
<body>

<!--main-->
<!-- BLL2a -->
<apex:outputText rendered="{!AND(ISBLANK(dealer__Deal__c.dealer__Sales_Lead__c),ISBLANK(dealer__Deal__c.Id))}"><!-- BLL3c -->
<apex:sectionHeader title="Proposal" subtitle="You must begin a Proposal from a Solution Opportunity"/>
<apex:image value="{!$Resource.NewProposalSplash}" />
</apex:outputText>
<!-- BLL2a end -->


<!-- PROPOSAL HEADER -->
<apex:outputText rendered="{!NOT(AND(ISBLANK(dealer__Deal__c.dealer__Sales_Lead__c),ISBLANK(dealer__Deal__c.Id)))}"><!-- BLL2, BLL3c -->
<div class="container"><!-- BLL55 moved above proposal header --> 

    <div id="force">
    <div class="row">
      
      <!--left-->
      <div class="col-md-9">

<div id="proposalHeader" class="recordHeader">
    <!-- BLL28d moved apex:messages / -->
    <apex:form id="headForm">
    <!-- BLL36d apex:actionFunction action="{!inplaceSaveProposal}" name="inplaceSaveProposal" reRender="proposalHeader,NonStockVehiclePanel"/ -->
    <table class="table" style="margin-bottom:0px;">
        <tr valign="top">
            <td valign="top" style="border-right:1px solid #DBDBDB;"><!--width="275px;"-->
                <table width="100%" class="table" id="vehicleTable">
                    <tr>
                        <td rowspan="4">
                            <apex:outputText rendered="{!IF(thumbnailURL!='', true, false)}">
                                <apex:image url="{!thumbnailURL}" height="55px;"/>
                            </apex:outputText>
                        </td>
                        <td colspan="2">
                            <apex:outputText rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
                            <strong>Proposal #:&nbsp;
                                <apex:outputLink value="/{!dealer__Deal__c.Id}">
                                    <apex:outputText value="{!dealer__Deal__c.Name}" />
                                </apex:outputLink>
                            </strong>
                            </apex:outputText>
                            <apex:outputText rendered="{!ISBLANK(dealer__Deal__c.Id)}">
                            <strong>New Proposal</strong>
                            </apex:outputText>                            
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input class="initial_input" style="width:2px;background-color:#ecf0f1;border:0px;" type="text" />
                            <span id="year"><b><apex:outputText value="{!dealer__Deal__c.dealer__Year__c}" /></b></span>
                            <span id="make"><b><apex:outputText value="{!dealer__Deal__c.dealer__Make__c}" /></b></span>
                            <span id="model"><b><apex:outputText value="{!dealer__Deal__c.dealer__Model__c}" /></b></span>
                        </td>
                    </tr>
                    <tr class="min_font">
                        <td><span style="text-align:right;"><apex:outputText >Status:&nbsp;</apex:outputText></span></td>
                        <td><apex:outputField value="{!dealer__Deal__c.Vehicle_Status__c}" id="vehicleStatusCode" /></td>
                    </tr>
                    <tr class="min_font">
                        <td><apex:outputText >WIP:&nbsp;</apex:outputText></td>
                        <td><apex:outputField value="{!dealer__Deal__c.WIP__c}" id="vehicleWIP" style="text-decoration: blink;color:red;" /></td>
                    </tr>               
                </table>                
            </td>
            <td style="border-right:1px solid #DBDBDB;"><!--width="400px;" -->
                <table class="table" id="conversionTable">

                    <tr>
                        <td><b>STOCK #:</b></td>
                        <td><span id="stock_number"><apex:outputText value="{!vehicle.dealer__Stock_Number__c}" /></span></td> 

                        <td><b>Ramp Type:</b></td>
                        <td><span id="mv_ramp_type"><apex:outputText value="{!vehicle.MV_Ramp_Type__c}" /></span></td>
                    </tr>
                    <tr>
                        <td><b>Conv. MFG:</b></td>
                        <td><span id="conversion_mfg"><apex:outputText value="{!vehicle.Conv_MFG__c}" /></span></td>
                        <td><b>Ramp Operation:</b></td>
                        <td><span id="mv_ramp_operation"><apex:outputText value="{!vehicle.MV_Ranp_Operation__c}" /></span></td>
                    </tr>

                    <tr>
                        <td><b>Conv. Model:</b></td>
                        <td><span id="conversion_model"><apex:outputText value="{!vehicle.Conversion_Model__c}" /></span></td>
                        <td><b>Ramp Location:</b></td>
                        <td><span id="mv_ramp_location"><apex:outputText value="{!vehicle.Ramp_Location__c}" /></span></td>
                    </tr>       
                </table>
            </td>
            <td style="border-right:1px solid #DBDBDB;"><!--width="175px;" -->
                <table>
                    <tr>
                        <td><apex:outputField value="{!dealer__Deal__c.dealer__Buyer__r.Name}" /></td>
                    </tr>
                    <tr>
                        <td><apex:outputField value="{!dealer__Deal__c.dealer__Buyer_Address__c}" /></td>
                    </tr>
                    <tr>
                        <td>
                            <apex:outputField value="{!dealer__Deal__c.dealer__Buyer_City__c}" />&nbsp;
                            <apex:outputField value="{!dealer__Deal__c.dealer__Buyer_State__c}" />&nbsp;
                            <apex:outputField value="{!dealer__Deal__c.dealer__Buyer_Postal_Code__c}" />
                        </td>
                    </tr>                   
                </table>
            </td>
            <td>
                <apex:outputText rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
                <table>
                    <tr>
                        <td>Status:</td>
                        <td>
                            <apex:outputField value="{!dealer__Deal__c.dealer__Status__c}" id="status"/>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            Proposal Date:
                            <!--br/-->
                            <apex:inputField value="{!dealer__Deal__c.dealer__Deal_Date__c}" id="dealdate"  />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="font-weight:bold;color:#000099">Delivery Date:
                        <!--br/-->
						<apex:inputField value="{!dealer__Deal__c.Proposed_Delivery_Date__c}" id="proposedDeliveryDate" /></td>
                    </tr>
                </table>
                </apex:outputText>
            </td>
            <td>
                <!--<button class="btn btn-info" id="header_save">Save</button>-->
            </td>
        </tr>
    </table>
    </apex:form>
    <!-- apex:pageMessages / --><!-- BLL28a, BLL36d -->
    <apex:pageMessages id="page_messages" /><!-- BLL36a -->
</div>

<!--  END PROPOSAL HEADER -->


<!-- BLL55 move up above PROPOSAL HEADER div class="container" --> 
    <chatter:feedWithFollowers entityId="{!dealer__Deal__c.Id}" id="chatterFeed" />

	<!-- div id="force" -->
    <!-- div class="row" -->
      
      <!--left-->
      <!-- div class="col-md-9" -->

        <apex:form id="frm">

            <apex:actionFunction action="{!noaction}" name="updateScreenEquipment" rerender="additional_equipment"/><!-- BLL36a --><!-- BLL44c rerender was amSelectedEquipment -->
            <apex:actionFunction action="{!noaction}" name="redrawFinanceTerms" rerender="FinanceTerms,LeaseInformationTables"/><!-- BLL40a -->
			<apex:actionFunction action="{!noaction}" name="redrawFinanceTerms2" rerender="FinanceTerms2,LeaseInformationTables"/><!-- BLL40a -->
            
        <!-- BLL2a - Need a copy of these fields so the save button sees the new value -->
        <div style="display:none">
        <apex:inputField value="{!dealer__Deal__c.dealer__Deal_Date__c}" id="copy_dealdate"  />
        <apex:inputField value="{!dealer__Deal__c.Proposed_Delivery_Date__c}" id="copy_proposedDeliveryDate"  />
        </div>
        

        <!-- Gross Profit Fields -->
        <apex:inputHidden value="{!dealer__Deal__c.Total_Proposal_Gross__c}" id="gross_TotalProposal" />
        <apex:inputHidden value="{!dealer__Deal__c.dealer__Front_End_Gross__c}" id="gross_FE" />
        <apex:inputHidden value="{!dealer__Deal__c.dealer__Finance_Gross__c}" id="gross_FI" />
        <apex:inputHidden value="{!dealer__Deal__c.Conversion_Gross__c}" id="gross_Conversion" />
        <apex:inputHidden value="{!dealer__Deal__c.Commissionable_Gross__c}" id="gross_Sales" />
        <apex:inputHidden value="{!dealer__Deal__c.Chassis_Gross__c}" id="gross_Chassis" />
        <apex:inputHidden value="{!dealer__Deal__c.dealer__Back_End_Gross__c}" id="gross_BE" />
        <apex:inputHidden value="{!dealer__Deal__c.dealer__Aftermarket_Gross__c}" id="gross_AM" />

        <apex:pageBlock title="{!RecordTypeLabel} Proposal" id="pB" tabStyle="{!IF(tabstyle='Commercial','Commercial_Quote__c','dealer__Deal__c')}"><!-- BLL36c -->
            
            <apex:pageBlockButtons id="cmdButton">
                <apex:commandButton action="{!saveProposal}" value="Save" styleClass="btn-info btn-sm" id="saveButton" rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}"/>
				<apex:commandButton action="{!saveProposal}" value="Create New Proposal" styleClass="btn-info btn-sm" id="saveButtonNew" rendered="{!ISBLANK(dealer__Deal__c.Id)}"/>
				<!-- BLL58 -->
				<!--apex:commandButton action="{!markLost}" value="Mark Lost" styleClass="btn-default btn-sm" style="margin-left:3em;" 
                    onclick="javascript:if(!confirm('Mark this proposal lost?')){return false};" 
					rendered=" { ! AND(NOT(ISBLANK(dealer__Deal__c.Id)),dealer__Deal__c.dealer__Status__c!='Won - Posted',dealer__Deal__c.dealer__Status__c!='Lost')}"/ --><!-- BLL30a -->
				<!-- BLL61 -->
				<!-- apex:commandButton action="{!marklost}" value="Mark Lost" styleClass="btn-default btn-sm" style="margin-left:3em;" 
					onclick="javascript:if(!confirm('Mark this proposal lost?')){return false};" 					immediate="true" html-formnovalidate="formnovalidate"
					rendered=" { ! AND(NOT(ISBLANK(dealer__Deal__c.Id)),dealer__Deal__c.dealer__Status__c!='Won - Posted',dealer__Deal__c.dealer__Status__c!='Lost')}"/--><!-- BLL30a -->
				<apex:commandButton action="{!marklost}" value="Mark Lost" styleClass="btn-default btn-sm" style="margin-left:3em;" 
					onclick="javascript:if(!confirm('Mark this proposal lost?')){return false};" 					immediate="true" html-formnovalidate="formnovalidate"
					rendered="{!AND(NOT(ISBLANK(dealer__Deal__c.Id)),dealer__Deal__c.dealer__Status__c=='Pending')}"/>
				<!-- BLL61 end -->
				<!-- BLL58 end -->
                <apex:commandButton action="{!markPending}" value="Re-open" styleClass="btn-default btn-sm" style="margin-left:3em;" 
                    onclick="javascript:if(!confirm('Re-open this proposal to Pending?')){return false};" 
                    rendered="{!AND(NOT(ISBLANK(dealer__Deal__c.Id)),dealer__Deal__c.dealer__Status__c=='Lost')}"/><!-- BLL47a -->
                <apex:commandButton action="{!gotoClonePage}" value="Clone" styleClass="btn-info btn-sm" id="cloneBtn"
                    rendered="{!AND(NOT(ISBLANK(dealer__Deal__c.Id)),RecordTypeName=='Commercial',dealer__Deal__c.dealer__Status__c!='Lost')}"/>
                <apex:commandButton action="{!emailPDF}" value="Email PDF" styleClass="btn-info btn-sm"
                    rendered="{!AND(NOT(ISBLANK(dealer__Deal__c.Id)),dealer__Deal__c.dealer__Status__c!='Lost')}"/><!-- BLL36a -->
                <apex:commandButton action="{!emailReleasingDealer}" value="Email Rel. Dealer" styleClass="btn-info btn-sm"  
                    rendered="{!AND(dealer__Deal__c.ReleasingDealer__c!=null, dealer__Deal__c.dealer__Status__c!='Lost')}"/><!-- BLL36a -->
				<!-- BLL54a -->
				<apex:outputPanel layout="none" rendered="{!AND(purAgreement!=null,NOT(ISBLANK(dealer__Deal__c.Id)),RecordTypeName=='Retail',isVehicleSale,dealer__Deal__c.dealer__Status__c!='Lost')}">
                <button type="button" id="printPurAgreementBtn" onclick="printPDF_FDF('{!purAgreement.Id}', '{!purAgreement.dealer__DocumentContentId__c}', '{!purAgreement.dealer__Flatten__c}', '{!purAgreement.Name}')"
                    class="btn btn-info btn-sm">Purchase Agreement</button>
                </apex:outputPanel>
                <!-- BLL54a -->
            </apex:pageBlockButtons>

            <span id="sec_customer"></span>
            <apex:pageBlockSection title="Customer" id="pbCustomer" collapsible="false">
                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer__c}" id="buyer_contact" onchange="setBuyerDetails();"/>
                <!-- BLL36d apex:outputText / -->
                <!--
                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_First_Name__c}" id="buyer_firstname" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_Last_Name__c}" id="buyer_lastname" />
                -->
                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_Email__c}" id="buyer_email"/> 


                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_Address__c}" id="buyer_address"/>
                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_Home_Phone__c}" id="buyer_homephone"/>
                
                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_City__c}" id="buyer_city"/>
                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_Mobile_Phone__c}" id="buyer_mobilephone"/>

                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_State__c}" id="buyer_state"/>
                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_Work_Phone__c}" id="buyer_workphone"/>

                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_Postal_Code__c}" id="buyer_postalcode"/>
                <!-- BLL36a -->
                <apex:inputField value="{!dealer__Deal__c.Buyer_Fax__c}" rendered="{!RecordTypeName='Commercial'}"/>
                <apex:outputText rendered="{!RecordTypeName!='Commercial'}"/>
                <!-- BLL36a end -->

                <apex:inputField value="{!dealer__Deal__c.dealer__Buyer_County__c}" id="buyer_county" />
                <apex:outputField value="{!dealer__Deal__c.GPC_Fleet__c}"/>
                
                <!-- BLL27d apex:inputField value=" { ! dealer__Deal__c.DeliveryAtStore__c}" id="deliveryAtStore"/ --><!-- BLL20a -->

                <!-- BLL35a -->

	<apex:pageBlockSectionItem rendered="{!OR(ISNULL(dealer__Deal__c.dealer__Status__c),dealer__Deal__c.dealer__Status__c=='Pending')}">
				<apex:outputLabel >Proposal Type</apex:outputLabel>
	<apex:actionRegion >
						<apex:inputField value="{!dealer__Deal__c.dealer__Deal_Type__c}" id="dealType" required="true" >
                    <apex:actionSupport event="onchange" action="{!chgDeaLType}" reRender="pbCMC,page_messages,sec_chassis_conversion"/><!-- BLL36a -->
                </apex:inputField>
	</apex:actionRegion>
	</apex:pageBlockSectionItem>
	
				<apex:outputField value="{!dealer__Deal__c.dealer__Deal_Type__c}" id="dealTypeDsp"
                    rendered="{!AND(NOT(ISNULL(dealer__Deal__c.dealer__Status__c)),dealer__Deal__c.dealer__Status__c!='Pending')}"/>
                <apex:inputField value="{!dealer__Deal__c.Accepted_Date__c}" rendered="{!recordTypeName='Commercial'}"/>
                <apex:outputText rendered="{!recordTypeName!='Commercial'}"/>
                
                <apex:inputField value="{!dealer__Deal__c.Funding_option__c}"/>
                <apex:inputField value="{!dealer__Deal__c.Customer_Financing_Source__c}"/>
                <!-- BLL35a end -->

				<!-- BLL51a required prescription or other certification for tax reduction -->
				<apex:pageBlockSectionItem rendered="{!NOT(ISBLANK(TaxCertificateRequired))}">
				<apex:outputLabel for="HaveClientCert">
					Client&apos;s {!TaxCertificateRequired} is on file
				</apex:outputLabel>
				<apex:inputField id="HaveClientCert" value="{!dealer__Deal__c.HaveRequiredTaxCert__c}"/>
				</apex:pageBlockSectionItem>
				<apex:pageBlockSectionItem rendered="{!NOT(ISBLANK(TaxCertificateRequired))}"/>
				<!-- BLL51a end -->
                
                <!-- BLL36a -->
                <!-- Commercial fields -->
                <apex:inputField value="{!dealer__Deal__c.New_Customer__c}" rendered="{!RecordTypeName='Commercial'}" required="{!IF(deal.Id!=null,'true','false')}"/>
                <apex:inputField value="{!dealer__Deal__c.Job_Reference__c}" rendered="{!RecordTypeName='Commercial'}"/>
                <apex:inputField value="{!dealer__Deal__c.Market_Segment__c}" rendered="{!RecordTypeName='Commercial'}" required="{!IF(deal.Id!=null,'true','false')}"/>
                <apex:inputField value="{!dealer__Deal__c.Customer_Purchase_Order__c}" rendered="{!RecordTypeName='Commercial'}"/>
                <apex:outputText />
                <!-- BLL36a end -->
                
            </apex:pageBlockSection>

<!-- BLL36a delivery information -->
<apex:pageBlockSection title="Delivery information" collapsible="true" id="deliverySection"><!-- BLL38 remove rendered="{ ! RecordTypeName='Commercial' } " -->
    <apex:inputField value="{!dealer__Deal__c.Deliver_to__c}" label="Drop-ship to">
        <apex:actionSupport event="onchange" action="{!chgDeliverTo}" reRender="deliverySection"/>
    </apex:inputField>
    <apex:inputField value="{!dealer__Deal__c.Delivery_Store__c}" rendered="{!dealer__Deal__c.Deliver_to__c=='Store'}">
        <apex:actionSupport event="onchange" action="{!chgDeliverTo}" reRender="deliverySection"/>
    </apex:inputField>
    <apex:outputText rendered="{!dealer__Deal__c.Deliver_to__c!='Store'}"/>
    <apex:inputField value="{!dealer__Deal__c.dealer__Delivery_Street__c}"/>
    <apex:inputField value="{!dealer__Deal__c.dealer__Delivery_City__c}"/>
    <apex:inputField value="{!dealer__Deal__c.dealer__Delivery_State__c}"/>
    <apex:inputField value="{!dealer__Deal__c.DeliveryPostalCode__c}"/>
    <apex:inputField value="{!dealer__Deal__c.dealer__Delivery_Notes__c}"/>
</apex:pageBlockSection>
<!-- BLL36a end -->

            <apex:pageBlockSection title="CMC Team" id="pbCMC" collapsible="true">
                <apex:inputField value="{!dealer__Deal__c.dealer__Salesperson_1__c}" id="cmc_1" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Salesperson_2__c}" id="cmc_2" />

                <apex:inputField value="{!dealer__Deal__c.dealer__Desk_Manager__c}" id="cmc_3" />
                <!-- BLL31d apex:inputField value="{!dealer__Deal__c.dealer__F_I_Manager__c}" id="cmc_4" / -->
                <!-- BLL35d apex:outputText / --><!-- BLL31a -->

                <!-- BLL35d apex:inputField value="{!dealer__Deal__c.dealer__Deal_Type__c}" id="dealType" 
                    rendered="{!OR(ISNULL(dealer__Deal__c.dealer__Status__c),dealer__Deal__c.dealer__Status__c=='Pending')}"/ --><!-- BLL15c add rendered -->
                <!-- BLL35d apex:outputField value="{!dealer__Deal__c.dealer__Deal_Type__c}" id="dealTypeDsp"
                    rendered="{!AND(NOT(ISNULL(dealer__Deal__c.dealer__Status__c)),dealer__Deal__c.dealer__Status__c!='Pending')}"/ --><!-- BLL15a -->
                <apex:inputField value="{!dealer__Deal__c.dealer__Store_Location__c}" id="CompanyNumber" />

                <apex:inputField value="{!dealer__Deal__c.Sales_Admin__c}" id="d_salesAdmin"/>
                <apex:outputField value="{!dealer__Deal__c.dealer__Sales_Lead__c}" id="d_saleslead" />

                <apex:inputField value="{!dealer__Deal__c.dtmob__Service_Manager__c}" id="d_servicemanager" /><!-- BLL34c -->
                <apex:outputField value="{!dealer__Deal__c.dealer__DeliveryRepairOrder__c}" id="d_ro" /><!-- BLL34c --> 
            </apex:pageBlockSection>

            <apex:pageBlockSection columns="2" id="SystemInformation">
                <apex:pageBlockSectionItem >
                    <apex:outputText value="Created By:" styleClass="labelCol vfLabelColTextWrap  last"/>
                    <apex:outputText />
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem >
                    <apex:outputText value="Last Modified By:" styleClass="labelCol vfLabelColTextWrap  last"/>
                    <apex:outputText />
                </apex:pageBlockSectionItem> 

                <apex:pageBlockSectionItem >
                        <apex:outputField value="{!dealer__Deal__c.CreatedById}" />
                        <apex:outputField value="{!dealer__Deal__c.CreatedDate}" />
                </apex:pageBlockSectionItem>                
                <apex:pageBlockSectionItem >            
                        <apex:outputField value="{!dealer__Deal__c.LastModifiedById}" />
                        <apex:outputField value="{!dealer__Deal__c.LastModifiedDate}" />
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>

            <apex:pageBlockSection title="Co-Buyer" collapsible="true" id="coBuyerBlock" rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
                <apex:inputField value="{!dealer__Deal__c.dealer__Co_Buyer__c}" id="co_buyer" onchange="loadCoBuyerRecord();" />
                <apex:inputField value="{!dealer__Deal__c.And_Or_Contract__c}" id="andOrContract" />

                <apex:inputField value="{!dealer__Deal__c.dealer__Co_Buyer_Contact__c}" id="co_buyer_cont" onchange="loadCoBuyerRecord();" />
                <apex:outputText />

                <apex:inputField value="{!dealer__Deal__c.dealer__Co_Buyer_Address__c}" id="co_buyer_address" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Co_Buyer_Home_Phone__c}" id="co_buyer_homephone" />

                <apex:inputField value="{!dealer__Deal__c.dealer__Co_Buyer_City__c}" id="co_buyer_city" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Co_Buyer_Mobile_Phone__c}" id="co_buyer_mobilephone" />

                <apex:inputField value="{!dealer__Deal__c.dealer__Co_Buyer_County__c}" id="co_buyer_county" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Co_Buyer_Email__c}" id="co_buyer_email" />

                <apex:inputField value="{!dealer__Deal__c.dealer__Co_Buyer_State__c}" id="co_buyer_state" />
                <apex:outputText />

                <apex:inputField value="{!dealer__Deal__c.dealer__Co_Buyer_Postal_Code__c}" id="co_buyer_zip" />
                <apex:outputText />

            </apex:pageBlockSection>

            <apex:pageBlockSection title="Title Information" collapsible="true" id="pbTitleInfo" rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
                <apex:inputField value="{!dealer__Deal__c.dealer__Business_Title__c}" id="businessTitle" />
                <apex:outputText />

                <apex:inputField value="{!dealer__Deal__c.dealer__Business_Contracting_Name__c}" id="businessContractName" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Business_Phone__c}" id="busnessPhone" />

                <apex:inputField value="{!dealer__Deal__c.dealer__Business_Address__c}" id="businessAddress" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Business_City__c}" id="businessCity" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Business_State__c}" id="businessState" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Business_Postal_Code__c}" id="businessPostalCode" />

            </apex:pageBlockSection>

    <!-- BLL36a Releasing dealer -->
    <apex:pageBlockSection title="Releasing Dealer" collapsible="true" columns="2" rendered="{!AND(RecordTypeName='Commercial',dealer__Deal__c.dealer__Deal_Type__c='Chassis/Conversion')}">
        <apex:inputField value="{!dealer__Deal__c.ReleasingDealer__c}" id="releasingdealer"/>
        <apex:outputField value="{!dealer__Deal__c.Releasing_Dealer_Tax_ID__c}"/>
        <apex:inputField value="{!dealer__Deal__c.Preferred_Releasing_Dealer__c}" label="Releasing dealer notes"/>
        <apex:outputText />
        <!-- not using apex:inputField value="{!dealer__Deal__c.ReleasingDealerCollectsTax__c}"/ -->
    </apex:pageBlockSection>
    <!-- BLL36a end -->

            <span id="sec_chassis"></span>

            <!-- 
                4502 (Car Grant / Auto Grant) - VA Billing code for veterans first chassis purchase
                    * Add dialog to capture this dollar value, VA Office, 
                    * This dollar value is non-taxable (reduces taxable base)
            -->

            <!-- Retial Vehicle Sale Section -->
            <apex:outputText rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}" id="dealCalcBlock">
            <apex:pageBlockSection title="{!SUBSTITUTE(deal.dealer__Deal_Type__c,'_',' ')}" id="sec_chassis_conversion" collapsible="false" columns="1">

                <apex:commandButton action="{!saveProposal}" value="Save" styleClass="btn-info btn-sm" id="saveButtonVehicleTop"/>
                <!-- BLL36d apex:outputText / -->

                <!-- BLL36a -->
                <apex:inputField value="{!dealer__Deal__c.Chassis_QTY__c}" style="width:4em;" label="Chassis Qty" id="quantity" 
                    rendered="{!AND(isVehicleSale,recordTypeName=='Commercial',dealer__Deal__c.dealer__Deal_Type__c!='Wholesale')}"/>
                <apex:inputField value="{!dealer__Deal__c.Vehicle_Source__c}" required="true"  
                    rendered="{!AND(isVehicleSale,dealer__Deal__c.dealer__Deal_Type__c!='Wholesale',OR(ISNULL(dealer__Deal__c.dealer__Status__c),dealer__Deal__c.dealer__Status__c=='Pending'))}">
                    <apex:actionSupport event="onchange" action="{!noaction}" reRender="sec_chassis_conversion,page_messages"/>
                </apex:inputField>
                <apex:outputField value="{!dealer__Deal__c.Vehicle_Source__c}" 
                    rendered="{!AND(isVehicleSale,dealer__Deal__c.dealer__Deal_Type__c!='Wholesale',NOT(ISNULL(dealer__Deal__c.dealer__Status__c)),dealer__Deal__c.dealer__Status__c!='Pending')}"/>
                <!-- BLL36a end -->


                <!-- BLL36a Build To Order -->
				<!-- BLL63 -->
                <!-- apex:pageblocksectionitem rendered=" { ! OR(dealer__Deal__c.Vehicle_Source__c=='Order',dealer__Deal__c.Vehicle_Source__c=='Customer Owned') } " -->
				<apex:pageblocksectionitem rendered="{!OR(AND(recordTypeName=='Commercial',OR(dealer__Deal__c.Vehicle_Source__c=='Order',dealer__Deal__c.Vehicle_Source__c=='Customer Owned')),dealer__Deal__c.Commercial_Quote__c!=null)}">
				<!-- BLL63 end -->
                    <apex:outputLabel value="Build Order"/>
                    <apex:outputPanel >
                        <apex:inputField value="{!dealer__Deal__c.Commercial_Quote__c}" label="Build Order" rendered="{!dealer__Deal__c.Commercial_Quote__c==null}"/>
                        <apex:outputField value="{!dealer__Deal__c.Commercial_Quote__c}" style="margin-left:2em;" 
                            rendered="{!dealer__Deal__c.Commercial_Quote__c!=null}"/>
                        <apex:outputText value="({!dealer__Deal__c.Commercial_Quote__r.Chassis_QTY__c} unit{!IF(dealer__Deal__c.Commercial_Quote__r.Chassis_QTY__c>1,'s','')})"
                            style="margin-left:2em;" rendered="{!dealer__Deal__c.Commercial_Quote__c!=null}"/>
                        <apex:commandButton value="Remove Build Order" styleClass="btn btn-xs" style="margin-left:2em;" 
                            action="{!removeCommercialQuote}" rendered="{!AND(dealer__Deal__c.Commercial_Quote__c!=null,NOT(BEGINS(dealer__Deal__c.dealer__Status__c,'Won')))}" /> <!-- BLL36a -->
                        <apex:commandButton value="Create New Build Order" styleClass="btn btn-info btn-xs" style="margin-left:2em;" 
                            action="{!createCommercialQuote}" rendered="{!dealer__Deal__c.Commercial_Quote__c==null}" /> <!-- BLL36a -->
                    </apex:outputPanel>
                </apex:pageblocksectionitem>

                    <apex:outputText rendered="{!AND(isVehicleSale,OR(dealer__Deal__c.Vehicle_Source__c=='Order',dealer__Deal__c.Vehicle_Source__c=='Customer Owned'))}">
                    <table style="margin-left: 5em;width:100%;">
                    <tr>
                        <td>
                            <apex:outputLabel value="Chassis MFG" style="margin-right: 1em;"/>
                            <apex:outputField value="{!dealer__Deal__c.Commercial_Quote__r.Chassis_MFG__c}"/>
                        </td>
                        <td>
                            <apex:outputLabel value="Platform" style="margin-right: 1em;"/>
                            <apex:outputField value="{!dealer__Deal__c.Commercial_Quote__r.Chassis_Platform__c}"/>
                        </td>
                        <td>
                            <apex:outputLabel value="Wheelbase" style="margin-right: 1em;"/>
                            <apex:outputField value="{!dealer__Deal__c.Commercial_Quote__r.Chassis_Platform_Wheelbase__c}"/>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3">
                            <apex:outputLabel value="Chassis" style="margin-right: 1em;"/>
                            <apex:outputField value="{!dealer__Deal__c.Commercial_Quote__r.Chassis__c}"/>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3">
                            <apex:outputLabel value="Chassis description" style="margin-right: 1em;"/>
                            <apex:outputField value="{!dealer__Deal__c.Commercial_Quote__r.Chassis_Description__c}"/>
                        </td>
                    </tr>
                </table>
                </apex:outputText>
                <!-- BLL36a end -->

                <!-- BLL36a -->
                <apex:outputPanel layout="block" styleClass="myheader myhide" rendered="{!AND(isVehicleSale,OR(dealer__Deal__c.Vehicle_Source__c=='Order',dealer__Deal__c.Vehicle_Source__c=='Customer Owned'),dealer__Deal__c.Commercial_Quote__c!=null)}"
                    onclick="javascript:mytoggle(this, 'quoteequipment');">
                    <apex:outputText ><div class="twistyicon" style="width:11px;height:11px;">&nbsp;</div>
                        Ordered Equipment
                    </apex:outputText>
                </apex:outputPanel>
                <apex:pageBlockTable styleclass="collapse" id="quoteequipment" value="{!oem.Commercial_Quote_Lines__r}" 
                    var="oemequip">
                    <!-- apex:facet name="caption">Conversion OEM Equipment</apex:facet -->
                    <apex:column value="{!oemequip.Quantity__c}">
                        <apex:facet name="header">Qty per<br/>Chassis</apex:facet>
                    </apex:column>
                    <apex:column value="{!oemequip.Commercial_Quote_Options__c}"/>
                    <apex:column value="{!oemequip.Description__c}"/>
                    <apex:column value="{!oemequip.RecordTypeName__c}"><!-- Line_Type__c -->
                        <apex:facet name="header">Option Type</apex:facet>
                    </apex:column>
                </apex:pageBlockTable>
                <!-- BLL36a end -->


                <!-- Equipment Only Sale, Financial Products or Build on Customer Chassis-->       
                <apex:pageBlockSectionItem rendered='{!AND(isCustomerVehicle,NOT(dealer__Deal__c.Chassis_QTY__c>1))}'
                    labelStyleClass="{!IF(AND(isCustomerVehicle,NOT(dealer__Deal__c.Chassis_QTY__c>1)),'','nondisplay')}"
                    dataStyleClass="{!IF(AND(isCustomerVehicle,NOT(dealer__Deal__c.Chassis_QTY__c>1)),'','nondisplay')}"> <!-- BLL36d was rendered="{!IF(recordTypeName=='Equipment_Only_Sale',true,false)}" -->
                    <apex:outputLabel styleClass="{!IF(AND(isCustomerVehicle,NOT(dealer__Deal__c.Chassis_QTY__c>1)),'','nondisplay')}"
                    >Customer Owned Vehicle</apex:outputLabel><!-- BLL36a -->
                    <apex:outputPanel layout="none" >
                    <apex:inputField value="{!dealer__Deal__c.dealer__Service_Vehicle__c}" id="serviceVehicle" 
                        label="{!IF(isCustomerVehicle,'Customer Owned Vehicle','Service Vehicle')}" /><!-- BLL34c, BLL39c -->
                    <button type="button" class="btn btn-sm btn-primary" onclick="$dt('#addServiceVehicle').modal('show');">Add New Customer Owned Vehicle</button>
                    <!-- Modal for the addition of a Service Vehicle -->
                    <div class="modal fade" id="addServiceVehicle" role="dialog">
                      <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h4 class="modal-title">New Customer Owned Vehicle</h4>
                          </div>
                          <div class="modal-body">
                            <table class="table">
                                <tr>
                                    <td>VIN</td>
                                    <td><input type="text" id="sv_VIN" style="width:450px;" /></td>
                                </tr>
                                <tr>
                                    <td>Year</td>
                                    <td><input type="text" id="sv_Year" maxlength="4" /></td>
                                </tr>
                                <tr>
                                    <td>Make</td>
                                    <td><input type="text" id="sv_Make" /></td>
                                </tr>
                                <tr>
                                    <td>Model</td>
                                    <td><input type="text" id="sv_Model" /></td>
                                </tr>                                
                                <tr>
                                    <td>Odometer</td>
                                    <td><input type="number" id="sv_Odometer" /></td>
                                </tr>
                                <tr><!-- BLL47a -->
                                    <td>Exterior Color</td>
                                    <td><input type="text" id="sv_ExteriorColor" /></td>
                                </tr><!-- BLL47a end -->
                            </table>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-default btn-info btn-xs" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary btn-info btn-xs" id="saveVehicle" onclick="saveCustomerVehicle();">Save Vehicle</button>
                          </div>                                
                        </div>
                      </div>
                    </div>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <!-- End Equipment Only Sale -->


                <!-- Chassis / Conversion Sale -->
                <apex:pageBlockSectionItem rendered="{!AND(isVehicleSale,NOT(dealer__Deal__c.Chassis_QTY__c>1))}"> <!-- BLL36c was rendered="{!recordTypeName!='Equipment_Only_Sale'}" -->
                    <apex:outputLabel value="Stock Vehicle" for="vehicle" />
                    <apex:outputPanel ><!-- BLL36a -->
                        <apex:outputLink value="/{!dealer__Deal__c.dealer__Vehicle__c}" id="vehicle" target="_blank" style="width:450px;"> <!--  BLL17c was rendered=" { ! IF(dealer__Deal__c.dealer__Deal_Type__c=='Retail Vehicle Sale', true, false)}" -->
                            <!-- BLL26d apex:outputText value="{!dealer__Deal__c.dealer__Vehicle__r.Name}"/ -->
                            <apex:outputField value="{!dealer__Deal__c.dealer__Vehicle__c}"/><!-- BLL26a -->
                        </apex:outputLink>
                        <apex:outputText value="({!dealer__Deal__c.dealer__Vehicle__r.Division__c})" style="margin-left:1.5em;" rendered="{!AND(dealer__Deal__c.dealer__Vehicle__c!=null,dealer__Deal__c.dealer__Vehicle__r.Division__c!=null)}"/>   
                        <apex:commandButton value="Remove Vehicle" styleClass="btn btn-xs" style="margin-left:2em;" 
                            action="{!removeVehicle}" rendered="{!dealer__Deal__c.dealer__Vehicle__c!=null}" /> <!-- BLL36a -->
                        <apex:commandButton value="Advanced Search" styleClass="btn btn-info btn-sm" style="margin-left:2em;" 
                            action="{!navigateAdvancedSearch}" disabled="{!ISBLANK(dealer__Deal__c.Id)}" rendered="{!isVehicleSale}"/> <!-- BLL36c was rendered="{!recordTypeName!='Equipment_Only_Sale'}" /--> <!-- BLL17c was rendered=" { ! IF(dealer__Deal__c.dealer__Deal_Type__c=='Retail Vehicle Sale', true, false)}"/  -->
                    </apex:outputPanel><!-- BLL36a -->
                 </apex:pageBlockSectionItem>
                 <!--  apex:outputText rendered=" { ! recordTypeName=='Equipment_Only_Sale' } "/--><!-- BLL23a -->
                <!-- End Chassis Conversion Sale -->
                
    <!-- BLL36a commercial chassis info -->
    <!-- BLL36a end -->
                
                <apex:inputField value="{!dealer__Deal__c.Conversion_Description__c}" id="conversionDescription" 
                                 html-data-autoresize="auto" style="width:100%"  
                                 rendered="{!isVehicleSale}"/><!-- BLL36c -->
                                 <!-- BLL36d was rendered="{!IF(recordTypeName=='Equipment_Only_Sale',false,true)}"/ -->
                <!-- 
                <apex:inputField value="{!dealer__Deal__c.dealer__Vehicle__c}" id="vehicle" style="width:400px;" />
                -->
                <apex:inputField value="{!dealer__Deal__c.dealer__Mileage__c}" id="odometer" rendered="{!OR(isVehicleSale,isCustomerVehicle)}"/>

                <!-- BLL36a -->
                <apex:outputPanel layout="block" styleClass="myheader myhide" 
                    rendered="{!AND(isVehicleSale,dealer__Deal__c.dealer__Vehicle__c!=null,dealer__Deal__c.dealer__Deal_Type__c!='Wholesale',vehHasCommercialOptions)}"
                    onclick="javascript:mytoggle(this, 'vehicleequipment');">
                    <apex:outputText ><div class="twistyicon" style="width:11px;height:11px;">&nbsp;</div>
                        Stock Unit Equipment
                    </apex:outputText>
                </apex:outputPanel>
                <apex:pageBlockTable styleclass="collapse" id="vehicleequipment" value="{!vehicle.Vehicle_Commercial_Options__r}" var="vehequip" 
                    rendered="{!AND(isVehicleSale,dealer__Deal__c.dealer__Vehicle__c!=null,dealer__Deal__c.dealer__Deal_Type__c!='Wholesale',vehHasCommercialOptions)}">
                    <!-- apex:facet name="caption">Conversion OEM Equipment on Vehicle</apex:facet -->
                    <apex:column value="{!vehequip.Quantity__c}"/>
                    <apex:column value="{!vehequip.CommercialQuoteOption__c}"/>
                    <apex:column value="{!vehequip.Description__c}"/>
                    <apex:column value="{!vehequip.OptionType__c}"/><!-- Line_Type__c -->
                    <apex:column ><!-- Line_Type__c -->
                        <apex:facet name="header">Print</apex:facet>
                        <apex:inputField value="{!vehequip.Flag1__c}"/>
                    </apex:column>
                </apex:pageBlockTable>
                <!-- BLL36a end -->


<!-- BLL23a Chassis sale but we dont have the vehicle yet -->
<!-- need to verify these fields are *always* getting set when a vehicle is attached to the deal! -->
<!-- need to update proposal printout, but NOT other paperwork to use these fields instead of going through the vehicle. -->
<apex:outputPanel layout="none" rendered="{!isVehicleSale}"  
><!-- rendered=" { ! AND(isVehicleSale,dealer__Deal__c.dealer__Deal_Type__c!='Wholesale',dealer__Deal__c.dealer__Vehicle__c==null)}"--><!-- BLL48c add rendered -->
<table id="newVehicleVINtable" cellpadding="5" width="100%" style="margin-bottom:1em;">
<tr>
    <td colspan="5">For a vehicle not yet in stock...</td>
</tr>
<tr>
	<td>
	    <apex:outputLabel >VIN</apex:outputLabel><br/>
	    <apex:inputField value="{!dealer__Deal__c.dealer__VIN__c}" id="nonstockVIN"/>
	</td>
	<td>
	    <apex:outputLabel >Year</apex:outputLabel><br/>
	    <apex:inputField value="{!dealer__Deal__c.dealer__Year__c}" id="nonstockYear"/>
	</td>
	<td>
	    <apex:outputLabel >Make</apex:outputLabel><br/>
	    <apex:inputField value="{!dealer__Deal__c.dealer__Make__c}" id="nonstockMake"/>
	</td>
	<td>
	    <apex:outputLabel >Model</apex:outputLabel><br/>
	    <apex:inputField value="{!dealer__Deal__c.dealer__Model__c}" id="nonstockModel"/>
	</td>
	<td>
	    <apex:outputLabel >Exterior Color</apex:outputLabel><br/>
	    <apex:inputField value="{!dealer__Deal__c.dealer__Exterior_Color__c}" id="nonstockColor"/>
	</td>
</tr>
</table>
</apex:outputPanel>

</apex:pageBlockSection><!-- BLL36a -->

<!-- BLL36d apex:outputText rendered="{!AND(dealer__Deal__c.dealer__Vehicle__c==null,recordTypeName!='Equipment_Only_Sale')}"/ -->
<!-- BLL23a end -->

<span id="sec_recap"></span><!-- BLL40a -->
<apex:pageBlockSection id="recap" title="Financial Recap" columns="1" collapsible="false"><!-- BLL36a -->
<apex:outputText ><!-- BLL36a -->

                <!-- Worksheet Block -->
                <table width="100%" class="table table-condensed">
                    <!-- Chassis Cost and Sale -->
                      <apex:outputPanel rendered="{!isVehicleSale}" > <!-- BLL36c was rendered="{!IF(recordTypeName=='Equipment_Only_Sale',false,true)}" -->
                      <tr>
                        <td>Chassis Cost</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Chassis_Cost__c}" id="chassis_cost" styleClass="dCalc" /></td>
                        <td>WIP&nbsp;<apex:inputField value="{!dealer__Deal__c.WIP__c}" id="wip" /></td>
                        <td>Chassis Sale
                            <apex:outputPanel layout="none" rendered="{!showChassisTaxableBox}">
                            <span style="float:right;font-size:10px;">
                                Taxable?&nbsp;<apex:inputField value="{!dealer__Deal__c.ChassisTaxable__c}" id="chassis_taxable" />
                            </span>
                            </apex:outputPanel>
                        </td>
                        <td><apex:inputField value="{!dealer__Deal__c.Chassis_Price__c}" id="chassis_price" styleClass="dCalc"/></td>
                        <td style="text-align:right;">
                            <apex:outputText rendered="{!AND(NOT(ISBLANK(dealer__Deal__c.Chassis_Price__c)), NOT(ISBLANK(dealer__Deal__c.Chassis_Cost__c)))}">
                            <apex:outputText value="{0, number, ###,###.00}">
                                <apex:param value="{!dealer__Deal__c.Chassis_Price__c - dealer__Deal__c.Chassis_Cost__c}" />
                            </apex:outputText>
                            </apex:outputText>
                        </td><!-- GP -->
                        <td style="text-align:right;">
                            <apex:outputText rendered="{!AND(NOT(ISBLANK(dealer__Deal__c.Chassis_Price__c)), NOT(ISBLANK(dealer__Deal__c.Chassis_Cost__c)), IF(dealer__Deal__c.Chassis_Cost__c!=0,true,false))}">
                            <apex:outputText value="{0, number, #.00}%"> 
                                <apex:param value="{!((dealer__Deal__c.Chassis_Price__c - dealer__Deal__c.Chassis_Cost__c) / dealer__Deal__c.Chassis_Cost__c) * 100}" />
                            </apex:outputText>
                            </apex:outputText>
                        </td><!-- PCT -->
                      </tr>
                      <!-- BLL18a -->
                      <apex:outputPanel layout="none" rendered="{!AND(isVehicleSale,useFMV)}"> <!-- BLL36c was rendered="{!AND(recordTypeName!='Equipment_Only_Sale',useFMV)}"-->
                      <tr>
                        <td colspan="3">
                            <apex:outputLink value="{!fmvURL}" rendered="{!NOT(ISBLANK(fmvURL))}" target="_blank">
                            {!fmvURL}
                            </apex:outputLink>
                        </td>
                        <td>Fair Market Value</td>
                        <td>
                            <apex:inputField value="{!dealer__Deal__c.FairMarketValue__c}" id="fair_market_value" styleClass="dCalc" />
                        </td>
                        <td></td>
                        <td></td>
                      </tr>
                      </apex:outputPanel>
                      <!-- BLL18a end -->
                      </apex:outputPanel>

                      <!-- Conversion Cost and Sale -->
                      <apex:outputText rendered="{!isVehicleSale}"><!-- BLL36c was rendered="{!IF(recordTypeName=='Equipment_Only_Sale',false,true)}"-->
                      <tr >
                        <td>Conversion Cost</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Conversion_Cost__c}" id="conversion_cost" styleClass="dCalc" /></td>
                        <td>&nbsp;</td>
                        <td>Conversion Sale
                            <span style="float:right;font-size:10px;">
                                Non-Medical?&nbsp;<apex:inputField value="{!dealer__Deal__c.Conversion_Taxable__c}" id="conversion_taxable" />
                                 <br/>Tax Exempt?&nbsp;<apex:inputField value="{!dealer__Deal__c.ConversionExempt__c}" id="conversion_exempt" /><!-- BLL29a -->
                            </span>
                        </td>
                        <td><apex:inputField value="{!dealer__Deal__c.Conversion_Price__c}" id="conversion_price" styleClass="dCalc"/></td>
                        <td style="text-align:right;">
                            <apex:outputText value="{0, number, ###,###.00}">
                                <apex:param value="{!dealer__Deal__c.Conversion_Price__c - dealer__Deal__c.Conversion_Cost__c}" />
                            </apex:outputText>
                        </td><!-- GP -->
                        <td style="text-align:right;">
                            <apex:outputText value="{0, number, #.00}%" rendered="{!AND(NOT(ISBLANK(dealer__Deal__c.Conversion_Cost__c)), IF(dealer__Deal__c.Conversion_Cost__c!=0,true,false))}"> 
                                <apex:param value="{!((dealer__Deal__c.Conversion_Price__c - dealer__Deal__c.Conversion_Cost__c) / dealer__Deal__c.Conversion_Cost__c) * 100}" />
                            </apex:outputText>
                        </td><!-- PCT -->
                      </tr>
                      </apex:outputText>

                      <!-- Pack & Total chassis+conversion cost -->
                      <apex:outputText rendered="{!isVehicleSale}"><!-- BLL36c was rendered="{!IF(recordTypeName=='Equipment_Only_Sale',false,true)}"-->
                      <tr>
                        <td>Store Pack</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Pack__c}" id="pack" styleClass="dCalc"/>
                        </td>
                        <td>&nbsp;</td>
                        <td><b>Total Chassis &amp; Conversion</b></td>
                        <td>
                            <apex:inputField value="{!dealer__Deal__c.dealer__Sale_Cost__c}" id="totChassisConvCost" styleClass="dCalc readonly"
                                onfocus="this.blur();"/><!-- BLL36c readonly -->
                        </td>
                        <td style="text-align:right;"><!-- BLL21a show amount here too since it affects GP -->
                            <apex:outputText value="Pack -{0, number, ###,###.##}">
                                <apex:param value="{!dealer__Deal__c.Pack__c}"/>
                            </apex:outputText>
                        </td>
                        <td>&nbsp;</td>
                      </tr>
                      </apex:outputText>

                      <!-- GP Sharing - BLL49a -->
                      <apex:outputText rendered="{!AND(dealer__Deal__c.GP_Sharing_Amount__c!=null, dealer__Deal__c.GP_Sharing_Amount__c!=0)}">
                      <tr>
                        <td>GP Sharing -&nbsp;<apex:outputField value="{!dealer__Deal__c.GP_Sharing_Location__c}"/></td>
                        <td style="text-align:right;"><apex:outputField value="{!dealer__Deal__c.GP_Sharing_Amount__c}" id="gpsharing"/>
                        </td>
                        <td>&nbsp;</td>
                        <td></td>
                        <td></td>
                        <td style="text-align:right;font-weight:bold;color:{!IF(dealer__Deal__c.GP_Sharing_Amount__c>0,'darkred','darkgreen')}"><!-- BLL21a show amount here too since it affects GP -->
                            <apex:outputText value="GP Sharing {0, number, ###,###.##}">
                                <apex:param value="{!-dealer__Deal__c.GP_Sharing_Amount__c}"/>
                            </apex:outputText>
                        </td>
                        <td>&nbsp;</td>
                      </tr>
                      </apex:outputText>

                      <!-- Equipment Sales -->
                      <tr>
                        <td>Adaptive Equipment Cost</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Total_Internal_Local_Equipment__c}" id="equipmentSale" styleClass="dCalc readonly" 
                            onfocus="this.blur();"/></td><!-- BLL36c onfocus -->
                        <td>&nbsp;</td>
                        <td>Adaptive Equipment Sale</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Total_Additional_Equipment__c}" id="totalAdditionalEquipment" styleClass="dCalc readonly"
                            onfocus="this.blur();"/></td><!-- BLL36c onfocus -->
                        <td style="text-align:right;">
                            <apex:outputText value="{0, number, ###,###.00}">
                                <apex:param value="{!dealer__Deal__c.Total_Additional_Equipment__c - dealer__Deal__c.Total_Internal_Local_Equipment__c}" />
                            </apex:outputText>
                        </td><!-- GP -->
                        <td style="text-align:right;">
                            <apex:outputText value="{0, number, #.00}%" rendered="{!AND(IF(dealer__Deal__c.Total_Additional_Equipment__c != 0, true, false), IF(dealer__Deal__c.Total_Internal_Local_Equipment__c != 0, true, false))}"> 
                                <apex:param value="{!((dealer__Deal__c.Total_Additional_Equipment__c - dealer__Deal__c.Total_Internal_Local_Equipment__c) / dealer__Deal__c.Total_Additional_Equipment__c) * 100}" /><!-- BLL2 fix calc -->
                            </apex:outputText>
                        </td><!-- PCT -->
                      </tr>

                      <!-- Protection Sales -->
                      <tr>
                        <td>Protection Product Cost</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Warranty_Cost__c}" id="warrantyCost" styleClass="dCalc readonly" 
                            onfocus="this.blur();"/></td><!-- BLL36c onfocus -->
                        <td>&nbsp;</td>
                        <td>Protection Product Sale</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Total_Protection_Products__c}" id="totalProtectionProducts" styleClass="dCalc readonly"
                            onfocus="this.blur();"/></td><!-- BLL36c onfocus -->
                        <td style="text-align:right;" >
                            <!--
                            <apex:outputText value="{0, number, ###,###.00}">
                                <apex:param value="{!dealer__Deal__c.Total_Protection_Products__c - dealer__Deal__c.Warranty_Cost__c}" />
                            </apex:outputText>
                            -->
                        </td><!-- GP -->
                        <td style="text-align:right;">
                            <!--
                            <apex:outputText value="{0, number, #.00}%" rendered="{!IF(dealer__Deal__c.Warranty_Cost__c!=0, true, false)}"> 
                                <apex:param value="{!((dealer__Deal__c.Total_Protection_Products__c - dealer__Deal__c.Warranty_Cost__c) / dealer__Deal__c.Warranty_Cost__c) * 100}" />
                            </apex:outputText>
                            <apex:outputText value="{0, number, #.00}%" rendered="{!IF(dealer__Deal__c.Warranty_Cost__c==0, true, false)}"> 
                                <apex:param value="{!((dealer__Deal__c.Total_Protection_Products__c - dealer__Deal__c.Warranty_Cost__c) / 1) * 100}" />
                            </apex:outputText>  
                            -->                          
                        </td><!-- PCT -->
                      </tr>    

                    <!-- Blank Row -->

                      <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td></td>
                        <td></td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr> 

                    <!-- autogrant -->
                      <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td><a href="#sec_payments">Grants / Other Funding</a></td>
                        <td><apex:inputField value="{!dealer__Deal__c.Grants_Government_Assistance__c}" id="grantTotal" styleClass="dCalc readonly"
                            onfocus="this.blur();"/></td><!-- BLL36c -->
                        <td></td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr>                       

                    <apex:outputPanel layout="none" rendered="{!showRebates}"><!-- BLL36a -->
                      <!-- BLL36a -->
                    <!-- GPC -->
                      <tr style="{!IF(OR(NOT(isVehicleSale),RecordTypeName!='Commercial'),'display:none;','')}">
                        <td></td>
                        <td></td>
                        <td>&nbsp;</td>
                        <td>GPC Amount</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Government_Price_Concession__c}" id="gpcAmount" styleClass="dCalc"/></td>
                        <td></td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr>
                      </apex:outputPanel>
                      <!-- BLL36a end -->

                    <apex:outputPanel layout="none" rendered="{!AND(isVehicleSale, dealer__Deal__c.dealer__Deal_Type__c!='Wholesale')}"><!-- BLL36a -->
                    <!-- Rebate -->
                      <tr>
                        <td>{!IF(RecordTypeName='Commercial','Mobility Rebate','Rebate Description')}</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Rebate_Description__c}" id="rebateDescription" label="1) Rebate Description" styleClass="dCalc" /></td>
                        <td>&nbsp;</td>
                        <td>Rebate Amount</td>
                        <td><apex:inputField value="{!dealer__Deal__c.dealer__Rebate__c}" id="rebate" styleClass="dCalc"/></td>
                        <td></td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr>

                      <!-- BLL36d tr id="rebateRow2Add">
                        <td><span class="glyphicon glyphicon-plus"></span></td>
                        <td colspan="6">&nbsp;</td>
                      </tr BLL36d end -->

                    <!-- Rebate 2-->
                      <tr id="rebateRow2"><!-- BLL36d style="display:none;" -->
                        <td>{!IF(RecordTypeName='Commercial','Commercial Rebate','Rebate Description')}</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Rebate_2_Description__c}" id="rebateDescription2" label="2) Rebate Description" styleClass="dCalc" /></td>
                        <td>&nbsp;</td>
                        <td>Rebate Amount</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Rebate_2__c}" id="rebate2" styleClass="dCalc"/></td>
                        <td></td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr> 


                      <!-- BLL36d tr id="rebateRow3Add" style="display: none;">
                        <td><span class="glyphicon glyphicon-plus"></span></td>
                        <td colspan="6">&nbsp;</td>
                      </tr BLL36d end -->

                    <!-- Rebate 3-->
                      <tr id="rebateRow3"><!-- BLL36d style="display:none;" -->
                        <td>{!IF(RecordTypeName='Commercial','Additional MFG Rebate','Rebate Description')}</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Rebate_3_Description__c}" id="rebateDescription3" label="3) Rebate Description" styleClass="dCalc" /></td>
                        <td>&nbsp;</td>
                        <td>Rebate Amount</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Rebate_3__c}" id="rebate3" styleClass="dCalc"/></td>
                        <td></td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr> 

                    <!-- Rewards -->
                    <tr style="{!IF(OR(NOT(isVehicleSale),RecordTypeName=='Commercial'),'display:none;','')}">
                        <td></td>
                        <td></td>
                        <td>&nbsp;</td>
                        <td>MobilityWorks Rewards</td>
                        <td><apex:inputField value="{!dealer__Deal__c.MBW_Rewards__c}" id="mbwRewards" styleClass="dCalc"/></td>
                        <td></td><!-- GP -->
                        <td></td><!-- PCT -->
                    </tr>
                    
                    </apex:outputPanel><!-- BLL36a -->
                    
                    <apex:outputPanel layout="none" rendered="{!AND(OR(isVehicleSale,BEGINS(dealer__Deal__c.dealer__Deal_Type__c,'Equipment Only')), dealer__Deal__c.dealer__Deal_Type__c!='Wholesale')}"><!-- BLL36a -->
                    <!-- Discount -->
                      <tr>
                        <td>Conversion Discount Reason</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Conversion_Discount_Reason__c}" id="conversionDiscountReason" styleClass="dCalc"/></td>
                        <td>&nbsp;</td>
                        <td>Conversion Discount Amount</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Conversion_Discount__c}" id="conversionDiscount" styleClass="dCalc"/></td>
                        <td style="text-align:right;"><!-- BLL21a show amount here too since it affects GP -->
                            <apex:outputText value="{0, number, ###,###.##}">
                                <apex:param value="{!dealer__Deal__c.Conversion_Discount__c}"/>
                            </apex:outputText>
                        </td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr>
                    </apex:outputPanel><!-- BLL36a -->

                    <!-- Deposit -->
                      <tr>
                        <td>{!IF(dealer__Deal__c.Contract_Type__c='Lease','First Pmt Notes','Deposit Notes')}</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Deposit_Notes__c}" id="depositnotes" styleClass="dCalc"/></td>
                        <td>&nbsp;</td>
                        <td>{!IF(dealer__Deal__c.Contract_Type__c='Lease','First Lease Pmt','Deposit Amount')}</td>
                        <td><apex:inputField value="{!dealer__Deal__c.dealer__Deposit__c}" id="deposit" styleClass="dCalc"/></td>
                        <td></td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr>
                    <!-- Down -->
                      <tr>
                        <td></td>
                        <td></td>
                        <td>&nbsp;</td>
                        <td>{!IF(dealer__Deal__c.Contract_Type__c='Lease','Cap Cost Reduction','Down Payment')}</td>
                        <td><apex:inputField value="{!dealer__Deal__c.dealer__Down_Pymt__c}" id="down" styleClass="dCalc"/></td>
                        <td></td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr>

                    <!-- Trades -->
                    <apex:outputText rendered="{!NOT(ISBLANK(dealer__Deal__c.dealer__Trade_Allowance__c))}">
                      <tr>
                        <td>Trade Payoff</td>
                        <td><apex:inputField value="{!dealer__Deal__c.dealer__Trade_Payoff__c}" id="tradepayoff" styleClass="dCalc readonly"
                            onfocus="this.blur();"/></td><!-- BLL36c onfocus -->
                        <td>&nbsp;</td>
                        <td>Trade Allowance</td>
                        <td><apex:inputField value="{!dealer__Deal__c.dealer__Trade_Allowance__c}" id="tradeallowance" styleClass="dCalc readonly"
                            onfocus="this.blur();"/></td><!-- BLL36c onfocus -->
                        <td style="text-align:right;">
                            OA&nbsp;-<apex:outputText value="{!dealer__Deal__c.dealer__Trade_Allowance__c-dealer__Deal__c.Trade_ACV__c}" id="toa" />
                        </td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr>  
                    </apex:outputText>                   

                    <!-- BLL36a Delivery Freight -->
                    <apex:outputText rendered="{!RecordTypeName=='Commercial'}">
                      <tr><!-- BLL40c add id -->
                        <td>Delivery Freight Cost</td>
                        <td><apex:inputField value="{!dealer__Deal__c.DeliveryFreightCost__c}" id="freightcost" styleClass="dCalc"/></td>
                        <td>&nbsp;</td>
                        <td>Freight Amount</td>
                        <td><apex:inputField value="{!dealer__Deal__c.DeliveryFreightAmount__c}" id="freightamount" styleClass="dCalc"/></td>
                        <td style="text-align:right;">
                            <apex:outputText value="{!dealer__Deal__c.DeliveryFreightAmount__c-dealer__Deal__c.DeliveryFreightCost__c}" id="freightgp" />
                        </td><!-- GP -->
                        <td></td><!-- PCT -->
                      </tr>  
                    </apex:outputText>                   

                    <!-- Fees -->
                      <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>Fees &amp; Taxes</td>
                        <td><apex:inputField value="{!dealer__Deal__c.dealer__Total_Fees__c}" id="totalFees" styleClass="dCalc readonly"
                            onfocus="this.blur();"/></td><!-- BLL36c onfocus -->
                        <td style="text-align:right;"><!-- GP -->
                            <apex:outputText value="{!-dealer__Deal__c.LoanAcquisitionCost__c}" id="feesgp" />
                        </td>
                        <td><!-- PCT -->
                        </td>
                      </tr> 

                    <!-- Taxes -->
                    <!--
                      <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>Taxes</td>
                        <td><apex:inputField value="{!dealer__Deal__c.dealer__Sales_Tax__c}" id="totalTax" styleClass="dCalc" /></td>
                        <td></td>
                        <td></td>
                      </tr>                       
                    -->
                    <apex:inputHidden value="{!dealer__Deal__c.dealer__Sales_Tax__c}" id="totalTax" />

                    <!-- Unit total BLL36a -->
                    <apex:outputPanel layout="none" rendered="{!AND(isVehicleSale,RecordTypeName='Commercial',dealer__Deal__c.dealer__Deal_Type__c!='Wholesale')}">
                      <!-- Unit Total -->
                      <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td><b>Total Per Unit</b></td>
                        <td>
                            <apex:inputField value="{!dealer__Deal__c.TotalUnitPrice__c}" id="totalUnitPrice" styleClass="dCalc readonly"
                                onfocus="this.blur();"/>
                        </td>
                        <td class="aright">
                            CMC Unit Gross &nbsp;
                            <input id="totalUnitGrossInput" value="0" class="dCalc readonly" disabled="disabled" style="width:8em;"/>
                        </td><!-- GP -->
                        <td style="text-align:right;"></td><!-- PCT -->
                      </tr>
                    </apex:outputPanel>
                     
                    <!-- Totals -->
                      <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td><b>Total Proposal</b></td>
                        <td>
                            <apex:inputField value="{!dealer__Deal__c.Total_Price__c}" id="totalPackagePrice" styleClass="dCalc readonly" 
                                onfocus="this.blur();"/>
                        </td>
                        <td style="text-align:right;">
                            CMC Gross &nbsp;
                            <input id="totalGrossInput" value="0" class="dCalc readonly" disabled="disabled"  style="width:8em;"/>
                        </td><!-- GP -->
                        <td style="text-align:right;"></td><!-- PCT -->
                      </tr> 

                      
                </table>
                <!-- Recap Section -->

                <table class="table table-condensed" style="display:none;" id="commissiontable"><!-- BLL24c display:none! id=commissiontable -->
                    <tr>
                        <th colspan="11">Commission</th>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Employee_1__c}" id="commissionemployee1" /></td>
                        <td>Rate</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Rate__c}" id="commissionRate" styleClass="dCalc" style="width:50px;"/></td>
                        <td>Standard</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission__c}" id="commissionTotal" styleClass="dCalc" style="width:75px;"/></td>
                        <td>Flat</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Flat__c}" id="commissionTotalFlat" styleClass="dCalc" style="width:75px;"/></td>
                        <td>F&amp;I</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_FI_1__c}" id="commissionFI1" styleClass="dCalc" style="width:75px;"/></td>                        
                        <td>Total</td>
                        <td><input type="text" value="0" class="dCalc" id="totalCommission1"  style="width:100px;"/></td>
                    </tr>

                    <!-- Second Level Comissions -->
                    <tr id="commRow2Add">
                        <td><span class="glyphicon glyphicon-plus"></span></td>
                        <td colspan="11">&nbsp;</td>
                    </tr>                    
                    <tr id="commRow2" style="display: none;">
                        <td>2</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Employee_2__c}" id="commissionemployee2" /></td>
                        <td>Rate</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Rate_2__c}" id="commissionRate2" styleClass="dCalc" style="width:50px;"/></td>
                        <td>Standard</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_2__c}" id="commissionTotal2" styleClass="dCalc"  style="width:75px;"/></td>
                        <td>Flat</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Flat_2__c}" id="commissionTotalFlat2" styleClass="dCalc"  style="width:75px;"/></td>
                        <td>F&amp;I</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_FI_2__c}" id="commissionFI2" styleClass="dCalc" style="width:75px;"/></td>                          
                        <td>Total</td>
                        <td><input type="text" value="0" class="dCalc" id="totalCommission2"  style="width:100px;"/></td>
                    </tr>  


                    <!-- Third Level Comissions -->
                    <tr id="commRow3Add" style="display: none;">
                        <td><span class="glyphicon glyphicon-plus"></span></td>
                        <td colspan="11">&nbsp;</td>
                    </tr>

                    <tr id="commRow3" style="display: none;">
                        <td>3</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Employee_3__c}" id="commissionemployee3" /></td>
                        <td>Rate</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Rate_3__c}" id="commissionRate3" styleClass="dCalc" style="width:50px;"/></td>
                        <td>Standard</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_3__c}" id="commissionTotal3" styleClass="dCalc" style="width:75px;"/></td>
                        <td>Flat</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Flat_3__c}" id="commissionTotalFlat3" styleClass="dCalc"  style="width:75px;"/></td>
                        <td>F&amp;I</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_FI_3__c}" id="commissionFI3" styleClass="dCalc" style="width:75px;"/></td>                          
                        <td>Total</td>
                        <td><input type="text" value="0" class="dCalc" id="totalCommission3" style="width:100px;"/></td>
                    </tr>  

                    <!-- Third Level Comissions -->
                    <tr id="commRow4Add" style="display: none;">
                        <td><span class="glyphicon glyphicon-plus"></span></td>
                        <td colspan="11">&nbsp;</td>
                    </tr>

                    <tr id="commRow4" style="display: none;">
                        <td>4</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Employee_4__c}" id="commissionemployee4" /></td>
                        <td>Rate</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Rate_4__c}" id="commissionRate4" styleClass="dCalc" style="width:50px;"/></td>
                        <td>Standard</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_4__c}" id="commissionTotal4" styleClass="dCalc" style="width:75px;"/></td>
                        <td>Flat</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_Flat_4__c}" id="commissionTotalFlat4" styleClass="dCalc"  style="width:75px;"/></td>
                        <td>F&amp;I</td>
                        <td><apex:inputField value="{!dealer__Deal__c.Commission_FI_4__c}" id="commissionFI4" styleClass="dCalc" style="width:75px;"/></td>                          
                        <td>Total</td>
                        <td><input type="text" value="0" class="dCalc" id="totalCommission4" style="width:100px;"/></td>
                    </tr>                                                           
                </table>

</apex:outputText><!-- BLL36a -->
</apex:pageBlockSection><!-- BLL36a -->

            </apex:outputText>

            <apex:pageBlockSection columns="2">
                <apex:commandButton action="{!saveProposal}" value="Save" styleClass="btn-info btn-sm" id="saveButtonVehicleBottom" rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}"/>
                <apex:outputText />
            </apex:pageBlockSection>

            <!--apex:outputText rendered="{!IF(recordTypeName=='Retail_Vehicle_Sale',true,false)}"--> <!-- DR1 -->
            <span id="sec_fees"></span>
            <apex:pageBlockSection title="MW Registration Fees" id="sec_fees" collapsible="false"  rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
                <apex:inputField value="{!dealer__Deal__c.GVW_GVWR__c}" id="gvwr" styleClass="dCalc"/>
                <apex:inputField value="{!dealer__Deal__c.dealer__Doc_Fee__c}" id="docfee"  styleClass="dCalc"/>

                <!-- BLL43d apex : outputLink value="https://www.dmv.ca.gov/FeeCalculatorWeb/newVehicleForm.do" target="_blank">CA Fee Calculator</apex:outputLink -->
                <!-- BLL43a -->
                <apex:pageBlockSectionItem >
                    <apex:outputText rendered="{!OR(dealer__Deal__c.dealer__Store_Location__r.dealer__State__c=='CA',dealer__Deal__c.dealer__Buyer_State__c=='CA')}">CA Fee Calculators</apex:outputText> 
                    <apex:outputPanel layout="none" rendered="{!OR(dealer__Deal__c.dealer__Store_Location__r.dealer__State__c=='CA',dealer__Deal__c.dealer__Buyer_State__c=='CA')}">
                        <apex:outputLink value="https://www.dmv.ca.gov/wasapp/FeeCalculatorWeb/newVehicleForm.do" target="_blank" style="margin-right:2em;">New</apex:outputLink>
                        <apex:outputLink value="https://www.dmv.ca.gov/wasapp/FeeCalculatorWeb/usedVehicleForm.do" target="_blank" style="margin-right:2em;">Used</apex:outputLink>
                        <!-- not needed apex:outputLink value="https://www.dmv.ca.gov/wasapp/FeeCalculatorWeb/newResidentForm.do" target="_blank" style="margin-right:2em;">Nonresident</apex:outputLink -->
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <!-- BLL43a end -->
                <apex:inputField value="{!dealer__Deal__c.dealer__License_Fee__c}" id="licFee"  styleClass="dCalc"/>

                <apex:inputField value="{!dealer__Deal__c.Tire_Fee__c}" id="tireFee"   styleClass="dCalc"/>
                <apex:inputField value="{!dealer__Deal__c.Registration_Title_Fee__c}" id="registrationTitleFee"  styleClass="dCalc"/>

                <apex:inputField value="{!dealer__Deal__c.Smog_Fee__c}" id="smogFee"  styleClass="dCalc"/>
                <apex:inputField value="{!dealer__Deal__c.Smog_Cert__c}" id="smogCert"  styleClass="dCalc"/>

                <apex:inputField value="{!dealer__Deal__c.Electronic_Filing_Fee__c}" id="electronicFilingFee"  styleClass="dCalc"/>
                <apex:inputField value="{!dealer__Deal__c.dealer__Sales_Tax__c}" id="salesTax"  styleClass="dCalc"/>

                <!--
                <apex:outputText />
                <apex:commandButton action="{!calcTax}" value="Calculate Sales Tax" styleClass="btn-info btn-sm" reRender="sec_fees"/>

                <apex:outputText />
                <apex:commandButton action="{!postTax}" value="Post Sales Tax" styleClass="btn-info btn-sm" reRender="sec_fees"/>

                <apex:outputText />
                <apex:commandButton action="{!commitTax}" value="Commit Sales Tax" styleClass="btn-info btn-sm" reRender="sec_fees"/>  
                -->

                <!-- BLL40a -->
				<!-- BLL57 -->
				<!--apex:outputField styleClass="dCalc" value="{!dealer__Deal__c.LeaseAcquisitionFee__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/ -->
                <!--apex:outputField styleClass="dCalc" value="{!dealer__Deal__c.LoanAcquisitionCost__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/ -->
                <!--apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c!=null}"/ -->
				<apex:outputField styleClass="dCalc" value="{!dealer__Deal__c.LeaseAcquisitionFee__c}" rendered="{!dealer__Deal__c.Contract_Type__c!=null}"/>
                <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c!=null}"/>
				<!-- BLL64 -->
				<!-- apex:outputField styleClass="dCalc" value=" { ! dealer__Deal__c.LoanAcquisitionCost__c}" rendered=" { ! dealer__Deal__c.Contract_Type__c='Loan'}"/ -->
                <apex:outputField styleClass="dCalc" value="{!dealer__Deal__c.LoanAcquisitionCost__c}" rendered="{!AND(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.dealer__Deal_Type__c!='Financial Products')}"/>
                <apex:outputField styleClass="dCalc" value="{!dealer__Deal__c.ESC_Loan_Cost__c}" rendered="{!AND(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.dealer__Deal_Type__c='Financial Products')}"/>
				<!-- BLL64 end -->
                <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c=='Loan'}"/>
				<!--BLL57 end -->
                <!-- BLL40a end -->
                              
            </apex:pageBlockSection> 
            <!--/apex:outputText--><!-- DR1 -->

<!-- BLL13a -->
<style>
#force th.tablecellalignright {text-align:right;}
#force td.tablecellalignright {text-align:right;}
</style>
    <!-- BLL36d apex:pagemessages id="taxmessages"/ -->
    <apex:pageBlockSection title="Taxes" id="taxsection" columns="4" rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}" collapsible="false">
    <apex:commandButton action="{!pageCalcTax}" value="Calc taxes" 
        styleClass="{!IF(needToRecalcTax,'btn-warning','btn-default')}"
        rerender="salesTax,taxsummarysection,buyer_county,taxsection,taxmessages"/><!--  onclick="showTaxCalcNotice()"/ --><!-- BLL25 add county refresh -->
    <apex:inputField value="{!dealer__Deal__c.DeliveryAtStore__c}" rendered="{!dealer__Deal__c.TaxCommitDT__c==null}"/><!-- BLL27a -->
    <apex:outputField value="{!dealer__Deal__c.DeliveryAtStore__c}" rendered="{!dealer__Deal__c.TaxCommitDT__c!=null}"/><!-- BLL27a -->
    <apex:inputField value="{!dealer__Deal__c.DoNotCollectTax__c}"
        label="{!IF(recordTypeName=='Commercial','Do Not Collect Tax','Do Not Tax Out-of-State')}" 
        rendered="{!dealer__Deal__c.TaxCommitDT__c==null}"/><!-- BLL27a -->
    <apex:outputField value="{!dealer__Deal__c.DoNotCollectTax__c}" rendered="{!dealer__Deal__c.TaxCommitDT__c!=null}"/><!-- BLL27a -->
        
   </apex:pageBlockSection>

    <apex:pageBlockSection columns="1" id="taxsummarysection" rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
        <apex:outputText value="Committed" rendered="{!deal.TaxCommitDT__c!=null}"/>
        <apex:pageBlockTable value="{!Taxes}" var="tax" id="taxdetailsection"> 
            <apex:column value="{!tax.TaxType__c}"/>
            <apex:column value="{!tax.Name}"/>
            <apex:column value="{!tax.JurisName__c}"/>
            <apex:column value="{!tax.Taxable__c}" styleClass="tablecellalignright" headerClass="tablecellalignright"/>
            <apex:column value="{!tax.TaxRate__c}" styleClass="tablecellalignright" headerClass="tablecellalignright"/>
            <apex:column value="{!tax.Tax__c}" styleClass="tablecellalignright" headerClass="tablecellalignright">
                <apex:facet name="footer" >
                    <apex:outputText value="{0,number,$###,##0.00}" style="float:right;">
                        <apex:param value="{!TaxTotal}"/>
                    </apex:outputText>
                </apex:facet>
            </apex:column>
        </apex:pageBlockTable>

    </apex:pageBlockSection>

    <apex:outputPanel layout="none" rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
        <!-- BLL42a -->
        <table class="list" width="50%">
        <thead>
        <tr class="headerRow">
        <th class="headerRow"></th>
        <th class="headerRow" style="text-align:right;">Taxable amt</th>
        <th class="headerRow" style="text-align:right;">Tax rate</th>
        <th class="headerRow" style="text-align:right;">Tax</th>
        </tr>
        </thead>
        
        <tbody>
        <tr class="dataRow">
        <th>Chassis</th>
        <td style="text-align:right;"><apex:outputText value="{0, number, currency}">
            <apex:param value="{!deal.Chassis_taxable_amt__c}"/>
            </apex:outputText> 
        </td>
        <td style="text-align:right;"><apex:outputText value="{0, number, 0.000}">
            <apex:param value="{!deal.Chassis_tax_rate__c}"/>
            </apex:outputText> 
        </td>
        <td style="text-align:right;"><apex:outputText value="{0, number, currency}">
            <apex:param value="{!deal.Chassis_tax__c}"/>
            </apex:outputText> 
        </td>
        </tr>
        
        <tr class="dataRow">
        <th>Conversion</th>
        <td style="text-align:right;"><apex:outputText value="{0, number, currency}">
            <apex:param value="{!deal.Conversion_taxable_amt__c}"/>
            </apex:outputText>
        </td>
        <td style="text-align:right;" ><apex:outputText value="{0, number, 0.000}">
            <apex:param value="{!deal.Conversion_tax_rate__c}"/>
            </apex:outputText>
        </td>
        <td style="text-align:right;"><apex:outputText value="{0, number, currency}">
            <apex:param value="{!deal.Conversion_tax__c}"/>
            </apex:outputText>
        </td>
        </tr>
        </tbody>
        </table>
        <br/>
        </apex:outputPanel>
<apex:pageBlockSection columns="2"  id="taxoverride"
	rendered="{!OR(dealer__Deal__c.SalesTaxOverrideAmt__c!=null,AND(dealer__Deal__c.Funding_option__c=='Financed',dealer__Deal__c.Contract_Type__c=='Lease'),AND(TaxTotal==0,dealer__Deal__c.TaxCalcDT__c!=null),dealer__Deal__c.ReleasingDealer__c!=null)}"><!-- BLL46c -->
        <apex:inputField value="{!dealer__Deal__c.SalesTaxOverrideAmt__c}"/>
        <apex:inputField value="{!dealer__Deal__c.SalesTaxOverrideBasis__c}" />
        <apex:inputField value="{!dealer__Deal__c.SalesTaxOverrideReason__c}" style="width:100%"/>
</apex:pageBlockSection>
        
<!-- BLL13a end -->

            <span id="sec_equipment"></span>
            <apex:pageBlockSection id="additional_equipment" title="Selected Additional Equipment" collapsible="false" columns="1" rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
                <apex:actionStatus onstart="$dt('#removeAdditionalEquipmentModal').modal('show');$dt('#p\\:frm\\:pB\\:additional_equipment').css('opacity', '0.33');" onstop="$dt('#removeAdditionalEquipmentModal').modal('hide');$dt('#p\\:frm\\:pB\\:additional_equipment').css('opacity', '1');resetEquipmentValues();" id="removeAEStatus" />
<!-- BLL8a --> 
<apex:outputPanel layout="none" rendered="{!AND(accountInfo!=null,RecordTypeName!='Commercial')}"><!--BLL36c and not commercial --><!-- AND( OR(accountInfo.dtffa__Chair_Brand__c!=null, accountInfo.dtffa__Chair_Model__c!=null), ... ) -->
<table border="0">
    <tr>
        <th>Chair brand: </th><td style="padding-right:4em;">{!accountInfo.dtffa__Chair_Brand__c}</td>
        <th>Chair model: </th><td style="padding-right:4em;">{!accountInfo.dtffa__Chair_Model__c}</td>
    </tr>
</table>
</apex:outputPanel>
<!-- BLL8a end -->
				<apex:variable var="tothrs" value="{!0}"/><!--BLL44a-->
				<apex:variable var="totamt" value="{!0}"/><!--BLL44a-->
                <!-- BLL14a do not show values if misc item has no cost, price or labor -->
                <apex:pageBlockTable id="amSelectedEquipment" var="pk" value="{!selectedKits}" title="Selected Equipment">
                    <apex:column headerValue="Action">
                        <apex:commandLink value="Delete" action="{!deleteEquipment}" style="btn btn-info btn-xs" reRender="additional_equipment,selectedAftermarketItems" status="removeAEStatus">
                            <apex:param value="{!pk.Id}" name="deleteEquipmentId" assignTo="{!deleteEquipmentId}" />
                        </apex:commandLink>
                        <input type="hidden" value="{!pk.Id}" name="hAM_ID" />
                        <apex:facet name="footer">Totals</apex:facet>
                    </apex:column>
                    <apex:column headerValue="Qty"><!-- BLL36a -->
                        <apex:inputField value="{!pk.dealer__Quantity__c}" onchange="updateEquipmentQty(this);" 
                            html-recordId="{!pk.Id}" styleClass="aright" style="width:3em;"/><!-- BLL36a -->
                    </apex:column><!-- BLL36a -->
                    <apex:column headerValue="Name" value="{!pk.Name}" />
                    <apex:column headerValue="Description" value="{!pk.dealer__Description__c}" />
                    <apex:column headerValue="Cost" style="text-align:right;"> 
                        <apex:outputField value="{!pk.dealer__Cost__c}" 
                            rendered="{!OR(pk.Name!='Misc',NOT(OR(ISNULL(pk.Labor_Hours__c),pk.Labor_Hours__c==0)),pk.dealer__Cost__c!=0,pk.dealer__Sale_Price__c!=0)}"/><!-- BLL5a -->
                    </apex:column>
                    <apex:column headerValue="Labor" style="text-align:right;"> 
                        <apex:outputField value="{!pk.Labor_Hours__c}" rendered="{!OR(pk.dealer__Cost__c!=0,pk.dealer__Sale_Price__c!=0)}"/>
                    </apex:column>
                    <!--BLL44a-->
                    <apex:column headerValue="Extd Lbr Hours" style="text-align:right;"> 
                        <apex:outputText value="{!pk.Labor_Hours__c*pk.dealer__Quantity__c}" rendered="{!OR(pk.dealer__Cost__c!=0,pk.dealer__Sale_Price__c!=0)}"/>
						<apex:variable var="tothrs" value="{!tothrs+NULLVALUE(pk.Labor_Hours__c,0)*NULLVALUE(pk.dealer__Quantity__c,0)}"/>
                        <apex:facet name="footer">
                        	<div style="width:100%;text-align:right;"><span id="aftermktTotHrs"></span></div>
                        </apex:facet>
                    </apex:column>
                    <!--BLL44a end-->
                    <apex:column headerValue="Tax as Non-Mobility"><!-- BLL27c was "Taxable" -->
                        <apex:inputField value="{!pk.Taxable__c}" onchange="setEqTax(this);" html-recordId="{!pk.Id}" 
                            rendered="{!OR(pk.Name!='Misc',NOT(OR(ISNULL(pk.Labor_Hours__c),pk.Labor_Hours__c==0)),pk.dealer__Cost__c!=0,pk.dealer__Sale_Price__c!=0)}"/>
                    </apex:column>
                    <apex:column headerValue="Tax Exempt"><!-- BLL29a -->
                        <apex:inputField value="{!pk.TaxExempt__c}" onchange="setEqTaxExempt(this);" html-recordId="{!pk.Id}"/><!-- BLL29a -->
                    </apex:column><!-- BLL29a -->
                    <apex:column headerValue="Print on Pg 2">
                        <apex:inputField value="{!pk.Print_on_Proposal__c}" onchange="setPrintOnProposal(this);" html-recordId="{!pk.Id}" />
                        <apex:outputText style="color:red;" rendered="{!AND(CONTAINS(pk.dealer__Description__c,'NMEDA '),pk.Print_on_Proposal__c=true)}"><br/>NMEDA s/b unchecked</apex:outputText><!-- BLL53a -->
                    </apex:column>
                    <apex:column headerValue="Price" headerClass="aright">
                        <apex:inputField value="{!pk.dealer__Sale_Price__c}" onchange="updateEquipmentSale(this);" html-recordId="{!pk.Id}" styleClass="aright" style="width:120px;"
                            rendered="{!OR(pk.Name!='Misc',NOT(OR(ISNULL(pk.Labor_Hours__c),pk.Labor_Hours__c==0)),pk.dealer__Cost__c!=0,pk.dealer__Sale_Price__c!=0)}"/>
                    </apex:column>
                    <apex:column >
                        <apex:facet name="header">Order</apex:facet>
                        <input type="number" disabled="disabled" id="equipmentorder-{!pk.Id}" maxlength="3" style="width:35px;" value="{!pk.Page_Order__c}" />
                    </apex:column>
                    <apex:column styleClass="aright" headerClass="aright">
                    	<apex:facet name="header">Extd Price</apex:facet>
                    	<apex:outputField value="{!pk.ExtendedPrice__c}"/>
                        <apex:variable var="totamt" value="{!totamt+pk.ExtendedPrice__c}"/><!-- BLL44a -->
                        <apex:facet name="footer">
                        	<div style="width:100%;text-align:right;"><span id="aftermktTotAmt"></span></div>
                        </apex:facet>
                    </apex:column><!-- BLL36a -->
                </apex:pageBlockTable>
<!-- BLL44a -->
<script type="text/javascript">
document.getElementById('aftermktTotHrs').innerHTML='{!tothrs}';
var ttlaftermarketamt = {!totAmt};
document.getElementById('aftermktTotAmt').innerHTML='$'+ttlaftermarketamt.formatMoney(2);
</script>
<!-- BLL44a end -->
            </apex:pageBlockSection>  

            <!-- Modal for the removal of an parts kit -->
            <div class="modal fade" id="removeAdditionalEquipmentModal" role="dialog">
              <div class="modal-dialog modal-sm">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title">Additional Equipment</h4>
                  </div>
                  <div class="modal-body">
                    <p>Removing the Additional Equipment, Please Wait...</p>
                  </div>
                </div>
              </div>
            </div>  

            <apex:pageBlockSection id="kitSearch" columns="1" collapsible="true" title="Search Additional Equipment" rendered="{!AND(NOT(ISBLANK(dealer__Deal__c.Id)), dealer__Deal__c.dealer__Deal_Type__c!='Financial Products')}"><!-- BLL48c not for financial products! -->
<apex:actionRegion ><!-- BLL53a -->
                <apex:outputPanel id="eqs">
                <apex:outputText rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}" id="equipmentSelect">
                    <apex:panelGrid columns="3" id="addEquipPanel" style="width:100%;" columnClasses="eqsCatCol,eqsMfgCol,eqsSubCol">
                        <!-- Row 1 -->
                        <apex:outputText value="Category:" style="font-weight:bold;"/>
                        <apex:outputText value="Manufacturer:" style="font-weight:bold;"/>
                        <apex:outputText value="Sub Category (Qualifying Question)" style="font-weight:bold;"/>
                        <!-- <apex:outputText value="Show Favorites Only?" style="width:25%;"/> -->

                        <!-- Row 2 -->
                        <apex:selectList value="{!selectCategory}" size="1" id="ctg"><!-- BLL19c add id -->
                            <apex:selectOptions value="{!categories}" />
                            <apex:actionSupport event="onchange" reRender="addEquipPanel" status="eqsDropDownStatus"/><!-- BLL7d remove reRender kitTable, status="equipmentStatus" --> <!-- BLL19c change rerender for only dropdowns -->
                        </apex:selectList>

                        <apex:selectList value="{!selectMFG}" size="1" id="mfgS" styleClass="eqsDropDown">
                            <apex:selectOptions value="{!equipmentMFG}" />
                            <apex:actionSupport event="onchange" reRender="addEquipPanel" status="eqsDropDownStatus"/><!-- BLL7d remove reRender kitTable, status="equipmentStatus" --> <!-- BLL19c change rerender for only dropdowns -->
                        </apex:selectList>

                        <apex:selectList value="{!selectSubCat}" size="1" id="subCat" styleClass="eqsDropDown">
                            <apex:selectOptions value="{!subcat}"/>
                            <!-- BLL7d not needed apex:actionSupport event="onchange" reRender="eqs" status="eqsDropDownStatus"/ -->
                        </apex:selectList>     

                        <!--
                        <apex:outputPanel >
                            <apex:inputCheckbox id="favoriteCheckbox" />
                        </apex:outputPanel>                 
                        -->
                    </apex:panelGrid>

                    <apex:panelGrid columns="1" style="width:100%;height:8px;">
						<!--BLL67d hr/-->
						&nbsp;
                    </apex:panelGrid>

                    <apex:panelGrid columns="5" id="kitCustomSearch" style="width:100%;">

                        <apex:outputText value="Search Part#" style="font-weight:bold;" />
						<apex:outputText value="Search Description" style="font-weight:bold;" />
						<!--BLL67-->
						<!--apex:outputText value="Search Notes" style="font-weight:bold;" /-->  
						<!--BLL67 end-->
                        <!-- AMM2 -->
                        <!-- <apex:outputText /> -->
                        <apex:outputText value="Show Favorites" style="font-weight:bold;" />  
                        <!-- AMM2 -->
						<apex:outputText />   
						<!--BLL67-->
						<apex:outputText />
						<!--BLL67-->

                        <apex:outputPanel id="pnSearchPanel">
                            <apex:inputText value="{!searchByPartNumber}" id="searchbypartnumber" styleClass="noEnterSubmit">
                                <!-- BLL7d apex:actionSupport event="onchange" reRender="eqs,kitTable" status="equipmentStatus"/ -->
                            </apex:inputText>
                        </apex:outputPanel>

                        <apex:outputPanel id="desSearchPanel">
                            <apex:inputText value="{!searchByDescription}" id="searchbydescription" styleClass="noEnterSubmit">
                                <!-- BLL7d apex:actionSupport event="onchange" reRender="eqs" status="equipmentStatus"/ -->
                            </apex:inputText>
                        </apex:outputPanel>

						<!--BLL67d-->
						<!--apex:outputPanel id="notesSearchPanel"-->
                            <!--apex:inputText value="{!searchByNotes}" id="searchbynotes" styleClass="noEnterSubmit"-->
                                <!-- BLL7d apex:actionSupport event="onchange" reRender="eqs" status="equipmentStatus"/ -->
                            <!--/apex:inputText-->                            
						<!--/apex:outputPanel -->
						<!--BLL67d end-->

                        <!-- AMM2 -->
						<apex:outputPanel >
							<apex:inputCheckbox value="{!showFavorites}" id="favoriteBool">
									<apex:actionSupport event="onchange" reRender="eqs,kitTable" status="equipmentStatus"/>
							</apex:inputCheckbox>  
						</apex:outputPanel>
						<!-- AMM2 -->
						
                        <apex:outputPanel > 
                            <!-- BLL7a Search button -->
							<!-- BLL106 -->
							<!-- apex:commandButton value="Search" action="{!noAction}" reRender="kitTable" status="equipmentStatus"  styleClass="btn-info btn-xs"/ -->
							<apex:commandButton value="Search" action="{!SearchAvailablePartsKits}" reRender="kitTable" status="equipmentStatus" styleClass="btn-info btn-xs"/>
							<!-- BLL106 -->
                            &nbsp;&nbsp;
                            <apex:commandButton action="{!addService}" value="Add Labor" styleClass="btn-info btn-xs" />
                            &nbsp;&nbsp;
                            <apex:commandButton action="{!addSublet}" value="Add Sublet" styleClass="btn-info btn-xs" />
                            &nbsp;&nbsp;
                            <apex:commandButton action="{!addPart}" styleClass="btn btn-info btn-xs" value="Add Parts" />
                            <!-- BLL19a -->
                            &nbsp;&nbsp;
                            <input type="button" class="btn btn-info btn-xs" value="New search" onclick="clearEquipmentSearch();"/>
                            <!-- BLL19a -->
                        </apex:outputPanel>
                        <apex:outputPanel >
                            
                        </apex:outputPanel>

                    </apex:panelGrid>   
                </apex:outputText>
                </apex:outputPanel>
                
                <!-- AMM2 -->
                <apex:actionFunction name="rerendAction" rerender="kitTable"/>
                <!-- AMM2 -->

                <apex:outputPanel id="kitTable" rendered="{!NOT(ISBLANK(deal.Id))}">
                    <apex:outputText ><b>Search Results</b></apex:outputText>
					<!-- BLL106 -->
					<!-- apex:pageBlockTable value="{!getAvailablePartsKits}" var="a" title="Available Kits" -->
					<apex:pageBlockTable value="{!cParts}" var="a" title="Available Kits">
					<!-- BLL106 -->
                        <!-- AMM2 -->
                        <apex:column headerValue="Favorite">
							<!--BLL66-->
							<!--apex:image value="https://img.icons8.com/android/24/000000/christmas-star.png" onclick="setRemoteFavorite('{!a.kit.Id}', false, '{!dealer__Deal__c.dealer__Store_Location__c}', '{!showFavorites}')" rendered="{!IF(a.favorited, true, false)}"/>
                            <apex:image value="https://img.icons8.com/material-outlined/24/000000/christmas-star.png" onclick="setRemoteFavorite('{!a.kit.Id}', true, '{!dealer__Deal__c.dealer__Store_Location__c}', '{!showFavorites}')" rendered="{!IF(a.favorited, false, true)}"/ -->
							<apex:outputLink onclick="setRemoteFavorite('{!a.kit.Id}', false, '{!dealer__Deal__c.dealer__Store_Location__c}', '{!showFavorites}')" rendered="{!IF(a.favorited, true, false)}"
								styleClass="favorite">
								&#x02605;
							</apex:outputLink>
							<apex:outputLink onclick="setRemoteFavorite('{!a.kit.Id}', true, '{!dealer__Deal__c.dealer__Store_Location__c}', '{!showFavorites}')" rendered="{!IF(a.favorited, false, true)}"
								styleClass="favorite">
								&#x02606;
							</apex:outputLink>
							<!--BLL66-->
                        </apex:column>
                        <!-- AMM2 -->
 
						<apex:column value="{!a.Kit.Name}">
                            <apex:facet name="header">Name</apex:facet>
                        </apex:column>
                        <apex:column value="{!a.Kit.Manufacturer__c}">
                            <apex:facet name="header">MFG</apex:facet>
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!a.Kit.dealer__Description__c}" />
                            <apex:outputText rendered="{!NOT(ISBLANK(a.Kit.Kit_Notes__c))}">
                                <br />
                                <b>Notes:</b>&nbsp;{!a.Kit.Kit_Notes__c}
                            </apex:outputText>
                        </apex:column>
                        <apex:column value="{!a.Kit.Labor_Hours__c}">
                            <apex:facet name="header">Hours</apex:facet>
                        </apex:column>
                        <!-- JVK4 East/West Costing -->
                        <apex:column value="{!a.Kit.Cost_West__c}" rendered="{!IF(location.Kit_Cost_Structure__c=='West', true, false)}"> <!-- Set to Cost West -->
                            <apex:facet name="header">Cost</apex:facet> 
                        </apex:column>
                        <apex:column rendered="{!IF(location.Kit_Cost_Structure__c=='West', true, false)}">
                            <apex:facet name="header">Sale Price</apex:facet>
                            <apex:inputField value="{!a.Kit.Price_West__c}" /> <!-- Set To Price West -->
                        </apex:column>
                        <apex:column value="{!a.Kit.Cost_East__c}" rendered="{!IF(location.Kit_Cost_Structure__c=='East', true, false)}"> <!-- Set to Cost West -->
                            <apex:facet name="header">Cost</apex:facet> 
                        </apex:column>
                        <apex:column rendered="{!IF(location.Kit_Cost_Structure__c=='East', true, false)}">
                            <apex:facet name="header">Sale Price</apex:facet>
                            <apex:inputField value="{!a.Kit.Price_East__c}" /> <!-- Set To Price West -->
                        </apex:column>                        
                        <!-- //JVK4 Cost west/east -->
                        
                        <apex:column >
                            <apex:facet name="header">Taxable</apex:facet>
                            <apex:inputCheckbox value="{!a.taxable}" />
                        </apex:column>
                        <apex:column >
                            <apex:commandButton action="{!addKitToProposal}" value="Select" reRender="kitTable,selectedAftermarketItems,additional_equipment" styleClass="btn-xs btn-primary" onclick="$dt(this).prop('disabled', true);$dt('#addEQModal').modal('show');" oncomplete="resetEquipmentValues();$dt('#addEQModal').modal('hide');">
                                <apex:param name="addKitId" value="{!a.Kit.Id}" assignTo="{!addKitId}" />
                            </apex:commandButton>
                        </apex:column>
                        <apex:column >
                            <!-- 
                            <apex:commandButton value="Favorite?" styleClass="btn-xs btn-default" />
                            -->
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:outputPanel>
</apex:actionRegion><!-- BLL53a -->
            </apex:pageBlockSection>
            
            <!-- Modal for the addition of an parts kit -->
            <div class="modal fade" id="addEQModal" role="dialog">
              <div class="modal-dialog modal-sm">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title">Additional Equipment</h4>
                  </div>
                  <div class="modal-body">
                    <p>Adding the Additional Equipment, Please Wait...</p>
                  </div>
                </div>
              </div>
            </div>              
          <!-- Modal for the removal of an parts kit -->
            <div class="modal fade" id="searchPartsKits" role="dialog">
              <div class="modal-dialog modal-sm">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title">Additional Equipment</h4>
                  </div>
                  <div class="modal-body">
                    <p>Searching for matching Additional Equipment, Please Wait...</p>
                  </div>
                </div>
              </div>
            </div> 


            <apex:outputText rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
            <span id="sec_esc"></span>
            <apex:pageBlockSection title="Protection Products" id="pb_esc" collapsible="false" columns="1">
            
                <!-- BLL40d apex:panelGrid columns="4" style="width:100%" id="escPG"><!-- BLL40 columns was 4 -->
                <apex:panelGrid columns="{!EscTypes.size}" style="width:100%" id="escPG"><!-- BLL40 columns was 4 -->
                <apex:repeat value="{!EscTypes}" var="esct">
                    <apex:outputPanel >
                    <apex:commandLink action="{!newServiceContract}" value="Add {!esct}" styleClass="btn btn-default btn-sm"
                        style="margin-right:2em;" immediate="true"><!-- BLL53 added immediate=true -->
                        <apex:param assignTo="{!escType}" value="{!esct}" name="escType"/>
                    </apex:commandLink>
                    </apex:outputPanel>
                </apex:repeat>
                
                </apex:panelGrid>
            </apex:pageBlockSection> 
            <apex:pageBlockSection columns="1">
                <apex:actionStatus onstart="escRemoveStart();" onstop="escRemoveEnd();" id="escRemoveStatus" />
                <apex:pageBlockTable var="esc" value="{!soldOnProposal}" id="escSales">
                        <apex:column headerValue="Action">
                            <apex:commandLink action="{!deleteProduct}" value="Remove" reRender="escSales" oncomplete="clearFinancialProducts();" status="escRemoveStatus"
                             immediate="true"><!-- BLL53 added immediate=true -->
                                <apex:param value="{!esc.Id}" assignTo="{!deleteProductId}" name="delete_product_id" />
                            </apex:commandLink>
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputLink value="/{!esc.Id}"><apex:outputText value="{!esc.Name}" /></apex:outputLink>
                        </apex:column>
                        <apex:column headerValue="Code" value="{!esc.dealer__Plan_Code__c}" />
                        <apex:column headerValue="Description" value="{!esc.dealer__Description__c}" />
                        <apex:column headerValue="Exp. Miles" value="{!esc.dealer__Expiration_Mileage__c}" />
                        <apex:column headerValue="Exp. Mo." value="{!esc.dealer__Expiration_Months__c}" />
                        <apex:column headerValue="Price" headerClass="aright">
                            <apex:inputField value="{!esc.dealer__Sale_Price__c}" id="escSalePrice" html-recordId="{!esc.Id}" onchange="updateServiceContractSale(this);" styleClass="aright" />
                        </apex:column> 
                </apex:pageBlockTable>
                <!-- Modal for the removal of an ESC product -->
                <div class="modal fade" id="removeESCModal" role="dialog">
                  <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h4 class="modal-title">Protection Products</h4>
                      </div>
                      <div class="modal-body">
                        <p>Removing the Protection Product, Please Wait...</p>
                      </div>
                    </div>
                  </div>
                </div>                
            </apex:pageBlockSection> 

            <apex:outputText rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
            <span id="sec_payments" />
            <apex:pageBlockSection title="Grants / Other Funding Sources" id="sec_payments" collapsible="false" columns="1">
                
                <apex:panelGrid columns="4" style="width:100%;">

                    <apex:commandButton action="{!saveProposal}" value="Save" styleClass="btn-info btn-sm" id="saveButtonGrants"/>
                    <apex:outputText />
                    <apex:outputText />
                    <apex:outputText />

                    <apex:outputText styleclass="nondisplay">
                        <b class="nondisplay">Auto Grant</b>
                    </apex:outputText>
                    <apex:outputText styleclass="nondisplay" value="Payor" /><!-- BLL6 change from Payee to Payor -->
                    <apex:outputText styleclass="nondisplay" value="Amount"/>
                    <apex:outputText />                
                    
                    <apex:outputText styleclass="nondisplay"><span class="nondisplay">Auto Grant (4502) - Service Connected</span></apex:outputText>
                    <apex:inputField styleclass="nondisplay" value="{!dealer__Deal__c.dtmob__Auto_Grant_Payor__c}" id="autograntpayee"/><!-- BLL34c -->
                    <apex:inputField styleclass="nondisplay dCalc" value="{!dealer__Deal__c.AutoGrant__c}" id="autogranttotal" />
                    <apex:outputText styleclass="nondisplay" />

                    <apex:outputText >
                        <b>Third Party Payor</b>
                    </apex:outputText>
                    <apex:outputText />
                    <apex:outputText />
                    <apex:outputText />

                    <apex:outputText value="3rd Party Receivable" />
                    <apex:outputText value="Due Date" />
                    <apex:outputText value="Ref# / Notes" />
                    <apex:outputText value="Amount" />
                    

                    <apex:inputField value="{!dealer__Deal__c.Third_Party_Pay_1__c}" />
                    <apex:inputField value="{!dealer__Deal__c.dealer__Deferred_Date_1__c}" />
                    <apex:inputField value="{!dealer__Deal__c.dealer__Deferred_Note_1__c}" />
                    <apex:inputField value="{!dealer__Deal__c.dealer__Deferred_Down_1__c}" id="deferred_1" styleClass="dCalc"/>

                    <!-- BLL6a -->
                    <apex:outputText >
                        <b>Additional Third Party or Other Payors</b>
                    </apex:outputText>
                    <apex:outputText />
                    <apex:outputText />
                    <apex:outputText />
                    <!-- BLL6a end -->

                    <apex:inputField value="{!dealer__Deal__c.Third_Party_Pay_2__c}" />
                    <apex:inputField value="{!dealer__Deal__c.dealer__Deferred_Date_2__c}" />
                    <apex:inputField value="{!dealer__Deal__c.dealer__Deferred_Note_2__c}" />
                    <apex:inputField value="{!dealer__Deal__c.dealer__Deferred_Down_2__c}" id="deferred_2" styleClass="dCalc"/>

                    <apex:inputField value="{!dealer__Deal__c.Third_Party_Pay_3__c}" /><!-- BLL6 - actually "Other" payor now -->
                    <apex:inputField value="{!dealer__Deal__c.dealer__Deferred_Date_3__c}" />
                    <apex:inputField value="{!dealer__Deal__c.dealer__Deferred_Note_3__c}" />
                    <apex:inputField value="{!dealer__Deal__c.dealer__Deferred_Down_3__c}" id="deferred_3" styleClass="dCalc"/>

                </apex:panelGrid>
            </apex:pageBlockSection>
			
			<!--BLL59-->
			<apex:actionRegion >
			<apex:pageBlockSection title="VA Paperwork Approval"
				rendered="{!AND(dealer__Deal__c.VA_Deal__c, $Permission.Proposal_Approve_VA_Paperwork)}" 
				id="va_section" columns="2">
				<apex:outputField value="{!dealer__Deal__c.VA_Deal__c}"/>
				<apex:outputField value="{!dealer__Deal__c.VA_Paperwork_Approved__c}"/>
				<apex:outputField value="{!dealer__Deal__c.VA_Paperwork_Approver__c}"/>
				<apex:commandButton value="Approve VA Paperwork" action="{!approveVA}" 
					rendered="{!NOT(dealer__Deal__c.VA_Paperwork_Approved__c)}"
					rerender="va_section" styleClass="btn-info btn-xs"/>
				<apex:commandButton value="Revoke VA Paperwork Approval" action="{!revokeVA}" 
					rendered="{!dealer__Deal__c.VA_Paperwork_Approved__c}"
					rerender="va_section" styleClass="btn-xs"/>
				<apex:outputField value="{!dealer__Deal__c.VA_Paperwork_ApprovalDT__c}"/>
			</apex:pageBlockSection>
			</apex:actionRegion>
			<!--BLL59 end -->
		
			</apex:outputText>

            <apex:outputText rendered="{!isVehicleSale}"><!-- BLL36c was rendered="{!IF(recordTypeName=='Retail_Vehicle_Sale',true,false)}"--> 

<!-- SBS Comparison -->     <div id="printSection">
                            <div class="modal fade" id="multiVehicleQuote" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismisss="modal">
                                                <span aria-hidden="true">&times;</span>
                                                <span class="sr-only">Close</span>
                                            </button>
                                            <h4 class="modal-title" id="myModalLabel">Side by Side Comparison</h4>
                                        </div>
                                        <div class="modal-body">
                                            <table class="table">
                                                <tr>
                                                    <th>&nbsp;</th>
                                                    <th>Vehicle 1</th>
                                                    <th>&nbsp;</th>
                                                    <th>Vehicle 2</th>
                                                    <th>&nbsp;</th>
                                                    <th>Vehicle 3</th>
                                                </tr>
                                                <tr>
                                                    <td><b>Description</b></td>
                                                    <td><apex:inputField styleClass="mod-form-control" id="mqVehicle1" value="{!dealer__Deal__c.dealer__Multi_Quote_Vehicle_1__c}" onChange="mqv('mqVehicle1', 1);" style="width:225px;" /></td>
                                                    <td></td>
                                                    <td><apex:inputField styleClass="mod-form-control" id="mqVehicle2" value="{!dealer__Deal__c.dealer__Multi_Quote_Vehicle_2__c}" onChange="mqv('mqVehicle2', 2);" style="width:225px;" /></td>
                                                    <td></td>
                                                    <td><apex:inputField styleClass="mod-form-control" id="mqVehicle3" value="{!dealer__Deal__c.dealer__Multi_Quote_Vehicle_3__c}" onChange="mqv('mqVehicle3', 3);" style="width:225px;" /></td>
                                                </tr>
                                                <tr>
                                                    <td><b>Trim</b></td>
                                                    <td><input id="mvq_trim_1" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_trim_2" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_trim_3" class="form-control" /></td>
                                                </tr>
                                                <!--
                                                <tr>
                                                    <td><b>Color</b></td>
                                                    <td><input id="mvq_color_1" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_color_2" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_color_3" class="form-control" /></td>
                                                </tr>
                                                <tr>
                                                    <td><b>Engine</b></td>
                                                    <td><input id="mvq_engine_1" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_engine_2" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_engine_3" class="form-control" /></td>
                                                </tr>                                                                                                      
                                                <tr>
                                                    <td><b>Tranmission</b></td>
                                                    <td><input id="mvq_transmission_1" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_transmission_2" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_transmission_3" class="form-control" /></td>
                                                </tr> 

                                                <tr>
                                                    <td colspan="6"></td>
                                                </tr> 
                                                -->
                                                <!--
                                                <tr>
                                                    <td><b>MSRP</b></td>
                                                    <td><input id="mvq_msrp_1" type="number" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_msrp_2" type="number" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_msrp_3" type="number" class="form-control" /></td>
                                                </tr>
                                                -->

                                                <tr>
                                                    <td><b>Chassis Price</b></td>
                                                    <td><input id="mvq_saleprice_1" type="number" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_saleprice_2" type="number" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_saleprice_3" type="number" class="form-control" /></td>
                                                </tr>
                                                    <td><b>Conversion Price</b></td>
                                                    <td><input id="mvq_conversionprice_1" type="number" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_conversionprice_2" type="number" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_conversionprice_3" type="number" class="form-control" /></td>
                                                <tr>

                                                </tr>
                                                <!--
                                                <tr>
                                                    <td><b>Discount</b></td>
                                                    <td><input id="mvq_discount_1" type="number" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_discount_2" type="number" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input id="mvq_discount_3" type="number" class="form-control" /></td>
                                                </tr>  
                                                --> 
                                                <tr>
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td></td>
                                                </tr>     
                                                <tr>
                                                    <td colspan="2">1)&nbsp;<input type="number" class="form-control" id="mvq_down_1" placeholder="Down" style="width:85px;display:inline;" value="5000" />
                                                        <input class="form-control" id="mvq_term_1" style="width:45px;display:inline;" type="text" value="48" />
                                                    <span style="color:#bdc3c7;">Mo.&nbsp;</span>
                                                    <input class="form-control" id="mvq_rate_1" style="width:45px;display:inline;" type="text" value="4.9" />
                                                    <span style="color:#bdc3c7;">APR</span>
                                                    </td>
                                                    <td colspan="2">
                                                        2)&nbsp;<input type="number" class="form-control" id="mvq_down_2"  style="width:85px;display:inline;" placeholder="Down"  value="5000"/>
                                                        <input class="form-control" id="mvq_term_2" style="width:45px;display:inline;" type="text" value="60" />
                                                    <span style="color:#bdc3c7;">Mo.&nbsp;</span>
                                                    <input class="form-control" id="mvq_rate_2" style="width:45px;display:inline;" type="text" value="5.9" />
                                                    <span style="color:#bdc3c7;">APR</span>                                                        

                                                    </td>
                                                    <td colspan="2">
                                                        3)&nbsp;
                                                        <input type="number" class="form-control" id="mvq_down_3"  style="width:85px;display:inline;" placeholder="Down"  value="5000"/>
                                                            <input class="form-control" id="mvq_term_3" style="width:45px;display:inline;" type="text" value="72" />
                                                        <span style="color:#bdc3c7;">Mo.&nbsp;</span>
                                                        <input class="form-control" id="mvq_rate_3" style="width:45px;display:inline;" type="text" value="6.9" />
                                                        <span style="color:#bdc3c7;">APR</span>                                                        
                                                    </td>
                                                </tr>   

                                                <tr>
                                                    <td>1)&nbsp;</td>
                                                    <td><input type="number" id="mvq_pymt_1_1"  onfocus="mvqCalcOptions(1);" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input type="number" id="mvq_pymt_1_2" onfocus="mvqCalcOptions(1);" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input type="number" id="mvq_pymt_1_3" onfocus="mvqCalcOptions(1);" class="form-control" /></td>                                                                 
                                                </tr>

                                                <tr>
                                                    <td>2)&nbsp;</td>
                                                    <td><input type="number" id="mvq_pymt_2_1" onfocus="mvqCalcOptions(2);" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input type="number" id="mvq_pymt_2_2" onfocus="mvqCalcOptions(2);" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input type="number" id="mvq_pymt_2_3" onfocus="mvqCalcOptions(2);" class="form-control" /></td>                                                                 
                                                </tr>


                                                <tr>
                                                    <td>3)&nbsp;</td>
                                                    <td><input type="number" id="mvq_pymt_3_1" onfocus="mvqCalcOptions(3);" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input type="number" id="mvq_pymt_3_2" onfocus="mvqCalcOptions(3);" class="form-control" /></td>
                                                    <td></td>
                                                    <td><input type="number" id="mvq_pymt_3_3" onfocus="mvqCalcOptions(3);" class="form-control" /></td>                                                                 
                                                </tr>

                                            </table>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>                                
                                        </div>
                                    </div>
                                </div>
                                </div>  
                                </div>
                            <!-- End SBS Comparison -->                 

            </apex:outputText>               
            
            <apex:outputText rendered="{!isVehicleSale}"> <!-- BLL36c rendered="{!IF(recordTypeName=='Retail_Vehicle_Sale',true,false)}" -->
            <span id="sec_trade"></span>
            <apex:pageBlockSection title="Trade(s)" id="sec_trades" collapsible="false" columns="1">
                <apex:panelGrid columns="1" id="tradeGrid">
					<!-- apex:outputLink styleClass="btn btn-sm btn-default" value="/apex/dtmob__MobilityAppraisal?did= { ! deal.Id}">Add a Trade-In</apex:outputLink -->
					<apex:commandButton action="{!newTrade}" value="Add a Trade-In" styleClass="btn btn-sm btn-default" 
                    	disabled="{!dealer__Deal__c.dealer__Status__c=='Won - Posted'}"/>
                </apex:panelGrid>
                
            </apex:pageBlockSection>  

            <apex:pageBlockSection columns="1">
                <apex:pageBlockTable value="{!tradeInList}" var="t">
                    
                    <apex:column rendered="{!IF(location.Use_Appraisal_Dashboard__c==true, false, true)}" >
                        <apex:facet name="header">Action</apex:facet>
                        <!-- apex:outputLink value="/apex/dtmob__MobilityAppraisal?tradeid= { ! t.Id}" target="_top">Edit</apex:outputLink -->
                        <apex:outputLink value="/{!t.Id}">Edit</apex:outputLink>
                    </apex:column>

                    <apex:column rendered="{!IF(location.Use_Appraisal_Dashboard__c==true, true, false)}" >
                        <apex:facet name="header">Action</apex:facet>
						<apex:outputLink value="/apex/dtmob__mobilityappraisal?tradeid={!t.Id}" 
                            rendered="{!t.dtmob__Appraisals__r.size>0}">Edit</apex:outputLink>
                        &nbsp;&nbsp;<apex:outputLink value="/{!t.Id}" rendered="{!OR(ShowTradeRecordLink,t.dtmob__Appraisals__r.size=0)}">Trade&nbsp;Record</apex:outputLink>
                        <!-- rendered="{!t.dtmob__Appraisals__r.size=0}" -->
                    </apex:column>

                    <apex:column value="{!t.dealer__Year__c}" />
                    <apex:column value="{!t.dealer__Make__c}" />
                    <apex:column value="{!t.dealer__Model__c}" />
                    <apex:column value="{!t.dealer__VIN__c}" />
                    <apex:column value="{!t.dealer__Odometer_at_Trade_In__c}" />
                    <apex:column value="{!t.Mobility_Equiped__c}" />
                    <apex:column value="{!t.dealer__ACV__c}" />
                    <apex:column value="{!t.dealer__Pay_Off_Amount__c}" />
                    <apex:column value="{!t.dealer__Trade_Allowance__c}" />
                    <apex:column value="{!t.Net_Value__c}" headerValue="Net" />
                </apex:pageBlockTable>
            </apex:pageBlockSection>
            </apex:outputText>
            </apex:outputText>

            <span id="sec_commissions"></span>
            <!--
                Two Commissions Formulas
                    1) Equipment Only (Customer Owned)
                        Commission$ = (GP <=33 ) * .15 else .20 
                            
                    2) Vehicle Sale
                        Commission$ = (GP <4000) * .15
                                      (GP >=4000 && GP <=5999) * .2
                                      (GP >=6000) * .25 

                    ** Flat override, Change %, no comm at all

                    ** https://www.dmv.ca.gov/FeeCalculatorWeb/newVehicleForm.do  
            -->
            <apex:pageBlockSection title="Finance Calculator" columns="2" rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">

                <!-- BLL31d apex:outputText / -->
                <!-- BLL31d apex : inputField value=" { ! dealer__Deal__c.dealer__Finance_Institution_Account__c}" id="lender"/ -->
                <apex:inputField value="{!dealer__Deal__c.dealer__Term__c}" id="d_term" styleClass="noEnterSubmit" onchange="calcPayment();" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Monthly_Pymt__c}" id="d_pymt" styleClass="noEnterSubmit" onchange="calcPayment();" />
                <apex:inputField value="{!dealer__Deal__c.dealer__Rate__c}" id="d_rate" styleClass="noEnterSubmit" onchange="calcPayment();"  />
                <apex:inputField value="{!dealer__Deal__c.BalloonPmt__c}" id="d_balloon" styleClass="noEnterSubmit" onchange="calcPayment();" /><!-- BLL36a -->
                <!-- BLL36d apex:outputText / -->

                <apex:inputField value="{!dealer__Deal__c.dealer__Days_to_First__c}" id="d_days" styleClass="noEnterSubmit" onchange="calcPayment();" />
                <apex:outputText />

                <apex:inputField value="{!dealer__Deal__c.dealer__Payments_Per_Year__c}" id="d_paymentsperyear" styleClass="noEnterSubmit" onchange="calcPayment();"  />
                <apex:outputText />

            </apex:pageBlockSection>
<!-- apex:actionFunction name="CalculateLeasePmt" action="{!CalculateLeasePmt}" rerender="FinanceTerms,page_messages,taxoverride"/ -->
<!-- apex:actionFunction name="LeaseDesiredUpfrontCash" action="{!LeaseDesiredUpfrontCash}" rerender="FinanceTerms,page_messages,taxoverride"/ -->
<span id="sec_finance"></span>

<!-- F&I team version -->
            <apex:pageBlockSection title="Finance Terms for Contract" columns="2" rendered="{!AND(memberOfFIteam, NOT(ISBLANK(dealer__Deal__c.Id)))}" 
                collapsible="true" id="FinanceTerms">
                <apex:pageBlockSectionItem >
                    <apex:commandButton action="{!applicationReceived}" value="Application received" 
                        styleClass="btn-xs {!IF(dealer__Deal__c.Credit_Application_Received__c!=null,'','btn-info')}"
                        disabled="{!dealer__Deal__c.Credit_Application_Received__c!=null}"/>
                <apex:outputPanel layout="none">
                    <apex:commandButton value="Calc Lease Pmt" styleClass="btn-xs btn-info" 
                      rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"
                        action="{!calculateLeasePmt}" 
                        rerender="taxoverride,FinanceTerms,page_messages"/><!-- onclick="recalcLease(event);" --> 
                    <apex:commandButton value="Calc with Up-front Cash" styleClass="btn-xs btn-info" 
                      rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"
                      action="{!LeaseDesiredUpfrontCash}" 
                      rerender="taxoverride,FinanceTerms,page_messages,down" /><!-- onclick="optimizeLeaseDownPmt(event);" --> 
                </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:commandButton action="{!applicationBackToStore}" value="Back to Store" 
                        styleClass="btn-xs {!IF(dealer__Deal__c.dealer__Status__c!='Won - F&I', '', 'btn-info')}"
                        disabled="{!dealer__Deal__c.dealer__Status__c!='Won - F&I'}"/>
                    <apex:outputPanel layout="block"> 
                    <apex:commandButton action="{!applicationApproved}" value="Approved"  
                        styleClass="btn-xs {!IF(dealer__Deal__c.Credit_Application_Received__c==null,'', IF(dealer__Deal__c.Credit_Decision_Received__c!=null,'btn-info','btn-warning'))}" 
                        disabled="{!dealer__Deal__c.Credit_Application_Received__c==null}"/>
                    &nbsp;&nbsp;
                    <apex:commandButton action="{!applicationRejected}" value="Declined" 
                        styleClass="btn-xs {!IF(dealer__Deal__c.Credit_Application_Received__c==null,'', IF(dealer__Deal__c.Credit_Decision_Received__c!=null,'btn-info','btn-warning'))}" 
                        disabled="{!dealer__Deal__c.Credit_Application_Received__c==null}"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>

                <!-- BLL35d apex:inputField value="{!dealer__Deal__c.Contract_CustomerArranged__c}"/--><!-- BLL31a -->
                <!-- BLL35d apex:inputField value="{!dealer__Deal__c.Customer_Financing_Source__c}"/--><!-- BLL31a -->
                <apex:inputField value="{!dealer__Deal__c.Contract_Type__c}" onchange="redrawFinanceTerms()"/><!-- BLL31a -->
                <apex:inputField value="{!dealer__Deal__c.dealer__Finance_Institution_Account__c}" id="lender"/><!-- BLL31a -->

                <apex:inputField value="{!dealer__Deal__c.ChassisMSRP__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:inputField value="{!dealer__Deal__c.ConversionMSRP__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>

        <apex:inputField value="{!dealer__Deal__c.ChassisResidualPct__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:inputField value="{!dealer__Deal__c.ConversionResidualPct__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>

        <apex:outputField value="{!dealer__Deal__c.ChassisResidualAmt__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:outputField value="{!dealer__Deal__c.ConversionResidualAmt__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>

        <!-- apex:inputField value="{!dealer__Deal__c.Contract_ResidualValue__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/ --><!-- BLL31a -->
                <!-- apex:pageBlocSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/> -->
                <apex:outputField value="{!dealer__Deal__c.Chassis_Price__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:outputField value="{!dealer__Deal__c.Conversion_Price__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>

        <!-- BLL57 -->
        <!-- apex:inputField styleClass="dCalc aright" value="{!dealer__Deal__c.LeaseAcquisitionFee__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" id="leasefee"/ -->
                <!-- apex:inputField styleClass="dCalc aright" value="{!dealer__Deal__c.LoanAcquisitionCost__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}" id="loancost"/ -->
                <!-- apex:inputField value="{!dealer__Deal__c.LeaseMoneyFactor__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/ -->
        <!-- apex:inputField value="{!dealer__Deal__c.Contract_APR__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/ -->
        <apex:inputField styleClass="dCalc aright" value="{!dealer__Deal__c.LeaseAcquisitionFee__c}" rendered="{!dealer__Deal__c.Contract_Type__c!=null}" id="leasefee"/>
        <apex:inputField value="{!dealer__Deal__c.LeaseMoneyFactor__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
        <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c=='Loan'}"/>

		<!-- BLL64 -->
		<!-- apex:inputField styleClass="dCalc aright" value=" { ! dealer__Deal__c.LoanAcquisitionCost__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}" id="loancost"/ -->
		<apex:inputField styleClass="dCalc aright" value="{!dealer__Deal__c.LoanAcquisitionCost__c}" rendered="{!AND(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.dealer__Deal_Type__c!='Financial Products')}" id="loancost"/>
		<apex:inputField styleClass="dCalc aright" value="{!dealer__Deal__c.ESC_Loan_Cost__c}" rendered="{!AND(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.dealer__Deal_Type__c='Financial Products')}" id="loancostesc"/>
		<!-- BLL64 end -->

		<apex:inputField value="{!dealer__Deal__c.Contract_APR__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/>
        <!-- BLL57 end -->
        <!-- apex:pageBlockSectionItem rendered="{!AND(dealer__Deal__c.Contract_Type__c!='Loan',dealer__Deal__c.Contract_Type__c!='Lease')}"/ -->
                
                <apex:inputField value="{!dealer__Deal__c.Contract_Number_of_Payments__c}" styleClass="aright" rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/>
                <apex:inputField value="{!dealer__Deal__c.LeaseDispositionFee__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/> 

        <apex:inputField value="{!deal.DesiredUpfrontCash__c}"  styleClass="aright" style="width:10em;margin-right:2em;" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
                <apex:inputField value="{!dealer__Deal__c.FinanceCompanyReimbursement__c}" rendered="{!OR(dealer__Deal__c.Contract_Type__c=='Lease',dealer__Deal__c.Contract_Type__c=='Loan')}" 
                  styleClass="aright readonly" onfocus="this.blur();"/><!-- BLL47a -->
        <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c=='Loan'}"/>

<!-- do not display -->
<apex:inputField value="{!dealer__Deal__c.LeaseSalesTaxHandling__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
<apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
<apex:outputPanel layout="none" rendered="false">
<!-- special flags and settings for leases (BancLease) -->
<apex:inputField value="{!dealer__Deal__c.LeaseDocFeeHandling__c}"/>
<apex:inputField value="{!dealer__Deal__c.LeaseAcquisitionFeeHandling__c}"/>
</apex:outputPanel>


<apex:outputPanel layout="block" style="width:100%;border-bottom:1px solid #666"
 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}">&nbsp;</apex:outputPanel>
<apex:outputPanel layout="block" style="width:100%;border-bottom:1px solid #666"
 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}">&nbsp;</apex:outputPanel>
                
                <apex:pageBlockSectionItem rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}">
                <apex:outputLabel value="{!IF(dealer__Deal__c.Contract_Type__c='Lease','Adjusted Capitalized Cost','Contract Amount Financed')}"/>  <!-- BLL53a -->
                <apex:inputField value="{!dealer__Deal__c.Contract_Amount_Financed__c}" styleClass="aright dCalc" id="amtfinanced"/>
                </apex:pageBlockSectionItem>
                <apex:inputField value="{!dealer__Deal__c.Contract_Monthly_Payment__c}" styleClass="aright" id="contractMonthlyPayment"
                 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/>
                
                <apex:inputField value="{!dealer__Deal__c.Contract_Final_Payment__c}" styleClass="aright"
                 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/>
                <apex:inputField value="{!dealer__Deal__c.Contract_Total_of_Payments__c}" styleClass="aright" 
                 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/>

                <apex:inputField value="{!dealer__Deal__c.Contract_Finance_Charge__c}" styleClass="aright"
                 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/>
                <apex:inputField value="{!deal.LeasePmtBeforeTax__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/>

                <apex:inputField value="{!dealer__Deal__c.LeaseUpfrontSalesTax__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:inputField value="{!dealer__Deal__c.LeaseMonthlySalesTax__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:inputField value="{!dealer__Deal__c.TaxOnCostReduction__c}"  rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:inputField value="{!dealer__Deal__c.TotalUpfrontCash__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>

<apex:outputPanel layout="block" style="width:100%;border-bottom:1px solid #666">&nbsp;</apex:outputPanel>
<apex:outputPanel layout="block" style="width:100%;border-bottom:1px solid #666">&nbsp;</apex:outputPanel>

                <apex:inputField value="{!dealer__Deal__c.dealer__F_I_Manager__c}" /><!-- BLL31a -->
                <apex:outputField value="{!dealer__Deal__c.Contract_Status__c}" /><!-- BLL31a -->
                <apex:inputField value="{!dealer__Deal__c.Contract_CounterOffer__c}"/><!-- BLL31a -->
                <!-- BLL56 -->
                <!-- apex:pageBlockSectionItem / -->
                <apex:inputField value="{!dealer__Deal__c.FICO_Score__c}"/><!-- rendered="{!$ObjectType.dealer__Deal__c.fields.FICO_Score__c.updateable}"/ -->
                <!-- apex : pageBlockSectionItem rendered="{!NOT($ObjectType.dealer__Deal__c.fields.FICO_Score__c.updateable)}"/ -->
                <!-- BLL56 end -->

                <!-- lease section BLL40 -->
                <apex:inputField value="{!dealer__Deal__c.dealer__First_Payment_Date__c}"  rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
                <apex:inputField value="{!dealer__Deal__c.Contract_LeaseEndDate__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/><!-- BLL31a -->
                <apex:inputField value="{!dealer__Deal__c.LeasePmtDueDOM__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
                <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>

                <apex:inputField value="{!dealer__Deal__c.LeaseMilesIncluded__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
                <apex:inputField value="{!dealer__Deal__c.LeaseMilesOverageRate__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:inputField value="{!dealer__Deal__c.LeaseLatePmtFee__c}"  rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/> 
                <apex:inputField value="{!dealer__Deal__c.LeaseEarlyTerminationFee__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/> 
                <!-- BLL40a end -->
                
                <apex:inputField value="{!dealer__Deal__c.Finance_Reserve__c}" rendered="{!dealer__Deal__c.Contract_Type__c!=null}" styleClass="aright"/><!-- BLL31a -->
                <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c!=null}"/>

                <apex:outputField value="{!dealer__Deal__c.Credit_Application_Received__c}"/><!-- BLL31a -->
                <apex:outputField value="{!dealer__Deal__c.Credit_Decision_Received__c}"/><!-- BLL31a -->
                <apex:outputField value="{!dealer__Deal__c.Credit_BackToStore__c}"/><!-- BLL31a -->
                <apex:pageBlockSectionItem />

                <apex:commandButton action="{!btnSaveFandI}" value="Save F&I" styleClass="btn-info btn-sm" rerender="LeaseInformationTables" /><!-- BLL31a -->
            </apex:pageBlockSection>
<!-- end of F&I team version -->
            
            
            <!-- BLL31a read-only / non F&I version -->
            <!-- $Permission.Can_Edit_Proposal_F_and_I vs memberOfFIteam -->
            <apex:pageBlockSection title="Finance Terms for Contract" columns="2" id="FinanceTerms2"  collapsible="true"
                rendered="{!AND(NOT(memberOfFIteam), NOT(ISBLANK(dealer__Deal__c.Id)))}">
            <!--apex:pageBlockSection title="Finance Terms for Contract" columns="2" id="FinanceTerms2"  collapsible="true"-->

                    <!-- apex:commandButton value="Calc Lease Pmt"
                        styleClass="btn-xs btn-info" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"
                        action="{!calculateLeasePmt}" rerender="FinanceTerms2,page_messages,taxoverride"/ --><!--  onclick="recalcLease(event);" --> 
                	<!-- apex:pageBlockSectionItem rendered="{!AND(dealer__Deal__c.Contract_Type__c!='Lease',dealer__Deal__c.Contract_Type__c!='Loan')}"/ -->

<!-- BLL62 show items missing & checkbox -->
<apex:outputField value="{!dealer__Deal__c.Credit_App_Incomplete__c}"/>
<apex:pageBlockSectionItem >
	<apex:outputLabel >Missing items/notes</apex:outputLabel>
	<apex:outputPanel layout="none">
		<span class="{!IF(dealer__Deal__c.Credit_App_Incomplete__c,'redtext','normaltext')}">
		<apex:outputField value="{!dealer__Deal__c.Credit_App_Missing_Items__c}"/>
		</span>
	</apex:outputPanel>
</apex:pageBlockSectionItem>
<!-- BLL62 end -->

                <!-- BLL35d apex:inputField value="{!dealer__Deal__c.Contract_CustomerArranged__c}"/--><!-- BLL31a -->
                <!-- BLL35d apex:inputField value="{!dealer__Deal__c.Customer_Financing_Source__c}"/--><!-- BLL31a -->
				<apex:inputField value="{!dealer__Deal__c.Contract_Type__c}" onchange="redrawFinanceTerms2()"/><!-- BLL31a -->
                <apex:inputField value="{!dealer__Deal__c.dealer__Finance_Institution_Account__c}" id="lender"/><!-- BLL31a -->


				<apex:inputField value="{!dealer__Deal__c.ChassisMSRP__c}" 
					rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright hidden"/>
				<apex:inputField value="{!dealer__Deal__c.ConversionMSRP__c}" 
					rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright hidden"/>
				<apex:inputField value="{!dealer__Deal__c.ChassisResidualPct__c}" 
					rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright hidden"/>
				<apex:inputField value="{!dealer__Deal__c.ConversionResidualPct__c}" 
					rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright hidden"/>
				<apex:outputField value="{!dealer__Deal__c.ChassisResidualAmt__c}" 
					rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
				<apex:outputField value="{!dealer__Deal__c.ConversionResidualAmt__c}" 
					rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <!-- apex:inputField value="{!dealer__Deal__c.Contract_ResidualValue__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/ --><!-- BLL31a -->
				<!-- apex:pageBlocSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/> -->
				<!--BLL62d -->
                <!-- apex:outputField value="{!dealer__Deal__c.Chassis_Price__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/ -->
				<!-- apex:outputField value="{!dealer__Deal__c.Conversion_Price__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/ -->
				<!--BLL62d end -->

				<!-- BLL57 -->
                <!-- apex:inputField styleClass="dCalc aright" value="{!dealer__Deal__c.LeaseAcquisitionFee__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" id="leasefee"/ -->
                <!-- apex:inputField styleClass="dCalc aright" value="{!dealer__Deal__c.LoanAcquisitionCost__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}" id="loancost"/ -->
                <!-- apex:inputField value="{!dealer__Deal__c.LeaseMoneyFactor__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/ -->
                <!-- apex:inputField value="{!dealer__Deal__c.Contract_APR__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/ -->
				<apex:inputField styleClass="dCalc aright" value="{!dealer__Deal__c.LeaseAcquisitionFee__c}" 
					rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}" id="leasefee"/>
				<!-- BLL62 -->
                <!--apex:inputField value="{!dealer__Deal__c.LeaseMoneyFactor__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/-->
				<apex:inputField value="{!dealer__Deal__c.LeaseDispositionFee__c}"  
					rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>				
				<!--BLL62 end -->
				<apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/>

				<apex:inputField styleClass="dCalc aright" value="{!dealer__Deal__c.LoanAcquisitionCost__c}" 
					rendered="{!AND(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.dealer__Deal_Type__c!='Financial Products')}" id="loancost"/>
				<apex:inputField styleClass="dCalc aright" value="{!dealer__Deal__c.ESC_Loan_Cost__c}" 
					rendered="{!AND(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.dealer__Deal_Type__c='Financial Products')}" id="loancostesc"/>
				<apex:inputField value="{!dealer__Deal__c.Contract_APR__c}" 
					rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/>
				<!-- BLL57 end -->
				<!-- apex:pageBlockSectionItem rendered="{!AND(dealer__Deal__c.Contract_Type__c!='Loan',dealer__Deal__c.Contract_Type__c!='Lease')}"/ -->
                
				<!--BLL62 moved -->
                <!--apex:inputField value="{!dealer__Deal__c.Contract_Number_of_Payments__c}" styleClass="aright" rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/-->
				<!--apex:inputField value="{!dealer__Deal__c.LeaseDispositionFee__c}"  rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/-->
                <!--apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/--> 
				<!-- BLL62 end -->

				<apex:inputField value="{!deal.DesiredUpfrontCash__c}" styleClass="aright" style="width:10em;margin-right:2em;" 
					rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
				<apex:outputField value="{!dealer__Deal__c.FinanceCompanyReimbursement__c}" 
					rendered="{!OR(dealer__Deal__c.Contract_Type__c='Lease',dealer__Deal__c.Contract_Type__c='Loan')}"/><!-- BLL47a -->
				<apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/>

<apex:outputPanel layout="block" style="width:100%;border-bottom:1px solid #666"
 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}">&nbsp;</apex:outputPanel>
<apex:outputPanel layout="block" style="width:100%;border-bottom:1px solid #666"
 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}">&nbsp;</apex:outputPanel>
                
                <apex:inputField value="{!dealer__Deal__c.Contract_Amount_Financed__c}" style="color:black;" 
                	 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}" id="amtfinanced" styleClass="aright dCalc"/>
				<!-- BLL62 -->
				<apex:outputField value="{!dealer__Deal__c.LeaseSalesTaxHandling__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
				<apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/>

				<apex:inputField value="{!dealer__Deal__c.Contract_Number_of_Payments__c}" styleClass="aright" 
					rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/>
				<!-- BLL62 -->
				<apex:inputField value="{!dealer__Deal__c.Contract_Monthly_Payment__c}" styleClass="readonly aright" id="contractMonthlyPayment" onfocus="this.blur();"
                	rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/>
                
                <apex:outputField value="{!dealer__Deal__c.Contract_Final_Payment__c}" styleClass="aright"
                 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/>
                <apex:outputField value="{!dealer__Deal__c.Contract_Total_of_Payments__c}" styleClass="aright"
                 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/>

                <apex:outputField value="{!dealer__Deal__c.Contract_Finance_Charge__c}" styleClass="aright"
                 rendered="{!OR(dealer__Deal__c.Contract_Type__c='Loan',dealer__Deal__c.Contract_Type__c='Lease')}"/>
                <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}">
                    <apex:outputLabel >Pmt Before Sales Tax</apex:outputLabel>
                    <apex:outputText value="{0,number,currency}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright">
                    <apex:param value="{!dealer__Deal__c.LeasePmtBeforeTax__c}"/>
                    </apex:outputText>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Loan'}"/>

                <apex:outputField value="{!dealer__Deal__c.LeaseUpfrontSalesTax__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:outputField value="{!dealer__Deal__c.LeaseMonthlySalesTax__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:outputField value="{!dealer__Deal__c.TaxOnCostReduction__c}"  rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:outputField value="{!dealer__Deal__c.TotalUpfrontCash__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>

<apex:outputPanel layout="block" style="width:100%;border-bottom:1px solid #666">&nbsp;</apex:outputPanel>
<apex:outputPanel layout="block" style="width:100%;border-bottom:1px solid #666">&nbsp;</apex:outputPanel>

				<apex:outputField value="{!dealer__Deal__c.dealer__F_I_Manager__c}" /><!-- BLL31a -->
				<!--BLL61-->
				<!--apex:outputField value="{!dealer__Deal__c.Contract_Status__c}" /--><!-- BLL31a -->
				<apex:outputField value="{!dealer__Deal__c.Credit_Application_Status__c}" />
				<!--BLL61 end -->
                <apex:outputField value="{!dealer__Deal__c.Contract_CounterOffer__c}"/><!-- BLL31a -->
                <apex:pageBlockSectionItem />

                <!-- lease section BLL40 -->
                <apex:outputField value="{!dealer__Deal__c.dealer__First_Payment_Date__c}"  rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
                <apex:outputField value="{!dealer__Deal__c.Contract_LeaseEndDate__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/><!-- BLL31a -->
                <apex:outputField value="{!dealer__Deal__c.LeasePmtDueDOM__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
                <apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>

                <apex:outputField value="{!dealer__Deal__c.LeaseMilesIncluded__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}"/>
                <apex:outputField value="{!dealer__Deal__c.LeaseMilesOverageRate__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/>
                <apex:outputField value="{!dealer__Deal__c.LeaseLatePmtFee__c}"  rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/> 
                <apex:outputField value="{!dealer__Deal__c.LeaseEarlyTerminationFee__c}" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}" styleClass="aright"/> 
                <!-- BLL40a end -->
                
                <!-- apex:inputField value="{!dealer__Deal__c.Finance_Reserve__c}" rendered="{!dealer__Deal__c.Contract_Type__c!=null}" styleClass="aright"/ --><!-- BLL31a -->
                <!-- apex:pageBlockSectionItem rendered="{!dealer__Deal__c.Contract_Type__c!=null}"/ -->

                <apex:outputField value="{!dealer__Deal__c.Credit_Application_Received__c}"/><!-- BLL31a -->
                <apex:outputField value="{!dealer__Deal__c.Credit_Decision_Received__c}"/><!-- BLL31a -->
                <apex:outputField value="{!dealer__Deal__c.Credit_BackToStore__c}"/><!-- BLL31a -->
                <apex:pageBlockSectionItem />

            </apex:pageBlockSection>
            <!-- BLL31a end -->

<apex:pageBlockSection title="Lease information details" columns="1" collapsible="true" id="LeaseInformationTables" rendered="{!dealer__Deal__c.Contract_Type__c='Lease'}">

<apex:outputPanel layout="block">
    <table class="leaseformtable" style="border:1px solid gray; margin-bottom:6pt;">
        <tr>
            <td colspan="4" style="text-align:center;background-color:silver;">
                <b>CONSUMER LEASE DISCLOSURES</b>
            </td>
        </tr>
        <tr>
            <td width="20%">
                Amount due at Lease Signing or Delivery<br/>
                (Itemized below)<br/>
                <apex:outputText value="{0,number,currency}" title="Total itemized amount due">
                <apex:param value="{!dealer__Deal__c.dealer__Deposit__c+dealer__Deal__c.dealer__Down_Pymt__c+dealer__Deal__c.TaxOnCostReduction__c+dealer__Deal__c.Registration_Title_Fee__c+dealer__Deal__c.Contract_Monthly_Payment__c+dealer__Deal__c.dealer__Trade_Allowance__c-dealer__Deal__c.dealer__Trade_Payoff__c}"/>
                </apex:outputText>
            </td>
            <td width="30%">
                Monthly Payments<br/>
                <span style="font-size:8pt;">
                Your first monthly payment of&nbsp;
                    <apex:outputText styleClass="leasemonthlypayment" title="Contract monthly payment" 
                        value="{0,number,currency}">
                    <apex:param value="{!dealer__Deal__c.Contract_Monthly_Payment__c}"/>
                    </apex:outputText>
                is due on&nbsp;
                    <apex:outputText styleClass="proposeddeliverydate" title="Proposed delivery date" 
                        value="{0,date,MM'/'dd'/'yyyy}">
                    <apex:param value="{!dealer__Deal__c.dealer__First_Payment_Date__c}"/>
                    </apex:outputText>
                followed by&nbsp;
                    <apex:outputText styleClass="leasenumberofpayments" title="Lease number of payments less 1"
                        value="{!dealer__Deal__c.Contract_Number_of_Payments__c-1}"/>
                payments of&nbsp;
                    <apex:outputText styleClass="leasemonthlypayment" title="Contract Monthly Payment"
                        value="{0,number,currency}">
                    <apex:param value="{!dealer__Deal__c.Contract_Monthly_Payment__c}"/>
                    </apex:outputText>
                due on the&nbsp;
                    <apex:outputText styleClass="leasepaymentduedom" title="Lease payment due day of month"
                        value="{!dealer__Deal__c.LeasePmtDueDOM__c}"/>
                    
                of each month beginning on&nbsp;
                    <apex:outputText styleClass="leasefirstpaymentdate" title="First payment date" 
                        value="{0,date,MM'/'dd'/'yyyy}">
                    <apex:param value="{!dealer__Deal__c.dealer__First_Payment_Date__c}"/>
                    </apex:outputText>
                The total of your monthly payments is&nbsp;
                    <apex:outputText styleClass="leasetotalofpayments" title="Monthly pmt * Number of pmts"
                        value="{0,number,currency}">
                    <apex:param value="{!dealer__Deal__c.Contract_Monthly_Payment__c*dealer__Deal__c.Contract_Number_of_Payments__c}"/>
                    </apex:outputText>
                </span>
            </td>
            <td width="25%">
                Other Charges<br/>
                (Not part of monthly payment)<br/>
                <apex:outputText value="$ 0" title="Unchangeable"/>
            </td>
            <td width="25%">
                Total of Payments<br/>
                (The amount you will have paid by the end of the lease)<br/>
                <apex:outputText value="{0,number,currency}" title="Contract total of payments">
                <apex:param value="{!dealer__Deal__c.Contract_Total_of_Payments__c}"/>
                </apex:outputText>
            </td>
        </tr>
    </table>

    <apex:variable var="totDue" value="{!0}"/>
    <apex:variable var="totFunding" value="{!0}"/>
    <table class="leaseformtable" style="border:1px solid gray; margin-bottom:6pt;">
        <tr>
            <td colspan="5" style="text-align:center;background-color:silver;">
                <b>Itemization of Amount Due at Lease Signing or Delivery</b>
            </td>
        </tr>
        <tr>
            <td colspan="2" style="text-align:center;">Amount due at signing</td>
            <td>&nbsp;</td>
            <td colspan="2" style="text-align:center;">How the amount will be paid</td>
        </tr>
        <tr>
            <td>Capitalized Cost Reduction</td>
            <td style="text-align:right;">
                <apex:variable var="ccr" value="{!dealer__Deal__c.dealer__Down_Pymt__c+dealer__Deal__c.dealer__Trade_Allowance__c-dealer__Deal__c.dealer__Trade_Payoff__c+dealer__Deal__c.TotalOutsideFunding__c}"/>
                <apex:outputText title="Down payment + Trade Allowance + Outside funding" value="{0,number,currency}">
                <apex:param value="{!ccr}"/>
                </apex:outputText>
                <apex:variable var="totDue" value="{!totDue + ccr}"/>
            </td>
            <td>&nbsp;</td>
            <td>Net trade in allowance</td>
            <td style="text-align:right;">
                <apex:variable var="tradealw" value="{!dealer__Deal__c.dealer__Trade_Allowance__c-dealer__Deal__c.dealer__Trade_Payoff__c}"/>
                <apex:outputText title="Total trade allowance" value="{0,number,currency}">
                <apex:param value="{!tradealw}"/>
                </apex:outputText>
                <apex:variable var="totFunding" value="{!totFunding + tradealw}"/>
            </td>
        </tr>
        <tr>
            <td>Tax on Capitalized Cost Reduction</td>
            <td style="text-align:right;">
                <apex:variable var="ccrtax" value="{!dealer__Deal__c.TaxOnCostReduction__c}"/>
                <apex:outputText title="Tax on Cost Reduction" value="{0,number,currency}">
                <apex:param value="{!ccrtax}"/>
                </apex:outputText>
                <apex:variable var="totDue" value="{!totDue + ccrtax}"/>
            </td>
            <td>&nbsp;</td>
            <td>Rebates and non-cash credits</td>
            <td style="text-align:right;" title="Unchangeable">$ 0</td>
        </tr>
        <tr>
            <td>Refundable Security deposit</td>
            <td style="text-align:right;" title="Unchangeable">$ 0</td>
            <td>&nbsp;</td>
            <td>Other funding sources</td>
            <td style="text-align:right;">
                <apex:variable var="outside" value="{!dealer__Deal__c.TotalOutsideFunding__c}"/>
                <apex:outputText title="Registration / Title Fee" value="{0,number,currency}">
                <apex:param value="{!outside}"/>
                </apex:outputText>
                <apex:variable var="totFunding" value="{!totFunding + outside}"/>
            </td>
        </tr>
        <tr>
            <td>Registration, document and other fees</td>
            <td style="text-align:right;">
                <!-- apex:variable var="fees" value="{!IF(dealer__Deal__c.LeaseDocFeeHandling__c!='Capitalized', dealer__Deal__c.Registration_Title_Fee__c, 0)}"/ -->
                <apex:variable var="fees" value="{!0}"/>
                <apex:outputText title="Registration / Title Fee" value="{0,number,currency}">
                <apex:param value="{!fees}"/>
                </apex:outputText>
                <apex:variable var="totDue" value="{!totDue + fees}"/>
            </td>
            <td>&nbsp;</td>
            <td>Amount to be paid in cash</td>
            <td style="text-align:right;">
                <apex:variable var="cash" value="{!dealer__Deal__c.dealer__Down_Pymt__c+dealer__Deal__c.TaxOnCostReduction__c+dealer__Deal__c.TotalUpFrontFees__c+dealer__Deal__c.Contract_Monthly_Payment__c}"/>
                <apex:outputText title="Down+Up front Fees+First pmt (which is also deposit)" value="{0,number,currency}">
                <apex:param value="{!cash}"/>
                </apex:outputText>
                <apex:variable var="totFunding" value="{!totFunding + cash}"/>
            </td>
        </tr>
        <tr>
            <td>First monthly payment</td>
            <td style="text-align:right;">
                <apex:variable var="mthlypmt" value="{!dealer__Deal__c.Contract_Monthly_Payment__c}"/>
                <apex:outputText title="Contract Monthly Payment" value="{0,number,currency}">
                <apex:param value="{!mthlypmt}"/>
                </apex:outputText>
                <apex:variable var="totDue" value="{!totDue + mthlypmt}"/>
            </td>
            <td>&nbsp;</td>
            <td></td>
            <td style="text-align:right;"></td>
        </tr>
        <tr>
            <td>Other Membership Fee</td>
            <td style="text-align:right;" title="Unchangeable">$ 0</td>
            <td>&nbsp;</td>
            <td>
            </td>
            <td style="text-align:right;"></td>
        </tr>
        <tr>
            <td>Other Up Front Sales Tax</td>
            <td style="text-align:right;">
                <apex:variable var="upfrontslstax" value="{!IF(dealer__Deal__c.LeaseSalesTaxHandling__c!='Capitalized', dealer__Deal__c.dealer__Sales_Tax__c, 0)}"/>
                <apex:outputText value="{0,number,currency}" title="Sales tax, not capitalized">
	                <apex:param value="{!upfrontslstax}"/>
                </apex:outputText>
                <apex:variable var="totDue" value="{!totDue + upfrontslstax}"/>
            </td>
            <td>&nbsp;</td>
            <td></td>
            <td style="text-align:right;"></td>
        </tr>
        <tr>
            <td style="text-align:right;"><b>Total</b></td>
            <td style="text-align:right;">
                <apex:outputText title="Total amounts due at signing" value="{0,number,currency}">
                <apex:param value="{!totDue}"/>
                </apex:outputText>
            </td>
            <td>&nbsp;</td>
            <td style="text-align:right;">Total</td>
            <td style="text-align:right;">
                <apex:outputText title="Total amounts funded" value="{0,number,currency}">
                <apex:param value="{!totFunding}"/>
                </apex:outputText>
            </td>
        </tr>
        <apex:outputPanel layout="none" rendered="{!totDue!=totFunding}">
        <tr>
            <td>
            </td>
            <td>
            </td>
            <td>&nbsp;</td>
            <td style="text-align:right;">
                Under / (Over) funded
            </td>
            <td style="text-align:right;">
                <apex:outputText title="Total due less Amount to be paid" value="{0,number,currency}">
                <apex:param value="{!totDue-totFunding}"/>
                </apex:outputText>
            </td>
        </tr>
        </apex:outputPanel>
    </table>

    <table class="leaseformtable" style="border:1px solid gray; margin-bottom:6pt;">
        <tr>
            <td colspan="2" style="text-align:center;background-color:silver;">
                <b>Monthly payment calculations</b>
            </td>
        </tr>
        <tr>
            <td width="80%">Value of the vehicle</td>
            <td style="text-align:right;" width="20%">
                <apex:outputText title="Chassis + Conversion + Added equipment"
                    value="{0,number,currency}">
                <apex:param value="{!dealer__Deal__c.Chassis_Price__c+dealer__Deal__c.Conversion_Price__c+dealer__Deal__c.Total_Additional_Equipment__c}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Gross capitalized cost</td>
            <td style="text-align:right;">
                <apex:outputText title="Price of sale (Chassis+Conversion+Equip+ESC+Fees)"
                    value="{0,number,currency}">
                <apex:param value="{!dealer__Deal__c.Chassis_Price__c+dealer__Deal__c.Conversion_Price__c+dealer__Deal__c.Total_Additional_Equipment__c+dealer__Deal__c.Total_Protection_Products__c+dealer__Deal__c.dealer__Total_Fees__c-upfrontslstax}"/>
                <!-- apex:param value="{!dealer__Deal__c.Chassis_Price__c+dealer__Deal__c.Conversion_Price__c+dealer__Deal__c.Total_Additional_Equipment__c+dealer__Deal__c.dealer__Total_Fees__c+dealer__Deal__c.Total_Protection_Products__c}"/ -->
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Capitalized cost reduction</td>
            <td style="text-align:right;">-&nbsp;
                <apex:outputText title="Down payment+Trade+Outside funding+discount" value="{0,number,currency}">
                <apex:param value="{!dealer__Deal__c.dealer__Down_Pymt__c+dealer__Deal__c.dealer__Trade_Allowance__c-dealer__Deal__c.dealer__Trade_Payoff__c+dealer__Deal__c.TotalOutsideFunding__c+dealer__Deal__c.Conversion_Discount__c}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Adjusted capitalized cost</td>
            <td style="text-align:right;">=&nbsp;
                <apex:outputText title="Contract Amount Financed" value="{0,number,currency}">
                <apex:param value="{!dealer__Deal__c.Contract_Amount_Financed__c}"/>
                </apex:outputText><br/>
                <apex:outputText rendered="{!dealer__Deal__c.Contract_Amount_Financed__c!=(dealer__Deal__c.Chassis_Price__c+dealer__Deal__c.Conversion_Price__c+dealer__Deal__c.Total_Additional_Equipment__c+dealer__Deal__c.dealer__Total_Fees__c+dealer__Deal__c.Total_Protection_Products__c-(dealer__Deal__c.dealer__Down_Pymt__c+dealer__Deal__c.TotalOutsideFunding__c+dealer__Deal__c.dealer__Trade_Allowance__c-dealer__Deal__c.dealer__Trade_Payoff__c+dealer__Deal__c.Conversion_Discount__c)-upfrontslstax)}"
                    title="Gross Capitalized Cost less Capitalized Cost Reduction">
                    Contract Amount Financed should be {!(dealer__Deal__c.Chassis_Price__c+dealer__Deal__c.Conversion_Price__c+dealer__Deal__c.Total_Additional_Equipment__c+dealer__Deal__c.dealer__Total_Fees__c+dealer__Deal__c.Total_Protection_Products__c-(dealer__Deal__c.dealer__Down_Pymt__c+dealer__Deal__c.TotalOutsideFunding__c+dealer__Deal__c.dealer__Trade_Allowance__c-dealer__Deal__c.dealer__Trade_Payoff__c+dealer__Deal__c.Conversion_Discount__c)-upfrontslstax)}
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Residual value</td>
            <td style="text-align:right;">-&nbsp;
                <apex:outputText title="Residual value" value="{0,number,currency}">
                <apex:param value="{!dealer__Deal__c.Contract_ResidualValue__c}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Depreciation and any amortized amounts</td>
            <td style="text-align:right;">=&nbsp;
                <apex:outputText title="Adjusted capitalized cost less Residual value" value="{0,number,currency}">
                <!-- apex:param value="{!dealer__Deal__c.Contract_Amount_Financed__c-(dealer__Deal__c.dealer__Deposit__c+dealer__Deal__c.dealer__Down_Pymt__c+dealer__Deal__c.dealer__Trade_Allowance__c-dealer__Deal__c.dealer__Trade_Payoff__c)-dealer__Deal__c.Contract_ResidualValue__c}"/ -->
                <apex:param value="{!dealer__Deal__c.Contract_Amount_Financed__c-dealer__Deal__c.Contract_ResidualValue__c}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Rent charge</td>
            <td style="text-align:right;" title="Finance Charge">-&nbsp;&nbsp;
                <apex:outputText title="Adjusted capitalized cost less Residual value" value="{0,number,currency}">
                <apex:param value="{!dealer__Deal__c.Contract_Finance_Charge__c}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Total of base monthly payments</td>
            <td style="text-align:right;">=&nbsp;
                <apex:outputText title="Adjusted capitalized cost less Residual value" value="{0,number,currency}">
                <!-- apex:param value="{!dealer__Deal__c.Contract_Amount_Financed__c-(dealer__Deal__c.dealer__Deposit__c+dealer__Deal__c.dealer__Down_Pymt__c+dealer__Deal__c.dealer__Trade_Allowance__c-dealer__Deal__c.dealer__Trade_Payoff__c)-dealer__Deal__c.Contract_ResidualValue__c+dealer__Deal__c.Contract_Finance_Charge__c}"/ -->
                <apex:param value="{!dealer__Deal__c.Contract_Amount_Financed__c-dealer__Deal__c.Contract_ResidualValue__c+dealer__Deal__c.Contract_Finance_Charge__c}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Lease payments</td>
            <td style="text-align:right;">&divide;&nbsp;
            <apex:outputText title="Contract number of payments" value="{!dealer__Deal__c.Contract_Number_of_Payments__c}"/>
            </td>
        </tr>
        <tr>
            <td>Base monthly payment</td>
            <td style="text-align:right;">=&nbsp;
                <apex:outputText title="Total of base monthly payments / Nbr of payments" value="{0,number,currency}">
                <!-- apex:param value="{!(dealer__Deal__c.Contract_Amount_Financed__c-(dealer__Deal__c.dealer__Deposit__c+dealer__Deal__c.dealer__Down_Pymt__c+dealer__Deal__c.dealer__Trade_Allowance__c-dealer__Deal__c.dealer__Trade_Payoff__c)-dealer__Deal__c.Contract_ResidualValue__c+dealer__Deal__c.Contract_Finance_Charge__c) / dealer__Deal__c.Contract_Number_of_Payments__c}"/ -->
                <apex:param value="{!(dealer__Deal__c.Contract_Amount_Financed__c-dealer__Deal__c.Contract_ResidualValue__c+dealer__Deal__c.Contract_Finance_Charge__c) / dealer__Deal__c.Contract_Number_of_Payments__c}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Monthly sales/use tax</td>
            <td style="text-align:right;">
                <apex:outputText title="Lease monthly sales tax" value="{0,number,currency}">
                <apex:param value="{!dealer__Deal__c.LeaseMonthlySalesTax__c}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Total monthly payment</td>
            <td style="text-align:right;">
                <apex:outputText title="Lease monthly sales tax" value="{0,number,currency}">
                <apex:param value="{!dealer__Deal__c.Contract_Monthly_Payment__c}"/>
                </apex:outputText><br/>
                <apex:outputText value="Payment should be {0,number,currency}" 
                        rendered="{!dealer__Deal__c.Contract_Monthly_Payment__c!=ROUND(((dealer__Deal__c.Contract_Amount_Financed__c-dealer__Deal__c.Contract_ResidualValue__c+dealer__Deal__c.Contract_Finance_Charge__c) / dealer__Deal__c.Contract_Number_of_Payments__c)+IF(dealer__Deal__c.LeaseMonthlySalesTax__c==null,0,dealer__Deal__c.LeaseMonthlySalesTax__c),2)}">
                <apex:param value="{!ROUND(((dealer__Deal__c.Contract_Amount_Financed__c-dealer__Deal__c.Contract_ResidualValue__c+dealer__Deal__c.Contract_Finance_Charge__c) / dealer__Deal__c.Contract_Number_of_Payments__c)+IF(dealer__Deal__c.LeaseMonthlySalesTax__c==null,0,dealer__Deal__c.LeaseMonthlySalesTax__c),2)}"/>
                </apex:outputText>
                
            </td>
        </tr>
    </table>

    <table class="leaseformtable" style="border:1px solid gray; margin-bottom:6pt;">
        <tr>
            <td colspan="5" style="text-align:center;background-color:silver;">
                <b>Itemization of Gross Capitalized Cost</b>
            </td>
        </tr>
        <tr>
            <td>Agreed upon value of the vehicle</td>
            <td style="text-align:right;">
                <apex:outputText value="{0,number,currency}" title="Chassis+Conversion+Equipment">
                <apex:param value="{!dealer__Deal__c.Chassis_Price__c+dealer__Deal__c.Conversion_Price__c+dealer__Deal__c.Total_Additional_Equipment__c}"/>
                </apex:outputText>
            </td>
            <td>&nbsp;</td>
            <td>Optional Products and Services</td>
            <td style="text-align:right;">
            </td>
        </tr>
        <tr>
            <td>Other amounts included in the gross capitalized cost</td>
            <td style="text-align:right;">
            </td>
            <td>&nbsp;</td>
            <td>Mechanical breakdown protection</td>
            <td style="text-align:right;">
                <apex:outputText value="{0,number,currency}" title="Roadside protection">
                <apex:param value="{!RoadsideAmount}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Taxes</td>
            <td style="text-align:right;">
                <apex:outputText value="{0,number,currency}" title="Sales tax">
                <!-- apex:param value="{!IF(dealer__Deal__c.LeaseSalesTaxHandling__c=='Capitalized', dealer__Deal__c.dealer__Sales_Tax__c, 0)}"/ -->
                <apex:param value="{!dealer__Deal__c.dealer__Sales_Tax__c}"/>
                </apex:outputText>
            </td>
            <td>&nbsp;</td>
            <td>Service Contract</td>
            <td style="text-align:right;">
                <apex:outputText value="{0,number,currency}" title="Service Contract">
                <apex:param value="{!ServiceContractAmount}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Registration, doc and other fees</td>
            <td style="text-align:right;">
                <apex:outputText value="{0,number,currency}" title="Sales tax">
                <!-- apex:param value="{!IF(dealer__Deal__c.LeaseDocFeeHandling__c!='Capitalized', dealer__Deal__c.dealer__Total_Fees__c - dealer__Deal__c.TotalUpFrontFees__c, 0)}"/ -->
                <apex:param value="{!dealer__Deal__c.dealer__Total_Fees__c - dealer__Deal__c.TotalUpFrontFees__c}"/>
                </apex:outputText>
            </td>
            <td>&nbsp;</td>
            <td>Gap Contract or Coverage or Waiver</td>
            <td style="text-align:right;">
                <apex:outputText value="{0,number,currency}" title="Gap">
                <apex:param value="{!GapAmount}"/>
                </apex:outputText>
            </td>
        </tr>
        <tr>
            <td>Lease Acquisition Fee</td>
            <td style="text-align:right;">
                <apex:outputText value="{0,number,currency}" title="Sales tax">
                <apex:param value="{!dealer__Deal__c.LeaseAcquisitionFee__c}"/>
                </apex:outputText>
            </td>
            <td>&nbsp;</td>
            <td></td>
            <td style="text-align:right;">
            </td>
        </tr>
        <tr>
            <td>Documentation Fee</td>
            <td style="text-align:right;">
                <apex:outputText value="{0,number,currency}" title="Sales tax">
                <apex:param value="{!dealer__Deal__c.dealer__Doc_Fee__c}"/>
                </apex:outputText>
            </td>
            <td>&nbsp;</td>
            <td></td>
            <td style="text-align:right;">
            </td>
        </tr>
        <tr>
            <td>Prior credit or lease balance on trade-in vehicle</td>
            <td style="text-align:right;">
                <apex:outputText value="{0,number,currency}" title="Trade payoff">
                <apex:param value="{!dealer__Deal__c.dealer__Trade_Payoff__c}"/>
                </apex:outputText>
            </td>
            <td>&nbsp;</td>
            <td>Total Gross Capitalized Cost</td>
            <td style="text-align:right;">
                <apex:outputText value="{0,number,currency}" title="Total of this section">
                <apex:param value="{!dealer__Deal__c.Chassis_Price__c+dealer__Deal__c.Conversion_Price__c+dealer__Deal__c.Total_Additional_Equipment__c+dealer__Deal__c.dealer__Total_Fees__c+dealer__Deal__c.Total_Protection_Products__c+dealer__Deal__c.dealer__Trade_Payoff__c}"/>
                </apex:outputText>
            </td>
        </tr>
    </table>
</apex:outputPanel>
</apex:pageBlockSection>

            </apex:pageBlock>

            <!-- Selected Equipment Action Status -->
            <apex:actionStatus id="equipmentStatus" 
                           onstart="seStart()"
                           onstop="seEnd()"/>
            <apex:actionStatus id="eqsDropDownStatus" onstart="eqsDdStart()" onstop="eqsDdEnd()"/><!-- BLL7a -->


        </apex:form>

<!-- BLL36a Save Pacifier Modal -->
  <div class="modal fade" id="saveNotice" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Saving proposal</h4>
        </div>
        <div class="modal-body">
          <p>Please wait...</p>
        </div>
        <div class="modal-footer">
          <!-- button type="button" class="btn btn-default" data-dismiss="modal">Close</button -->
        </div>
      </div>
      
    </div>
  </div>
<!-- BLL36a end -->
            <span id="sec_preview"></span>

            <span id="sec_approval"></span>
            <apex:relatedList list="ProcessSteps" />

<!-- BLL63d
	        <span id="sec_notes_attachments"></span>
            <apex:relatedList list="CombinedAttachments" />  
            <apex:relatedList list="AttachedContentDocuments" />  
            <apex:relatedList list="AttachedContentNotes" />  
-->
            <!-- BLL37a -->
<!-- BLL63d
            <apex:relatedList list="OpenActivities" />  
			<apex:relatedList list="ActivityHistories" />
-->

		  <!--RT2-->
<!-- BLL63d
          <apex:outputPanel rendered="{!$ObjectType.c2g__codaTransaction__c.accessible}">
              <span id="journals"></span>
              <apex:relatedList list="Transactions__r"  rendered="{!$ObjectType.c2g__codaTransaction__c.accessible}"/>
          </apex:outputPanel>
-->

<!-- BLL9a -->
<!-- BLL63d
<apex:pageBlock rendered="{!historyAvailable}" id="objectHistoryBlock" mode="maindetail" tabStyle="{!IF(tabstyle='Commercial','Commercial_Quote__c','dealer__Deal__c')}">
<apex:pageBlockSection collapsible="true" id="objectHistorySection" columns="1" title="Proposal History">
<apex:pageBlockSectionItem >
<apex:pageBlockTable value="{!HistoryLines}" var="h">
   <apex:column value="{!h.whattime}" style="min-width: 12em;">
     <apex:facet name="header">Date</apex:facet>
   </apex:column>
   <apex:column headerValue="User" style="min-width: 13em;">
    <apex:outputLink value="/{!h.who.Id}">{!h.username}</apex:outputLink>
   </apex:column>
   <apex:column headerValue="Action">
      <apex:outputText escape="false" value="{!h.action}" /> 
   </apex:column>
</apex:pageBlockTable>
</apex:pageBlockSectionItem>
</apex:pageBlockSection>
<script> 
    twistSection(document.getElementById('{!$Component.objectHistoryBlock.objectHistorySection}').getElementsByTagName('img')[0]); 
</script>
</apex:pageBlock>
-->
<!-- BLL9 end test -->
            <!-- Modal Dialogs -->
            <div class="modal fade" id="multiQuoteDialog" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismisss="modal">
                                    <span aria-hidden="true">&times;</span>
                                    <span class="sr-only">Close</span>
                                </button>
                                <h4 class="modal-title" id="myModalLabel">Multiple Payment Options <small class="multiQuoteBalance"></small></h4>
                            </div>
                            <div class="modal-body">
                                <table class="table">                          
                                    <tr>
                                        <td><!-- BLL36a -->
                                            <b>Balloon</b> <input class="form-control" id="MQballoon" style="width:5em;display:inline;" type="text" value="{!multiQuote.balloon}" />
                                            &nbsp;
                                        </td>
                                        <td>
                                            <b>Plan 1 </b>
                                        </td>
                                        <td>
                                            <b>Plan 2 </b>
                                        </td>
                                        <td>
                                           <b>Plan 3 </b>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><b>Down Payment</b></td>
                                        <!-- JVK3 - Use the stored values for Term / Rate -->
                                        <td>
        
                                            <input class="form-control" id="MQterm1"  style="width:65px;display:inline;" type="text" value="{!multiQuote.term1}" />
                                            <span style="color:#bdc3c7;">Mo.&nbsp;</span>
                                            <input class="form-control" id="MQrate1" style="width:65px;display:inline;" type="text" value="{!multiQuote.rate1}" />
                                            <span style="color:#bdc3c7;">APR</span>

                                        </td>
                                        <td>
                                            <input class="form-control" id="MQterm2"  style="width:65px;display:inline;" type="text" value="{!multiQuote.term2}" />
                                            <span style="color:#bdc3c7;">Mo.&nbsp;</span>
                                            <input class="form-control" id="MQrate2" style="width:65px;display:inline;" type="text" value="{!multiQuote.rate2}" />
                                            <span style="color:#bdc3c7;">APR</span>
                                        </td>
                                        <td>
                                            <input class="form-control" id="MQterm3"  style="width:65px;display:inline;" type="text" value="{!multiQuote.term3}" />
                                            <span style="color:#bdc3c7;">Mo.&nbsp;</span>
                                            <input class="form-control" id="MQrate3" style="width:65px;display:inline;" type="text" value="{!multiQuote.rate3}" />
                                            <span style="color:#bdc3c7;">APR</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input class="form-control" id="MQdown1" style="width:145px;" type="text" value="{!multiquote.down1}" /></td>
                                        <td><input class="form-control" id="MQpymt_1_1" style="width:145px;" type="text" value="{!multiquote.payment1_1}" /></td>
                                        <td><input class="form-control" id="MQpymt_1_2" style="width:145px;" type="text" value="{!multiquote.payment1_2}" /></td>
                                        <td><input class="form-control" id="MQpymt_1_3" style="width:145px;" type="text" value="{!multiquote.payment1_3}" /></td>
                                    </tr>
                                    <tr>
                                        <td><input class="form-control" id="MQdown2" style="width:145px;" type="text" value="{!multiquote.down2}" /></td>
                                        <td><input class="form-control" id="MQpymt_2_1" style="width:145px;" type="text" value="{!multiquote.payment1_2}" /></td>
                                        <td><input class="form-control" id="MQpymt_2_2" style="width:145px;" type="text" value="{!multiquote.payment2_2}" /></td>
                                        <td><input class="form-control" id="MQpymt_2_3" style="width:145px;" type="text" value="{!multiquote.payment2_3}" /></td>
                                    </tr>
                                    <tr>
                                        <td><input class="form-control" id="MQdown3" style="width:145px;" type="text" value="{!multiquote.down3}" /></td>
                                        <td><input class="form-control" id="MQpymt_3_1" style="width:145px;" type="text" value="{!multiquote.payment3_1}" /></td>
                                        <td><input class="form-control" id="MQpymt_3_2" style="width:145px;" type="text" value="{!multiquote.payment3_2}" /></td>
                                        <td><input class="form-control" id="MQpymt_3_3" style="width:145px;" type="text" value="{!multiquote.payment3_3}" /></td>
                                    </tr>

                                    <tr>
                                        <td>&nbsp;</td>
                                        <td><input type="button" class="btn btn-sm btn-success" value="Select" /></td>
                                        <td><input type="button" class="btn btn-sm btn-success" value="Select" /></td>
                                        <td><input type="button" class="btn btn-sm btn-success" value="Select" /></td>
                                    </tr>                                                            
                                </table>
                            </div>
                            <div class="modal-footer">
                                <a type="button" class="btn-info btn-xs btn btn-default pull-left" href="/apex/MultiQuote2_PDF?id={!dealer__Deal__c.Id}" target="_blank">PDF</a>
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>   
                            </div>
                        </div>
                    </div>
                    </div>                     
            <!-- End Modal Dialogs -->
      </div>
      <!--/left-->

      <!--right-->
      <div class="col-md-3" id="rightCol">
        <div id="sidebar" data-spy="affix"><!-- BLL36c data-spy="affix" -->


<!-- BLL33a -->
<apex:outputPanel layout="block" style="height:20px;">
<!--BLL55-->
<a href="/apex/DealMBW2?id={!dealer__Deal__c.Id}" target="_blank" style="float:right;">
<!--div class="slds-scope" -->
<svg aria-hidden="true" class="slds-icon" title="Full-screen" style="height:14px;width:14px;fill:black;">
    <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#expand_alt')}">
        <title>Full-screen</title>
    </use>
</svg>
<!--div -->
</a>
<!--BLL55 end-->
<apex:outputPanel rendered="{!AND($Permission.canOverrideToNativeLayout,deal.id!=null)}" id="NativeLayoutLinks"
    layout="none">
Native page: 
    [<a href="{!URLFOR($Action.dealer__Deal__c.View, deal.id, null, true)}">view</a>] 
    [<a href="{!URLFOR($Action.dealer__Deal__c.Edit, deal.Id, null, true)}">edit</a>]
</apex:outputPanel>
</apex:outputPanel>
<!-- BLL33a end -->


        <ul class="nav nav-stacked">

          <!-- Nav Column -->
          <apex:outputText rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
          
          <!-- BLL36a static location for save button -->
          <!-- li>
            <input type="submit" onclick="saveForm();" value="Save" class="btn btn-primary btn-info btn-sm" id="saveButtonMenu"></input>
          </li -->
          <!-- BLL36a end -->
          
          <li style="height:40px;">
			<span class="totColumn">
			     <input type="submit" onclick="saveForm();" value="Save" class="btn btn-primary btn-info btn-sm" id="saveButtonMenu"></input>
			</span>
            <a href="#sec_customer">Client Information</a>
          </li>

          <apex:outputText rendered="{!isVehicleSale}"> <!-- BLL36c rendered="{!IF(recordTypeName=='Retail_Vehicle_Sale',true,false)}" -->
          <li>
            <span id="tot_chassis" class="totColumn">$0</span>
            <a href="#sec_chassis">Chassis / Conversion</a>
          </li>
          </apex:outputText>

          <apex:outputText rendered="{!isCustomerVehicle}"><!-- BLL36c was rendered="{!IF(recordTypeName=='Equipment_Only_Sale',true,false)}"-->
          <li>
            <a href="#sec_chassis">Customer Owned Chassis</a>
          </li>
          </apex:outputText>          

          <!-- BLL16d apex:outputText rendered="{!IF(recordTypeName=='Retail_Vehicle_Sale',true,false)}"> -->
          <li>
            <span id="tot_fees" class="totColumn">$0</span>
            <a href="#sec_fees">Fees / Taxes</a>
          </li>  
          <!-- BLL16d /apex:outputText --> 

        <!-- BLL40a -->
        <apex:outputPanel layout="none" rendered="{!RecordTypeName=='Commercial'}">
          <li>
            <span id="tot_freight" class="totColumn">$0</span>
            <a href="#sec_recap">Freight</a>
          </li>  
        </apex:outputPanel>
        <!-- BLL40a end -->

          <li>
            <a href="#sec_equipment">Additional Equipment</a><button class="btn-link" data-toggle="collapse" data-target="#selectedKits"><span class="caret"></span></button>
            <apex:outputPanel id="selectedAftermarketItems">
            <span id="tot_equipment" class="totColumn">
                <apex:outputText value="{0, number, $###,##0.00}">
                    <apex:param value="{!afterMarketTotal}"/>
                </apex:outputText>
            </span>
            </apex:outputPanel>
            <!-- Chosen Equipment -->
            <ul class="nav collapse" id="selectedKits">
                <apex:repeat value="{!selectedKits}" var="s">
                    <span id="tot_chass_{!s.Id}" class="totColumn">
                        <apex:outputText value="{0, number, $###,##0.00}">
                            <apex:param value="{!s.dealer__Sale_Price__c}"/>
                        </apex:outputText>                      
                    </span>
                    <li><a href="#sec_equipment">{!s.Name}</a></li>
                </apex:repeat>
            </ul>
          </li>

          <li>
            <span id="tot_esc" class="totColumn">$0.00</span>
            <a href="#sec_esc">Protection Products</a><button class="btn-link" data-toggle="collapse" data-target="#selectedContracts"><span class="caret"></span></button>
            <!-- List the Service Contracts -->
                <ul class="nav collapse" id="selectedContracts">
                    <apex:repeat value="{!soldOnProposal}" var="esc">
                        <span id="tot_esc_{!esc.Id}" class="totColumn">
                            <apex:outputText value="{0, number, $###,##0.00}">
                                <apex:param value="{!esc.dealer__Sale_Price__c}"/>
                            </apex:outputText>                      
                        </span>
                        <li><a href="#sec_esc">{!esc.dealer__Description__c}</a></li>                       
                    </apex:repeat>
                </ul>
          </li>

          <li><!-- BLL50a -->
            <span id="tot_discount" class="totColumn">$0.00</span>
            <a href="#sec_chassis">Discount</a>
          </li>

          <li>
            <span id="tot_rebates" class="totColumn">$0.00</span>
            <a href="#sec_chassis">Rebate(s)</a>
          </li>

          
          <li><span id="tot_cart" class="totColumn">$0.00</span><a href="#" style="text-decoration:none;font-weight:bold;color:darkblue;">Total Proposal</a></li>

          <li>
            <span id="tot_trade" class="totColumn">$0.00</span>
            <a href="#sec_trade">Trade(s)</a>
          </li>

          <li>
            <span id="tot_payments" class="totColumn">$0.00</span>
            <a href="#sec_payments">Grants / Other Funding Sources</a>
          </li>

          <li>
            <span id="tot_down" class="totColumn">$0.00</span>
            <a href="#sec_chassis">
            <apex:outputText value="{!IF(AND(dealer__Deal__c.Funding_option__c=='Financed',dealer__Deal__c.Contract_Type__c=='Lease'),'Cap Cost Reduction','Down / Deposit')}"/>
            </a>
          </li>          
          
          <li>
            <span id="tot_financed" class="totColumn">$0.00</span>
            <a href="#sec_finance">Financing</a>
          </li>
          
<apex:outputPanel layout="none" rendered="{!AND(dealer__Deal__c.Funding_option__c=='Financed',dealer__Deal__c.Contract_Type__c=='Lease')}">
          <li>
            <span id="lease_first_pmt" class="totColumn">$0.00</span>
            <a href="#sec_finance">First payment</a>
          </li>
</apex:outputPanel>

          <li><span id="tot_due" class="totColumn">$0.00</span>
          <a href="#" style="text-decoration:none;font-weight:bold;color:darkblue;">Due</a>
          </li><!-- BLL44a -->

          <!--
          <apex:outputText rendered="{!IF(recordTypeName=='Retail_Vehicle_Sale',true,false)}">
          <li><a href="#sec_mq">Multi-Qoute</a></li>
          <li><a href="#sec_commission">Recap</a></li>
          </apex:outputText>
          -->

          <apex:outputText rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
            <li style="height:40px;">
				<span class="totColumn">
      <apex:form ><!-- BLL53a, BLL85 moved -->
            <apex:outputText rendered="{!NOT(ISBLANK(dealer__Deal__c.Id))}">
            <button type="button" id="printProposal" class="btn btn-info btn-xs" onclick="window.open('/apex/{!defaultPDF}?id={!deal.Id}')">Proposal</button>
            <button class="btn btn-info btn-xs" data-toggle="modal" data-target="#multiQuoteDialog" type="button">Multi-Quote</button>
            <!-- BLL53d button type="button" id="formsPage" class="btn btn-primary btn-xs" onclick="window.location.href='/apex/FormManager?id={!deal.Id}'">Forms</button -->
            <apex:commandButton id="formsPage" styleClass="btn btn-info btn-xs" action="{!gotoFormsPage}" value="Form"/>
            </apex:outputText>
      </apex:form><!-- BLL53a -->
				</span>
				<a href="#sec_approval">Approvals</a>
            </li>
          </apex:outputText>
          <!--  li -->
            <!--
            <a href="/apex/Form_ProposalPreview?id={!deal.Id}" target="_blank" class="btn btn-xs">Print Proposal</a>
            <a href="/apex/Form_ProposalPreview?id={!deal.Id}" target="_blank" class="btn btn-xs">Forms</a>
            -->
          <!-- /li -->
          </apex:outputText>
        </ul>
        </div>
      </div>
      <!--/right-->

    </div><!--/row-->
    </div>  

</div><!--/container-->

</apex:outputText><!-- BLL2 -->
<div style="height:400px;"></div>

<!-- BLL54a -->
<form id="fdfForm" method="post" action="https://apsv1.dealerteam.com/docgen/fill/" target="_blank"
	style="display:none;">
<input type="hidden" id="fdf" name="fdf" value="'+result+'" />
<input type="hidden" id="f" name="f" value="'+f+'" />
<input type="hidden" id="DocumentContentId" name="DocumentContentId" value="'+dcid+'" />
<input type="hidden" id="Flatten" name="Flatten" value="'+flatten+'" />
<input type="hidden" id="DocumentName" name="DocumentName" value="'+name+'" />
</form>   
<!-- BLL54a end --> 

</body>
<script type="text/javascript">
//function recalcLease(e) {
//	e = e | window.event;
//	if (e && e.preventDefault) e.preventDefault();
//	if (e && e.stopPropogation) e.stopPropogation();
//	calculateLeasePmt();
//	cDeal();
//	return false;
//}
//function optimizeLeaseDownPmt(e) {
//	e = e | window.event;
//	if (e && e.preventDefault) e.preventDefault();
//	if (e && e.stopPropogation) e.stopPropogation();
//	leaseDesiredUpfrontCash();
//	cDeal();
//	return false;
//}

$dt("#p\\:frm\\:pB\\:pbCustomer\\:buyer_contact").focus();
/* BLL36d unused var introguide = introJs();
introguide.setOptions({
    steps: [
        {
            element : '#proposalHeader',
            intro : 'The Proposal Header is a floating infomration block that will detail the Vehicle, Conversion, Customer and Proposal Status',
            position : 'bottom'
        },
        {
            element: '#p\\:frm\\:pB\\:pbCustomer',
            intro : "Customer Information Block is the area you will store all customer related information for this proposal",
            position : "buttom"
        },
        {
            element : '#p\\:frm\\:pB\\:pbCMC',
            intro : 'CMC Team Block is the area that all CMC related information will be stored',
            position : "bottom"
        },
        {
            element : '#p\\:frm\\:pB\\:coBuyerBlock',
            intro : "Co-Buyer Block is the section any co-buyer data will be recorded",
            position : "bottom"
        },
        {
            element : '#p\\:frm\\:pB\\:pbTitleInfo',
            intro : "Title Information Block is where to store all relevant title information",
            position : "bottom"
        }
    ]
});    
*/ 

/* BLL54 Support for printing FDF form */
        function printPDF_FDF(f, dcid, flatten, name) {
            // $dt.get('/apex/dealer__FormFDFData?fid='+f+'&did='+dealId, function(data) {
              Deal_MBW2.compileFDF('{"form" : "'+f+'", "deal" : "'+dealId+'"}', function(result, event){ 

                  // Open Window and Post FDF Data
                  //BLL4d $dt('<form method="post" action="https://apsv1.dealerteam.com/docgen/fill/'+encodeURIComponent(dcid)+'" target="_blank"><input type="hidden" name="fdf" value="'+result+'" /><input type="hidden" name="f" value="'+f+'" /><input type="hidden" name="DocumentContentId" value="'+dcid+'" /><input type="hidden" name="Flatten" value="'+flatten+'" /><input type="hidden" name="DocumentName" value="'+name+'" /></form>').submit();
                  
                  // BLL4a
                  //if (console) console.log(result);
                  $dt('#fdf').val($dt('<textarea/>').html(result).text());
                  $dt('#f').val(f);
                  $dt('#DocumentContentId').val(dcid);
                  $dt('#Flatten').val(flatten);
                  $dt('#DocumentName').val(name);
                  $dt('#fdfForm').attr('action', 'https://apsv1.dealerteam.com/docgen/fill/'+encodeURIComponent(dcid));
                  $dt('#fdfForm').submit();
        		  // BLL4a end 
        		  
              });
        }        
        

</script>
</html>
</apex:page>