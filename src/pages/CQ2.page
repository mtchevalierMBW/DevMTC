<apex:page showHeader="true" sidebar="false" standardController="CommercialQuote__c" showChat="false" title="{!CommercialQuote__c.Name} Conversion Build Order" id="p" 
            extensions="CQ_EXT,SObjectHistory_EXT" docType="html-5.0">
    <head>
<!--  
   2015-06-02   B. Leaman   BLL2 Auto-resize text areas, allow <CR>; Unit# and VIN; Correct AsyncField ids;
   2015-06-18   B. Leaman   BLL3 When chassis-qty changes, multiply lines instead of replacing qty; 
   2015-07-16   B. Leaman   BLL4 Support multiple selections on options modal selection screens;
   2016-01-12   B. Leaman   BLL5 IT18388 add Mark Lost button. Alertify s/b lowercase.
   2016-02-23   B. Leaman   BLL6 Ability to sell from commercial stock. Lock options already installed on stock veh.
   2016-03-01   B. Leaman   BLL7 Add keyword search to chassis options; link to detail cost report; edit misc descriptions; add transaction related list 
   2016-03-22   RedTeal     RT1  Add the advanced vehicle search functionality to the page
   2016-04-19   B. Leaman   BLL8 Add color & mileage
   2016-04-20   B. Leaman   BLL9 Add forms printing support.
   2016-04-25   B. Leaman   BLL10 Add service mgr and sales mgr for new approval process and user's manager.
   2016-04-27   B. Leaman   BLL11 IT#24094 - Recap shows deposit as a discount
   2016-05-09   B. Leaman   BLL12 IT#24741 - Save commission calc result to database! 
   2016-05-13   B. Leaman   BLL13 Type of sale (Releasing Dealer, Customer Owned, Used).
                            Also save totals when chassis price changes.
   2016-05-18   B. Leaman   BLL14 IT#25172 - option to email the releasing dealer invoice.
   2016-05-19   RedTeal     RT2  Change 'showChat' to false per Kathi's request
   2016-05-19   B. Leaman   BLL15 Don't try to create an async field for opportunity if user cannot see opportunities.
   2016-05-23   B. Leaman   BLL16 report error saving async fields (when returned result is "false"!   
   2016-06-07   B. Leaman   BLL17 add general manager field.
   2016-06-09   B. Leaman   BLL18 Protect inbound freight cost field.
   2016-06-09   B. Leaman   BLL19 Print Invoice version of quote pdf.
   2016-06-10   B. Leaman   BLL20 Show chassis gp on recap (gp = markup = price - cost)
   2016-06-20   B. Leaman   BLL21 Fix unnecessary updates to gross=$0, then back up to correct amount; incl freight in total veh package;
                            Only protect inbound freight if it's the default value of $500.
   2016-06-21   B. Leaman   BLL22 - When quote is marked delivered & vehicle is present, switch gp calc from options costs to vehicle costs.
                            Also show history.
   2016-07-14   B. Leaman   BLL23 undo BLL18 (default freight to $500 and protect it)
   2016-07-19   B. Leaman   BLL24 Tax Exemption support and Releasing Dealer Collects Taxes; fix AsyncField to work with checkboxes;
   2016-09-12   B. Leaman   BLL25 Skip some calcs when displaying a posted quote.
   2016-11-28   B. Leaman   BLL26 Add links to native page layout view and edit for authorized people only.
   2017-02-17   B. Leaman   BLL27 change to a build order as commercial gets combined with retail.
   2019-02-21	B. Leaman	BLL28 remove duplication of static resources
  -->
    <apex:includeScript value="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" />

   <!-- apex:includeScript value="{!URLFOR($Resource.jQuery_UI_1820, 'js/jquery-ui-1.8.20.custom.min.js')}" /-->
  
    <!-- Bootsrap Includes -->
   <!-- BLL28d apex:includeScript value="{!URLFOR($Resource.DTBootStrap,'/js/bootstrap.min.js')}"/-->
   <!-- BLL28d apex:includeScript value="{!URLFOR($Resource.DTBootStrap,'/js/typeahead-bundle.min.js')}"/-->
   <!-- BLL28d apex:stylesheet value="{!URLFOR($Resource.DTBootStrap,'/css/VFbootstrap.css')}"/-->

   <!-- Include JS Notify and Moment -->
   <!-- BLL28d apex:includeScript value="{!URLFOR($Resource.DTBootStrap, '/js/notify.min.js')}" /-->
   <!-- BLL28d apex:includeScript value="{!URLFOR($Resource.DTBootStrap, '/js/moment.min.js')}" /-->

   <!-- Include datepicker -->
   <!-- BLL28d apex:includeScript value="{!URLFOR($Resource.DTBootStrap, '/js/bootstrap-datepicker.js')}" /-->
   <!-- BLL28d apex:stylesheet value="{!URLFOR($Resource.DTBootStrap, '/css/datepicker.css')}" /-->

   <!-- Include Checkbox -->
   <!-- BLL28d apex:includeScript value="{!URLFOR($Resource.DTBootStrap, '/js/bootstrap-checkbox.js')}" /-->
   <!-- BLL28d apex:stylesheet value="{!URLFOR($Resource.DTBootStrap, '/css/bootstrap-checkbox.css')}" /-->

   <!-- Include Select Box -->
   <!-- BLL28d apex:includeScript value="{!URLFOR($Resource.DTBootStrap, '/js/bootstrap-select.min.js')}" /-->
   <!-- BLL28d apex:stylesheet value="{!URLFOR($Resource.DTBootStrap, '/css/bootstrap-select.css')}" /-->

   <!-- Include Tipr-->
   <!-- BLL28d apex:includeScript value="{!URLFOR($Resource.DTBootStrap, '/js/jquery.tooltipster.min.js')}" /-->
   <!-- BLL28d apex:stylesheet value="{!URLFOR($Resource.DTBootStrap, '/css/tooltip/tooltipster.css')}" /-->

<!-- BLL28a copied from DealMBW2 -->
	   <apex:includeScript value="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"/>
	   <!-- Bootsrap Includes -->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources,'/js/bootstrap.min.js')}"/>
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources,'/js/typeahead-bundle.min.js')}"/>
       <apex:stylesheet value="{!URLFOR($Resource.dealer__SDLResources,'/css/VFbootstrap.css')}"/>
       <!--  apex:includeScript value="//code.jquery.com/ui/1.11.2/jquery-ui.js"/ -->       

       <!-- Include JS Notify and Moment -->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/notify.min.js')}" />
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/moment.min.js')}" />

       <!-- Include datepicker -->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/bootstrap-datepicker.js')}" />
       <apex:stylesheet value="{!URLFOR($Resource.dealer__SDLResources, '/css/datepicker.css')}" />

       <!-- Include Checkbox -->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/bootstrap-checkbox.js')}" />
       <apex:stylesheet value="{!URLFOR($Resource.dealer__SDLResources, '/css/bootstrap-checkbox.css')}" />

       <!-- Include Select Box -->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/bootstrap-select.min.js')}" />
       <apex:stylesheet value="{!URLFOR($Resource.dealer__SDLResources, '/css/bootstrap-select.css')}" />

       <!-- Include Tipr-->
       <apex:includeScript value="{!URLFOR($Resource.dealer__SDLResources, '/js/jquery.tooltipster.min.js')}" />
       <apex:stylesheet value="{!URLFOR($Resource.dealer__SDLResources, '/css/tooltip/tooltipster.css')}" />
<!-- BLL28a end copied from DealMBW2 -->

   <!-- Alertify -->
   <apex:includeScript value="//cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.min.js" />
   <apex:stylesheet value="//cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.core.min.css" />
   <apex:stylesheet value="//cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.bootstrap.min.css" />

    <script type="text/javascript">
        $dt = jQuery.noConflict();
        /* activate sidebar */
        var runningTotal = 0;
        var chassis_total= 0;
        var rebates = 0;
        var fees = 0;
        var freight = 0;    // BLL21
        var commissionableGrossSet = false; // BLL21 don't recalc commissions until this amt is available!
        var total_discount= 0;
        var quoteRecord = '{!CommercialQuote__c.Id}';
        var default_comm_rate = '{!CommercialQuote__c.Commission_Rate__c}';
        var viewportWidth = $dt(window).width();
        var scrollPos = $dt(window).scrollTop();
        var chassisqtyval = '{!CommercialQuote__c.Chassis_QTY__c}'; // BLL3
        
        var lastCommission = {!CommercialQuote__c.Commission__c} + 0;   // BLL22a

        $dt(window).scroll(function(){
                set_header_offset();
        });

        function set_header_offset(scrollPos) {
            viewportWidth = $dt(window).width();
            scrollPos = $dt(this).scrollTop();
            if(viewportWidth < 992) {
                if (scrollPos <= 145) {
                    $dt('#rightCol').css('top', 200-scrollPos );
                } else {
                    $dt('#rightCol').css('top', 55 );
                }
            }
        }

        // BLL24a
        function taxableChange() {
            var taxable = $dt('input[id$=chassis_taxable]').is(':checked');
            //if (console) console.log('Taxable='+taxable);
            if (taxable==true) {
                $dt('input[id$=dealerCollectsTax]').removeClass('readonly');
                $dt('input[id$=salestax]').removeClass('readonly');
                taxfield = new AsyncField( $dt('input[id$=salestax]'), 'Tax__c', true, false ); 
                dealerCollectsTax = new AsyncField($dt('input[id$=dealerCollectsTax]'),'ReleasingDealerCollectsTax__c', true, false);   // BLL24a
            } else {
                $dt('input[id$=dealerCollectsTax]').addClass('readonly').off('focus').off('blur');
                $dt('input[id$=salestax]').focus().val('0.00').blur().addClass('readonly').off('focus').off('blur');
            }
        }
        // BLL24a end

        $dt(document).ready(function() {

            // BLL2 - Auto-resize selected textareas 
            $dt.each(jQuery('textarea[data-autoresize=auto]'), function() { 
                var offset = this.offsetHeight - this.clientHeight;
                var resizeTextarea = function(el) {
                    $dt(el).css('height', 'auto').css('height', el.scrollHeight + offset);
                };
                $dt(this).on('keyup input', function() { resizeTextarea(this) }).removeAttr('data-autoresize').css({'overflow':'hidden'}); 
                resizeTextarea(this); // initial resize!
            }); // End auto-resize 

            $dt('#addOtherBtn').click( function(e){
                e.preventDefault();
                if (console) console.log('Clicked Add other!');
                addOtherOption();
            } );

            viewportWidth = $dt(window).width();
            scrollPos = $dt(window).scrollTop();
            set_header_offset();


            $dt('.off_canvas').click(function(){
                $dt('#rightCol').toggleClass('visible');
            });

            // BLL2 don't eliminate <CR>
            //$dt('html').bind('keypress', function(e)
            //{
            //   if(e.keyCode == 13)
            //   {
            //      return false;
            //   }
            //});

            if(viewportWidth>=992) {
                $dt('#sidebar').affix({
                    offset: {
                        top: function() {
                            return $dt('#AppBodyHeader').height();
                        }
                    }
                });
            } 
            // else {
            //     $dt('#rightCol').affix({
            //         offset: {
            //             top: function() {
            //                 return $dt('#AppBodyHeader').height();
            //             }
            //         }
            //     });
            // }

            $dt("#proposalHeader").affix({
                offset: {
                    top: 105
                }
            })

            var $submenu = $dt("#proposalHeader");
            $submenu.after('<div style="width:100%;height:' + $submenu.height() + ';border: 1px solid #7f8c8d;" class="proposalHeader affix-placeholder"></div>');

            /* activate scrollspy menu */
            var $dtbody   = $dt(document.body);
            var navHeight = $dt('.recordHeader').outerHeight(true) + 10;

            $dtbody.scrollspy({
                target: '#rightCol',
                offset: navHeight
            });

            /* smooth scrolling sections */
            $dt('a[href*=#]:not([href=#])').click(function() {
                if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
                  var target = $dt(this.hash);
                  target = target.length ? target : $dt('[name=' + this.hash.slice(1) +']');
                  if (target.length) {
                    $dt('html,body').animate({
                      scrollTop: target.offset().top - 125
                    }, 1000);
                    return false;
                  }
                }
            });

            // Bind to the Fields that require manual save
            /*
            $dt(el('')).on('change',function() {
                saveField( , , );
            });
            */

            /* Fake field for Deposit on the recap page */
            //BLL11d $dt(el('qCommercialDiscount')).val(doubleVal($dt(el('p:frm:pB:quoteMisc:chassis_deposit')).val()));

<apex:outputText rendered="{!NOT(ISBLANK(CommercialQuote__c.Id))}">
//BLL11d already inside a .ready() function   $dt(document).ready( function() { 
            cContact = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cContact')), 'Contact__c', false, false );
            cEmail = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cEmail')), 'Email_Address__c', false, false );
            cPhone = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cPhone')), 'Phone__c', false, false );
            cAddress = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cAddress')), 'Street__c', false, false );
            cCounty = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cCounty')), 'County__c', false, false );
            cFOB = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cFOB')), 'F_O_B__c', false, false );
            cPO = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cPO')), 'Customer_Purchase_Order__c', false, false );
            cAdate = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cAdate')), 'Accepted_Date__c', false, false );
            // BLL7d AsyncField doesn't work for lookups -- it sees the "name" value, not the Id. Remove salesperson & location
            //cSalesperson = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cSalesperson')), 'Salesperson__c', false, false );
            //cLocation = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cLocation')), 'Location__c', false, false); // BLL7a
            // BLL7d end
            //cStatus = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cStatus')), 'Status__c', false, false );
            //cStatus = new AsyncField( $dt(el('p:frm:pB:pbCustomer:stsPanel:cStatus')), 'Status__c', false, false);
            cMobile = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cMobile')), 'Mobile__c', false, false );
            cCity = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cCity')), 'City__c', false, false );

            /*
                $dt(el('p:frm:pB:pbCustomer:cContact')).on('change',function() {
                    saveField('Contact__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cEmail')).on('change',function() {
                    saveField('Email_Address__c', $dt(this).val(), $dt(this).attr('id'));
                }); 
                $dt(el('p:frm:pB:pbCustomer:cPhone')).on('change',function() {
                    saveField('Phone__c', $dt(this).val(), $dt(this).attr('id'));
                }); 
                $dt(el('p:frm:pB:pbCustomer:cAddress')).on('change',function() {
                    saveField('Street__c', $dt(this).val(), $dt(this).attr('id'));
                }); 
                $dt(el('p:frm:pB:pbCustomer:cCounty')).on('change',function() {
                    saveField('County__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cFOB')).on('change',function() {
                    saveField('F_O_B__c', $dt(this).val(), $dt(this).attr('id'));
                });     
                $dt(el('p:frm:pB:pbCustomer:cPO')).on('change',function() {
                    saveField('Customer_Purchase_Order__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cAdate')).on('change',function() {
                    saveField('Accepted_Date__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cSalesperson')).on('change',function() {
                    saveField('Salesperson__c', $dt(el('p:frm:pB:pbCustomer:cSalesperson_lkid')).val(), $dt(this).attr('id'));
                });         
                $dt(el('p:frm:pB:pbCustomer:cStatus')).on('change',function() {
                    saveField('Status__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cMobile')).on('change',function() {
                    saveField('Mobile__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cCity')).on('change',function() {
                    saveField('City__c', $dt(this).val(), $dt(this).attr('id'));
                });
            */
            /* - This event is hooked to Freight Charges
            $dt(el('p:frm:pB:pbCustomer:cState')).on('change',function() {
                saveField('State__c', $dt(this).val(), $dt(this).attr('id'));
            });
            */
            cPostalCode = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cPostalCode')), 'Zip__c', false, false );
            // BLL15d don't need to condition this, it's an output field, so there's no need to use AsyncField.
            //if ('{!$ObjectType.Opportunity.accessible}'=='true') {    // BLL15a
            //  cOpp = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cOpp')), 'Opportunity__c', false, false );
            //} // BLL15a
            cDdate = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cDdate')), 'Delivery_Date__c', false, false );
            cDeliveryNotes = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cDeliveryNotes')), 'Delivery_Notes__c', false, false );
            cDeliveryLocation = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cDeliveryLocation')), 'Delivery_Location__c', false, false );
            cTerms = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cTerms')), 'Terms__c', false, false );
            cJobReference = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cJobReference')), 'Job_Reference__c', false, false );
            // BLL2 
            cUnitNumber = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cUnitNumber')), 'UnitNumber__c', false, false );
            cVIN = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cVIN')), 'VIN__c', false, false );
            // BLL8a
            cExteriorColor = new AsyncField( $dt('input[id$="exteriorcolor"]'), 'ExteriorColor__c', false, false);
            cMileage = new AsyncField( $dt('input[id$="mileage"]'), 'Mileage__c', false, false);
            // BLL8a end

            // Chassis Fields
            chassis = new AsyncField( $dt(el('p:frm:pB:chassis:chassis')), 'Chassis__c', false, false );
            chassis_qty = new AsyncField( $dt(el('p:frm:pB:chassis:chassis_qty')), 'Chassis_QTY__c', false, false );
            chassis_cost = new AsyncField( $dt(el('p:frm:pB:chassis:chassis_cost')), 'Chassis_Cost__c', false, false );
            chassis_price = new AsyncField( $dt(el('p:frm:pB:chassis:chassis_price')), 'Chassis_Price__c', true, false ); // BLL13c save totals = true!
            // BLL2 no matching id: chassis_description = new AsyncField( $dt(el('p:frm:pB:chassis:chassis_description')), 'Chassis_Description__c', false, false );
            chassis_wheelbase = new AsyncField( $dt(el('p:frm:pB:chassis:chassis_wheelbase')), 'Chassis_Platform_Wheelbase__c', false, false );
            chassis_mfg = new AsyncField( $dt(el('p:frm:pB:chassis:chassis_mfg')), 'Chassis_Platform__c', false, false );

            if ('{!CommercialQuote__c.Customer__r.SalesTaxStatus__c}'!='Exempt') {  // BLL24a - only allow change if customer is not exempt
                taxfield = new AsyncField( $dt('input[id$=salestax]'), 'Tax__c', true, false ); // BLL13c save totals = true
            } // BLL24a
            dealerCollectsTax = new AsyncField( $dt('input[id$=dealerCollectsTax]'), 'ReleasingDealerCollectsTax__c', true, false); // BLL24a
            chassis_taxable   = new AsyncField( $dt('input[id$=chassis_taxable]'),   'Chassis_Taxable__c', false, 
                function() {taxableChange();} 
            ); // BLL24c
            if (console) console.log('Setup tax fields first time');
            if ('{!CommercialQuote__c.Status__c}'!='Won - Posted' && '{!CommercialQuote__c.Status__c}'!='Booked') {
                taxableChange();    // BLL24a
            }
             
            so_notes = new AsyncField( $dt(el('p:frm:pB:chassis:pb_notes_so:so_notes')), 'Chassis_Special_Order_Notes__c', false, false );
            int_notes = new AsyncField( $dt(el('p:frm:pB:chassis:pb_notes_int:int_notes')), 'Chassis_Internal_Notes__c', false, false );
            //BLL27d type_of_sale = new AsyncField ($dt(el('p:frm:pB:chassis:typeofsale')), 'TypeOfSale__c', false, false); // BLL14a

            // Not async due to having to update several other fields and related list objects...
            // vehicle = new AsyncField( $dt(el('p:frm:pB:chassis:vehicle')), 'VehicleInventory__c', false, false); // BLL7a

            /*
                $dt(el('p:frm:pB:pbCustomer:cPostalCode')).on('change',function() {
                    saveField('Zip__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cOpp')).on('change',function() {
                    saveField('Opportunity__c', $dt(el('p:frm:pB:pbCustomer:cOpp_lkid')).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cDdate')).on('change',function() {
                    saveField('Delivery_Date__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cDeliveryNotes')).on('change', function(){
                    saveField('Delivery_Notes__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cDeliveryLocation')).on('change', function(){
                    saveField('Delivery_Location__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cTerms')).on('change', function(){
                    saveField('Terms__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:pbCustomer:cJobReference')).on('change', function(){
                    saveField('Job_Reference__c', $dt(this).val(), $dt(this).attr('id'));
                });


                // Chassis Fields
                $dt(el('p:frm:pB:chassis:chassis')).on('change',function() {
                    saveField('Chassis__c', $dt(el('p:frm:pB:chassis:chassis_lkid')).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:chassis:chassis_qty')).on('change',function() {
                    saveField('Chassis_QTY__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:chassis:chassis_cost')).on('change',function() {
                    saveField('Chassis_Cost__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:chassis:chassis_price')).on('change',function() {
                    saveField('Chassis_Price__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:chassis:chassis_description')).on('change',function() {
                    saveField('Chassis_Description__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:chassis:chassis_wheelbase')).on('change',function() {
                    saveField('Chassis_Platform_Wheelbase__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:chassis:chassis_mfg')).on('change',function() {
                    saveField('Chassis_Platform__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:chassis:chassis_taxable')).on('change',function() {
                    saveField('Chassis_Taxable__c', $dt(this).val(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:chassis:pb_notes:so_notes')).on('change',function() {
                    saveField('Chassis_Special_Order_Notes__c', $dt(this).html(), $dt(this).attr('id'));
                });
                $dt(el('p:frm:pB:chassis:pb_notes_int:int_notes')).on('change',function() {
                    saveField('Chassis_Internal_Notes__c', $dt(this).html(), $dt(this).attr('id'));
                });
            */
            // Set Freight
            cState = new AsyncField( $dt(el('p:frm:pB:pbCustomer:cState')), 'State__c', false, false );
            //$dt(el('p:frm:pB:pbCustomer:cState')).on('change', function(){

                /* - Per Jerry, not the right implimentation based on a conversion with Eric Mansfeld 2/23/2015
                CQ_EXT.setFreight($dt(this).val(), function(result, event){
                    if(event.status) {
                        // Set the Fields
                        $dt(el('p:frm:pB:quoteMisc:freightCost')).val(result.Cost__c);
                        $dt(el('p:frm:pB:quoteMisc:freightAmount')).val(result.Freight__c);
                        $dt(el('p:frm:pB:pbCustomer:cState')).notify('Freight Charges Applied', {position : 'left', className : 'success'});
                    } else {
                        $dt(el('p:frm:pB:pbCustomer:cState')).notify('Failed to lookup Frieght Charges for this State', {position : 'left', className : 'error'});
                    }
                });
                */

                //saveField('State__c', $dt(this).val(), $dt(this).attr('id'));
            //});

            // Bottom of the page totals.

            docFee = new AsyncField($dt(el('p:frm:pB:quoteMisc:docfee')), 'Dealer_document_fee_temp_tag__c', true, 
                function() { totals(); calcCommissionRate(); }
            );

            /*
                $dt(el('p:frm:pB:quoteMisc:docfee')).on('change', function() {
                    totals();
                    saveField('Dealer_document_fee_temp_tag__c' ,$dt(this).val(), $dt(this).attr('id'));
                    saveField('Total__c', $dt(el('p:frm:pB:quoteMisc:total')).val(), $dt(el('p:frm:pB:quoteMisc:total')).attr('id'));
                    saveField('Total_After_Discounts_Rebates__c', $dt(el('p:frm:pB:quoteMisc:totalafter')).val(), $dt(el('p:frm:pB:quoteMisc:totalafter')).attr('id'));
                    calcCommissionRate();
                });
            */

            // BLL2 note: id rebate1 has been commented out
            //rebate1 = new AsyncField(  $dt(el('p:frm:pB:quoteMisc:rebate1')), 'Commercial_rebate__c', true, 
            //    function() { totals(); calcCommissionRate(); }
            //);
            /*
                $dt(el('p:frm:pB:quoteMisc:rebate1')).on('change', function() {
                    // Copy Commercial Discount to the Recap Modal Dialog
                    $dt(el('qCommercialDiscount')).val(doubleVal($dt(this).val()));
                    totals();
                    saveField('Commercial_rebate__c' ,$dt(this).val(), $dt(this).attr('id'));
                    saveField('Total__c', $dt(el('p:frm:pB:quoteMisc:total')).val(), $dt(el('p:frm:pB:quoteMisc:total')).attr('id'));
                    saveField('Total_After_Discounts_Rebates__c', $dt(el('p:frm:pB:quoteMisc:totalafter')).val(), $dt(el('p:frm:pB:quoteMisc:totalafter')).attr('id'));
                    calcCommissionRate();
                });
            */
           
            rebate2 = new AsyncField(  $dt(el('p:frm:pB:quoteMisc:rebate2')), 'Mobility_rebate__c', true, 
                function() { totals(); calcCommissionRate(); }
            );
            /*$dt(el('p:frm:pB:quoteMisc:rebate2')).on('change', function() {
                totals();
                saveField('Mobility_rebate__c' ,$dt(this).val(), $dt(this).attr('id'));
                saveField('Total__c', $dt(el('p:frm:pB:quoteMisc:total')).val(), $dt(el('p:frm:pB:quoteMisc:total')).attr('id'));
                saveField('Total_After_Discounts_Rebates__c', $dt(el('p:frm:pB:quoteMisc:totalafter')).val(), $dt(el('p:frm:pB:quoteMisc:totalafter')).attr('id'));
                calcCommissionRate();
            }); */

            rebate3 = new AsyncField(  $dt(el('p:frm:pB:quoteMisc:rebate3')), 'Additional_Ford_Rebate_Or_Special_Financ__c', true, 
                function() { totals(); calcCommissionRate(); }
            );
            /*$dt(el('p:frm:pB:quoteMisc:rebate3')).on('change', function() {
                totals();
                saveField('Additional_Ford_Rebate_Or_Special_Financ__c' ,$dt(this).val(), $dt(this).attr('id'));
                saveField('Total__c', $dt(el('p:frm:pB:quoteMisc:total')).val(), $dt(el('p:frm:pB:quoteMisc:total')).attr('id'));
                saveField('Total_After_Discounts_Rebates__c', $dt(el('p:frm:pB:quoteMisc:totalafter')).val(), $dt(el('p:frm:pB:quoteMisc:totalafter')).attr('id'));
                calcCommissionRate();
            }); */

            rebate4 = new AsyncField(  $dt(el('p:frm:pB:quoteMisc:rebate4')), 'Government_Price_Concession__c', true, 
                function() { totals(); calcCommissionRate(); }
            );
            /*$dt(el('p:frm:pB:quoteMisc:rebate4')).on('change', function() {
                totals();
                saveField('Government_Price_Concession__c' ,$dt(this).val(), $dt(this).attr('id'));
                saveField('Total__c', $dt(el('p:frm:pB:quoteMisc:total')).val(), $dt(el('p:frm:pB:quoteMisc:total')).attr('id'));
                saveField('Total_After_Discounts_Rebates__c', $dt(el('p:frm:pB:quoteMisc:totalafter')).val(), $dt(el('p:frm:pB:quoteMisc:totalafter')).attr('id'));
                calcCommissionRate();
            });   */ 

            freightCost = new AsyncField( $dt(el('p:frm:pB:quoteMisc:freightCost')), 'Freight_Cost__c', true, 
                function() { totals(); calcCommissionRate(); }
            );
            /*$dt(el('p:frm:pB:quoteMisc:freightCost')).on('change', function() {
                saveField('Freight_Cost__c' ,$dt(this).val(), $dt(this).attr('id'));
                saveField('Total__c', $dt(el('p:frm:pB:quoteMisc:total')).val(), $dt(el('p:frm:pB:quoteMisc:total')).attr('id'));
                saveField('Total_After_Discounts_Rebates__c', $dt(el('p:frm:pB:quoteMisc:totalafter')).val(), $dt(el('p:frm:pB:quoteMisc:totalafter')).attr('id'));
                calcCommissionRate();
            }); 
            */

            freightAmount = new AsyncField( $dt(el('p:frm:pB:quoteMisc:freightAmount')), 'Freight_Amount__c', true, 
                function() { totals(); calcCommissionRate(); }
            );
            /*
                $dt(el('p:frm:pB:quoteMisc:freightAmount')).on('change', function() {
                    totals();
                    saveField('Freight_Amount__c' ,$dt(this).val(), $dt(this).attr('id'));
                    saveField('Total__c', $dt(el('p:frm:pB:quoteMisc:total')).val(), $dt(el('p:frm:pB:quoteMisc:total')).attr('id'));
                    saveField('Total_After_Discounts_Rebates__c', $dt(el('p:frm:pB:quoteMisc:totalafter')).val(), $dt(el('p:frm:pB:quoteMisc:totalafter')).attr('id'));
                    calcCommissionRate();
                });
            */

            chassis_deposit = new AsyncField( $dt(el('p:frm:pB:quoteMisc:chassis_deposit')), 'Deposit__c', false, false );  
            /*$dt(el('p:frm:pB:quoteMisc:chassis_deposit')).on('change', function() {
                saveField('Deposit__c' ,$dt(this).val(), $dt(this).attr('id'));
            });*/            

            // Save COMM Rate
            qCommissionRate = new AsyncField( $dt(el('p:frm:qCommissionRate')), 'Commission_Rate__c', false, calcCommissionRate() );
            /*$dt(el('p:frm:qCommissionRate')).on('change', function(){
                saveField('Commission_Rate__c', $dt(this).val(), $dt(this).attr('id'));

                // Calc based on Commission Rate
                calcCommissionRate();

            });*/

            // BLL6a freight calcs
            InbFrtCost = new AsyncField($dt('input[id$="inboundFreightCost"]'), 'InboundFreightCost__c', true, 
                function() { calcFreight(); }
            );
            DlvFrtCost = new AsyncField($dt('input[id$="deliveryFreightCost"]'), 'DeliveryFreightCost__c', true, 
                function() { calcFreight(); }
            );
            InbFrtAmt = new AsyncField($dt('input[id$="inboundFreightAmount"]'), 'InboundFreightAmount__c', true, 
                function() { calcFreight(); }
            );
            DlvFrtAmt = new AsyncField($dt('input[id$="deliveryFreightAmount"]'), 'DeliveryFreightAmount__c', true, 
                function() { calcFreight(); }
            );
            // BLL6a end

//BLL11d });

</apex:outputText>
            // flatCheckbox = new AsyncField( $dt('[id$="flatCheckbox"]'), 'Commission_Flat_Rate__c', false, calcCommissionRate() );

            // Save Flat Rate
            //$dt('[id$="flatRate"]').on('change', function(){
            $dt(el('flatRate')).on('change', function(){
                // Flat rate Changed, if larger than 0, override commissionable gross based on percentage
                if(doubleVal($dt(this).val())>0) {
                    // SHow saving message
                    $dt('#savingModal').modal('show');

                    //$dt('[id$="flatRate"]').val(doubleVal($dt(this).val()).toFixed(2));
                    $dt(el('flatRate')).val(doubleVal($dt(this).val()).toFixed(2));
                    $dt('#commission_total').val(doubleVal($dt(this).val()).toFixed(2));
                    //$dt(el('p:frm:qCommissionRate')).val(0);
                    //$dt('[id$="flatCheckbox"]').prop('checked', true);
                    $dt('#commission_total').trigger('change');
                }
            });

            // Flat Rate Checkbox
            //$dt('[id$="flatCheckbox"]').on('change', function(){
            $dt(el('p:frm:flatCheckbox')).on('change', function(){
                $dt('#savingModal').modal('show');

                // determine if we are setting flat rate or not.
                //if ( $dt('[id$="flatCheckbox"]').is(':checked') ) {
                if ( $dt(el('p:frm:flatCheckbox')).is(':checked') ) {
                    // $dt(el('p:frm:qCommissionRate')).val(0);
                    //$dt('#commission_total').val(doubleVal( $dt('[id$="flatRate"]').val() ).toFixed(2));
                    $dt('#commission_total').val(doubleVal( $dt(el('flatRate')).val() ).toFixed(2));
                    //saveField( 'Commission_Flat_Rate__c', true, $dt('[id$="flatCheckbox"]').prop('id') );
                    saveField( 'Commission_Flat_Rate__c', true, $dt(el('p:frm:flatCheckbox')).prop('id') );
                } else {
                    //$dt('[id$="flatRate"]').val( default_comm_rate );
                    //$dt(el('flatRate')).val( default_comm_rate );
                    $dt(el('p:frm:qCommissionRate')).val( default_comm_rate );
                    saveField( 'Commission_Rate__c', $dt(el('p:frm:qCommissionRate')).val(), $dt(el('p:frm:qCommissionRate')).prop('id') );
                    //saveField( 'Commission_Flat_Rate__c',false, $dt('[id$="flatCheckbox"]').prop('id') );
                    saveField( 'Commission_Flat_Rate__c', false, $dt(el('p:frm:flatCheckbox')).prop('id') );
                }
                calcCommissionRate(); 
                $dt('#commission_total').trigger('change');
            });

            // BLL22a Which commission total to save to the quote is based on quote status
            if (['Won - Delivered','Won - Posted','Delivered','Booked'].indexOf('{!CommercialQuote__c.Status__c}')>-1) {
                $dt('#commission_totalActual').on('change',function(){
                    if (console) console.log('Total Comission changed...');
                    lastCommission = doubleVal($dt('#commission_totalActual').val()).toFixed(2);    // BLL22a
                    saveField('Commission__c', doubleVal($dt('#commission_totalActual').val()).toFixed(2), $dt('#commission_totalActual').prop('id') );
                    calcCommissionRate(); 
                });
            } else {
            // BLL22a end
            $dt('#commission_total').on('change',function(){
                if (console) console.log('Total Comission changed...');
                lastCommission = doubleVal($dt('#commission_totalActual').val()).toFixed(2);    // BLL22a
                saveField('Commission__c', doubleVal($dt('#commission_total').val()).toFixed(2), $dt('#commission_total').prop('id') );
                calcCommissionRate(); 
            });
            }   // BLL22a

            
            // 
            if($dt(el('p:frm:pB:chassis:chassis_qty')).val()=='') {
                $dt(el('p:frm:pB:chassis:chassis_qty')).val(1);
            }

            if($dt(el('p:frm:pB:chassis:chassis_price')).val()=='') {
                $dt(el('p:frm:pB:chassis:chassis_price')).val(0);
            }
            
            $dt(el('p:frm:pB:chassis:chassis_total')).val(0);

            // onChange of QTY for Chassis will propmt Change of QTY Lines for related items
            // BLL3 add save qty on focus
            $dt(el('p:frm:pB:chassis:chassis_qty')).on('focus', function() {
                chassisqtyval = $dt(el('p:frm:pB:chassis:chassis_qty')).val();
            }); // BLL3 end
            $dt(el('p:frm:pB:chassis:chassis_qty')).on('change', function(){
                // Recalc Chassis Total
                var qty = doubleVal($dt(el('p:frm:pB:chassis:chassis_qty')).val());
                var price=doubleVal($dt(el('p:frm:pB:chassis:chassis_price')).val());
                // BLL3 add multiplier
                var mult = 1;
                try {
                   if (console) console.log('Old qty='+chassisqtyval+'; new qty='+qty);
                   mult = qty / doubleVal(chassisqtyval);
                } catch(e) { }
                if (console) console.log('Line multiplier='+mult);
                // BLL3 end multiplier
                
                $dt(el('p:frm:pB:chassis:chassis_total')).val(qty * price);
                // Apply to other items
                if (mult!=1) { // BLL3 add
                    alertify.confirm("Adjust Quantity of All Line Items?", function (e) {
                        if (e) {
                            $dt('[id^="LQ-"]').each(function(index, value){
                                // $dt(value).val(qty); // BLL3 dlt 
                                var newVal = Math.round(doubleVal($dt(value).val()) * mult); // BLL3 add
                                if (console) console.log('Update line to ' + newVal);  // BLL3 add
                                $dt(value).val(newVal); // BLL3 add
                                var elId = $dt(value).attr('Id').split('-');
                                lineChange(elId[1]);
                            });
                        } else {
                            var savedqty = chassisqtyval;
                            $dt(el('p:frm:pB:chassis:chassis_qty')).focus().select();
                            chassisqtyval = savedqty;
                            if (console) console.log('Reset saved chassis qty to ' + chassisqtyval);
                        }
                    });
                } // BLL3 add
            });         

            // Set Sidebar Totals
            totals();

            // Set Task as Proposal Task
            $dt("[name='task']").addClass('btn-primary').addClass('btn-xs');
            $dt("[name='event']").addClass('btn-primary').addClass('btn-xs');
            $dt("[name='new']").addClass('btn-primary').addClass('btn-xs');
            $dt("[name='mm']").addClass('btn-primary').addClass('btn-xs');
            $dt("[name='email']").addClass('btn-primary').addClass('btn-xs');
            $dt("[name='piSubmit']").addClass('btn-primary').addClass('btn-xs');
            $dt("[name='newNote']").addClass('btn-primary').addClass('btn-xs');
            $dt("[name='viewAll']").addClass('btn-primary').addClass('btn-xs');
            $dt("[name='attachFile']").addClass('btn-primary').addClass('btn-xs');
            $dt("[name='all']").addClass('btn-primary').addClass('btn-xs');
            $dt("[name='piRemove']").addClass('btn-primary').addClass('btn-xs');

            // Lock down mfg / wheelbase fields
            if(quoteRecord!='') {
                $dt(el('p:frm:pB:chassis:chassis_mfg')).prop('disabled', true);
                $dt(el('p:frm:pB:chassis:chassis_wheelbase')).prop('disabled', true);
            }

        });

        /**
         * AsyncField constructor ***
         * Setup an Asyncronous field object to handle fields sasving via ajax.
         * @param {array} _fieldsToSave An array of fields that need to be save
         *                [fieldName, fieldValue, element ]
         * @param {function} _callback     [description]
         */
        function AsyncField(_jqueryobj, _apiname, _saveTotals, _callback) {
            //if (console) console.log('AsyncField for ' + _apiname);   // BLL24a
            if (_jqueryobj==null || _jqueryobj.length==0) {
                if (console) console.log('No object found. _jqueryobj='+_jqueryobj);    // BLL24a
                alertify.alert('no object for ' + _apiname, 'error'); return null;
            }
            this.$el = _jqueryobj;
            this.fields = _saveTotals;
            this.callback = _callback;
            this.SaveSelf = function(){
                if (console) console.log('AsyncField.SaveSelf: ' + _apiname);   // BLL test
                if (console) console.log(this.newValue);
                if (_apiname !== false) {
                    //BLL24d saveField( _apiname, this.$el.val(), this.$el.attr('id') );
                    saveField( _apiname, this.newValue, this.$el.attr('id') );  // BLL24a
                } 
            }
            this.SaveTotals = function() {
                if (_saveTotals === true ) {
                    saveTotals();
                }
                if (this.callback !== false) {
                    this.callback();
                } 
            }

            var _parent = this;

            // Attach Events
            _jqueryobj.focus( function() {
                    _parent.oldValue = _parent.$el.val();
                    if (_parent.$el.is(':checkbox')) _parent.oldValue = _parent.$el.is(':checked');
                    //if (console) console.log('is checkbox=' + _parent.$el.is(':checkbox'));   // BLL24a
                    //if (console) console.log('is checked=' + _parent.$el.is(':checked')); // BLL24a
                    //if (console) console.log('old value=' + _parent.oldValue);    // BLL24a
                    disableActionbutton();
                });
            _jqueryobj.blur(function(){
                    _parent.newValue = _parent.$el.val();
                    if (_parent.$el.is(':checkbox')) _parent.newValue = _parent.$el.is(':checked');
                    //if (console) console.log('is checkbox=' + _parent.$el.is(':checkbox'));   // BLL24a
                    //if (console) console.log('is checked=' + _parent.$el.is(':checked')); // BLL24a
                    //if (console) console.log('old value=' + _parent.oldValue+'; new value='+_parent.newValue);    // BLL24a
                    if (_parent.oldValue != _parent.newValue ) {
                        _parent.SaveSelf();
                        _parent.SaveTotals();
                    } else {
                        enableActionbutton();
                    }
                });
        }

        function saveTotals(){
            var _fieldsToSave = get_total_fields_array();
            for(var i = 0; i < _fieldsToSave.length; i++) {
                saveField(_fieldsToSave[i][0], parseFloat(_fieldsToSave[i][1]),_fieldsToSave[i][2]);
                if (console) console.log( _fieldsToSave[i][1] );
            }
        }

        function get_total_fields_array(){
            var _totalFieldsArray = [ 
                [ 'Total__c',
                   $dt(el('p:frm:pB:quoteMisc:total')).val(), 
                   $dt(el('p:frm:pB:quoteMisc:total')).attr('id')
                ],
                [ 'Total_After_Discounts_Rebates__c',
                   $dt(el('p:frm:pB:quoteMisc:totalafter')).val(), 
                   $dt(el('p:frm:pB:quoteMisc:totalafter')).attr('id')
                ],
            ];
            if (console) console.log(_totalFieldsArray);
            return _totalFieldsArray;
        }

        function calcCommissionRate() {
            if (console) console.log('calcCommissionRate invoked');  
            // #qGross is set asynchronously, and isn't available when this routine is first called,
            // causing commission to be set to $0 temporarily, then reset to proper value, mucking up quote history logs.
            if (!commissionableGrossSet) return;    // BLL21a
            if (console) console.log('calcCommissionRate started');  
            
            var c_gross = doubleVal($dt('#qGross').val()); // commissionable gross
            var c_rate  = doubleVal($dt(el('p:frm:qCommissionRate')).val()); // comm rate
            // var f_rate  = doubleVal( $dt('[id$="flatRate"]').val() ); // flat rate
            var f_rate = doubleVal( $dt('#flatRate').val() ); // flat rate
            var c_tot   = c_gross * (c_rate / 100); // commission total 
            var c_qty   = doubleVal($dt(el('p:frm:pB:chassis:chassis_qty')).val()); // number of chassis?
            var u_gross = c_gross / c_qty; // per unit gross

            var c_grossActual = doubleVal($dt('#qGrossActual').val());  // BLL22a
            var u_grossActual = c_grossActual / c_qty;  // BLL22a
            var c_totActual   = c_grossActual * (c_rate / 100); // BLL22a 

            var c_save = 0; // commission rate to save.
            var c_saveActual = 0;   // BLL22a

            // determine if we are setting flat rate or not.
            //if ( $dt('[id$="flatCheckbox"]').is(':checked') && f_rate > 0 ) {
            if ( $dt(el('p:frm:flatCheckbox')).is(':checked') && f_rate > 0 ) {
                //c_save = doubleVal( $dt('[id$="flatRate"]').val() );
                c_save = doubleVal( $dt(el('flatRate')).val() );
                c_saveActual = c_save;  // BLL22a
            } else {
                c_save = c_tot;
                c_saveActual = c_totActual; // BLL22a
            }
            
            if (console) console.log('Calculating Commission... ' + c_save);
            if (console) console.log('Calculating Actual Commission... ' + c_saveActual);
            
            var prevCommissionTotal = $dt('#commission_total').val();   // BLL12a if commission_total is different, save field!
            $dt('#commission_total').val(c_save.toFixed(2)); 

            //BLL22d if (c_save.toFixed(2)!=prevCommissionTotal) saveField('Commission__c', c_save.toFixed(2),'');  // $dt('#commission_total').trigger('change');  // BLL12a if commission_total is different, save field!
            if (['Won - Delivered','Won - Posted','Delivered','Booked'].indexOf('{!CommercialQuote__c.Status__c}')>-1) {
                if (c_saveActual.toFixed(2)!=lastCommission) {
                    lastCommission = c_saveActual.toFixed(2);
                    saveField('Commission__c', c_saveActual.toFixed(2),'');
                } 
            } else {
                //if (c_save.toFixed(2)!=prevCommissionTotal) saveField('Commission__c', c_save.toFixed(2),'');     // $dt('#commission_total').trigger('change');  // BLL12a if commission_total is different, save field!
                if (c_save.toFixed(2)!=lastCommission) {
                    lastCommission = c_save.toFixed(2);
                    saveField('Commission__c', c_save.toFixed(2),'');
                } 
            }
            
            // $dt('#tot_recap').html(c_gross.toFixed(2)); 
            $dt('#tot_recap').html(c_save.toFixed(2)); 

            $dt(el('p:frm:totalGross')).val(doubleVal(c_gross).toFixed(2));

            saveField('Total_Gross_Profit__c', doubleVal(c_gross).toFixed(2), ''); 
            saveField('Unit_Gross_Profit__c', doubleVal(u_gross.toFixed(2)), '');     
            if (console) console.log('calcCommissionRate completed');  
        }
        
        // BLL6a freight calcs
        function calcFreight() {
            var inboundFrtCost = doubleVal($dt('input[id$="inboundFreightCost"]').val());
            var deliveryFrtCost = doubleVal($dt('input[id$="deliveryFreightCost"]').val());
            var inboundFrtAmt = doubleVal($dt('input[id$="inboundFreightAmount"]').val());
            var deliveryFrtAmt = doubleVal($dt('input[id$="deliveryFreightAmount"]').val());
            var frtcost = inboundFrtCost + deliveryFrtCost;
            var frtamount = inboundFrtAmt + deliveryFrtAmt;
            $dt('input[id$="freightCost"]').val(frtcost.toFixed(2)).blur();
            $dt('input[id$="freightAmount"]').val(frtamount.toFixed(2)).blur();
            if (console) console.log('calcFreight');
        }
        // BLL6a end

        function setSideBarTotals() {
            // Set Sidebar Totals
            // Chassis Totals
            var chassisqty      =   parseFloat($dt(el('p:frm:pB:chassis:chassis_qty')).val().replace(/,/,''));
            var chassisprice    =   parseFloat($dt(el('p:frm:pB:chassis:chassis_price')).val().replace(/,/,''));
            var chassistotal    =   chassisqty * chassisprice;
            chassis_total       =   chassistotal; // Global
            $dt(el('p:frm:pB:chassis:chassis_total')).val(chassistotal);
            $dt('#tot_chassis').html(chassistotal.toFixed(2));
        }
        // Supporting Functions
        function el(s) {
            return '#' + s.replace(/(:|\.)/g,'\\\\$1');
        }

        function populateCustomerDetails() {
            var acctId = $dt(el('p:frm:pB:pbAccount:CommercialAccount_lkid')).val();
            if(acctId!='000000000000000') {
                CQ_EXT.lookupCustomerRecord(acctId, function(result, event) {
                    if(event.status) {
                        // Populate Contents of the other Fields
                        $dt(el('p:frm:pB:pbCustomer:cAddress')).val(result.BillingStreet);
                        $dt(el('p:frm:pB:pbCustomer:cCity')).val(result.BillingCity);
                        $dt(el('p:frm:pB:pbCustomer:cState')).val(result.BillingState);
                        $dt(el('p:frm:pB:pbCustomer:cPostalCode')).val(result.BillingPostalCode);
                        $dt(el('p:frm:pB:pbCustomer:cPhone')).val(result.Phone);
                    }
                });
            }
        }

        function populateChassisDetails() {
            var chassisId = $dt(el('p:frm:pB:chassis:chassis_lkid')).val();
            if(chassisId!='000000000000000') {
                CQ_EXT.lookupOption(chassisId, function(result, event) {
                    if(event.status && result!=null) {
                        $dt(el('p:frm:pB:chassis:chassis_cost')).val(doubleVal(result.Cost__c));
                        $dt(el('p:frm:pB:chassis:chassis_price')).val(doubleVal(result.Selling_Price__c));
                        // MFG & Wheelbase
                        $dt(el('p:frm:pB:chassis:chassis_wheelbase')).val(result.Wheelbase__c);
                        $dt(el('p:frm:pB:chassis:chassis_mfg')).val(result.Vehicle_Manufacturer__c);
                        setSideBarTotals();
                    }
                });
            }
        }

        function chooseChassis(chassisId) {
            CQ_EXT.lookupOption(chassisId, function(result, event) {
                if(event.status && result!=null) {
                    $dt(el('p:frm:pB:chassis:chassis')).val(result.Id);
                    $dt(el('chassisId')).val(result.Name);
                    $dt(el('p:frm:pB:chassis:chassis_cost')).val(doubleVal(result.Cost__c));
                    $dt(el('p:frm:pB:chassis:chassis_price')).val(doubleVal(result.Selling_Price__c));
                    // MFG & Wheelbase
                    $dt(el('p:frm:pB:chassis:chassis_wheelbase')).val(result.Wheelbase__c);
                    $dt(el('p:frm:pB:chassis:chassis_mfg')).val(result.Vehicle_Manufacturer__c);

                    if(quoteRecord!='') {
                        saveField('Chassis_Platform__c', result.Vehicle_Manufacturer__c, $dt(el('p:frm:pB:chassis:chassis_mfg')).attr('id'));
                        saveField('Chassis_Platform_Wheelbase__c', result.Wheelbase__c, $dt(el('p:frm:pB:chassis:chassis_wheelbase')).attr('id'));
                        saveField('Chassis__c', result.Id, $dt(el('chassisId')).attr('id'));
                        saveField('Chassis_Cost__c', doubleVal(result.Cost__c), $dt(el('p:frm:pB:chassis:chassis_cost')).attr('id'));
                        saveField('Chassis_Price__c', doubleVal(result.Selling_Price__c), $dt(el('p:frm:pB:chassis:chassis_price')).attr('id'));
                    }
                    // Close the Modal
                    hide('chassisDialog');

                    // Ask client if they would like to reload pageblocks
                    if(quoteRecord!='') {
                        alertify.confirm("Would you like to clear the selected options?", function (e) {
                            if (e) {
                                CQ_EXT.clearSelectedOptions(quoteRecord, function(result, event){
                                    if(event.status) {
                                        window.location='/apex/CQ2?id='+quoteRecord;
                                    } else {
                                        alertify.alert('Something went wrong, woops', 'error');
                                    }
                                });   
                            }
                        });
                    }

                    setSideBarTotals();
                } else {
                    // Error
                    alertify.alert('Something went wrong, woops', 'error');
                }
            });  
        }

        function populateLongWheeBasePackage() {
            var wheelbaseId = $dt(el('p:frm:pB:lwbPbS:wbpkl_lkid')).val();
            if(wheelbaseId!='000000000000000') {
                CQ_EXT.lookupOption(wheelbaseId, function(result, event) {
                    if(event.status && result!=null) {
                        $dt(el('p:frm:pB:lwbPbS:wblPrice')).val(result.Selling_Price__c);
                        setSideBarTotals();
                    }
                });
            }           
        }

        function lineChange(lineId) {

            var qty     =   doubleVal($dt('#LQ-'+lineId).val());
            var price   =   doubleVal($dt('#SP-'+lineId).val());
            var costelem = $dt('#CST-'+lineId); // BLL6a
            var cost    =   null;   // BLL6a
            if (costelem.length) cost = doubleVal(costelem.val());  // BLL6a

            $dt('#ET-'+lineId).val(qty*price);

            // Remote the data
            var linedtl = lineId + '~' + qty + '~' + price; // BLL6a
            if (cost!=null) linedtl += '~' + cost;  // BLL6a
            //BLL6d CQ_EXT.setLineDetails(lineId+'~'+qty+'~'+price, function(result, event) {
            CQ_EXT.setLineDetails(linedtl, function(result, event) {    // BLL6a
                if(event.status) {
                    // Success
                    $dt('#ET-'+lineId).notify('Quote Line Updated', 'success');
                } else {
                    $dt('#ET-'+lineId).notify('Error while saving line', 'error');
                }
            });

            // Update Cart
            totals();
        }
        
        // BLL7a
        function lineDescChange(lineId) {
            var desc = $dt('#LD-' + lineId).val();
            var descdtl = lineId + '~' + desc;
            CQ_EXT.setMiscLineDescription(descdtl, function(result, event) {
                if (event.status) {
                    $dt('#LD-' + lineId).notify('Description updated', 'success');
                } else {
                    $dt('#LD-' + lineId).notify('Error updating description', 'error');
                }
            })
        }
        // BLL7a end

        function totals(){
            if (console) console.log('totals invoked'); // BLL test
            setSideBarTotals();
            totallongWheelBase();
            totalAdditionalSeating();
            totalFabric();
            totalChair();
            totalInterior();
            totalExterior();
            totalStantion();
            totalStorage();
            totalSafety();
            totalOther();
            totalFeesRebates();
            totalDiscount();
            totalRecap();

            // Generate a Running Total
            runningTotal = 0;
            $dt('[id^="ET-"]').each(function(index, value){
                runningTotal+=doubleVal($dt(value).val());
            });

            // Add Chassis
            runningTotal += chassis_total;
            //runningTotal += freight;  // BLL21a
            var prevTotal = doubleVal($dt(el('p:frm:pB:quoteMisc:total')).val());   // BLL13a
            var totMinus = runningTotal + fees - rebates;
            //var totMinus = runningTotal + fees - rebates - freight;   // BLL21c freight previously added in now

            // BLL25a
            if (['Won - Posted','Booked'].indexOf('{!CommercialQuote__c.Status__c}')>-1) {
                if (console) console.log('totals skipped for posted quote');
                if (console) console.log('prevTotal = ' + prevTotal)
                if (prevTotal!=runningTotal) 
                    if(console) console.log('Total would have changed from ' + prevTotal + ' to ' + runningTotal);
                runningTotal = prevTotal;
                total = prevTotal;
                totMinus = runningTotal + fees - rebates;
            }
            // BLL25a end

            $dt(el('p:frm:pB:quoteMisc:total')).val(runningTotal.toFixed(2));
            $dt('#tot_proposal').html(totMinus.toFixed(2));
            $dt(el('p:frm:pB:quoteMisc:totalafter')).val(totMinus.toFixed(2));

            if (console) console.log('totals()');
            
            if (prevTotal!=runningTotal) saveTotals; // BLL13a
            if (console) console.log('totals completed');   // BLL test

        }

        function totallongWheelBase() {
            var total = 0;
            $dt('#p\\:frm\\:pB\\:lwbPbS [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });
            $dt('#p\\:frm\\:pB\\:rwbPbS [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });     
            $dt('#p\\:frm\\:pB\\:lePbS [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });                
            $dt('#tot_wheelbase').html(total.toFixed(2));           
        }

        function totalAdditionalSeating() {
            var total = 0;
            $dt('#p\\:frm\\:pB\\:additionalseating\\:asPBT [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });
            $dt('#p\\:frm\\:pB\\:fabric [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });            
            $dt('#tot_seating').html(total.toFixed(2));
        }

        function totalFabric() {
            var total = 0;
            $dt('#p\\:frm\\:pB\\:fabric [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });
            $dt('#tot_fabric').html(total.toFixed(2));
        }

        function totalChair() {
            var total = 0;
            $dt('#p\\:frm\\:pB\\:wheelchair [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });
            $dt('#tot_wheelchair').html(total.toFixed(2));
        }

        function totalInterior() {
            var total = 0;
            $dt('#p\\:frm\\:pB\\:interior [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });
            $dt('#tot_interior').html(total.toFixed(2));
        }

        function totalStantion() {
            var total = 0;
            $dt('#p\\:frm\\:pB\\:stantion [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });
            $dt('#tot_stantion').html(total.toFixed(2));
        }

        function totalExterior() {
            var total = 0;
            $dt('#p\\:frm\\:pB\\:exterior [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });
            $dt('#tot_exterior_steps').html(total.toFixed(2));
        }

        function totalStorage() {
            var total = 0;
            $dt('#p\\:frm\\:pB\\:wheelchairstorage [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });
            $dt('#tot_wheelchairstorage').html(total.toFixed(2));
        }         

        function totalSafety() {
            var total = 0;
            $dt('#p\\:frm\\:pB\\:options [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });
            $dt('#tot_options').html(total.toFixed(2));         
        }

        function totalOther() {
            var total = 0;
            $dt('#p\\:frm\\:pB\\:other [id^="ET-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });         
            $dt('#tot_other').html(total.toFixed(2));
        }

        function totalDiscount() {
            var total = 0;
            $dt('[id^="DT-"]').each(function(index, value){
                total+=doubleVal($dt(value).val());
            });  
            total_discount = total;
            $dt('#tot_discount').html(total.toFixed(2));
        }

        function totalFeesRebates() {
            var total = 0;
            total+=doubleVal($dt(el('p:frm:pB:quoteMisc:rebate1')).val());
            total+=doubleVal($dt(el('p:frm:pB:quoteMisc:rebate2')).val());
            total+=doubleVal($dt(el('p:frm:pB:quoteMisc:rebate3')).val());
            total+=doubleVal($dt(el('p:frm:pB:quoteMisc:rebate4')).val());
            rebates = total;
            
            total = 0;
            total+=doubleVal($dt(el('p:frm:pB:quoteMisc:docfee')).val());
            total+=doubleVal($dt(el('p:frm:pB:quoteMisc:salestax')).val());
            //BLL21d total+=doubleVal($dt(el('p:frm:pB:quoteMisc:freightAmount')).val());
            // BLL21a
            freight = doubleVal($dt(el('p:frm:pB:quoteMisc:freightAmount')).val());
            total += freight;
            // BLL21a
            fees = total;
            var fees_rebates = 0;
            fees_rebates = fees - rebates;
            $dt('#tot_rebate').html(rebates.toFixed(2));
            $dt('#tot_fees').html(fees.toFixed(2));

        }

        function totalRecap() {
            if (console) console.log('totalRecap invoked'); // BLL test 
            // qCost
            // qGross
            var quoteId = '{!CommercialQuote__c.Id}';
            if(quoteId!='') {
                CQ_EXT.recapTotals(quoteId, function(result, event) {
                    if (console) console.log('CQ_EXT.recapTotals completed');   // BLL test 
                    if(event.status) {
                        // Set Dates
                        $dt('#qDateCreate').val(result.CreatedDate);
                        $dt('#qDateAccepted').val(result.Accepted_Date__c);
                        $dt('#qDateDelivered').val(result.Delivery_Date__c);

                        var chassis_cost =  (doubleVal(result.Chassis_Cost__c) * doubleVal(result.Chassis_QTY__c));
                        var chassis_price=  (doubleVal(result.Chassis_Price__c) * doubleVal(result.Chassis_QTY__c));
                        var commercial_rebate = doubleVal(result.Commercial_Rebate__c);
                        var options_cost =  doubleVal(result.Total_Options_Cost__c);
                        var conversion_cost = doubleVal(result.StockVehConversionCost__c); //BLL22a
                        var options_price=  doubleVal(result.Total_Options_Price__c);
                        var freight_cost =  doubleVal(result.Freight_Cost__c);
                        var freight_price=  doubleVal(result.Freight_Amount__c);
                        var comm_rate    =  doubleVal(result.Commission_Rate__c);

                        var cost = (chassis_cost+options_cost+freight_cost);
                        // BLL22a
                        var costActual = (chassis_cost + conversion_cost);  // BLL22a
                        //if (result.Status__c=='Won - Delivered' || result.Status__c=='Won - Posted') {
                        //  cost = (chassis_cost + conversion_cost);
                        //}
                        // BLL22a
                        var price= (chassis_price+options_price+freight_price);
                        var gross= (price - cost) - commercial_rebate;
                        var grossActual= (price - costActual) - commercial_rebate;  // BLL22a 
                        var fm   = (freight_price - freight_cost);
                        var chassis_gross = (chassis_price - chassis_cost); // BLL20a
                        var chassis_grossActual = (chassis_price - chassis_cost);   // BLL22a
        
                        // determine if we are setting flat rate or not.
                        var commActual = 0; // BLL22a
                        var comm = 0;   // BLL22a
                        if ( $dt('[id$="flatCheckbox"]').is(':checked') ) {
                            comm = doubleVal(result.Commission__c);
                            commActual = doubleVal(result.Commission__c);
                        } else {
                            comm = (gross * (comm_rate / 100));
                            commActual = doubleVal(grossActual * (comm_rate / 100));
                        }

                        $dt('#qTotal').val(doubleVal(price).toFixed(2));
                        $dt('#qTotalActual').val(doubleVal(price).toFixed(2));  // BLL22a
                        $dt('#qCost').val(cost.toFixed(2));
                        $dt('#qCostActual').val(costActual.toFixed(2)); // BLL22a
                        $dt('#qGross').val(gross.toFixed(2));
                        $dt('#qGrossActual').val(grossActual.toFixed(2));
                        commissionableGrossSet = true;  // BLL21a Now we can calc commissions!
                        $dt('#qFreight').val(fm.toFixed(2));
                        //$dt('#qCommercialDiscount').val(total_discount.toFixed(2)); // commercial_discount.toFixed(2));   // BLL11a
                        // unused field $dt('#qCommercialDiscount').val(commercial_discount.toFixed(2));    // BLL22a
                        $dt('#chassisGross').val(chassis_gross.toFixed(2)); // BLL20a
                        $dt('#chassisGrossActual').val(chassis_grossActual.toFixed(2)); // BLL20a

                        var prevCommissionTotal = $dt('#commission_total').val();   // BLL12a if commission_total is different, save field!
                        $dt('#commission_total').val(comm.toFixed(2));
                        $dt('#commission_totalActual').val(commActual.toFixed(2));  // BLL22a

                        //if (comm.toFixed(2)!=prevCommissionTotal) saveField('Commission__c', comm.toFixed(2),'');     // $dt('#commission_total').trigger('change');  // BLL12a if commission_total is different, save field!

                        // BLL22a conditionally set & save correct commission field
                        if (['Won - Delivered','Won - Posted','Delivered','Booked'].indexOf('{!CommercialQuote__c.Status__c}')>-1) {
							$dt('#tot_recap').html($dt('#commission_totalActual').val());
							commActual = commActual.toFixed(2);
                            if (lastCommission!=commActual) {
                                lastCommission = commActual; // BLL22a
                                saveField('Commission__c', commActual.toFixed(2), $dt('#commission_totalActual').prop('id') );
                            }
                        } else {
							$dt('#tot_recap').html($dt('#commission_total').val());
							comm = comm.toFixed(2);
                            if (lastCommission!=comm) {
                                lastCommission = comm;   // BLL22a
                                saveField('Commission__c', comm.toFixed(2), $dt('#commission_total').prop('id') );
                            }
                        }   // BLL22a

                        // if (console) console.log('Commission Total  remote' + comm.toFixed(2) );
                        //BLL22d moved up into new conditional section: $dt('#tot_recap').html($dt('#commission_total').val());

                        // Save Gross
                        if (console) console.log('Commission recalc completed (totalRecap)');   // BLL test 

                    }
                });
            }
            if (console) console.log('totalRecap exited');  // BLL test 
            
        }

        function doubleVal(v) {

            if(v== undefined) {
                return 0;
            }
            if(typeof v=='number') {
                return v;
            }           
            if(v=='') {
                return 0;
            }
            if(v === parseInt(v)) {
                return v;
            }
            return Number(v.replace(/[^0-9-.]/g, ''));
        }   

        function deleteNotify() {
            
        }

        function asynchUpdateTotals() {
            $dt('.proposalbutton').addClass('disabledc');
            totals();
        }

        function hide(el){
            $dt('#'+el).modal('hide');
        }

        function sf(el) {
            // $dt('#'+el).focus();
        }

        function clearOtherFields() {
            $dt('#p\\:frm\\:pB\\:other\\:otherQTY').val('');
            $dt('#p\\:frm\\:pB\\:other\\:otherDescription').val('');
            $dt('#p\\:frm\\:pB\\:other\\:otherCost').val('');
            $dt('#p\\:frm\\:pB\\:other\\:otherPrice').val('');
        }

        function saveField(fieldName, fieldValue, element) {
            if (console) console.log('SaveField: ' + fieldName);    // BLL test
            // var fieldValue = (fieldValue == '') ? ' ' :fieldValue;
            var quoteId = '{!CommercialQuote__c}';
            if(quoteId != '') {
                CQ_EXT.saveField('{!CommercialQuote__c}~'+fieldName+'~'+fieldValue, function(result, event){
                    if(event.status && event.result) {  // BLL16c also check result, as exception is caught in the savefield function!
                        $dt(el(element)).notify('Saved', { position : 'left', className : 'success'});
                        enableActionbutton();
                        totals();
                    } else {
                        $dt(el(element)).notify('Error Saving', 'error', { position : 'left', className : 'error'});
                        enableActionbutton();
                    }

                    // hide modal if displayed
                    $dt('#savingModal').modal('hide');

                });
            } else {
               //enableActionbutton();
            }
        }

        function disableActionbutton() {
            $dt('.actionbutton').prop('disabled', true);
            // if (console) console.log('Disabled Buttons');
        }

        function enableActionbutton() {
            $dt('.actionbutton').prop('disabled', false);
            // if (console) console.log('Buttons Enabled');
        }

        function open_CQ_PDF(btn){
            if (console) console.log('disabled? ' + $dt(btn).hasClass('disabledc') );

            if ( $dt(btn).hasClass('disabledc') ) {
                alert('Equipment Options have changed, please save the Quote before continuing.');
                return false;
            } else {
                if (console) console.log('open pdf!');
                window.open('/apex/CQ_PDF2?id={!CommercialQuote__c.Id}');
            }
            return false; // BLL 5/29/2015
        }

        function open_CQ_Email(btn){
            if ( $dt(btn).hasClass('disabledc') ) {
                alert('Equipment Options have changed, please save the Quote before continuing.');
                $dt(btn).prop('disabled', true);
                return false;
            } 
            return true;  // BLL 5/29/2015
        }

        // BLL14a
        function open_RDInvoice_Email(btn){
            if ( $dt(btn).hasClass('disabledc') ) {
                alert('Equipment Options have changed, please save the Quote before continuing.');
                $dt(btn).prop('disabled', true);
                return false;
            } 
            return true;  // BLL 5/29/2015
        }
        // BLL14a end

        // BLL19a
        function open_CQ_INV(btn){
            if (console) console.log('disabled? ' + $dt(btn).hasClass('disabledc') );

            if ( $dt(btn).hasClass('disabledc') ) {
                alert('Equipment Options have changed, please save the Quote before continuing.');
                return false;
            } else {
                if (console) console.log('open invoice pdf!');
                window.open('/apex/CQ_PDF2?id={!CommercialQuote__c.Id}&dt=i');
            }
            return false; // BLL 5/29/2015
        }
        // BLL19a end
        // BLL5a
        function lostQuote() {
            if (confirm("Mark quote lost?")) {
                markLost();
            }
        }
        // BLL5a end

    </script>

    <style>
        /* BLL6a */
        .readonly {border:none; color:#666666; background:transparent;}
        /* BLL6a end */
        
        /*BLL7a*/
        a.button {
            font: bold 11px Arial;
            text-decoration: none;
            background-color: #EEEEEE;
            color: #333333;
            padding: 2px 6px 2px 6px;
            border-top: 1px solid #CCCCCC;
            border-right: 1px solid #333333;
            border-bottom: 1px solid #333333;
            border-left: 1px solid #CCCCCC;
        }
        /*BLL7a end*/
        
        .modal-backdrop {
          position: fixed;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          z-index: 1040;
          background-color: #000;
          opacity: .5;
        }

        .proposalbutton.disabledc {
            opacity: .7;
        }

        #contentWrapper {
            overflow: hidden;
        }

        .labelCol {
            text-align: right !important;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @-webkit-keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .container { width: 100% !important; margin-right: 0px !important; margin-left: 0px !important; }

        
        .recordHeader {
            height: 55px;
            border: 1px solid #eeeeee;
            z-index: 10000;
            background-color: #ecf0f1;
            padding: 10px;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            -khtml-border-radius: 5px;
            border-radius: 5px;
            border: 1px solid #7f8c8d;
        }

        .recordHeader.affix {
            box-sizing: border-box;
            padding-top: 10px !important;
        }

        /*
        #proposalHeader.affix {
            position: fixed;
            top:0px;
            width:100%;
        }

        #proposalHeader.affix-top {
            position: static;
            margin-top:0px;
            width:100%;
        }       
        */

        .recordHeader.affix {
            position: fixed;
            z-index: 10000;
            top: 0;
            left: 0;
            width: 100%;
            border: 0;
            margin-top: 0;
            padding-top: 0px;
            border-radius: 0;
            animation: fadeIn 0.5s ease-in;
            -webkit-animation: fadeIn 0.5s;
        }

        .affix-placeholder {
            display: none;
        }
        .recordHeader.affix + .affix-placeholder {
            display: block;
            visibility: hidden;
        }   

        .navbar-bright {
         background-color:#111155;
         color:#fff;
        }

        .affix-top,.affix{
         position: static;
        }   

        @media (min-width: 979px) {
          #sidebar.affix-top {
            position: static;
            margin-top:30px;
            width:285px;
          }
          
          #sidebar.affix {
            position: fixed;
            top:70px;
            width:285px;
          }
        }

        #sidebar li.active {
          border:0 #eee solid;
          border-bottom: 1px solid #eee !important;
          border-left-width:5px;
        }   

        #sidebar li {
            border-bottom: 1px solid #eee;
        }

        .mainTitle {
            font-size: 24px !important;
        }

        .pbBody h3 {
            font-size: 20px !important;
        }

        #force h3 {
            font-size: 16px !important;
            margin-top: 0px !important;
            margin-bottom: 0px !important;
        }   

        .totColumn {
            display: inline;
            float: right;
            margin-top: 5px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .container { 
            padding: 0px !important;
        }

        // Fix BootStrap Overlay
        .btn {
            padding: 5px 10px !important; 
            font-size: 12px !important;
            line-height: 1.5 !important;
            border-radius: 3px !important;
            color: #ffffff !important;
            background-color: #5bc0de !important;
            border-color: #46b8da !important;
            display: inline-block !important;
            margin-bottom: 0 !important;
            font-weight: normal !important;
            text-align: center !important;
            white-space: nowrap !important;
            vertical-align: middle !important;
            background-image: none !important;
            border: 1px solid transparent !important;
            -webkit-user-select: none !important;       
        }

        h3 {
            font-size: 16px !important;
            margin-top: 0px !important;
            margin-bottom: 0px !important;
        }   

        #force .nav > li > a {
            display: inline-block;
        }

        #force .nav > li li, #force ul.nav ul span {
            font-size: 0.7em;
        }

        #force .nav > li > a {
            display: inline-block;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 80%;
            overflow: hidden;
        }

        #force .modal {
            z-index: 20000;
        }

        #force .modal-lg {
            width: 975px;
        }

        #force .table {
            border:1px solid #dddddd;
        }

        #force .nav-stacked > li:first-child {
            margin-left: 0;
        }

        #force .off_canvas_menu {
            float: right; 
            display: none;
        }

        @media only screen 
        and (max-width : 992px) { 

            #force #rightCol {
                right: -300px;
                width: 300px;
                background-color: #fff;
            }

            #force #rightCol.visible {
                right: 0px;
                background: #fff;
                position: fixed;
                top: 200px;
            }

            #force .off_canvas_menu {
                display: block;
            }
        }

        @media only screen 
        and (min-device-width : 768px) 
        and (max-device-width : 1024px) 
        and (orientation : portrait) { 

            #force .modal-lg {
                width: 725px;
            }

        }

    </style>


    </head>
<body>

<!--main-->
<apex:outputText rendered="{!AND(false,ISBLANK(slopId),ISBLANK(oppId),ISBLANK(CommercialQuote__c.Id))}"> <!--RT1, BLL27c slopid-->
    <apex:sectionHeader title="Commercial Quote" subtitle="To create a new Conversion Build, start from a Solution Opportunity" description="New conversion builds must be started from the solution opportunity.  This will save you time and effort in the long run."/>
    <apex:image value="{!$Resource.NewCommQuoteSplash}" />
</apex:outputText>

<!-- BLL26a -->
<apex:outputPanel rendered="{!$Permission.canOverrideToNativeLayout}" id="NativeLayoutLinks"
    layout="block" style="float:right;">

<script type="text/javascript">
  //var url = document.referrer;    // when this is a widget on the page
  var url = window.location.href;   // when this is embedded into the visualforce page
  var baseurl = url.substring(0,url.indexOf('/',8)+1);
  var idloc = url.indexOf('?id=');
  if (idloc==-1) idloc = url.indexOf('?Id=');
  if (idloc==-1) idloc = url.indexOf('&id=');
  if (idloc==-1) idloc = url.indexOf('&Id=');
  var nooverride = url.indexOf('?nooverride=1');
  var editnooverride = url.indexOf('/e?nooverride=1');
  var nativeview = '';
  var nativeedit = '';
  var endOfId=url.indexOf('&',idloc+4);
  if (endOfId==-1) endOfId=url.indexOf('#',idloc+4);
  if (endOfId==-1) endOfId=url.length;
  if (idloc>0 && nooverride<=0) {
     nativeview = baseurl+url.substring(idloc+4,endOfId)+'?nooverride=1';
     nativeedit = baseurl+url.substring(idloc+4,endOfId)+'/e?nooverride=1';
  } 
  if (nooverride>0 && editnooverride<0) {
     nativeedit = url.substring(0, nooverride) + '/e' + url.substring(nooverride);
  }
  if (editnooverride>0) {
     nativeview = url.substring(0, editnooverride) + url.substring(nooverride);
  }

  if (nativeview.length>0 || nativeedit.length>0) {
      document.write('Native page&nbsp;');
      if (nativeview.length>0) {
         document.write('[<a target="_top" href="'+nativeview+'">view</a>]&nbsp;');
      }
      if (nativeedit.length>0) {
         document.write('[<a target="_top" href="'+nativeedit+'">edit</a>]&nbsp;');
      }
      document.writeln('<br/>');
  }
  if (nooverride>0) {
     var customurl = url.substring(0, nooverride);
     document.writeln('<a target="_top" href="' + customurl + '">Custom page</a><br/>');
  }
</script>

</apex:outputPanel>
<!-- BLL26a end -->

<apex:outputText > <!-- BLL27d allow to create build-for-stock with no opportunity rendered="{!OR(NOT(ISBLANK(slopId)),NOT(ISBLANK(oppId)), NOT(ISBLANK(CommercialQuote__c.Id)))}" --><!-- BLL27c slopId -->
<div id="proposalHeader" class="recordHeader">
    <div id="force">
        <div class="container">
            <div class="row" >
              <div class="col-sm-2" id="quotename" ><h3>{!CommercialQuote__c.Name}</h3></div>
              <div class="col-sm-2" id="selectedAccount" ><h3>{!CommercialQuote__c.Customer__r.Name}</h3></div>
              <div class="col-sm-5" id="selectedChassis" ><h3>{!CommercialQuote__c.Chassis__r.Name}</h3></div>
              <div class="col-sm-1 text-right" id="quoteTotal"></div>
                <div class="col-sm-2 visible-xs-block visible-md-block off_canvas_menu">
                    <button class="btn btn-primary off_canvas">Menu<i class="glyphicon glyphicon-menu-hamburger"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container"> 
    <chatter:feedWithFollowers entityId="{!CommercialQuote__c.Id}" id="chatterFeed" />
    <apex:pageMessages id="messagebox"/>

    <div id="force">
    <div class="row" >
      
      <!--left-->
      <div class="col-sm-12 col-md-9">

        <apex:form id="frm" html-novalidate="">

<apex:actionFunction action="{!convertToProposal}" name="convertToProposal" rerender="messagebox"/>
<script type="text/javascript">
function cvtQuoteToProposal() {
    if ('{!CommercialQuote__c.Proposal__c}'=='' || confirm('Re-convert this quote?')) {
        $dt('input[id$="cvtButton"]').prop("disabled",true);
        convertToProposal();
    }
}
</script>

        <apex:actionFunction action="{!save}" name="saveQuote"/><!-- BLL7a -->
        <apex:actionStatus id="deleteStatus" onstart="deleteNotify();" onstop="deleteNotify()" />
        <apex:inputHidden id="typeAheadSelect" value="{!optionId}" />
        <!--
        <apex:inputHidden id="totalGross" value="{!CommercialQuote__c.Total_Gross_Profit__c}" />
        <apex:inputHidden id="unitGross" value="{!CommercialQuote__c.Unit_Gross_Profit__c}" />
        -->
        <apex:pageBlock title="Conversion Build Order" id="pB"><!-- BLL27c was Commercial Quote -->
            
            <apex:pageBlockButtons >
                <apex:commandButton action="{!save}" value="Save" styleClass="actionbutton btn-info btn-sm"/>&nbsp;&nbsp;
                <apex:commandButton action="{!cloneQuote}" value="Clone" styleClass="actionbutton btn-info btn-sm" onclick="if(!confirm('This will create an exact copy of this quote in Pending status, continue?')) return false;" rendered="{!NOT(ISBLANK(CommercialQuote__c.Id))}"/>&nbsp;&nbsp;
                <apex:commandButton action="{!doNothing}" onClick="return open_CQ_PDF(this);" value="Print PDF" styleClass="proposalbutton actionbutton btn-info btn-sm"  rendered="{!NOT(ISBLANK(CommercialQuote__c.Id))}"/>&nbsp;&nbsp;
                
                <apex:commandButton action="{!emailPDF}" onclick="return open_CQ_Email(this);" value="Email Proposal" styleClass="proposalbutton actionbutton btn-info btn-sm"  rendered="{!AND(NOT(ISBLANK(CommercialQuote__c.Id)),NOT(BEGINS(CommercialQuote__c.TypeOfSale__c,'Build for')))}"/>&nbsp;&nbsp;<!-- BLL27c rendered -->
                <apex:commandButton action="{!emailReleasingDealerInvoice}" onclick="return open_RDInvoice_Email(this);" value="Email Rel. Dealer" styleClass="proposalbutton actionbutton btn-info btn-sm"  rendered="{!AND(NOT(ISBLANK(CommercialQuote__c.Id)),CommercialQuote__c.TypeOfSale__c=='Releasing Dealer')}"/>&nbsp;&nbsp;<!-- BLL14a -->
                <apex:commandButton action="{!doNothing}" onClick="return open_CQ_INV(this);" value="Print Invoice" styleClass="proposalbutton actionbutton btn-info btn-sm" rendered="{!AND(NOT(ISBLANK(CommercialQuote__c.Id)),NOT(BEGINS(CommercialQuote__c.TypeOfSale__c,'Build for')))}"/>&nbsp;&nbsp;<!-- BLL19a, BLL27c rendered -->
                <apex:commandButton action="{!doRecap}" value="Order Checklist" styleClass="actionbutton btn-info btn-sm"  rendered="{!AND(NOT(ISBLANK(CommercialQuote__c.Id)),CommercialQuote__c.Proposal__c==null,CommercialQuote__c.TypeOfSale__c!='Build for Stock')}"/>&nbsp;&nbsp;<!-- BLL27c hide for proposals and order for stock -->
                <apex:commandButton onclick="window.open('/apex/CQ_MfgOrder_PDF?id={!CommercialQuote__c.Id}'); return false;" value="Print Order" styleClass="btn-info btn-sm" rendered="{!quoteInstance.Id!=null}"/>&nbsp;&nbsp;<!-- BLL27a -->
                <!--
                <apex:commandButton action="{!placeOrder}" value="Submit for Approval" styleClass="btn-info btn-sm"  rendered="{!NOT(ISBLANK(CommercialQuote__c.Id))}" onclick="if(!confirm('Once you submit this record for approval, you might not be able to edit it or recall it from the approval process depending on your settings. Continue?')){return};"/>
                -->
                <apex:commandButton action="{!returnToProposal}" value="Return to Proposal" styleClass="actionbutton btn-info btn-sm"  rendered="{!NOT(ISBLANK(CommercialQuote__c.Proposal__c))}"/>&nbsp;&nbsp;
                <apex:commandButton onclick="cvtQuoteToProposal();" value="Convert to Proposal" styleClass="actionbutton btn-info btn-sm" id="cvtButton"
                    rendered="{!AND($ObjectType.CommercialQuote__c.Deletable,CONTAINS($Profile.Name,'Administrator'))}"/>&nbsp;&nbsp;
            </apex:pageBlockButtons>

            <apex:actionFunction action="{!markQuoteLost}" name="markLost" reRender="pbCustomer" /><!-- BLL5a -->
            
            <span id="sec_customer"></span>
            <apex:pageBlockSection columns="1" id="pbAccount">
                <apex:inputField value="{!CommercialQuote__c.Customer__c}" id="CommercialAccount" label="Commercial Account"  style="width:450px;" onchange="populateCustomerDetails();" />
            </apex:pageBlockSection>
            <apex:pageBlockSection id="pbCustomer" collapsible="false">
                <apex:outputText value=""/><!-- BLL7a placeholder -->
                <!-- BLL5a - add "Mark as lost" button -->
                <apex:pageBlockSectionItem >
                <apex:outputLabel >Status</apex:outputLabel>
                <apex:outputPanel layout="none" id="stsPanel">
                    <apex:outputField value="{!CommercialQuote__c.Status__c}" id="cStatus" label="Status" />
                    &nbsp;&nbsp;
                    <apex:outputPanel layout="none" rendered="{!CommercialQuote__c.Status__c=='Pending'}">
                        <input type="button" onclick="lostQuote();" value="Mark lost"></input>
                    </apex:outputPanel>
                </apex:outputPanel>
                </apex:pageBlockSectionItem>

                <apex:inputField value="{!CommercialQuote__c.Contact__c}" id="cContact" label="Contact" />
                <apex:inputField value="{!CommercialQuote__c.Salesperson__c}" id="cSalesperson" label="Transit Rep" />

                <apex:inputField value="{!CommercialQuote__c.Email_Address__c}" id="cEmail" label="Email" />
                <!-- BLL7a moved status above rep, add location -->
                <apex:inputField value="{!CommercialQuote__c.Location__c}" id="cLocation" label="Store Location"/>
                
                <apex:inputField value="{!CommercialQuote__c.Phone__c}" id="cPhone" label="Work Phone" />
                <apex:inputField value="{!CommercialQuote__c.Mobile__c}" id="cMobile" label="Mobile Phone" />

                <apex:inputField value="{!CommercialQuote__c.Street__c}" id="cAddress" label="Billing Address" />
                <apex:inputField value="{!CommercialQuote__c.City__c}" id="cCity" label="Billing City" />

                <apex:inputField value="{!CommercialQuote__c.County__c}" id="cCounty" label="Billing County" />
                <apex:inputField value="{!CommercialQuote__c.State__c}" id="cState" label="Billing State" />

                <apex:inputField value="{!CommercialQuote__c.F_O_B__c}" id="cFOB" />
                <apex:inputField value="{!CommercialQuote__c.Zip__c}" id="cPostalCode" label="Billing Zip" />

                <apex:inputField value="{!CommercialQuote__c.Customer_Purchase_Order__c}" id="cPO" />
                <apex:outputField value="{!CommercialQuote__c.Opportunity__c}" id="cOpp" rendered="{!CommercialQuote__c.SolutionOpportunity__c==null}"/><!-- BLL27c rendered -->
                <apex:outputField value="{!CommercialQuote__c.SolutionOpportunity__c}" id="cSolOpp" rendered="{!CommercialQuote__c.SolutionOpportunity__c!=null}"/><!-- BLL27c rendered -->
                <!-- BLL27d no longer needed apex:outputText rendered="{!NOT($ObjectType.Opportunity.accessible)}"/ --><!-- BLL10a -->

                <apex:inputField value="{!CommercialQuote__c.Accepted_Date__c}" id="cAdate" />
                <apex:inputField value="{!CommercialQuote__c.Delivery_Date__c}" id="cDdate" />

                <apex:inputField value="{!CommercialQuote__c.Terms__c}" id="cTerms" 
                                 html-data-autoresize="auto" style="width:100%;"/>
                <apex:inputField value="{!CommercialQuote__c.Delivery_Notes__c}" id="cDeliveryNotes" 
                                 html-data-autoresize="auto" style="width:100%;"/>
                
                <apex:inputField value="{!CommercialQuote__c.Job_Reference__c}" id="cJobReference" />                
                <apex:inputField value="{!CommercialQuote__c.Delivery_Location__c}" id="cDeliveryLocation" />
                
                <!-- BLL2 -->
                <apex:inputField value="{!CommercialQuote__c.UnitNumber__c}" id="cUnitNumber" />
                <apex:inputField value="{!CommercialQuote__c.VIN__c}" id="cVIN" />

                <!-- BLL8a -->
                <apex:inputField value="{!CommercialQuote__c.ExteriorColor__c}" id="exteriorcolor"/>
                <apex:inputField value="{!CommercialQuote__c.Mileage__c}" id="mileage"/>
                
                <!-- BLL10a -->
                <apex:inputField value="{!CommercialQuote__c.ServiceManager__c}" id="servicemanager"/>
                <apex:inputField value="{!CommercialQuote__c.SalesAdministrator__c}" id="salesadministrator"/>
                <apex:inputField value="{!CommercialQuote__c.Manager__c}" id="cmcmanager"/>
                <!-- BLL17d apex:outputText / -->
                <!-- BLL10a end -->
                <apex:inputField value="{!CommercialQuote__c.GeneralManager__c}" id="generalmanager"/><!-- BLL17a -->
                
                <!-- BLL7a -->
                <apex:outputText value=""/>
                <apex:outputField value="{!CommercialQuote__c.ServiceRepairOrder__c}" rendered="{!CommercialQuote__c.ServiceRepairOrder__c!=null}"/>
                <apex:outputText rendered="{!location.Legacy_systems__c==true}">Location is not using salesforce</apex:outputText>
                <!-- BLL7a end -->
            </apex:pageBlockSection>    

            <span id="sec_chassis"></span>
            <apex:pageBlockSection id="chassis" title="Chassis" collapsible="false" columns="1">
                <!-- BLL6a -->
                <apex:pageBlockSectionItem ><!-- rendered="{!CommercialQuote__c.TypeOfSale__c!='Build for Stock'}" -->
                    <apex:outputLabel value="Commercial Vehicle"/>
                    <apex:outputPanel >
                        <apex:inputField value="{!CommercialQuote__c.VehicleInventory__c}" id="vehicle"/><!-- BLL6a -->
                        <!-- rmv vehicle button -->
                        <apex:commandButton value="Remove stock vehicle" action="{!rmvCommercialVehicle}" styleClass="btn btn-success btn-xs"  
                            rendered="{!AND(CommercialQuote__c.VehicleInventory__c!=null, CommercialQuote__c.Id != null)}" style="margin-left:3em;"/>
                            <apex:commandButton value="Remove stock vehicle" action="{!rmvCommercialVehicleNoUpdate}" styleClass="btn btn-success btn-xs"  
                            rendered="{!AND(CommercialQuote__c.VehicleInventory__c!=null, CommercialQuote__c.Id == null)}" style="margin-left:3em;"/>
                        <apex:commandButton action="{!save}" value="Save" styleClass="actionbutton btn-info btn-xs"
                            rendered="{!OR(CommercialQuote__c.VehicleInventory__c==null, CommercialQuote__c.Id == null)}" style="margin-left:3em;"/> <!--RT1-->
                            <apex:commandButton action="{!advancedVehicleSearch}" value="Advanced Vehicle Search" styleClass="actionbutton btn-info btn-xs"
                            style="margin-left:3em;"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem rendered="{!NOT(ISBLANK(CommercialQuote__c.VehicleInventory__c))}"><!--  AND( ... ,CommercialQuote__c.TypeOfSale__c!='Build for Stock') -->
                    <apex:outputLabel >
                        Vehicle status
                    </apex:outputLabel>
                    <apex:outputPanel >
                    <apex:outputText value="{!vehicleStatus}" rendered="{!NOT(ISBLANK(vehicleStatus))}"/>
                    <!-- apex:outputLink value="/{!veh.Id}" target="_blank" rendered="{!veh!=null}" style="margin-left:5em;">
                        {!veh.Name}
                    </apex:outputLink -->
                    <span>&nbsp;&nbsp;&nbsp;</span>
                    <apex:outputField value="{!CommercialQuote__c.VehicleInventory__c}"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <!-- BLL6a end -->
                <apex:inputHidden value="{!CommercialQuote__c.Chassis__c}" id="chassis"/>
                <apex:outputPanel ><!-- BLL6a -->
                <apex:outputLabel value="Chassis"/>
                <input type="text" id="chassisId" style="width:650px;" value="{!CommercialQuote__c.Chassis__r.Name}" />
                <!-- BLL6a no find button for chassis when a vehicle was selected -->
                <apex:outputPanel layout="none" rendered="{!CommercialQuote__c.VehicleInventory__c==null}"><!-- BLL6a -->
                    <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#chassisDialog">
                        <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                    </button>
                </apex:outputPanel><!-- BLL6a -->
                </apex:outputPanel><!-- BLL6a -->

                <apex:panelGrid columns="4" style="width:100%;" id="cPG">
                    <apex:outputText ><b>QTY</b></apex:outputText>
                    <apex:outputText ><b>Chassis Cost</b></apex:outputText>
                    <apex:outputText ><b>Chassis Sale Price</b></apex:outputText>
                    <apex:outputText ><b>Chassis Total</b></apex:outputText>
                    
                    <apex:inputField value="{!CommercialQuote__c.Chassis_QTY__c}" id="chassis_qty" />
                    <apex:inputField value="{!CommercialQuote__c.Chassis_Cost__c}" id="chassis_cost" />
                    <apex:inputField value="{!CommercialQuote__c.Chassis_Price__c}" id="chassis_price" />
                    <apex:inputText id="chassis_total" html-readonly="READONLY"/>
                </apex:panelGrid>

                <apex:panelGrid columns="3" id="mPG" style="width:100%;">
                    
                    <apex:outputText ><b>MFG</b></apex:outputText>
                    <apex:outputText ><b>Wheelbase</b></apex:outputText>
                    <!-- BLL24d apex:outputText ><b>Taxable</b></apex:outputText -->
                    <apex:outputText /><!-- BLL24a -->

                    <apex:inputField value="{!CommercialQuote__c.Chassis_Platform__c}" id="chassis_mfg" />
                    <apex:inputField value="{!CommercialQuote__c.Chassis_Platform_Wheelbase__c}" id="chassis_wheelbase" />
                    <!-- BLL24d apex:inputField value=" { ! CommercialQuote__c.Chassis_Taxable__c}" id="chassis_taxable" / -->
                    <apex:outputText /><!-- BLL24a -->
                    
                </apex:panelGrid>

                <apex:outputField value="{!CommercialQuote__c.TypeOfSale__c}" id="typeofsale" label="Type of Build"><!-- BLL27c to outputField -->
                    <!-- BLL27d required="{!AND(CommercialQuote__c.Status__c!='Won - Posted',CommercialQuote__c.Status__c!='Booked')}"--><!-- BLL13a, BLL27c required -->
                <apex:actionSupport event="onchange" action="{!noaction}" reRender="FirstFollowup"/>
                </apex:outputField><!--BLL27c to outputfield -->
                    
                <apex:inputField value="{!CommercialQuote__c.Proposal__c}" 
                    rendered="{AND(CommercialQuote__c.TypeOfSale__c=='Build for Customer',CommercialQuote__c.Proposal__c==null)}"/><!-- BLL27a -->
                <apex:outputField value="{!CommercialQuote__c.Proposal__c}"
                    rendered="{!CommercialQuote__c.Proposal__c!=null}"/><!-- BLL27a -->

                <apex:pageBlockSectionItem id="pb_notes_so">
                    <apex:outputText style="color:red;font-weight:bold;">Special Order Notes:</apex:outputText>
                    <apex:inputField value="{!CommercialQuote__c.Chassis_Special_Order_Notes__c}" 
                                     html-data-autoresize="auto" style="width:500px;" id="so_notes" />
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem id="pb_notes_int">
                    <apex:outputText style="color:red;font-weight:bold;">Internal Notes:</apex:outputText>
                    <apex:inputField value="{!CommercialQuote__c.Chassis_Internal_Notes__c}" 
                                     html-data-autoresize="auto" style="width:500px;" id="int_notes" />
                </apex:pageBlockSectionItem>

            </apex:pageBlockSection>
            <!-- Chassis Dialog -->
                <div class="modal fade" id="chassisDialog" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Chassis / Platform</h4>
                                <!-- BLL7a -->
                                <apex:actionRegion >
                                <apex:actionFunction action="{!doNothing}" name="doSearch" reRender="chassisOptionsList"/><!-- BLL7a -->
                                <span style="margin-left:3em;">Keyword search: 
                                    <apex:inputText value="{!keyword1}" id="keyword1" style="margin-left:1em;"
                                        onkeypress="return submitOnEnter(event);"  onblur="return submitOnEnter(event);" />
                                    <apex:inputText value="{!keyword2}" id="keyword2" style="margin-left:1em;"
                                        onkeypress="return submitOnEnter(event);"  onblur="return submitOnEnter(event);" />
                                    <apex:inputText value="{!keyword3}" id="keyword3" style="margin-left:1em;"
                                        onkeypress="return submitOnEnter(event);"  onblur="return submitOnEnter(event);" />
                                    <input type="button" class="btn btn-xs" onclick="doSearch(); return false;" style="margin-left:1em;" value="Search"/>
                                </span>
                                </apex:actionRegion>
                                <!-- BLL7a end -->
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="chassisOptionsList"><!-- BLL7a -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>MFG</th>
                                        <th>Wheelbase</th>
                                        <th>Price</th>
                                    </tr>

                                    <apex:repeat value="{!ChassisList}" var="c"><!-- BLL7c use getChassisList method -->
                                    <apex:outputText rendered="{!IF(c.RecordTypeName__c=='Chassis Options', true, false)}">
                                    <tr>
                                        <td>
                                            <button type="button" class="btn btn-success btn-xs" onclick="chooseChassis('{!c.Id}')">
                                                Select
                                            </button>                                     
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.Vehicle_Manufacturer__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.Wheelbase__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL7a -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of Chassis Dialog -->

                <!-- First FollowUp Date -->
                <apex:outputText id="FirstFollowup" rendered="{!AND(false,ISBLANK(CommercialQuote__c.Id))}"><!-- BLL27c hide section -->
                    <apex:pageBlockSection title="First Follow-Up" collapsible="false" rendered="{!OR(CommercialQuote__c.TypeOfSale__c==null,NOT(BEGINS(CommercialQuote__c.TypeOfSale__c,'Build for')))}">
                        <apex:inputField value="{!newTask.Subject}" required="true" />
                        <apex:inputField value="{!newTask.ActivityDate}" required="true" />
                    </apex:pageBlockSection>
                </apex:outputText>

            <apex:outputText >  

                <!-- WheelBase Packages -->
                <apex:outputText rendered="{!IF(CommercialQuote__c.Chassis_Platform_Wheelbase__c == 'Long', true, false)}">
                <span id="sec_wheelbase"></span>
                <apex:pageBlockSection title="Long Wheelbase Wheelchair Access and Securement Packages" collapsible="false" columns="1" id="lwbPbS">
                    <apex:panelGrid columns="3" style="width:100%;">

                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#lwbModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>
                        <!--
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="longWheelBaseSearchDialog" placeholder="Long Wheelbase Search" filterClause="RecordTypeName__c=\'Wheelbase Options\' and Active__c = true and Vehicle_Manufacturer__c = \'Ford\'" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>
                        <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="lwbPBT" styleClass="btn-xs btn-success" />
                        -->
                    </apex:panelGrid>   
                    <apex:pageBlockTable value="{!longWheelBaseSelectedItems}" var="l" id="lwbPBT">

                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" reRender="lwbPBT,longWheelbaseSelection" 
                                    oncomplete="asynchUpdateTotals();" onclick="if(!confirm('Delete this item?')){return};" styleClass="btn-xs btn-warning"
                                    rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:pageBlockSection>                
                </apex:outputText>
                <div class="modal fade" id="lwbModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Long Wheelbase Options</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="longWheelbaseSelection"><!-- BLL4 -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!AND(c.option.RecordTypeName__c=='Wheelbase Options', c.option.Wheelbase__c=='Long')}">
                                    <tr>
                                        <td>
                                        <!-- apex:commandLink action="{!addOptionToQuote}" value="Select" reRender="lwbPBT" onclick="hide('lwbModal');" oncomplete="asynchUpdateTotals();" styleClass="btn btn-success btn-xs" -->
                                            <!-- apex:param name="optId" assignTo="{!optionId}" value="{!c.Id}" / -->
                                        <!-- /apex:commandLink -->                                         
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="lwbPBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Long Extended WheelBase Packages -->
                <apex:outputText rendered="{!IF(CommercialQuote__c.Chassis_Platform_Wheelbase__c == 'Long Extended', true, false)}">
                <span id="sec_wheelbase"></span>
                <apex:pageBlockSection title="Long Extended Wheelbase Wheelchair Access and Securement Packages" collapsible="false" columns="1" id="lePbS">
                    <apex:panelGrid columns="3" style="width:100%;">

                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#leModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>
                        <!--
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="longWheelBaseSearchDialog" placeholder="Long Wheelbase Search" filterClause="RecordTypeName__c=\'Wheelbase Options\' and Active__c = true and Vehicle_Manufacturer__c = \'Ford\'" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>
                        <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="lwbPBT" styleClass="btn-xs btn-success" />
                        -->
                    </apex:panelGrid>   
                    <apex:pageBlockTable value="{!longWheelBaseSelectedItems}" var="l" id="lePBT">

                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" 
                                  reRender="lePBT,extendedWheelbaseSelection" oncomplete="asynchUpdateTotals();" onclick="if(!confirm('Delete this item?')){return};" styleClass="btn-xs btn-warning"
                                  rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:pageBlockSection>                
                </apex:outputText>
                <div class="modal fade" id="leModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Long Extended Wheelbase Options</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="extendedWheelbaseSelection"><!-- BLL4 -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!AND(c.option.RecordTypeName__c=='Wheelbase Options', c.option.Wheelbase__c=='Long Extended')}">
                                    <tr>
                                        <td>
                                        <!-- apex : commandLink action="{!addOptionToQuote}" value="Select" reRender="lePBT" onclick="hide('leModal');" oncomplete="asynchUpdateTotals();" styleClass="btn btn-success btn-xs" -->
                                            <!-- apex : param name="optId" assignTo="{!optionId}" value="{!c.Id}" / -->
                                        <!-- /apex : commandLink -->                                         
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="lePBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Regular WheelBase Packages -->
                <apex:outputText rendered="{!IF(CommercialQuote__c.Chassis_Platform_Wheelbase__c == 'Regular', true, false)}">
                <span id="sec_wheelbase"></span>
                <apex:pageBlockSection title="Regular Wheelbase Wheelchair Access and Securement Packages" collapsible="false" columns="1" id="rwbPbS">

                    <apex:panelGrid columns="3" style="width:100%;">
                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#rwbModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>                       
                        
                        <!--
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="regularWheelBaseSearchDialog" placeholder="Regular Wheelbase Search" filterClause="RecordTypeName__c=\'Wheelbase Options\' and Active__c = true" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>
                        <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="rwbPBT" styleClass="btn-xs btn-success" />
                        -->
                    </apex:panelGrid>

                    <apex:pageBlockTable value="{!WheelBaseSelectedItems}" var="l" id="rwbPBT">
                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" 
                                   reRender="rwbPBT,regularWheelbaseSelection" oncomplete="asynchUpdateTotals();" 
                                   onclick="if(!confirm('Delete this item?')){return};" styleClass="btn-xs btn-warning"
                                   rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>                  
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                            <!-- BLL11d remove duplicate input input type="hidden" value=" { ! l.Discount__c}" id="DT- { ! l.Id}" /-->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>

                </apex:pageBlockSection>                
                </apex:outputText>
                <div class="modal fade" id="rwbModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Regular Wheelbase Options</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="regularWheelbaseSelection"><!-- BLL4 -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!AND(c.option.RecordTypeName__c=='Wheelbase Options', c.option.Wheelbase__c=='Regular')}">
                                    <tr>
                                        <td>
                                        <!--  apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" reRender="rwbPBT" onclick="hide('rwbModal');" value="Select" styleClass="btn btn-success btn-xs">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.Id}" />
                                        </apex : commandLink -->                    
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="rwbPBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div>              


                <apex:outputText rendered="{!NOT(ISBLANK(CommercialQuote__c.Id))}">

                <!-- Seating Options -->
                <span id="sec_seating"></span>
                <apex:outputText rendered="{!IF(AdditionalSeating_size>0,true,false)}">
                <apex:pageBlockSection title="Additional Seating" id="additionalseating" columns="1" collapsible="false">
                    <apex:panelGrid columns="3" style="width:100%;">
                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#additionalSeatingModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>
                        
                        <!-- 
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="additionalSeatingSearchDialog" placeholder="Seating Options Search" filterClause="RecordTypeName__c=\'Seating Options\' and Active__c = true" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>
                        <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="asPBT" styleClass="btn-xs btn-success" />
                        -->
                    </apex:panelGrid>
                    <apex:pageBlockTable value="{!AdditionalSeatingItems}" var="l" id="asPBT">
                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" 
                                              onclick="if(!confirm('Delete this item?')){return;}" 
                                              oncomplete="asynchUpdateTotals();" 
                                              status="deleteStatus" reRender="asPBT,additionalSeatingSelection" styleClass="btn-xs btn-warning"
                                              rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>                  
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/>
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>              
                </apex:pageBlockSection> 
                <div class="modal fade" id="additionalSeatingModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Seating Options</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="additionalSeatingSelection"><!-- BLL4 -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!IF(c.option.RecordTypeName__c=='Seating Options', true, false)}">
                                    <tr>
                                        <td>
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="asPBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div> 
                </apex:outputText>             

                <!-- Fabric Items -->
                <span id="sec_fabric"></span>
                <apex:outputText rendered="{!IF(Fabric_size>0,true,false)}">                
                <apex:pageBlockSection title="Fabric Selection" id="fabric" columns="1" collapsible="false">
                    <apex:panelGrid columns="3" style="width:100%;">

                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#fabricModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>
                        <apex:commandButton value="Freedman Website" styleClass="btn-xs btn-default" onClick="window.open('http://www.freedmanseating.com/fabrics/')"  />
                        
                        <!--
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="fabricSearchDialog" placeholder="Fabric Options Search" filterClause="RecordTypeName__c=\'Fabric Options\' and Active__c = true" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>

                        <apex:outputPanel >
                            <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="fbPBT" styleClass="btn-xs btn-success" />
                            &nbsp;&nbsp;
                            <apex:commandButton value="Freedman Website" styleClass="btn-xs btn-default" onClick="window.open('http://www.freedmanseating.com/fabrics/')"  />
                        </apex:outputPanel>
                        -->
                    </apex:panelGrid>


                    <apex:pageBlockTable value="{!fabricItems}" var="l" id="fbPBT">
                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" 
                                     reRender="fbPBT,fabricSelection" oncomplete="asynchUpdateTotals();" onclick="if(!confirm('Delete this item?')){return};" styleClass="btn-xs btn-warning"
                                     rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>                      
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/>
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>                              
                </apex:pageBlockSection> 
                <div class="modal fade" id="fabricModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Fabric Options</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="fabricSelection"><!-- BLL4 -->
                                <!-- Build the fabric Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!IF(c.option.RecordTypeName__c=='Fabric Options', true, false)}">
                                    <tr>
                                        <td>
                                        <!-- apex:commandLink action="{!addOptionToQuote}" reRender="fbPBT" onclick="hide('fabricModal');" oncomplete="asynchUpdateTotals();" value="Select" styleClass="btn btn-success btn-xs" --> 
                                            <!-- apex:param name="optId" assignTo="{!optionId}" value="{!c.Id}" / -->
                                        <!--/apex:commandLink -->                                         
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="fbPBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div>
                </apex:outputText>
                <!-- End of Fabric Options -->              

                <span id="sec_wheelchair"></span>
                <apex:outputText rendered="{!IF(WheelchairRestraint_size>0,true,false)}">
                <apex:pageBlockSection title="Wheelchair Restraints" id="wheelchair" columns="1" collapsible="false">
                    <apex:panelGrid columns="3" style="width:100%;">
                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#restraintsModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>
                        
                        <!--
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="wheelcharSearchDialog" placeholder="Restraints Options Search" filterClause="RecordTypeName__c=\'Wheelchair Restraint Options\' and Active__c = true" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>
                        <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="wcrPBT" styleClass="btn-xs btn-success" />
                        -->
                    </apex:panelGrid>


                    <apex:pageBlockTable value="{!WheelChairRestraints}" var="l" id="wcrPBT">
                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" 
                                      reRender="wcrPBT,restraintSelection" oncomplete="asynchUpdateTotals();" onclick="if(!confirm('Delete this item?')){return};" styleClass="btn-xs btn-warning"
                                      rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>                      
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/>
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>                              
                </apex:pageBlockSection>
                <div class="modal fade" id="restraintsModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Wheelchair Restraints</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="restraintSelection"><!-- BLL4 -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!IF(c.option.RecordTypeName__c=='Wheelchair Restraint Options', true, false)}">
                                    <tr>
                                        <td>
                                        <!-- apex:commandLink action="{!addOptionToQuote}" reRender="wcrPBT" onclick="hide('restraintsModal');" oncomplete="asynchUpdateTotals();" value="Select" styleClass="btn btn-success btn-xs" -->
                                            <!-- apex:param name="optId" assignTo="{!optionId}" value="{!c.Id}" / -->
                                        <!-- /apex:commandLink -->                                         
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="wcrPBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div>
                </apex:outputText>
                <!-- End of WheelChair Options -->               

                <span id="sec_interior"></span>
                <apex:outputText rendered="{!IF(InteriorOptions_size>0,true,false)}">
                <apex:pageBlockSection title="Interior Upgrades" id="interior" collapsible="false" columns="1">
                    <apex:panelGrid columns="3" style="width:100%;">
                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#intModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>                   
                        
                        <!--
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="interiorSearchDialog" placeholder="Interior Options Search" filterClause="RecordTypeName__c=\'Interior Upgrades\' and Active__c = true" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>
                        <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="intPBT" styleClass="btn-xs btn-success" />
                        -->
                    </apex:panelGrid>


                    <apex:pageBlockTable value="{!InteriorOptions}" var="l" id="intPBT">
                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" 
                                  reRender="intPBT,interiorSelection" oncomplete="asynchUpdateTotals();" onclick="if(!confirm('Delete this item?')){return};" styleClass="btn-xs btn-warning"
                                  rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>                      
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/>
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>          
                </apex:pageBlockSection>      
                <div class="modal fade" id="intModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Interior Options</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="interiorSelection"><!-- BLL4 -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!IF(c.option.RecordTypeName__c=='Interior Upgrades', true, false)}">
                                    <tr>
                                        <td>
                                        <!-- apex:commandLink action="{!addOptionToQuote}" onclick="hide('intModal');" oncomplete="asynchUpdateTotals();"  reRender="intPBT" value="Select" styleClass="btn btn-success btn-xs" -->
                                            <!-- apex:param name="optId" assignTo="{!optionId}" value="{!c.Id}" / -->
                                        <!-- /apex:commandLink -->                                         
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="intPBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div>
                </apex:outputText>
                <!-- End of Interior Options -->


                <span id="sec_stantion"></span>
                <apex:outputText rendered="{!IF(Stant_size>0,true,false)}">
                <apex:pageBlockSection title="Stantion Poles / Modesty Panels" id="stantion" collapsible="false" columns="1">
                    <apex:panelGrid columns="3" style="width:100%;">
                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#stantModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>                   
                        
                        <!--
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="stantSearchDialog" placeholder="Stantion Poles / Modesty Panels" filterClause="RecordTypeName__c=\'Stanchion Poles\' and Active__c = true" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>
                        <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="stantPBT" styleClass="btn-xs btn-success" />
                        -->
                    </apex:panelGrid>


                    <apex:pageBlockTable value="{!StantItems}" var="l" id="stantPBT">
                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" 
                                    reRender="stantPBT,stantionSelection" oncomplete="asynchUpdateTotals();" onclick="if(!confirm('Delete this item?')){return};" styleClass="btn-xs btn-warning"
                                    rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>                      
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/>
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>      
                </apex:pageBlockSection>
                <div class="modal fade" id="stantModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Stanchion Poles / Modesty Panels</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="stantionSelection"><!-- BLL4 -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!IF(c.option.RecordTypeName__c=='Stanchion Poles', true, false)}">
                                    <tr>
                                        <td>
                                        <!-- apex:commandLink action="{!addOptionToQuote}" onclick="hide('stantModal');" reRender="stantPBT" oncomplete="asynchUpdateTotals();" value="Select" styleClass="btn btn-success btn-xs" -->
                                            <!-- apex:param name="optId" assignTo="{!optionId}" value="{!c.Id}" / -->
                                        <!-- /apex:commandLink -->                                         
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="stantPBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div>
                </apex:outputText>
                <!-- End Stantion Section -->                       

                <span id="sec_exterior_steps"></span>
                <apex:outputText rendered="{!IF(Ext_size>0,true,false)}">
                <apex:pageBlockSection title="Exterior Options - Perforated Tread Surface" id="exterior" collapsible="false" columns="1">
                    <apex:panelGrid columns="3" style="width:100%;">

                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#extModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>

                        <!--
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="stantSearchDialog" placeholder="Search Exterior Steps - Perforated Tread Surface" filterClause="RecordTypeName__c=\'Exterior Upgrades\' and Active__c = true" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>
                        <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="extPBT" styleClass="btn-xs btn-success" />
                        -->
                    </apex:panelGrid>


                    <apex:pageBlockTable value="{!ExtItems}" var="l" id="extPBT">
                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" 
                                    reRender="extPBT,exteriorSelection" oncomplete="asynchUpdateTotals();" onclick="if(!confirm('Delete this item?')){return};" styleClass="btn-xs btn-warning"
                                    rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>                      
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/>
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>  
                </apex:pageBlockSection>
                <div class="modal fade" id="extModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Exterior Options</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="exteriorSelection"><!-- BLL4 -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!IF(c.option.RecordTypeName__c=='Exterior Upgrades', true, false)}">
                                    <tr>
                                        <td>
                                        <!-- apex:commandLink action="{!addOptionToQuote}" reRender="extPBT" onclick="hide('extModal');" oncomplete="asynchUpdateTotals();" value="Select" styleClass="btn btn-success btn-xs" -->
                                            <!-- apex:param name="optId" assignTo="{!optionId}" value="{!c.Id}" / -->
                                        <!-- /apex:commandLink -->                                         
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="extPBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div>
                </apex:outputText>
                <!-- End Exterior Options -->

                <span id="sec_wheelchairstorage"></span>
                <apex:outputText rendered="{!IF(ChairStorage_size>0,true,false)}">
                <apex:pageBlockSection title="Wheelchair Storage" id="wheelchairstorage" columns="1" collapsible="false">
                    <apex:panelGrid columns="3" style="width:100%;">
                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#storageModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>                   
                        
                        <!--
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="storageSearchDialog" placeholder="Search Wheelchair Storage" filterClause="RecordTypeName__c=\'Wheelchair Storage Options\' and Active__c = true" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>
                        <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="storagePBT" styleClass="btn-xs btn-success" />
                        -->
                    </apex:panelGrid>

                    <apex:pageBlockTable value="{!ChairStorageItems}" var="l" id="storagePBT">
                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" 
                                   reRender="storagePBT,storageSelection" oncomplete="asynchUpdateTotals();" onclick="if(!confirm('Delete this item?')){return};" styleClass="btn-xs btn-warning"
                                   rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>                      
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/>
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>  
                </apex:pageBlockSection>
                <div class="modal fade" id="storageModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Wheelchair Storage Options</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="storageSelection"><!-- BLL4 -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!IF(c.option.RecordTypeName__c=='Wheelchair Storage Options', true, false)}">
                                    <tr>
                                        <td>
                                        <!-- apex:commandLink action="{!addOptionToQuote}" reRender="storagePBT" onclick="hide('storageModal');" oncomplete="asynchUpdateTotals();" value="Select" styleClass="btn btn-success btn-xs" -->
                                            <!-- apex:param name="optId" assignTo="{!optionId}" value="{!c.Id}" / -->
                                        <!-- /apex:commandLink -->                                         
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="storagePBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div>
                </apex:outputText>
                <!-- End of Storage Modal -->


                <span id="sec_options"></span>
                <apex:outputText rendered="{!IF(Safety_size>0,true,false)}">
                <apex:pageBlockSection title="Additional Safety Options" id="options" collapsible="false" columns="1">
                    <apex:panelGrid columns="3" style="width:100%;">
                        <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#safetyModal">
                            <span class="glyphicon glyphicon-search"></span>&nbsp;Find
                        </button>                   
                        
                        <!--
                        <apex:outputPanel style="width:85%;">
                        <c:Typeahead object="Commercial_Quote_Options__c" searchBoxId="additionalSafetySearchDialog" placeholder="Search Additional Safety Options" filterClause="RecordTypeName__c=\'Additional Safety Options\' and Active__c = true" destinationForSelectedId="typeAheadSelect" stealFocus="false"/>
                        </apex:outputPanel>
                        <apex:commandButton value="Add to Quote" action="{!addOptionToQuote}" reRender="safetyPBT" styleClass="btn-xs btn-success" />
                        -->
                    </apex:panelGrid>

                    <apex:pageBlockTable value="{!SafetyItems}" var="l" id="safetyPBT">
                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" 
                                         reRender="safetyPBT,safetyOptions" oncomplete="asynchUpdateTotals();" onclick="if(!confirm('Delete this item?')){return};" styleClass="btn-xs btn-warning"
                                         rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" />
                        </apex:column>                      
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/>
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="25%">
                            <apex:facet name="header">Name</apex:facet>
                            <apex:outputText value="{!l.Commercial_Quote_Options__r.Name}" />
                        </apex:column>
                        <apex:column width="35%">
                            <apex:facet name="header">Description</apex:facet>
                            <apex:outputText value="{!l.Description__c}" />
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column rendered="{!currentVehicleId!=null}">
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>                      
                </apex:pageBlockSection> 
                <div class="modal fade" id="safetyModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Additional Safety Options</h4>
                            </div>
                            <div class="modal-body">
                                <apex:outputPanel id="safetySelection"><!-- BLL4 -->
                                <!-- Build the LWB Options Table -->
                                <table class="table table-hover">
                                    <tr>
                                        <th>Action</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Selling Price</th>
                                    </tr>

                                    <apex:repeat value="{!MultiselectModalTable}" var="c"><!-- BLL4c -->
                                    <apex:outputText rendered="{!IF(c.option.RecordTypeName__c=='Additional Safety Options', true, false)}">
                                    <tr>
                                        <td>
                                        <!-- apex:commandLink action="{!addOptionToQuote}" reRender="safetyPBT" onclick="hide('safetyModal');" oncomplete="asynchUpdateTotals();" value="Select" styleClass="btn btn-success btn-xs" -->
                                            <!-- apex:param name="optId" assignTo="{!optionId}" value="{!c.Id}" / -->
                                        <!-- /apex:commandLink -->                                         
                                        <apex:commandLink action="{!addOptionToQuote}" oncomplete="asynchUpdateTotals();" 
                                            onclick="$dt(this).html('on quote').removeClass('btn-success').addClass('disabled btn-info');"  
                                            reRender="safetyPBT" value="{!IF(c.selected,'on quote','Select')}" styleClass="{!'btn btn-xs '+IF(c.selected,'btn-info disabled','btn-success')}">
                                            <apex:param name="optId" assignTo="{!optionId}" value="{!c.option.Id}" /><!-- BLL4 -->
                                        </apex:commandLink>                                         
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Name}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Description__c}" />
                                        </td>
                                        <td>
                                            <apex:outputText value="{!c.option.Selling_Price__c}" />
                                        </td>
                                    </tr>
                                    </apex:outputText>
                                    </apex:repeat>
                                </table>
                                </apex:outputPanel><!-- BLL4 -->
                            </div>
                        </div>
                    </div>
                </div>
                </apex:outputText>
                <!-- End Safety Items -->                

                <span id="sec_other"></span>
                <apex:pageBlockSection title="Other Items From Manufacturer" id="other" collapsible="false" columns="1">
                    <apex:panelGrid columns="5" width="100%">

                        <apex:outputText value="QTY" />
                        <apex:outputText value="Description" html-data-autoresize="auto" />
                        <apex:outputText value="Cost" />
                        <apex:outputText value="Price" />
                        <apex:outputText />

                        <apex:inputText value="{!otherQTY}" id="otherQTY" style="width:25px;" />
                        <apex:inputTextArea value="{!otherName}" id="otherDescription" 
                                            html-data-autoresize="auto" style="width:200px;" />
                        <apex:inputText value="{!otherCost}" id="otherCost" />
                        <apex:inputText value="{!otherPrice}" id="otherPrice" />

                        <button class="btn btn-success btn-xs" id="addOtherBtn">Save Other Item</button>
                        <apex:actionFunction action="{!addOtherOption}" name="addOtherOption" rerender="otherItemsTable" oncomplete="clearOtherFields();"></apex:actionFunction>

                        <!-- <apex:commandButton value="Save Other Item" action="{!addOtherOption}" rerender="otherItemsTable" oncomplete="clearOtherFields();" styleClass="btn-success btn-xs" ></apex:commandButton> -->

                    </apex:panelGrid>
                    <apex:pageBlockTable value="{!MiscItems}" var="l" id="otherItemsTable">
                        <apex:column >
                            <apex:facet name="header"></apex:facet>
                            <apex:commandLink value="-" action="{!removeItem}" status="deleteStatus" oncomplete="asynchUpdateTotals();" onclick="if(!confirm('Delete this item?')){return};" reRender="otherItemsTable" styleClass="btn-xs btn-warning"
                                  rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6 add rendered -->
                                <apex:param value="{!l.Id}" name="itemToRemove" assignTo="{!itemToRemove}" />
                            </apex:commandLink>
                            <apex:outputText value="Stock" rendered="{!l.LockedOption__c}"/><!-- BLL6a -->
                            <!-- <input type="hidden" value="{!l.Discount__c*l.Quantity__c}" id="DT-{!l.Id}" /> -->
                        </apex:column>                      
                        <apex:column >
                            <apex:facet name="header">QTY</apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" onchange="lineChange('{!l.Id}')"/>
                            </apex:outputPanel><!-- BLL6a -->
                            <apex:outputPanel layout="none" rendered="{!l.LockedOption__c}"><!-- BLL6a -->
                            <input type="text" style="width:25px;" maxlength="3" value="{!l.Quantity__c}" id="LQ-{!l.Id}" readonly="true" class="readonly" onfocus="this.blur();"/> 
                            </apex:outputPanel><!-- BLL6a -->
                        </apex:column>
                        <apex:column width="60%">
                            <apex:facet name="header">Description</apex:facet>
                            <!-- BLL7d apex:outputText value="{!l.Description__c} - Cost: {!l.Cost__c} " / -->
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}"><!-- BLL7a -->
                            <textarea id="LD-{!l.Id}" onchange="lineDescChange('{!l.Id}')"
                                html-data-autoresize="auto" style="width:200px;">{!l.Description__c}</textarea><!-- BLL7a -->
                            </apex:outputPanel><!-- BLL7a -->
                            <apex:outputText value="{!l.Description__c}" rendered="{!l.LockedOption__c}"/><!-- BLL7a -->
                        </apex:column>
                        <!-- BLL6a cost column -->
                        <apex:column ><!--  rendered="{!currentVehicleId!=null}" -->
                            <apex:facet name="header">
                                <apex:outputPanel id="cstPanel" style="float:right;">Cost</apex:outputPanel>                                
                            </apex:facet>
                            <apex:outputPanel layout="none" rendered="{!NOT(l.LockedOption__c)}">
                            <input type="text" value="{!l.Cost__c}" id="CST-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')"/> 
                            </apex:outputPanel>
                        </apex:column>
                        <!-- BLL6a end -->
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="spPanel" style="float:right;">Selling Price</apex:outputPanel>                                
                            </apex:facet>
                            <input type="text" value="{!l.Selling_Price__c}" id="SP-{!l.Id}" style="float:right;text-align:right;" onchange="lineChange('{!l.Id}')" />
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel id="etPanel" style="float:right;">Extended Total</apex:outputPanel>   
                            </apex:facet>
                            <input type="text" value="{!l.Extended_Total__c}" id="ET-{!l.Id}" style="float:right;text-align:right;"/>
                        </apex:column>
                    </apex:pageBlockTable>                      
                </apex:pageBlockSection> 

                </apex:outputText> <!-- End of Chassis Required -->

                <span id="sec_rebatefees"></span>
<style>.readonly {border:none; color:#666666; background:transparent;}</style>
<apex:actionFunction action="{!doNothing}" name="updateSalesTax" rerender="quoteMisc"/><!-- BLL24a -->
                <apex:pageBlockSection title="Rebates and Fees" columns="3" id="quoteMisc" collapsible="false" rendered="{!NOT(ISBLANK(CommercialQuote__c.Id))}">
                    <apex:outputText /><apex:outputText />
                    <apex:inputField value="{!CommercialQuote__c.Dealer_document_fee_temp_tag__c}" id="docfee" label="Documentation Fee / Temp Tag" />

                    <apex:outputText />
                    <apex:outputText />
                    <apex:outputText />
                    <!--
                    <apex:inputField value="{!CommercialQuote__c.Commercial_rebate__c}" id="rebate1" label="Commercial Discount" />
                    -->

                    <apex:outputText /><apex:outputText />
                    <apex:inputField value="{!CommercialQuote__c.Mobility_rebate__c}" id="rebate2" label="Mobility Rebate" />

                    <apex:outputText /><apex:outputText />
                    <apex:inputField value="{!CommercialQuote__c.Additional_Ford_Rebate_Or_Special_Financ__c}" id="rebate3" label="Additional MFG Rebate" />

                    <apex:outputText /><apex:outputText />
                    <apex:inputField value="{!CommercialQuote__c.Government_Price_Concession__c}" id="rebate4" label="Government Price Concession for Qualified Buyers (with GPC code)" />

                    <!-- apex:outputText / -->
                    <apex:inputField value="{!CommercialQuote__c.InboundFreightCost__c}" id="inboundFreightCost" 
                        onfocus="{!IF(CommercialQuote__c.InboundFreightCost__c==500,'this.blur();','')}" 
                        /> <!-- BLL23d styleClass=" { ! IF(CommercialQuote__c.InboundFreightCost__c==500,'readonly','')}" / --><!-- BLL6a --> <!-- BLL18c, BLL21c -->
                    <apex:inputField value="{!CommercialQuote__c.DeliveryFreightCost__c}" id="deliveryFreightCost"
                        /><!-- BLL6a -->
                    <apex:inputField value="{!CommercialQuote__c.Freight_Cost__c}" id="freightCost"
                        onfocus="this.blur();" styleClass="readonly" /> <!-- Frieght Cost -->

                    <!-- apex:outputText / -->
                    <apex:inputField value="{!CommercialQuote__c.InboundFreightAmount__c}" id="inboundFreightAmount"/><!-- BLL6a -->
                    <apex:inputField value="{!CommercialQuote__c.DeliveryFreightAmount__c}" id="deliveryFreightAmount"/><!-- BLL6a -->
                    <apex:inputField value="{!CommercialQuote__c.Freight_Amount__c}" id="freightAmount" 
                        onfocus="this.blur();" styleclass="readonly" /> <!-- Frieght Sale Amount -->

                    <!-- BLL24d apex:outputText /><apex:outputText / -->
                    <apex:inputField value="{!CommercialQuote__c.Chassis_Taxable__c}" id="chassis_taxable" />
                    <apex:inputField value="{!CommercialQuote__c.ReleasingDealerCollectsTax__c}" id="dealerCollectsTax" /> 
                    <apex:inputField value="{!CommercialQuote__c.Tax__c}" id="salestax" label="Tax" />

                    <apex:outputText /><apex:outputText />
                    <apex:inputField value="{!CommercialQuote__c.Deposit__c}" id="chassis_deposit" />
                    
                    <apex:outputText /><apex:outputText />
                    <apex:inputField value="{!CommercialQuote__c.Total__c}" id="total" label="Total Vehicle Package" />

                    <apex:outputText /><apex:outputText />
                    <apex:inputField value="{!CommercialQuote__c.Total_After_Discounts_Rebates__c}" id="totalafter" label="Total Vehicle Package after Rebates / Incentives" />
                </apex:pageBlockSection>

            </apex:outputText> <!-- End of Chassis Required Rendered Tag -->

            </apex:pageBlock>

            <!-- Modal for the recap -->
                            <div class="modal fade" id="recapModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                            <h4 class="modal-title" id="myModalLabel">Recap of Commercial Quote</h4>
                                        </div>
                                        <div class="modal-body">
                                            <!-- Recap Content -->
                                            <table class="table table-hover">
                                                <!-- BLL22a -->
                                                <tr>
                                                    <th></th>
                                                    <th>As Quoted</th>
                                                    <th style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        Actual
                                                    </th>
                                                </tr>
                                                <!-- BLL22a end -->
                                                <tr>
                                                    <td>Consultant</td>
                                                    <td><apex:outputField value="{!CommercialQuote__c.Salesperson__c}" /></td>
                                                    <td style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        <apex:outputField value="{!CommercialQuote__c.Salesperson__c}" />
                                                    </td><!-- BLL22a -->
                                                </tr> 
                                                <tr>
                                                    <td>Quote Total</td>
                                                    <td><input type="number" readonly="readonly" value="{!CommercialQuote__c.Total__c}" id="qTotal" /></td>
                                                    <td style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        <input type="number" readonly="readonly" value="{!CommercialQuote__c.Total__c}" id="qTotalActual" />
                                                    </td><!-- BLL22a -->
                                                </tr>
                                                <tr>
                                                    <td>Quote Cost</td>
                                                    <td><input type="number" readonly="readonly" id="qCost"/><!-- BLL7a -->
                                                        <apex:outputPanel layout="none" rendered="{!costReportId!=null}">
                                                        <a class="button" style="margin-left:2em;" href="/{!costReportId}?pv0={!CommercialQuote__c.Name}" target="_blank">Detail report</a>
                                                        </apex:outputPanel>
                                                    </td>
                                                    <td style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        <input type="number" readonly="readonly" id="qCostActual"/><!-- BLL22a -->
                                                    </td>
                                                </tr>
                                                <tr><!-- BLL20a -->
                                                    <td>Chassis Gross</td>
                                                    <td><input type="number" readonly="readonly" id="chassisGross"/></td>
                                                    <td style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        <input type="number" readonly="readonly" id="chassisGrossActual"/>
                                                    </td><!-- BLL22a -->
                                                </tr><!-- BLL20a end -->
                                                <tr>
                                                    <td>Commissionable Gross</td>
                                                    <td><input type="number" readonly="readonly" id="qGross"/></td>
                                                    <td style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        <input type="number" readonly="readonly" id="qGrossActual"/>
                                                    </td><!-- BLL22a -->
                                                </tr> 
                                                <!-- BLL22d tr style="display:none;" -->
                                                    <!-- BLL22d td>Commercial Discount</td -->
                                                    <!-- BLL22d td><input type="number" readonly="readonly" id="qCommercialDiscount" /></td -->
                                                    <!-- BLL22d td style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        &nbsp;
                                                    </td -->
                                                <!-- BLL22d /tr -->
                                                <tr>
                                                    <td>Freight Profit</td>
                                                    <td><input type="number" readonly="readonly" id="qFreight" /></td>
                                                    <td style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        &nbsp;
                                                    </td><!-- BLL22a -->
                                                </tr>      
                                                <tr>
                                                    <td>Percent (0% = No Commission or Flat Only)</td>
                                                    <td>
                                                        <apex:inputField value="{!CommercialQuote__c.Commission_Rate__c}" id="qCommissionRate" />
                                                    </td>
                                                    <td style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        &nbsp;
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Flat</td>
                                                    <td>
                                                        <apex:inputCheckbox id="flatCheckbox" value="{!CommercialQuote__c.Commission_Flat_Rate__c}"/>
                                                        <!-- <input type="checkbox" id="flatCheckbox" value="{!CommercialQuote__c.Commission_Flat_Rate__c}"/> -->
                                                        <apex:variable var="flatVar" value="{!CommercialQuote__c.Commission__c}" />
                                                        <!-- <apex:inputField value="{!CommercialQuote__c.Commission__c}" id="flatRate" /> -->
                                                        <input type="text" id="flatRate" value="{!flatVar}" />
                                                    </td>
                                                    <td style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        &nbsp;
                                                    </td><!-- BLL22a -->
                                                </tr>  
                                                <tr>
                                                    <td>Total</td>
                                                    <td><input type="number" id="commission_total" readonly="readonly"/></td>
                                                    <td style="display:{!IF(AND(veh!=null,OR(CONTAINS(CommercialQuote__c.Status__c,'Delivered'),CONTAINS(CommercialQuote__c.Status__c,'Posted'),CONTAINS(CommercialQuote__c.Status__c,'Booked'),CONTAINS(CommercialQuote__c.Status__c,'Received'))),'block','none')}">
                                                        <input type="number" id="commission_totalActual" readonly="readonly"/>
                                                    </td><!-- BLL22a -->
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                  <!-- End Modal Recap -->              
            </apex:form>
            <apex:relatedList list="OpenActivities" />  
            <apex:relatedList list="ActivityHistories" />
            <div id="approvalSection"></div>
            <apex:relatedList list="ProcessSteps" />
            <apex:relatedList list="CombinedAttachments" />
            <apex:relatedList list="Transactions__r"  rendered="{!$ObjectType.c2g__codaTransaction__c.accessible}"/><!-- BLL7a -->

<!-- BLL9a -->
<apex:pageBlock rendered="{!historyAvailable}" id="objectHistoryBlock" mode="maindetail">
<apex:pageBlockSection collapsible="true" id="objectHistorySection" columns="1" title="Quote History">
<!-- apex:outputPanel style="font-size:16px;">Quote History</apex:outputPanel -->
<apex:pageBlockSectionItem >
<apex:pageBlockTable value="{!HistoryLines}" var="h">
   <apex:column value="{!h.whattime}" style="min-width: 12em;">
     <apex:facet name="header">Date</apex:facet>
   </apex:column>
   <apex:column headerValue="User" style="min-width: 13em;">
    <apex:outputLink value="/{!h.who.Id}">{!h.username}</apex:outputLink>
   </apex:column>
   <apex:column headerValue="Action">
      <apex:outputText escape="false" value="{!h.action}" /> 
   </apex:column>
</apex:pageBlockTable>
</apex:pageBlockSectionItem>
</apex:pageBlockSection>
<script> 
    twistSection(document.getElementById('{!$Component.objectHistoryBlock.objectHistorySection}').getElementsByTagName('img')[0]); 
</script>
</apex:pageBlock>
<!-- BLL9 end test -->

      </div>
      <!--/left-->

      <!--right-->
      <div class="col-md-3" id="rightCol">
        <ul class="nav nav-stacked" id="sidebar">
          <!-- Nav Column -->
          <!--
          <li>
            <a href="#sec_customer">Commercial Account</a>
          </li>
          -->
          <li>
            <span id="tot_chassis" class="totColumn">$0</span>
            <a href="#sec_chassis">Chassis</a>
          </li>

          <apex:outputText rendered="{!NOT(ISBLANK(CommercialQuote__c.Id))}">

          <apex:outputText rendered="{!IF(Wheelbase_size>0,true,false)}">          
          <li>
            <span id="tot_wheelbase" class="totColumn">$0</span>
            <a href="#sec_wheelbase" onclick="sf('longWheelBaseSearchDialog');">Wheelbase Package</a>
          </li>
          </apex:outputText>

          <apex:outputText rendered="{!IF(AdditionalSeating_size>0,true,false)}">
          <li>
            <span id="tot_seating" class="totColumn">$0</span>
            <a href="#sec_seating">Additional Seating / Fabric</a>
          </li>
          </apex:outputText>

          <apex:outputText rendered="{!IF(WheelchairRestraint_size>0,true,false)}">
          <li>
            <span id="tot_wheelchair" class="totColumn">$0</span>
            <a href="#sec_wheelchair">Wheelchair Restraints</a>
          </li> 
          </apex:outputText>

          <apex:outputText rendered="{!IF(InteriorOptions_size>0,true,false)}">      
          <li>
            <span id="tot_interior" class="totColumn">$0</span>
            <a href="#sec_interior">Interior Upgrades</a>
          </li>
          </apex:outputText>

          <apex:outputText rendered="{!IF(Stant_size>0,true,false)}">
          <li>
            <span id="tot_stantion" class="totColumn">$0</span>
            <a href="#sec_stantion">Stantion Poles / Modesty Panels</a>
          </li>
          </apex:outputText>

          <apex:outputText rendered="{!IF(Ext_size>0,true,false)}">          
          <li>
            <span id="tot_exterior_steps" class="totColumn">$0</span>
            <a href="#sec_exterior_steps">Exterior Options</a>
          </li>
          </apex:outputText>

          <apex:outputText rendered="{!IF(ChairStorage_size>0,true,false)}">
          <li>
            <span id="tot_wheelchairstorage" class="totColumn">$0</span>
            <a href="#sec_wheelchairstorage">Wheelchair Storage</a>
          </li>
          </apex:outputText>

          <apex:outputText rendered="{!IF(Safety_size>0,true,false)}">
          <li>
            <span id="tot_options" class="totColumn">$0</span>
            <a href="#sec_options">Additional Safety Options</a>
          </li>
          </apex:outputText>

          <li>
            <span id="tot_other" class="totColumn">0</span>
            <a href="#sec_other">Other Options / Non-Standard</a>
          </li>

          <li>
            <span id="tot_rebate" class="totColumn">0</span>
            <a href="#sec_rebatefees">Rebates</a>
          </li>

          <li>
            <span id="tot_fees" class="totColumn">0</span>
            <a href="#sec_rebatefees">Fees</a>
          </li>
          <!--
          <li>
            <span id="tot_discount" class="totColumn">0</span>
            <a href="#sec_rebatefees">Equipment Discounts</a>
          </li>
          -->  
          </apex:outputText>

          <li>
            <span id="tot_proposal" class="totColumn">0</span>
            <a href="#sec_other"><b>Total Proposal</b></a>
          </li>  

          <li>
            <span id="approvals" class="totColumn"></span>
            <a href="#approvalSection">Approvals</a>
          </li>  

          <li>
            <span id="tot_recap" class="totColumn">0</span>
            <a href="#sec_recap" data-toggle="modal" data-target="#recapModal">Recap</a>
          </li>    
          <li>
            <button class="btn btn-info btn-xs" onclick="window.location.href='/apex/FormManagerCQ?id={!CommercialQuote__c.Id}'">Forms</button><!-- BLL9a -->
          </li> 
        </ul>
      </div>

      

      <!--/right-->
    </div><!--/row-->       

        <div class="modal fade" id="savingModal" role="dialog">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-body">
                <p>Saving Field, Please Wait...</p>
              </div>
            </div>
          </div>
        </div>  
    </div> <!-- End of Force Div -->

</div><!--/container-->
<div style="height:400px;"></div>
</apex:outputText>

<!-- BLL7a -->
<apex:outputPanel layout="none" rendered="{!AND(saveNewVehicle==true,NOT(ISBLANK(CommercialQuote__c.Id)))}">
    <script type="text/javascript">
        saveQuote();
    </script>
</apex:outputPanel>
<!-- BLL7a end -->

<script type="text/javascript">
/* BLL7a */
function submitOnEnter(ev) {
    ev = (window.event) ? window.event : ev;
    var keyCode = (ev.keyCode) ? ev.keyCode : ev.charCode;
    if (keyCode==13) {
        doSearch();
        return false;
    } else {
        return true;
    }
}
function clearKeywords() {
    jQuery("input[id$='keyword1']").val('');
    jQuery("input[id$='keyword2']").val('');
    jQuery("input[id$='keyword3']").val('');
}
/* BLL7a end */

$dt(document).on('hidden.bs.modal', function(e) {
    $dt(e.target).removeData('bs.modal');
});
</script>
</body>
</apex:page>